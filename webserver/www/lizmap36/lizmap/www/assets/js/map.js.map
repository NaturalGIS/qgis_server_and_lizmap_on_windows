{"version":3,"file":"../../lizmap/www/assets/js/map.js","mappings":";mBAAe,MAAMA,EAEjBC,cACIC,KAAKC,6BAA+B,CAChCC,WAAYC,QAAQC,OAAOF,WAC3BG,QAASF,QAAQC,OAAOC,QACxBC,QAAS,MACTC,QAAS,aACTC,QAAS,QACTC,aAAc,WAGlBT,KAAKU,sCAAwC,CACzCR,WAAYC,QAAQC,OAAOF,WAC3BG,QAASF,QAAQC,OAAOC,QACxBC,QAAS,MACTC,QAAS,sBACTC,QAAS,QACTC,aAAc,OAEtB,CAOAE,iBAAiBC,GACb,MAAMC,QAAiBC,MAAMX,QAAQY,IAAK,CACtCC,OAAQ,OACRC,KAAM,IAAIC,gBAAgB,IACnBlB,KAAKC,gCACLW,MAGX,aAAaC,EAASM,MAC1B,CAOAR,0BAA0BC,GACtB,MAAMC,QAAiBC,MAAMX,QAAQY,IAAK,CACtCC,OAAQ,OACRC,KAAM,IAAIC,gBAAgB,IACnBlB,KAAKU,yCACLE,MAGX,aAAaC,EAASM,MAC1B,ECpDW,MAAMC,EAEjBrB,cACIC,KAAKqB,iCAAmC,CACpCnB,WAAYC,QAAQC,OAAOF,WAC3BG,QAASF,QAAQC,OAAOC,QACxBC,QAAS,MACTC,QAAS,iBACTC,QAAS,QACTc,IAAK,YACLC,YAAa,YAErB,CAOAZ,qBAAqBC,GACjB,MAAMC,QAAiBC,MAAMX,QAAQY,IAAK,CACtCC,OAAQ,OACRC,KAAM,IAAIC,gBAAgB,IACnBlB,KAAKqB,oCACLT,MAGX,aAAaC,EAASW,MAC1B,ECbJC,OAAOC,OAAS,WAKd,IAAIC,EAAS,KAKTC,EAAiB,KAKjBC,EAAe,KAKfC,EAAmB,KAKnBC,EAAkB,KAKlBC,EAAM,KAKNC,EAAa,GAKbC,EAAS,GAKTC,EAAW,CAAC,EAKZC,EAAoB,CAACC,OAAO,GAAGC,QAAQ,IAKvCC,EAAO,CAACZ,OAAO,CAACa,KAAK,UAMrBC,EAAkC,CACpC,mBAAsB,GACtB,kBAAqB,GACrB,qBAAwB,GAOtBC,EAAgC,CAClC,IAAO,aACP,YAAa,mBACb,YAAe,gBACf,YAAa,eACb,KAAQ,mBACR,KAAQ,gBACR,KAAQ,iBACR,KAAQ,gBACR,KAAQ,YACR,QAAW,cACX,QAAW,cACX,OAAU,WACV,QAAW,WACX,SAAY,YACZ,aAAgB,iBAOdC,EAA+B,CACjC,aAAc,MACd,mBAAoB,YACpB,gBAAiB,cACjB,eAAgB,YAChB,mBAAoB,OACpB,gBAAiB,OACjB,iBAAkB,OAClB,gBAAiB,OACjB,YAAa,OACb,cAAe,UACf,cAAe,UACf,WAAY,SACZ,WAAY,UACZ,YAAa,WACb,gBAAiB,eACjB,MAAS,kBAOPC,EAAe,CACnB,EAMIC,EAAa,CACjB,EAKIC,EAAe,CACnB,EAKIC,EAAc,CAClB,EAKIC,EAAgB,KAMhBC,EAAkB,CAAC,EAcnBC,EAAiB,KAiBrB,SAASC,IAIP,IAAIC,EAAkB,CACpBC,0BAA2B,QAC3BC,sBAAuB,MACvBC,iCAAkC,MAClCC,cAAe,KACfC,qBAAsB,KAGxB,MAAM,aAAc9B,GAGhB,0BAA2BA,EAAiB,WAC9CyB,EAAuC,sBAAIzB,EAAiB,SAAyB,uBAEnF,qCAAsCA,EAAiB,WACzDyB,EAAkD,iCAAIzB,EAAiB,SAAoC,kCAEzG,kBAAmBA,EAAiB,WACtCyB,EAA+B,cAAIzB,EAAiB,SAAiB,eAEnE,yBAA0BA,EAAiB,WAC7CyB,EAAsC,qBAAIzB,EAAiB,SAAwB,sBAG9EyB,GAfEA,CAiBX,CAuBA,SAASM,EAAUC,GACjB,GAAKA,KAASf,EACV,OAAOe,EAEX,GAAcC,MAATD,EAED,OADAE,QAAQC,IAAK,oCACN,GAGX,IAAIC,EA9BN,SAA0BJ,GACxB,IAAIK,EAAY,CACZ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAC1U,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAAQ,EAAK,IAC7T,IAAI,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAQlCD,EAPY,SAAUE,GAEtB,IADA,IAAIC,EAAM,GACAC,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAC9BD,GAAOF,EAAWC,EAAKI,OAAOF,KAAQF,EAAKI,OAAOF,GAEtD,OAAOD,CACX,CACmBI,CAAUX,GACzBY,EAAM,IAAIC,OAAO,MAAO,KAC5B,OAAOT,EAAaU,QAAQF,EAAK,IACnC,CAeqBG,CAAkBf,GACrC,GAAMI,KAAgBnB,GAAiBA,EAAamB,IAAiBJ,EAAO,CAGxE,IAFA,IAAIQ,EAAI,EACJQ,EAAaZ,EAAaI,EACtBQ,KAAc/B,GAAiBA,EAAa+B,IAAehB,GAEjEgB,EAAaZ,GADbI,GAAK,GAGPJ,EAAeY,CACnB,CAEA,OADA/B,EAAamB,GAAgBJ,EACtBI,CACT,CAuBA,SAASa,EAAyBlB,GAChC,IAAImB,EAAY,KAOhB,OANInB,KAAaT,IACf4B,EAAY5B,EAAgBS,IACZ,MAAbmB,GAAqBnB,KAAad,IACrCiC,EAAYjC,EAAac,GACzBT,EAAgBS,GAAamB,GAExBA,CACT,CAsEA,SAASC,IA/DT,IACMC,KAAWC,OACOC,EAAE,YAAYC,SAAS,YAIzCH,GAEFE,EAAE,yBAAyBE,SAAS,UAGhCF,EAAE,oBAAoBG,SAASF,SAAS,WAC1CD,EAAE,oBAAoBI,QAGpBJ,EAAE,yBAAyBG,SAASF,SAAS,WAC/CD,EAAE,yBAAyBI,QAEzBJ,EAAE,SAASK,GAAG,aAChBL,EAAE,SAASM,OAEbN,EAAE,gBAAgBO,OAAOP,EAAE,aAE3BA,EAAE,iBACCQ,KAAK,sBAAsBR,EAAE,mBAAmBQ,KAAK,UACrDL,SAASK,KAAK,QAAQ,UAGzBR,EAAE,2BAA2BS,OAC7BT,EAAE,wBAAwBM,SAK1BN,EAAE,yBAAyBU,YAAY,UAGhCV,EAAE,oBAAoBG,SAASF,SAAS,WAC7CD,EAAE,oBAAoBI,QAEnBJ,EAAE,SAASK,GAAG,YAGjBL,EAAE,gBAAgBS,OAFlBT,EAAE,mCAAmCI,QAIvCJ,EAAE,YAAYW,aAAaX,EAAE,mBAE7BA,EAAE,iBACCQ,KAAK,sBAAsBR,EAAE,oBAAoBQ,KAAK,UACtDL,SAASK,KAAK,QAAQ,OAGzBR,EAAE,2BAA2BM,OAC7BN,EAAE,wBAAwBS,SAe5B,IAAIG,EAAIZ,EAAExD,QAAQqE,cAClBD,GAAQZ,EAAE,WAAWc,SACrBd,EAAE,QAAQc,OAAOF,GAGjBZ,EAAE,QAAQe,IAAI,cAAef,EAAE,WAAWgB,eAI1C,IAAIC,EAAIjB,EAAE,QAAQG,SAAS,GAAGe,YAC9BD,GAAKE,SAASnB,EAAE,gBAAgBe,IAAI,gBACpCE,GAAKE,SAASnB,EAAE,gBAAgBe,IAAI,iBAChCf,EAAE,SAASK,GAAG,YAAcL,EAAE,gBAAgBC,SAAS,cACzDD,EAAE,gBAAgBe,IAAI,cAAc,SAEpCE,GAAKjB,EAAE,SAASoB,QAChBpB,EAAE,gBAAgBe,IAAI,cAAef,EAAE,SAASoB,UAElDpB,EAAE,QAAQoB,MAAMH,GAEXjB,EAAE,oBAAoBK,GAAG,aAC5BL,EAAE,uBAAuBe,IAAK,aAAcf,EAAE,eAAec,SAAWd,EAAE,oBAAoBc,UAG7F/D,GAUN,WAEG,IAAIsE,EAAc,IACdC,EAAe,IACd,gBAAiB5E,EAAOf,SAAYe,EAAOf,QAAQ0F,cACpDA,EAAcE,OAAO7E,EAAOf,QAAQ0F,cACnC,iBAAkB3E,EAAOf,SAAYe,EAAOf,QAAQ2F,eACrDA,EAAeC,OAAO7E,EAAOf,QAAQ2F,eACzC,IAAIE,GAAmB,EACnBC,EAAa1E,EAAI2E,iBACjBC,EAAwBF,EAAWG,QACvC,GAAIH,EAAWR,EAAII,GAAeI,EAAWb,EAAIU,EAAc,CAC3DE,GAAmB,EACnB,IAAIK,EAAYC,KAAKC,IAAIV,EAAaC,GAClCU,EAAYF,KAAKG,IAAIZ,EAAaC,GAClCY,EAASJ,KAAKC,IAAIN,EAAWR,EAAGQ,EAAWb,GAC3CuB,EAASL,KAAKG,IAAIR,EAAWR,EAAGQ,EAAWb,GAE7Ce,EADEO,EAAO,EAAIC,EACW,IAAIC,WAAWC,KAAKP,KAAKQ,MAAMJ,EAAO,GAAIJ,KAAKQ,MAAMJ,EAAO,IAC7EL,EAAU,EAAIM,EACG,IAAIC,WAAWC,KAAKP,KAAKQ,MAAMT,EAAU,GAAIC,KAAKQ,MAAMT,EAAU,IAElE,IAAIO,WAAWC,KAAKP,KAAKQ,MAAMN,EAAU,GAAIF,KAAKQ,MAAMN,EAAU,GAChG,CAEA,IAAI,IAAI9C,EAAE,EAAGqD,EAAIxF,EAAIE,OAAOkC,OAAQD,EAAEqD,IAAOrD,EAAG,CAC5C,IAAIsD,EAAQzF,EAAIE,OAAOiC,GACvB,GAAMsD,aAAiBJ,WAAWK,MAAMtG,IAAxC,CAEA,IAAIuG,EAAW,KACVF,EAAMG,QAAQhF,IACf+E,EAAW/C,EAAwB6C,EAAMG,OAC7C,IAAIC,EAAc,KACbF,IACDE,EAAclG,EAAOO,OAAOyF,IAC1BE,IACFA,EAAclG,EAAOO,OAAOuF,EAAMrH,OAAe,SAC/CyH,IACFA,EAAclG,EAAOO,OAAOuF,EAAMG,OAChCC,GAEwB,QAA1BA,EAAYC,aAEZrB,GAAoBgB,EAAMK,WAC5BL,EAAMM,WAAW,CAACD,YAAW,EAAOE,SAAUpB,IACpCH,GAAqBgB,EAAMK,aACrClB,EAAsBf,EAAIO,SAASQ,EAAsBf,EAAI4B,EAAMQ,MAAO,IAC1ErB,EAAsBV,EAAIE,SAASQ,EAAsBV,EAAIuB,EAAMQ,MAAO,IAC1ER,EAAMM,WAAW,CAACD,YAAW,EAAME,SAAUpB,KApBnC,CAsBhB,CAEA,IAAIsB,EAASlG,EAAImG,YACjBnG,EAAIoG,aACJpG,EAAIqG,UAAUH,GACdlG,EAAIsG,UAAUC,SAEdC,GACF,CAnEIC,EAEJ,CAuEA,SAASD,IACL,GAAiD,GAA5CvD,EAAE,gCAAgCb,OACrC,OAAO,EAET,IAAIsE,EAAQzD,EAAE,yDACdyD,EAAM1C,IAAK,aAAc,QACzB,IAAIH,EAAIZ,EAAE,cAAcc,SACxBF,GAAKZ,EAAE,mCAAmCc,SAC1CF,GAAMO,SAASsC,EAAM1C,IAAI,eAAiBI,SAASsC,EAAM1C,IAAI,eAAiB,EAC9EH,GAAMO,SAASsC,EAAM1C,IAAI,kBAAoBI,SAASsC,EAAM1C,IAAI,kBAAoB,EACpFH,GAAMO,SAASsC,EAAM1C,IAAI,gBAAkBI,SAASsC,EAAM1C,IAAI,gBAAkB,EAChFH,GAAMO,SAASsC,EAAM1C,IAAI,mBAAqBI,SAASsC,EAAM1C,IAAI,mBAAqB,EAEtF0C,EAAM1C,IAAK,aAAcH,GAAIG,IAAI,aAAc,UAAUA,IAAI,aAAc,OAC/E,CAgBA,SAAS2C,EAAyBf,EAAMgB,GACtC,IAAInB,EAAQ,KAKZ,GAJAxC,EAAE4D,KAAK3G,GAAO,SAASiC,EAAE2E,GACV,MAATrB,GAAiBqB,EAAElB,MAAQA,IAC7BH,EAAQqB,EACZ,IACa,MAATrB,EACF,OAAO,KACT,IAAIE,EAAW,KACVC,KAAQhF,IACT+E,EAAW/C,EAAwBgD,IACvC,IAAImB,EAAc,KAOlB,GANKpB,IACDoB,EAAcpH,EAAOO,OAAOyF,IAC1BoB,IACFA,EAAcpH,EAAOO,OAAOuF,EAAMrH,OAAe,SAC/C2I,IACFA,EAAcpH,EAAOO,OAAOuF,EAAMG,QAChCmB,EACF,OAAO,KACX,GAAK,sBAAuBA,GAAgD,QAAjCA,EAAYC,mBAClD,mBAAoBD,GAAeA,EAAYE,gBAC/C,WAAYF,EAAYE,gBAAkB,QAASF,EAAYE,eAAgB,CAChF,IAAIA,EAAiBF,EAAYE,eAC7BC,EAAe,CAAC5I,QAAS,MACfE,QAAS,QACTD,QAAS,mBACT4I,MAAOF,EAAe/G,OACtBkH,MAAOH,EAAeI,OACtBC,YAAa,QACbC,WAAY,iCACZC,OAAQ,YACRC,YAAa,OACbC,MAAO,IACPC,IAAK,IAEfC,EAAqBvC,WAAWwC,KAAKC,mBACpCZ,GAEL,OAAO7B,WAAWwC,KAAKE,UAAUd,EAAee,IAAKJ,EACzD,CACIV,EAAe,CAAC5I,QAAS,MACfE,QAAS,QACTD,QAAS,mBACT4I,MAAO1B,EAAMrH,OAAe,OAC5BgJ,MAAO3B,EAAMrH,OAAe,OAC5BmJ,WAAY,iCACZC,OAAQ,YACRC,YAAa,OACbC,MAAO,IACPO,cAAe,EACfC,aAAc,EACdC,YAAa,EACbC,eAAgB,EAChBT,IAAK,GACLU,UAAU,QAEpBtB,EAAYuB,IAAIvB,EAAYnB,KAC9BsB,EAA4B,cAAI,QAEhCA,EAA4B,cAAI,EAChCA,EAAyB,WAAI,EAC7BA,EAA4B,cAAI,QAChCA,EAAyB,WAAI,SAE3BN,IACFM,EAAoB,MAAIlH,EAAIuI,YAC1BX,EAAqBvC,WAAWwC,KAAKC,mBACpCZ,GADL,IAGIsB,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC3CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEhD,OAAOiH,WAAWwC,KAAKE,UAAUS,EAASZ,EAC5C,CAiBA,SAASa,EAAcC,EAAOC,EAASC,GACrC,IAAK,IAAIzG,EAAI,EAAGqD,EAAMkD,EAAOG,aAAazG,OAAQD,EAAEqD,EAAKrD,IAAK,CAC5D,IAAIsD,EAAQiD,EAAOG,aAAa1G,GAC5B2G,EAAgBrD,EAAMG,KACrB,gBAAiBjG,EAAOf,SAAyC,QAA9Be,EAAOf,QAAQmK,YACrDD,EAAgBjI,EAAW4E,EAAMG,MACzBH,EAAMG,QAAQ9E,IACtBgI,EAAgBhI,EAAa2E,EAAMG,OACrC,IAAImB,EAAcpH,EAAOO,OAAO4I,GAChC,GAAiC,GAA7BrD,EAAMoD,aAAazG,OACpB,OAAOqG,EAAchD,EAAMkD,EAASC,GACnC7B,KACc,MAAZ4B,GAEK5B,EAAY4B,SAASA,KAD5BA,EAAS5B,EAAY4B,WAGP,MAAZC,GAEK7B,EAAY6B,SAASA,KAD5BA,EAAS7B,EAAY6B,UAI3B,CAGA,OAFKD,EAAW,IACdA,EAAW,GACN,CAACA,SAASA,EAASC,SAASA,EACrC,CAeA,SAASI,EAAcN,GAErB,KAAM,gBAAiB/I,GACrB,OAAQ,EAGV,GAAkC,GAA9B+I,EAAOG,aAAazG,OAAa,CACnC,IAAI0G,EAAgBJ,EAAO9C,KAK3B,MAJK,gBAAiBjG,EAAOf,SAAyC,QAA9Be,EAAOf,QAAQmK,YACrDD,EAAgBjI,EAAW6H,EAAO9C,MAC1B8C,EAAO9C,QAAQ9E,IACvBgI,EAAgBhI,EAAa4H,EAAO9C,OAClCkD,KAAiBnJ,EAAOsJ,YACnBtJ,EAAOsJ,YAAYP,EAAO9C,OAEzB,CACZ,CAIA,IADA,IAAIsD,GAAS,EACJ/G,EAAI,EAAGqD,EAAMkD,EAAOG,aAAazG,OAAQD,EAAEqD,EAAKrD,IAAK,CAC5D,IAAIsD,EAAQiD,EAAOG,aAAa1G,GAC5B2G,EAAgBrD,EAAMG,KACrB,gBAAiBjG,EAAOf,SAAyC,QAA9Be,EAAOf,QAAQmK,YACrDD,EAAgBjI,EAAW4E,EAAMG,MACzBH,EAAMG,QAAQ9E,IACtBgI,EAAgBhI,EAAa2E,EAAMG,OACrC,IAAIuD,GAOW,IALbA,EAD+B,GAA7B1D,EAAMoD,aAAazG,OACZqG,EAAchD,GAChBqD,KAAiBnJ,EAAOsJ,YACtBtJ,EAAOsJ,YAAYH,IAElB,MAEI,GAAVI,GAAeC,EAASD,KAC1BA,EAAQC,EAEd,CACA,OAAOD,CACT,CAuKA,SAASE,EAAaV,EAAOW,GAC3BA,EAAMC,SAAW,GAEjB,IAAId,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC7CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAE9C,GAAID,QAAQoL,eAAiBpL,QAAQoL,cAAcnH,OAAS,EAAI,CAC5DoG,EAAU,GACV,IAAK,IAAIgB,EAAE,EAAGC,EAAKtL,QAAQoL,cAAcnH,OAAQoH,EAAEC,EAAMD,IACvDhB,EAAQkB,KACNrE,WAAWwC,KAAKE,UACd5J,QAAQoL,cAAcC,GACtBnE,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAIrD,CAIA,IAFA,IAAIuL,EAAa,IAAItE,WAAWuE,OAAOC,iBAAiB,CAAC,GAEhD1H,EAAI,EAAGqD,EAAMkD,EAAOG,aAAazG,OAAQD,EAAEqD,EAAKrD,IAAK,CAC5D,IAAI2H,EAAatB,EACb/C,EAAQiD,EAAOG,aAAa1G,GAC5B2G,EAAgBrD,EAAMG,KAM1B,GALM,gBAAiBjG,EAAOf,SAA0C,QAA9Be,EAAOf,QAAQmK,YACvDD,EAAgBjI,EAAW4E,EAAMG,MACzBH,EAAMG,QAAQ9E,IACtBgI,EAAgBhI,EAAa2E,EAAMG,OAE/BkD,KAAiBnJ,EAAOO,OAA9B,CAGA,IAAI6G,EAAcpH,EAAOO,OAAO4I,GAC5BjG,EAAYnB,EAAUoH,GAG1B,GAFA7H,EAAgB4B,GAAaiG,EAEO,UAA/BA,EAAciB,cAEnB,GAAsB,YAAjBjB,GAIL,GAAM/B,EAAN,CAGiC,QAA5BA,EAAYiD,eACfjD,EAAYvG,KAAO,SAErB,IAAIyJ,EAAYhH,EAAEjD,IAAIyF,EAAM4B,QAAQ,SAAS6C,GACzC,OAAOA,EAAEtE,IACb,IACyB,GAApBqE,EAAU7H,OACX2E,EAAYM,OAAS4C,EACb,sBAAuBtK,EAAOf,SAAWe,EAAOf,QAAQuL,kBAAkBC,WAAW,MAC7FrD,EAAYM,OAAS,CAAC,IAEtBN,EAAYM,OAAS,CAAC,WAI1B,IAAIgD,EAAO,CAACzE,KAAK/C,EAAUlD,OAAOoH,EAAY3D,OAAOiG,GACjDhC,EAAU,WAAYN,EAAeA,EAAYM,OAAO,GAAK,UAChC,oBAAnBiD,gBACTzH,KAAayH,gBACbA,eAAgBzH,KAEnBwE,EAASiD,eAAgBzH,IAE3B,IAAI0H,EAAiB,CACjBrK,OAAOuF,EAAMG,KACZyB,OAAQA,EACRmD,QAAQ,QACRC,WAAW,iCACXC,OAAQ3D,EAAuB,YAAIA,EAAY4D,YAAc,YAC7DC,IAAI,IAEoB,cAAzBL,EAAeG,SACfH,EAA4B,aAAI,GAGJ,iBAArB9E,EAAMoF,cAER,SAAUpF,EAAMoF,aACU,IAA1BpF,EAAMoF,YAAYC,OACwB,GAA1CrF,EAAMoF,YAAYC,KAAKC,QAAQ,SAClCtF,EAAMoF,YAAYC,KAAO,UAAUrF,EAAMoF,YAAYC,MAGhD,UAAWrF,EAAMoF,aAA2C,IAA3BpF,EAAMoF,YAAYG,MAGnD,SAAUvF,EAAMoF,aAA0C,IAA1BpF,EAAMoF,YAAYC,OACrDrF,EAAMoF,YAAcpF,EAAMoF,YAAYG,OAHtCvF,EAAMoF,YAAYG,MAAQvF,EAAMoF,YAAYC,KAAKG,MAAM,OAAO,IAOtE,IAAIC,EAAY,KACW,QAAtBnE,EAAYoE,QAAoBrL,GACjCmD,EAAE4D,KAAK/G,EAAiBsL,SAASlL,QAAQ,SAASiC,EAAG2E,GACnD,GAAKA,EAAEuE,YAAc5F,EAAMG,KACzB,OAAO,EACT,IAAI0F,EAAc,CACd7F,MAAOA,EAAMG,KACb2F,UAAW5L,EAAOf,QAAQ4M,WAAWC,IACrC7F,KAAM/C,EACNzE,OAAQmM,EACRM,YAAYpF,EAAMoF,YAClBa,YAAuC,QAAzB3E,EAAYT,UAC1BqF,eAAe,EACf3D,IAAK8B,GAET,IAA+F,GAA1F7G,EAAE2I,QAASjM,EAAOf,QAAQ4M,WAAWC,IAAII,cAAe,CAAC,YAAY,iBACpE,gBAAiBlM,EAAOf,SACY,GAArCe,EAAOf,QAAQkN,YAAY1J,OAAc,CAM1C,IALA,IAAI0J,EAAcnM,EAAOf,QAAQkN,YAC7BC,EAASD,EAAY,GACrBE,EAAgBF,EAAY1J,OAC5B6J,EAAa,EACbC,EAAM,gBACFA,EAAMH,GACVE,GAAc,EACdC,EAAM,gBAAkBnH,KAAKoH,IAAI,EAAGF,GAExCX,EAAwB,WAAIW,EAC5BX,EAA2B,cAAIS,EAC/BT,EAA2B,cAAIU,EAC/BV,EAA0B,aAAIW,EAC9BX,EAAyB,YAAIQ,CACjC,CASA,OARAZ,EAAYvB,EAAWyC,YAAYtM,EAAkBwL,IAC3Ce,GAAK,CAAC,EAChBnB,EAAUoB,iBAAmB,WACzB,IAAIC,EAAWvO,KAAKwN,WAAWgB,UAC/B,OAAOC,WAAW,UAAY,QACvBzO,KAAKqO,GAAGE,IAAclH,WAAWqH,WAAWC,SAASJ,IACxDlH,WAAWqH,WAAWC,SAASJ,GAAUF,GACjD,GACO,CACT,IAIJ,IAAIO,EAAY,KAwBhB,GAvBI,mBAAoB7F,GAAeA,EAAYE,gBAC/C,WAAYF,EAAYE,gBAAkB,QAASF,EAAYE,kBAC/D2F,EAAY7F,EAAYE,gBACd/G,OAAS2M,UAAUD,EAAU1M,QACvC4J,EAAa8C,EAAU5E,IACvBuC,EAAiB,CACfrK,OAAQ0M,EAAU1M,OACjBmH,OAAQuF,EAAgB,OAAIA,EAAUvF,OAAS,GAC/CyF,IAAKF,EAAa,IAAIA,EAAUE,IAAM,YACtCpC,OAAQkC,EAAgB,OAAIA,EAAUlC,OAAS,YAC/CqC,YAAaH,EAAqB,YAAIA,EAAUG,YAAc,OAC9DtC,WAAW,mCAKiB,oBAAnBuC,gBACTlE,KAAiBkE,gBACjBA,eAAgBlE,KAEnByB,EAAuB,OAAIzB,EAAc,IAAIkE,eAAgBlE,IAGpC,QAAzB/B,EAAYT,WAAoC,MAAb4E,EAEnCjL,EAAWyJ,KAAMwB,QAEhB,GAAwB,SAApBnE,EAAYvG,MAAgC,MAAb0K,EAAmB,CAGvD,GAFAA,EAAUtM,QAAQ+J,SAAW5B,EAAY6B,SACzCsC,EAAUtM,QAAQgK,SAAmC,MAAxB7B,EAAY4B,UAAoB5B,EAAY4B,SAAW,EAAK,EAAI5B,EAAY4B,SACvE,GAA7BlD,EAAMoD,aAAazG,OAAc,CAClC,IAAI/B,EAASoI,EAAchD,EAAM,KAAK,MACtCyF,EAAUtM,QAAQ+J,SAAWtI,EAAOuI,SACpCsC,EAAUtM,QAAQgK,SAAWvI,EAAOsI,QACxC,CACAuC,EAAU+B,UAAkC,QAArBlG,EAAYmG,QACnChC,EAAUiC,YAAa,EACvBjC,EAAUkC,iBAAmB,KAC7BlC,EAAUmC,sBAAwB,IAClCnC,EAAUhC,MAAQF,EAAcvD,GAChCvF,EAAOwJ,KAAMwB,EACjB,MACK,GAA6B,QAAzBnE,EAAYT,UAEjBrG,EAAWyJ,KAAK,IAAIrE,WAAWK,MAAMtG,IAAIyD,EAAUiH,EAC9CS,EACA,CAACmB,aAAY,EACZ4B,OAA8B,QAAtBvG,EAAYoE,OAAoB,EAAI,EAC5CoC,OAAO,EACPzH,WAAsC,QAA1BiB,EAAYjB,WACxBG,MAAM,EACN4E,YAAYpF,EAAMoF,oBAGvB,GAAwB,SAApB9D,EAAYvG,KAAiB,CAClC,IAAIgN,EAAW,IAAInI,WAAWK,MAAMtG,IAAIyD,EAAUiH,EAC7CS,EACA,CAACmB,aAAY,EACZ/C,SAAS5B,EAAY6B,SACrBA,SAAkC,MAAxB7B,EAAY4B,UAAoB5B,EAAY4B,SAAW,EAAK,EAAI5B,EAAY4B,SACtFsE,UAAgC,QAArBlG,EAAYmG,QACvBC,YAAW,EACXG,OAA8B,QAAtBvG,EAAYoE,OAAoB,EAAI,EAC5CoC,OAAO,EACPH,iBAA4C,QAA1BrG,EAAYjB,WAAsB,SAAS,KAC7DuH,sBAAsB,IACtBvH,WAAsC,QAA1BiB,EAAYjB,YAA+C,QAAtBiB,EAAYoE,SAAqBrL,EAClFmG,MAAM,EACNiD,MAAMF,EAAcvD,GACpBoF,YAAYpF,EAAMoF,cAEU,GAA7BpF,EAAMoD,aAAazG,SAChB/B,EAASoI,EAAchD,EAAM,KAAK,MACtC+H,EAAS7E,SAAWtI,EAAOuI,SAC3B4E,EAAS5O,QAAQ+J,SAAWtI,EAAOuI,SACnC4E,EAAS5E,SAAWvI,EAAOsI,SAC3B6E,EAAS5O,QAAQgK,SAAWvI,EAAOsI,UAMnCiE,GAAa,WAAYrC,GAAkB,WAAYiD,GACpDA,EAASpP,OAAe,QAAKmM,EAAeG,SAC/C8C,EAASpP,OAAe,OAAImM,EAAeG,QAE/CxK,EAAOwJ,KAAM8D,EACjB,CAEwB,SAApBzG,EAAYvG,MAAgD,GAA7BiF,EAAMoD,aAAazG,QAAwC,SAAzB2E,EAAYT,WAC7E8C,EAAa3D,EAAM4E,GACM,QAAzBtD,EAAYT,WACZ+C,EAAMC,SAASI,KAAKW,GAGxBtD,EAAY0G,KAAOhI,EAAMgI,IAnMf,OAJR9N,EAAOf,QAAQ8O,aAAc,CAR/B,CAiNF,CACF,CAaA,SAASC,EAAYC,GACnB,IAAIC,EAAaD,EAAMjO,OACvB,GAAuB,SAAnBkO,EAAWrN,MAA2C,QAAxBqN,EAAWvH,UAC3C,OAAO,EACJ,GAAuB,SAAnBuH,EAAWrN,KAClB,OAAO,EAET,KAAM,aAAcoN,GAClB,OAAO,EAIT,IAHA,IAAItE,EAAWsE,EAAMtE,SACjBwE,GAAS,EACTC,EAAY,GACP5L,EAAE,EAAGqD,EAAI8D,EAASlH,OAAQD,EAAEqD,EAAKrD,IAAK,CAC7C,IACI6L,EAAUL,EADFrE,EAASnH,IAEhB6L,GACHD,EAAUrE,KAAKvH,GACjB2L,EAAUA,GAAUE,CACtB,CAEA,IADAD,EAAUE,UACD9L,EAAE,EAAGqD,EAAIuI,EAAU3L,OAAQD,EAAEqD,EAAKrD,IACzCmH,EAAS4E,OAAOH,EAAU5L,GAAG,GAE/B,OAAO2L,CACT,CAYA,SAASK,EAAgBP,EAAOQ,GAC9B,IAmD8BC,EAnD1BC,EAAO,GACPT,EAAaD,EAAMjO,OACnB4O,EAAe,KAyBnB,GAvBIH,IACFG,EAAeH,EAAQzO,UAGrB,iBAAkBkO,IACW,QAA3BA,EAAWW,cAAqD,WAA3BX,EAAWW,cAAwD,IAA3BX,EAAWW,eAE5FX,EAAWY,gBAAkB,SAG/BH,GAAQ,WAAWT,EAAWrN,KAAK,IAAIoN,EAAMhI,KAAK,IAClD0I,GAAQ,eAAeT,EAAWrN,KAC9B4N,IACFE,GAAQ,mBAAmBF,EAAQxI,MAEhC,aAAcgI,GAAoC,GAA1BA,EAAgB,SAAExL,SAC7CkM,GAAQ,oBAMmBnN,IACFI,kCAAoC,MAC7D,IAAImN,EAAeb,EAAWc,yBAE1BD,EAAe,kBACfb,EAAWe,eAA6C,QAA5Bf,EAAWe,gBACzCF,EAAe,YAKI,SAAnBb,EAAWrN,MAAmC,qBAAhBkO,IAChCJ,GAAQ,eAGL,oBAAqBT,GAA4C,SAA9BA,EAAWY,iBAC9CF,GAAgB,oBAAqBA,GAAgD,SAAhCA,EAAaE,mBACrEH,GAAQ,eAELC,GAAgB,sBAAuBA,GAAkD,QAAlCA,EAAaM,oBACvEP,GAAQ,uBAGVA,GAAQ,KAMRA,GAAQ,0CAA0CT,EAAWrN,KAAK,YAAYoN,EAAMhI,KAAK,YAAYkJ,QAAQ,wBAAwB,cACrIR,GAAQ,+BAAkG,KAL5ED,EAK6BpL,EAAE,QAAQ4K,EAAWkB,SAAS,UAAUvP,QAJrF4C,OAI4F,GAJ9EiM,EAAIW,OAAO,EAAEC,IAAK,WAAaZ,GAImD,MAAKR,EAAW7C,MAAM,UACpIsD,GAAQ,QAERA,GAAQ,uBACe,SAAnBT,EAAWrN,OACb8N,GAAQ,uCAEVA,GAAQ,QAER,IAAIY,EAAa,GAoBjB,GAnBIrB,EAAWsB,OACbD,EAAarB,EAAWsB,MAGxBb,GADgB,IAAdY,EACM,mDAAmDJ,QAAQ,oBAAoB,YAAYI,EAAW,WAGtG,YAGNrB,EAAW1C,QAA+B,QAArB0C,EAAW1C,QAAuC,SAAnB0C,EAAWrN,MAAoB,gBAAiBb,EAAOf,QAC7G0P,GAAQ,iEAAiEQ,QAAQ,2BAA2B,YAAYlB,EAAMhI,KAAK,WAGnI0I,GAAQ,YAGVA,GAAQ,QAEe,SAAnBT,EAAWrN,MACK,YAAhBkO,GACA,oBAAqBb,GAA4C,QAA9BA,EAAWY,gBAA4B,CAC5E,IAAIzG,EAAMrB,EAAyBiH,EAAMhI,MAAM,GACnC,MAAPoC,GAAsB,IAAPA,IAClBsG,GAAQ,kBAAkBV,EAAMhI,KAAK,2BAA2BgI,EAAMhI,KAAK,oBAC3E0I,GAAQ,+CACRA,GAAQ,kBAAkBtG,EAAI,UAAU7J,QAAQiR,SAAxC,0CACRd,GAAQ,cACRA,GAAQ,QAEZ,CAEA,OAAOA,CACT,CAYA,SAASe,EAAgBzB,EAAM0B,GAC7B,IAAIhB,EAAO,GACG,GAAVgB,IACFhB,GAAQ,wCACRA,GAAQ,wBAIV,IADA,IAAIhF,EAAWsE,EAAMtE,SACZnH,EAAE,EAAGqD,EAAI8D,EAASlH,OAAQD,EAAEqD,EAAKrD,IAAK,CAC7C,IAAIoN,EAAQjG,EAASnH,GAEnBmM,GADY,GAAVgB,EACMnB,EAAgBoB,GAEhBpB,EAAgBoB,EAAM3B,GAE3B,aAAc2B,GAAoC,GAA1BA,EAAgB,SAAEnN,SAC7CkM,GAAQe,EAAgBE,EAAOD,EAAO,GAC1C,CAMA,OAJc,GAAVA,IACFhB,GAAQ,WACRA,GAAQ,UAEHA,CACT,CAwMA,SAASkB,EAAwB7N,GAC/B,IAAI8N,EAAS9P,EAAO+P,cAAc/N,GAE9BgO,EAAW,CAAC,EAChB,IAAM,IAAIC,KAAOH,EAAOE,SACpBA,EAASC,GAAOH,EAAOE,SAASC,GAGpC,GAAI,oBAAqBH,EAAQ,CAC7B,IAAII,EAAc5M,EAAE,iBAAiBvB,EAAUC,GAAO,IAAI8N,EAAOK,iBAAiBC,MAClF,GAAoB,MAAfF,EACH,IAAK,IAAID,KAAOD,GACVK,EAAOL,EAASC,IACXK,WAAWR,EAAOK,kBAAoBD,UACtCF,EAASC,QAGpBD,EAAW,CAAC,CAClB,CAEA,GAAK,gBAAiBF,GAAuC,GAA7BA,EAAOS,YAAY9N,OAE/C,IADA,IAAI8N,EAAcT,EAAOS,YACf/N,EAAE,EAAGqD,EAAK0K,EAAY9N,OAAQD,EAAGqD,EAAKrD,IAAK,CACjD,IAAIgO,EAAaD,EAAY/N,GACzBiO,EAAQD,EAAWE,UACvB,GAAKD,KAASzQ,EAAO+P,cAAgB,CACjC,IAAIY,EAAU3Q,EAAO+P,cAAcU,GAC/BG,EAAOtN,EAAE,iBAAiBvB,EAAU0O,IAAQL,MAChD,GAAa,MAARQ,EAAe,SACpB,IAAIC,EAAQF,EAAQX,SAASY,GAC7B,IAAK,IAAIX,KAAOD,GACVK,EAAOL,EAASC,IACVK,WAAWE,EAAWM,kBAAoBD,EAAMP,WAAWE,EAAWO,uBACvEf,EAASC,EAExB,CACJ,CAIJ,IAAIhR,EAAU,6BADMe,EAAOO,OAAOyB,GAAOqJ,MACc,cACvD,IAAK,IAAI4E,KAAOD,EAAU,CACxB,IAAIK,EACJpR,GAAW,mBADPoR,EAAOL,EAASC,IACctH,GAAG,KAAK0H,EAAKC,WAAWR,EAAOkB,WAAW,WAC9E,CAEA1N,EAAE,iBAAiBvB,EAAUC,IAAQ2M,KAAK1P,EAC5C,CAEE,SAASgS,EAAeC,GACtB,IAAIpL,EAAQzF,EAAI8Q,gBAAgBD,GACZ,GAAhBpL,EAAMrD,QAGVqD,EAAM,GAAGsL,iBACX,CAKF,SAASC,EAAoBrP,GAE3BiP,EAAe,eAGf,IAAInB,EAAS9P,EAAO+P,cAAc/N,GAC9BkB,EAAYnB,EAAUC,GACtBsP,EAAO,IAAI5L,WAAWqH,WAAW+C,EAAO3C,KACxCiD,EAAM9M,EAAE,iBAAiBJ,GAAWkN,MACxC,GAAW,MAAPA,EAGFrQ,OAAOwR,OAAOC,aAAa,8BACzB,CACE,YAAexP,QAGd,CAEL,IAAIqO,EAAOP,EAAOE,SAASI,GACvBrF,EAAS,IAAIrF,WAAWuE,OAAOwH,QAAQ,CACvCC,iBAAiB,IAIrB,GAAqB,OAFrBrB,EAAOtF,EAAO4G,KAAKtB,GAAM,IAEhBuB,SAAiB,CAGxB,GAFAvB,EAAKuB,SAASC,UAAUP,EAAMjR,EAAIyR,iBAER,QAAtBhC,EAAOiC,YAAuB,CAC9B,IAAIjM,EAAQzF,EAAI8Q,gBAAgB,eAAe,GAC/C,QAAqB,IAAVrL,EACT,OACF,IAAIkM,EAAoBC,GAAsBjQ,EAAO,KAAM,KAAM,MACjEgQ,EAA2B,QAAgB,aAAI,CAAC,WAAWlC,EAAOkB,WAAWkB,KAAK,KAClFF,EAA2B,QAAa,UAAI5B,EAE5C9M,EAAE6O,KAAMH,EAAuB,IAAGA,EAA2B,SAAG,SAASI,GACjEA,EAAKpC,WACToC,EAAOC,KAAKC,MAAMF,IACQ,GAAxBA,EAAKpC,SAASvN,SAChB4N,EAAOtF,EAAO4G,KAAKS,EAAKpC,SAAS,IAAI,IAChC4B,SAASC,UAAUP,EAAMjR,EAAIyR,iBAEpChM,EAAMyM,YAAY,CAAClC,GACrB,IAAGmC,MAAK,WACN1M,EAAMyM,YAAY,CAAClC,GACrB,GACJ,CAEAhQ,EAAIoS,aAAapC,EAAKuB,SAASc,YAEjC,CAEA,IAAIzC,EAAMG,EAAI9E,MAAM,KAAK,GAGzBvL,OAAOwR,OAAOC,aAAa,6BACzB,CACE,YAAexP,EACf,UAAaiO,GAGnB,CACF,CAKA,SAAS0C,EAAiB3Q,GACxB,IAAI8N,EAAS9P,EAAO+P,cAAc/N,GAG9B4Q,EAAS,CAAC,WAAW9C,EAAOkB,WAKhC,GAHI,oBAAqBlB,GACvB8C,EAAO7I,KAAM+F,EAAOK,iBAEjB,gBAAiBL,EAEpB,IADA,IAAI+C,EAAc/C,EAAO+C,YACfrQ,EAAE,EAAGqD,EAAIgN,EAAYpQ,OAAQD,EAAEqD,EAAKrD,IAAK,CAC/C,IAAIsQ,EAAaD,EAAYrQ,GAC7BoQ,EAAO7I,KAAM+I,EAAWhC,gBAC5B,CAEF,GAAK,gBAAiBhB,EACpB,KAAIS,EAAcT,EAAOS,YACzB,IAAU/N,EAAE,EAAGqD,EAAI0K,EAAY9N,OAAQD,EAAEqD,EAAKrD,IAAK,CAC/C,IAAIgO,EAAaD,EAAY/N,GAC7BoQ,EAAO7I,KAAMyG,EAAWM,gBAC5B,CAJoC,CAQtC,IAAIkB,EAAoBC,GAAsBjQ,EAAO,KAAM,KAAM,UACjEgQ,EAA2B,QAAgB,aAAIY,EAAOV,KAAK,KAE3D,IAAIhP,EAAYnB,EAAUC,GAG1BsB,EAAE6O,KAAMH,EAAuB,IAAGA,EAA2B,SAAG,SAASI,GACvE,IAAIW,EAAU/S,EAAOO,OAAOyB,GAC5B8N,EAAiB,SAAI,CAAC,EAChBsC,EAAKpC,WACToC,EAAOC,KAAKC,MAAMF,IACpB,IAAIpC,EAAWoC,EAAKpC,SAUpB,GATkB,aAAdF,EAAO3C,KAAyC,GAAnB6C,EAASvN,QAEtCuQ,GAAoBlD,EAAO3C,KAAK,WAEvB,sBAAuBnN,EAAOf,SAA+C,QAApCe,EAAOf,QAAQuL,oBAC3DsF,EAAO3C,IAAM,YACnB,IAGA,oBAAqB2C,EAAQ,CAE/BE,EAASiD,MAAK,SAASC,EAAGC,GACtB,IAAIC,EAAYF,EAAE5C,WAAWR,EAAOK,iBAChCkD,EAAYF,EAAE7C,WAAWR,EAAOK,iBACpC,OAAImD,MAAMF,GACFE,MAAMD,GACCD,EAAUG,cAAcF,GAExB,EAGPC,MAAMD,IACE,EAEDvG,WAAWsG,GAAatG,WAAWuG,EAGtD,IACA,IAAIG,EAAoB,GACnB,qBAAsB1D,GAAmC,IAAzBA,EAAO2D,iBAC1CD,GAAqB1D,EAAO2D,iBAAiB,IAE7CD,GAAqB1D,EAAOK,gBAC9BqD,GAAoB,KAAMT,EAAQ1H,MAAQ,IAG1C,IAFA,IAAIqI,EAAW,+BACXC,EAAS,KACJnR,EAAE,EAAGqD,EAAImK,EAASvN,OAAQD,EAAEqD,EAAKrD,IAEnCmR,IADDtD,EAAOL,EAASxN,IACA8N,WAAWR,EAAOK,mBAEpCuD,GAAY,mBADZC,EAAStD,EAAKC,WAAWR,EAAOK,kBACK,KAAKwD,EAAO,aAMrDrQ,EAAE,iBAAiBJ,GAAWO,SAASmQ,OAAO,sDAAsD1Q,EAAU,IAAI4M,EAAOK,gBAAgB,KAAKuD,EAAS,wBAEvJpQ,EAAE,iBAAiBJ,EAAU,IAAI4M,EAAOK,iBAAiB0D,QAAO,WAC9D,IAAI3D,EAAc5M,EAAEjF,MAAMsL,SAAS,aAAayG,MAChDP,EAAyB7N,GACN,MAAfkO,GACF5M,EAAE,iBAAiBJ,EAAU,IAAI4M,EAAOK,gBAAgB,mBAAmBC,IAAI,IACjF9M,EAAE,iBAAiBJ,EAAU,mBAAmBkN,IAAI,IACpD9M,EAAE,iBAAiBJ,GAAWkN,IAAI,MAClCiB,EAAoBrP,EACtB,IAEAsB,EAAE,iBAAiBJ,EAAU,IAAI4M,EAAOK,iBAAiB2D,SAAS,CAChEC,SAAU,CAAEC,GAAK,YAAaC,GAAI,gBAClC,SAAY,SAASC,EAAKC,GACxB,GAAKA,EAAGC,KAAO,CACb,IAAIC,EAAO/Q,EAAEjF,MACTiW,EAAShR,EAAE6Q,EAAGC,MAClBtU,OAAOyU,YAAW,WAChBF,EAAKjE,IAAIkE,EAAOlE,OAAOyD,QACzB,GAAG,EACL,CACF,IAIFvQ,EAAE,iBAAiBJ,EAAU,IAAI4M,EAAOK,gBAAgB,mBAAmBrM,KAAK,cAAe0P,GAAmBpD,IAAI,IACtH9M,EAAE,iBAAiBJ,EAAU,IAAI4M,EAAOK,gBAAgB,mBAAmBqE,aAAa,SACxF3N,GACF,CAGAmJ,EAASiD,MAAK,SAASC,EAAGC,GACpB,IAAIC,EAAYF,EAAE5C,WAAWR,EAAOkB,WAChCqC,EAAYF,EAAE7C,WAAWR,EAAOkB,WACpC,OAAIsC,MAAMF,GACFE,MAAMD,GACCD,EAAUG,cAAcF,GAExB,EAGPC,MAAMD,IACE,EAEDvG,WAAWsG,GAAatG,WAAWuG,EAGxD,IACA,IAAIoB,EAAc,GACd,oBAAqB3E,GAChB,eAAgBA,GAA6B,IAAnBA,EAAO4E,WAClCD,GAAe3E,EAAO4E,WAAW,IAEjCD,GAAe3E,EAAOkB,UAAU,IACpCyD,GAAe,IAAI1B,EAAQ1H,MAAM,KAEjCoJ,EAAc1B,EAAQ1H,MAE1B,IAAIpM,EAAU,+BACd,IAASuD,EAAE,EAAGqD,EAAImK,EAASvN,OAAQD,EAAEqD,EAAKrD,IAAK,CAC7C,IAAI6N,EAAOL,EAASxN,GACpBsN,EAAOE,SAASK,EAAK1H,GAAGgM,YAActE,EAC/B,oBAAqBP,IAC1B7Q,GAAW,kBAAkBoR,EAAK1H,GAAG,KAAK0H,EAAKC,WAAWR,EAAOkB,WAAW,YAChF,CAEA1N,EAAE,iBAAiBJ,GAAWyL,KAAK1P,GAAS4U,QAAO,WAEjD,GAAW,MADDvQ,EAAEjF,MAAMsL,SAAS,aAAayG,MACvB,CAGf,GAFA9M,EAAE,iBAAiBJ,EAAU,mBAAmBkN,IAAI,IAE/C,gBAAiBN,GAAuC,GAA7BA,EAAO+C,YAAYpQ,OAE/C,IADA,IACSD,EAAE,EAAGqD,GADVgN,EAAc/C,EAAO+C,aACKpQ,OAAQD,EAAEqD,EAAKrD,IAGzC,IADIiO,EADaoC,EAAYrQ,GACNkO,aACT1Q,EAAO+P,cAAgB,CAEjC,IAAI6E,EAAStR,EAAE,iBAAiBvB,EAAU0O,IAAQL,MAGlD,OAFAP,EAAyBY,QACzBnN,EAAE,iBAAiBvB,EAAU0O,IAAQL,IAAKwE,EAE9C,CAIR,GAAK,gBAAiB9E,GAAuC,GAA7BA,EAAOS,YAAY9N,SAC3CgO,EAAQX,EAAOS,YAAY,GAAGG,aACpB1Q,EAAO+P,cAEnB,YADAsB,EAAqBZ,GAK3BY,EAAqBrP,EACvB,MAIE,GAFAqP,EAAqBrP,GAEhB,gBAAiB8N,GAAuC,GAA7BA,EAAO+C,YAAYpQ,OAC/C,KAAIoQ,EACJ,IAASrQ,EAAE,EAAGqD,GADVgN,EAAc/C,EAAO+C,aACKpQ,OAAQD,EAAEqD,EAAKrD,IAAK,CAC9C,IACIiO,KADaoC,EAAYrQ,GACNkO,aACT1Q,EAAO+P,gBAEjBF,EAAyBY,GACzBnN,EAAE,iBAAiBvB,EAAU0O,IAAQL,IAAI,MACzC9M,EAAE,iBAAiBvB,EAAU0O,GAAO,mBAAmBL,IAAI,IAEnE,CAVoC,CAa1C9M,EAAEjF,MAAMwW,MAEV,IACAvR,EAAE,iBAAiBJ,GAAW4Q,SAAS,CACzC,UAAc,cAAehE,EAAUA,EAAOgF,UAAY,EACtD,SAAY,CAAEd,GAAK,YAAaC,GAAI,gBACpC,SAAY,SAASC,EAAKC,GACxB,GAAKA,EAAGC,KAAO,CACb,IAAIC,EAAO/Q,EAAEjF,MACTiW,EAAShR,EAAE6Q,EAAGC,MAClBtU,OAAOyU,YAAW,WAChBF,EAAKjE,IAAIkE,EAAOlE,OAAOyD,QACzB,GAAG,EACL,CACF,IAEFvQ,EAAE,iBAAiBJ,EAAU,mBAAmBY,KAAK,cAAe2Q,GAAarE,IAAI,IACrF9M,EAAE,iBAAiBJ,EAAU,qBAAqBY,KAAK,QAAS2Q,GAChEnR,EAAE,iBAAiBJ,EAAU,mBAAmBsR,aAAa,SACvD,cAAe1E,GAAWA,EAAOgF,UAAY,GACjDxR,EAAE,iBAAiBJ,GAAWO,SAASD,SAAS,aAC/CH,OAEDC,EAAE,2BAA2BS,OAC7BT,EAAE,wBAAwBM,OAE9B,GAAE,OACJ,CAqDA,SAASmR,IAEPzR,EAAE,oBAAoBqL,KAAKe,EAAgB9O,EAAK,IAChD0C,EAAE,wBAAwB0R,UAAU,CAClCC,aAAc9F,QAAQ,sBACtB+F,eAAgB/F,QAAQ,wBACxBgG,WAAY,WACV,IAAId,EAAO/Q,EAAEjF,MAEb,GADAgW,EAAK7Q,SAAS,WACgC,GAA1C6Q,EAAKe,KAAK,sBAAsB3S,OAAa,CAC/C,IACI4F,EAAMrB,EADCqN,EAAKvQ,KAAK,MAAMhB,QAAQ,UAAU,KACJ,GACzC,GAAY,MAAPuF,GAAsB,IAAPA,EAAY,CAC5B,IAAIgN,EAAOhB,EAAKe,KAAK,0BACrBC,EAAKvR,KAAK,WAAYuE,GACtBgN,EAAKvR,KAAK,MAAOuR,EAAKvR,KAAK,YAC/B,CACF,CACF,EACAwR,WAAY,WACChS,EAAEjF,MACR2F,YAAY,UACnB,IAEFV,EAAE,8BAA8BiS,GAAG,YAAa,cAAc,SAASC,GAErE,GAAmB,IAAhBA,EAAMC,MAAY,CACnB,IACIC,GADcpS,EAAEjF,MAAMsX,QAAQ,YAAYpS,SAAS,YAEvDD,EAAE,iCAAiCU,YAAY,YAC/CV,EAAEjF,MAAMsX,QAAQ,YAAYC,YAAY,WAAYF,GACpDpS,EAAE,4BAA4BsS,YAAY,SAAUF,GAGpD,IAAI/M,EAAKrF,EAAEjF,MAAMsX,QAAQ,YAAY7R,KAAK,MACtC+R,EAAWlN,EAAG2C,MAAM,KAAK,GACzBwK,EAAWnN,EAAG2C,MAAM,KAAK,GAC7BvL,OAAOwR,OAAOC,aAAa,6BACzB,CAAE,KAAQsE,EAAU,KAAQD,EAAU,SAAYH,GAEtD,CACF,IAGF,IAAIzW,EAAU,CACZ8W,YAAc,aAGhB,SAASC,EAAWtL,GAClB,OAAOpH,EAAEoH,GAAMuL,SAAS,MAAQhX,EAAQ8W,YAAcrL,EAAK,GAAG/B,GAChE,CAEA,SAASuN,EAAcxL,GACrB,IAAIyL,EAAc,GACdxM,EAAW,GACXe,GAAQA,EAAK,KACff,EAAWqM,EAAWtL,IACxB,IAAK,IAAIlI,EAAE,EAAGqD,EAAI8D,EAASlH,OAAQD,EAAEqD,EAAKrD,IACxC2T,EAAYpM,KAAKJ,EAASnH,IAC1B2T,EAAcA,EAAYC,OAAOF,EAAc,CAACvM,EAASnH,MAE3D,OAAO2T,CACT,CAEA,SAASE,EAAS3L,GAChB,GAAmB,GAAfA,EAAKjI,OACP,OAAO,KAIT,IAFA,IAAI6T,EAAa5L,EAAK,GAAG6L,UAAUjL,MAAM,KAEjCkL,EAAI,EAAGA,EAAIF,EAAW7T,OAAQ+T,IACpC,GAAGF,EAAWE,GAAKC,MAAMxX,EAAQ8W,aAC/B,OAAOzS,EAAEoH,GAAMuL,SAAS,IAAMK,EAAWE,GAAKE,UAAUzX,EAAQ8W,YAAYtT,SAIhF,OAAO,IACT,CAEA,SAASkU,EAAYjM,GAEnB,IADA,IAAIkM,EAAY,GACVlM,EAAO2L,EAAS3L,IACpBkM,EAAUA,EAAUnU,QAAUiI,EAAK,GAErC,OAAOkM,CACT,CAGEtT,EAAE,6BACDI,OAAM,WACL,IAAI2Q,EAAO/Q,EAAEjF,MACb,GAAIgW,EAAK9Q,SAAS,YAChB,OAAO,EAGT,IAAIsT,EAASxC,EAAKsB,QAAQ,MAAMmB,QAE5BC,EAAWV,EAAUQ,GAErBG,EAAa,GACjB,GAAKD,GAA+B,GAAnBA,EAAStU,OACxB,IAAK,IAAIwU,EAAE,EAAGC,EAAiBlB,EAAWe,GAAWE,EAAEC,EAAiBzU,OAAQwU,KACxEE,EAAY7T,EAAE4T,EAAiBD,KACrBnT,KAAK,OAAS+S,EAAO/S,KAAK,OACtCkT,EAAWjN,KAAMoN,GAGzB,IAAIP,EAAY,GAChB,GAAIC,EAAOtT,SAAS,aAmBhB,GAjBK8Q,EAAK9Q,SAAS,YASf8Q,EAAKrQ,YAAY,WAAWA,YAAY,WACxC6S,EAAOzB,KAAK,iCAAiClO,MAAK,SAAS1E,EAAE2Q,GAC3D,IAAIlN,EAAO3C,EAAE6P,GAAG/C,MACZtK,EAAQzF,EAAI8Q,gBAAgBlL,GAAM,QACjB,IAAVH,GACTA,EAAMsR,eAAc,EACxB,MAdA/C,EAAKrQ,YAAY,WAAWR,SAAS,WACrCqT,EAAOzB,KAAK,iCAAiClO,MAAK,SAAS1E,EAAE2Q,GAC3D,IAAIlN,EAAO3C,EAAE6P,GAAG/C,MACZtK,EAAQzF,EAAI8Q,gBAAgBlL,GAAM,QACjB,IAAVH,GACTA,EAAMsR,eAAc,EACxB,KAUAP,EAAOtT,SAAS,sBAAuB,CACvC,GAAI8Q,EAAK9Q,SAAS,WAAa,CAC3B,IAAI,IAAIgH,EAAE,EAAG8M,EAAKL,EAAWvU,OAAQ8H,EAAE8M,EAAM9M,IAAK,CAC9C,IAAI4M,EACAG,GADAH,EAAY7T,EAAE0T,EAAWzM,KACD6K,KAAK,mBACjC,GAAIkC,EAAY/T,SAAS,aACvB+T,EAAYtT,YAAY,WAAWA,YAAY,WACf,SAA5BsT,EAAYxT,KAAK,SAAoB,CACrC,IAAImC,EAAO3C,EAAEgU,GAAalH,MACtBtK,EAAQzF,EAAI8Q,gBAAgBlL,GAAM,QACjB,IAAVH,GACTA,EAAMsR,eAAc,EAC1B,CAEN,CACKL,GAA+B,GAAnBA,EAAStU,QACLsU,EAAS3B,KAAK,mBACpBpR,YAAY,WAAWR,SAAS,UAEnD,MAAYuT,GAA+B,GAAnBA,EAAStU,QACZsU,EAAS3B,KAAK,mBACpBpR,YAAY,WAAWA,YAAY,WAElD4S,EAAYD,EAAYI,EAC5B,MACEH,EAAYD,EAAYE,OAEvB,CAEH,IAAIV,EAAcD,EAAcW,GAC5BU,EAA0B,GAC9BjU,EAAE4D,KAAKiP,GAAY,SAAS3T,EAAEgV,GAE5B,IAAIC,GADJD,EAAKlU,EAAEkU,IACOpC,KAAK,mBACnB,GAAKf,EAAK9Q,SAAS,WAkBfkU,EAAKzT,YAAY,WAAWA,YAAY,WACpCwT,EAAGjU,SAAS,cAAqC,SAArBkU,EAAK3T,KAAK,UAClCmC,EAAO3C,EAAEmU,GAAMrH,WAEE,KADjBtK,EAAQzF,EAAI8Q,gBAAgBlL,GAAM,KAEpCH,EAAMsR,eAAc,SArB1B,GADAK,EAAKzT,YAAY,WAAWR,SAAS,WACjCgU,EAAGjU,SAAS,cAAqC,SAArBkU,EAAK3T,KAAK,QAAoB,CAC1D,GAAI0T,EAAGjU,SAAS,sBAAuB,CACnC,IACImU,EADMrB,EAASmB,GACL1T,KAAK,MACnB,IAA6C,GAAzCyT,EAAwBnM,QAAQsM,GAEhC,YADAD,EAAKzT,YAAY,WAAWA,YAAY,WAG5CuT,EAAwBxN,KAAK2N,EACjC,CACA,IACI5R,EADAG,EAAO3C,EAAEmU,GAAMrH,WAEE,KADjBtK,EAAQzF,EAAI8Q,gBAAgBlL,GAAM,KAEpCH,EAAMsR,eAAc,EAC1B,CAUN,IACK/C,EAAK9Q,SAAS,WAGf8Q,EAAKrQ,YAAY,WAAWA,YAAY,WAFxCqQ,EAAKrQ,YAAY,WAAWR,SAAS,WAGzCoT,EAAYD,EAAYE,EAC5B,CAEAvT,EAAE4D,KAAK0P,GAAU,SAASpU,EAAEgV,GAC1BA,EAAKlU,EAAEkU,GACP,IAAIG,EAAQ,EACRC,EAAU,EACVC,EAAW,EACXC,EAAS9B,EAAWwB,GACxBlU,EAAE4D,KAAK4Q,GAAO,SAASjO,EAAEkO,GACvBzU,EAAEyU,GAAK3C,KAAK,mBAAmBlO,MAAK,SAAS1E,EAAE2Q,IAC7CA,EAAI7P,EAAE6P,IACC5P,SAAS,WACdqU,IACQzE,EAAE5P,SAAS,YAAa4P,EAAE5P,SAAS,YAC3CsU,IACFF,GACF,GACF,IACA,IAAIK,EAASR,EAAGpC,KAAK,mBACjBuC,GAAOC,EACTI,EAAOhU,YAAY,WAAWR,SAAS,WACvB,GAAToU,GAAwB,GAAVC,EACrBG,EAAOhU,YAAY,WAAWA,YAAY,WAE1CgU,EAAOxU,SAAS,WAAWA,SAAS,UACxC,GACF,IAGAF,EAAE,yBACDI,OAAM,WACL,IAAI2Q,EAAO/Q,EAAEjF,MACb,GAAIgW,EAAK9Q,SAAS,YAChB,OAAO,EACT,IAAI0U,EAAa5D,EAAKjE,MAEL,gBACH8H,KAAKD,KAIjBA,EAHgBvS,WAAWwC,KAAKE,UAAU5J,QAAQ2Z,MAC/CzS,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEvB,UAAUwZ,GAGnCnY,OAAOsY,KAAKH,EACd,IAGA3U,EAAE,gCACDI,OAAM,WACL,IAAI2Q,EAAO/Q,EAAEjF,MACb,GAAIgW,EAAK9Q,SAAS,YAChB,OAAO,EACT,IAII0U,EAJuBvS,WAAWwC,KAAKE,UACxC5J,QAAQ6Z,YACR3S,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEN,UAAY4V,EAAKjE,MAErDkI,QAAQnJ,QAAQ,2BAA6B,OAC/CrP,OAAOsY,KAAKH,EAChB,IAEA,IAAIpM,EAAaxL,EAAIwL,WAGjBlH,EAAc,IACdC,EAAe,IACd,gBAAiB5E,EAAOf,SAAYe,EAAOf,QAAQ0F,cACpDA,EAAcE,OAAO7E,EAAOf,QAAQ0F,cACnC,iBAAkB3E,EAAOf,SAAYe,EAAOf,QAAQ2F,eACrDA,EAAeC,OAAO7E,EAAOf,QAAQ2F,eACzC,IAAIE,GAAmB,EACnByT,EAAUlY,EAAImY,KACdvT,EAAwB,IAAIS,WAAWC,KAAKhB,EAAaC,GAC7D,GAAI2T,EAAQhU,EAAII,GAAe4T,EAAQrU,EAAIU,EAAc,CACrDE,GAAmB,EACnB,IAAIK,EAAYC,KAAKC,IAAIV,EAAaC,GAClCU,EAAYF,KAAKG,IAAIZ,EAAaC,GAClCY,EAASJ,KAAKC,IAAIkT,EAAQhU,EAAGgU,EAAQrU,GACrCuB,EAASL,KAAKG,IAAIgT,EAAQhU,EAAGgU,EAAQrU,GAEvCe,EADEO,EAAO,EAAIC,EACW,IAAIC,WAAWC,KAAKP,KAAKQ,MAAMJ,EAAO,GAAIJ,KAAKQ,MAAMJ,EAAO,IAC7EL,EAAU,EAAIM,EACG,IAAIC,WAAWC,KAAKP,KAAKQ,MAAMT,EAAU,GAAIC,KAAKQ,MAAMT,EAAU,IAElE,IAAIO,WAAWC,KAAKP,KAAKQ,MAAMN,EAAU,GAAIF,KAAKQ,MAAMN,EAAU,GAChG,CAIA,IAAImT,EAAS,GACbnY,EAAWgO,UACX,IAAK,IAAI9L,EAAE,EAAEqD,EAAIvF,EAAWmC,OAAQD,EAAEqD,EAAKrD,IAAK,CAC9C,IAAIkW,EAAYpY,EAAWkC,GAC3BkW,EAAUC,MAAQ9M,EAAWyF,KAAKqH,MAE9B7T,GAAqB4T,aAAqBhT,WAAWK,MAAMtG,KAAQiZ,EAAUvS,YAC7EuS,EAAUtS,WAAW,CAACD,YAAW,EAAOE,SAAUpB,IAEtD,IACI5E,EAAIuY,SAASF,GACb,IAAI1S,EAAW0S,EAAUzS,KACpByS,EAAUzS,QAAQhF,IACnB+E,EAAW/C,EAAwByV,EAAUzS,OACjD,IAAI4S,EAAW7Y,EAAOO,OAAOyF,GAE3ByS,GADEI,EACQ,kBAAkBH,EAAUzS,KAAK,KAAK4S,EAASxN,MAAM,YAErD,kBAAkBqN,EAAUzS,KAAK,KAAKyS,EAAUzS,KAAK,WAErE,CAAE,MAAM6S,GACA9S,EAAW0S,EAAUzS,KACpByS,EAAUzS,QAAQhF,IACnB+E,EAAW/C,EAAwByV,EAAUzS,OACjD/D,QAAQC,IAAI6D,EAAS,8BACzB,CACF,CAEA,GAAuB,GAAnB1F,EAAWmC,QAiBb,GAfAa,EAAE,8BAA8BO,OAAO4U,GACvCnV,EAAE,8BACCuQ,QAAO,WACN,IAAIzD,EAAM9M,EAAEjF,MAAM+R,MACd2I,EAAS1Y,EAAI8Q,gBAAgBf,GAAK,GACtC/P,EAAI2Y,aAAcD,GAGlBhZ,OAAOwR,OAAOC,aAAa,yBACzB,CAAE,MAASuH,IAGbzV,EAAEjF,MAAMwW,MACV,IAEqB,GAAnBvU,EAAWmC,OACba,EAAE,uBAAuBM,YAEtB,GAAK,qBAAsB5D,EAAOf,QAAU,CAC7C,IAAIga,EAAmBjZ,EAAOf,QAA0B,iBACnDga,KAAoBjY,EACvBiY,EAAmBjY,EAA6BiY,GACxCA,KAAoBjZ,EAAOO,SACnC0Y,EAAmBlX,EAAUkX,IAEqD,GAA/E3V,EAAE,4CAA4C2V,EAAiB,MAAMxW,QACxEa,EAAE,8BAA8B8M,IAAI6I,GAAkBpF,QAC5D,OAGAvQ,EAAE,uBAAuBM,OACzBvD,EAAIuY,SAAS,IAAIlT,WAAWK,MAAMmT,OAAO,YAAY,CACnDC,UAAU9Y,EAAI8Y,UACdlQ,SAAU5I,EAAI4I,SACdD,SAAU3I,EAAI2I,SACdqD,cAAehM,EAAIgM,cACnB3L,OAAQL,EAAIK,OACZmL,WAAYxL,EAAIwL,WAChB8M,MAAOtY,EAAIwL,WAAWyF,KAAKqH,SAW/B,IANApY,EAAO0S,MAAK,SAASC,EAAGC,GACtB,OAAID,EAAE3J,OAAS4J,EAAE5J,MACR,EACF2J,EAAE3J,MAAQ4J,EAAE5J,MAAQ,GAAK,CAClC,IACAhJ,EAAO+N,UACE9L,EAAE,EAAEqD,EAAItF,EAAOkC,OAAQD,EAAEqD,EAAKrD,IAAK,EACtC2E,EAAI5G,EAAOiC,IACbmW,MAAQ9M,EAAWyF,KAAKqH,MAC1BxR,EAAEoK,OAAOgE,GAAG,CACV6D,UAAW,SAASlF,GAClB5Q,EAAE,UAAU4Q,EAAImF,OAAOpT,KAAK,iBAAiBzC,SAAS,YACxD,EACA8V,QAAS,SAASpF,GAChB5Q,EAAE,UAAU4Q,EAAImF,OAAOpT,KAAK,iBAAiBjC,YAAY,YAC3D,IAGEgC,EAAW,KACVmB,EAAElB,QAAQhF,IACX+E,EAAW/C,EAAwBkE,EAAElB,OACzC,IAAIsT,EAAU,KACTvT,IACDuT,EAAUvZ,EAAOO,OAAOyF,IACtBuT,IACFA,EAAUvZ,EAAOO,OAAO4G,EAAE1I,OAAe,SACvC8a,IACFA,EAAUvZ,EAAOO,OAAO4G,EAAElB,OACxBsT,MAEF,iBAAkBA,IACM,QAAxBA,EAAQ1K,cAAkD,WAAxB0K,EAAQ1K,cAAqD,IAAxB0K,EAAQ1K,gBAK/E/J,GAAqBqC,aAAazB,WAAWK,MAAMtG,KAAQ0H,EAAEhB,YAC7DgB,EAAEf,WAAW,CAACD,YAAW,EAAOE,SAAUpB,IAE9C5E,EAAIuY,SAASzR,GAEf,CAGA,GAAI,kBAAmBnH,EAAQ,CAC7B,IAAIwZ,EAAoB,GACxB,IAAK,IAAIC,KAASzZ,EAAO+P,cAClB,UAAW/P,EAAO+P,cAAc0J,GACnCD,EAAmBxZ,EAAO+P,cAAc0J,GAAOlQ,OAAUkQ,EAEzDD,EAAkBzP,KAAM0P,GAE5B,IAAIC,EAAgB,GACpB,IAAK,IAAIvS,KAAKqS,EAAmB,CAC3BC,EAAQD,EAAkBrS,GAA9B,IACI4L,EAAU/S,EAAOO,OAAOkZ,GACxB9K,EAAO,6BACXA,GAAQ,4BAA4B5M,EAAU0X,GAAO,mBACrD9K,GAAQ,WAAWoE,EAAQ1H,MAAM,eACjCsD,GAAQ,YACRA,GAAQ,SAER+K,EAAc3P,KAAK4E,EACrB,CACArL,EAAE,yBAAyBqL,KAAK+K,EAAcxH,KAAK,UACnD7R,EAAIuY,SAAS,IAAIlT,WAAWK,MAAMmT,OAAO,cAAc,CACrDS,SAAU,IAAIjU,WAAWkU,SAAS,CAChCC,YAAa,EACbC,MAAM,EACNC,QAAQ,EACRC,YAAa,EACbC,YAAa,SACbC,cAAe,QAIjB,IAAIC,EAAeC,KACnB,GAA2B,GAAvBD,EAAa1X,OACfzC,EAAO+P,cAAgB,CAAC,EACxBzM,EAAE,kBAAkBG,SAAS4W,SAC7B/W,EAAE,gBAAgB+W,aACb,CACL,IAAK,MAAMC,KAAeH,EAAc,CACtC,IAAII,EAAWD,EAAYE,qBAAqB,QAAQ,GAAGC,YAE3D,KADIhB,EAAQ1Z,OAAO2a,kBAAmBH,IAElC,GAAIA,KAAYva,EAAO+P,cACnB0J,EAAQc,OACP,GAAMA,KAAYpZ,GAAkBA,EAAaoZ,KAAava,EAAO+P,cACtE0J,EAAQtY,EAAaoZ,QAErB,IAAK,IAAII,KAAO3a,EAAO+P,cACnB,GAAI4K,EAAIrP,MAAM,KAAK4G,KAAK,MAAQqI,EAAU,CACtCd,EAAQkB,EACR,KACJ,CAKZ,GAAOlB,KAASzZ,EAAO+P,cAAvB,EAGID,EAAS9P,EAAO+P,cAAc0J,IACtB,IAAIa,EAAYE,qBAAqB,OAAO,GAAGC,YAC3DzH,GAAoBlD,EAAO3C,KAAK,WAC5B,IAAIzH,WAAWqH,WAAW+C,EAAO3C,IACrC,IACA,IAAIW,EAAOwM,EAAYE,qBAAqB,sBAAsB,GAClE1K,EAAa,KAAI,CACfhD,WAAWgB,EAAK8M,aAAa,SAC3B9N,WAAWgB,EAAK8M,aAAa,SAC7B9N,WAAWgB,EAAK8M,aAAa,SAC7B9N,WAAWgB,EAAK8M,aAAa,SAZrB,CAcd,CAGA,IAAK,IAAIC,KAAS7a,EAAO+P,cAAe,CACtC,IAAID,EACJ,GAAI,gBADAA,EAAS9P,EAAO+P,cAAc8K,KAC6B,GAAhC/K,EAAoB,YAAErN,OAAa,CAChE,IAAI+N,EAAaV,EAAoB,YAAE,GAEvC,IAAK,IAAIW,KADTX,EAAsB,cAAIU,EAA4B,gBACpCxQ,EAAO+P,cAAe,CACtC,IAAIY,EAAU3Q,EAAO+P,cAAcU,GAC/BE,EAAQmK,SAAWtK,EAAWuK,cAChCvK,EAAsB,UAAIC,EAC1BX,EAAkB,UAAIW,EACtBE,EAAuB,cAAIH,EAA0B,cACrDG,EAAmB,UAAIkK,EACvBlK,EAAqB,YAAI,CAAC,CACtB,gBAAmBH,EAA0B,cAC7C,cAAiBA,EAA4B,gBAC7C,YAAeV,EAAOgL,QACtB,UAAaD,IAGrB,CACF,CACF,CAGA,IAAK,IAAIpB,KAASzZ,EAAO+P,cACvB4C,EAAiB8G,GAEnBnW,EAAE,qBAAqBI,OAAM,WAU3B,OATAuN,EAAe,eACf3N,EAAE,kBAAkB8M,IAAI,MACxB9M,EAAE,iCAAiC8M,IAAI,IAEnCrQ,OAAOib,yBACPjb,OAAOwR,OAAOC,aAAa,8BACzB,CAAC,YAAezR,OAAOib,2BAGtB,CAET,IACA1X,EAAE,iBAAiBI,OAAM,WAGvB,OAFAJ,EAAE,qBAAqBI,QACvBJ,EAAE,kBAAkBI,SACb,CACT,GACF,CACJ,CAEAJ,EAAE,wBAAwB2X,QAAQ,CAChCC,SAAU,SAGd,CAqKA,SAASC,EAAwBjH,GAC/B,IAAK,IAAIvL,KAAMnI,EAAU,CACvB,IAAI4a,EAAO5a,EAASmI,GACpB,GAAGyS,EAAK,CACN,GAAIlH,GAAQ,WAAYA,GAAQkH,GAAQlH,EAAImF,OAC1C,SAEE+B,EAAKva,MAAQ6E,WAAW2V,QAAQC,WAClCF,EAAKG,YAET,CACF,CACA,OAAO,CACT,CAEA,SAASC,EAAsB3b,EAAM4b,GACnC,IAAIC,EAAkBrb,EAAIsb,mBAAmBF,GAEpB,GAArBpb,EAAIub,OAAOnZ,QACXpC,EAAIwb,YAAYxb,EAAIub,OAAO,IAE/B,IAAIE,EAAQ,KACRC,EAAmB,KACvB,GAAI,kBAAmB/b,EAAOf,SAA2C,OAAhCe,EAAOf,QAAQ+c,cAAwB,CAC9ED,EAAmB,eAGnB,IAAIE,EAAW,IAAIpZ,OAAO,mBAAoB,KAE1CqZ,EAAW,oCADfrc,EAAOA,EAAKiD,QAASmZ,EAAU,wEACwB,SACnDE,KAAsBtc,GAAgB,MAARA,GAAwB,IAARA,GAClDyD,EAAE,kCAAkCqL,KAAKuN,GACnC5Y,EAAE,wCAAwCK,GAAG,aACjDL,EAAE,wCAAwCS,OAGvCoY,IACHD,EAAW,uCAAuC/M,QAAQ,uBAAuB,cACjF7L,EAAE,kCAAkCqL,KAAKuN,GACzCpc,OAAOyU,YAAW,WACTjR,EAAE,wCAAwCC,SAAS,WAA6C,cAAhCvD,EAAOf,QAAQ+c,eAChF1Y,EAAE,wBAAwBI,OAClC,GAAE,MAKDJ,EAAE,wCAAwCC,SAAS,cAC7CF,MAAoBA,MAAkB8Y,IACrB,MAAlB5a,GAA0Bma,EAAgBU,KAAO7a,EAAe6a,KAAOV,EAAgBW,KAAO9a,EAAe8a,IAKnH/Y,EAAE,wCAAwCC,SAAS,WAC5CF,MAAkB8Y,GAEvB7Y,EAAE,wBAAwBI,QAN1BJ,EAAE,wBAAwBI,QASzBJ,EAAE,wCAAwCC,SAAS,WAA6C,YAAhCvD,EAAOf,QAAQ+c,eAChFnV,GAEN,KACI,CACF,IAAKhH,GAAgB,MAARA,GAAwB,IAARA,EACzB,OAAO,EAEXkc,EAAmB,mBACnBD,EAAQ,IAAIpW,WAAW4W,MAAMC,eACzBR,EACAL,EACA,KACA7b,EACA,MACA,GACA,WASE,OARAQ,EAAIwb,YAAYxd,MACbgF,OACDC,EAAE,WAAWS,OACbT,EAAE,iBAAiBS,QAIrBkN,EAAe,gBACR,CACT,KAEEuL,mBAAoB,EAC1Bnc,EAAIoc,SAASX,GAIbxY,EAAE,IAAMyY,EAAmB,yBAAyBxG,GAAI,SAAQ,SAAUuD,GACxEA,EAAE4D,iBACFpZ,EAAEjF,MAAMse,IAAI,OACd,IAEAb,EAAMc,aAEHvZ,OACCC,EAAE,WAAWM,OACbN,EAAE,iBAAiBM,OAEzB,CACArC,EAAiBma,EAGjBmB,EAAwBf,EAAOC,GAE/Be,EAAwBhB,EAAOC,GAE/BgB,EAA0CjB,EAAOC,GAGjDhc,OAAOwR,OAAOC,aAAa,uBACvB,CAAC,MAASsK,EAAO,YAAeC,GAEtC,CA8FA,SAASiB,IAEP,IAAIC,EAAOvX,WAAW2V,QAAQ6B,UAAUC,UAAUC,aAAaC,MAC3Dhf,KAAMif,kBAIHL,EAAW,YACXA,EAAU,WACVA,EAAU,IACjBA,EAAW,KAAI5c,EAAIkd,YAAYC,SAC/BP,EAAU,IAAI5c,EAAIwL,WAAWe,SAG7B,IAAI6Q,EAAS,GACTC,EAAQ,GACRC,EAAU,GACd,IAAM,IAAK9C,KAAS7a,EAAOO,OAAS,CAElC,IAAIwS,EAAU/S,EAAOO,OAAOsa,GACrB,mBAAoB9H,GACO,MAA7BA,EAAwB,gBAGvB,WAAYA,EAAwB,gBACE,MAAvCA,EAAwB,eAAU,QACK,IAAvCA,EAAwB,eAAU,QACnC0K,EAAO1T,KAAMgJ,EAAwB,eAAU,OAGrD,CACK0K,EAAOhb,OAAS,IACnBwa,EAAa,OAAIQ,EAAOvL,KAAK,MAG/B,IAAK,IAAI1P,EAAE,EAAEqD,EAAItF,EAAOkC,OAAQD,EAAEqD,EAAKrD,IAAK,CAC1C,IAAIsD,EAAQvF,EAAOiC,IACfsD,EAAMwH,WACoB,WAA1BxH,EAAMrH,OAAe,QAA4C,IAA1BqH,EAAMrH,OAAe,QAC9Dif,EAAM3T,KAAMjE,EAAMG,KAAO,IAAMH,EAAMrH,OAAe,QAElDqH,EAAM6X,SAA4B,GAAjB7X,EAAM6X,SACzBA,EAAQ5T,KAAMjE,EAAMG,KAAO,IAAMH,EAAM6X,QAE3C,CAUA,OATKD,EAAMjb,OAAS,IAClBwa,EAAkB,YAAIS,EAAMxL,KAAK,MAC9ByL,EAAQlb,OAAS,IACpBwa,EAAqB,eAAIU,EAAQzL,KAAK,MAIxC7Q,EAAgB4b,EAETA,CAET,CAEA,SAASW,IACP,MAAMC,EAAgB,CAAC,EAEvB,GAAI/d,OAAOge,SAASC,OAAOtb,OAAS,EAClC,IAAK,MAAMub,KAAYle,OAAOge,SAASC,OAAOE,MAAM,GAAG3S,MAAM,KAAM,CACjE,MAAOkL,EAAK0H,GAASF,EAAS1S,MAAM,KACpCuS,EAAcM,mBAAmB3H,IAAQ2H,mBAAmBD,EAC9D,CAEF,OAAOL,CACT,CAEA,SAASO,IACP,GAAM9a,EAAE,cAAcC,SAAS,UAA/B,CAGA,IAAI8a,EAAQ/a,EAAE,cAAcQ,KAAK,QAEjCR,EAAE,0BAA0B8M,IAAIiO,GAEhC,IAAIC,EAAahb,EAAE,2BAA2B8M,MAC9CiO,EAAQ/a,EAAE,oBAAoBQ,KAAK,QACnC,IAAIya,EAAU,GACK,KAAdD,EACDC,EAAU,0EAA0EF,EAAM,8BACpE,KAAdC,EACRC,EAAU,0EAA0EF,EAAM,8BACrE,KAAdC,EACPC,EAAU,0EAA0EF,EAAM,8BACrE,KAAdC,IAGPC,EAAU,kBAFFjb,EAAE,gCAAgC8M,MAEZ,aADtB9M,EAAE,iCAAiC8M,MACE,2CAA2CiO,EAAM,+BAElG/a,EAAE,0BAA0B8M,IAAImO,EApBtB,CAqBZ,CAEA,SAASC,EAAiBhJ,GAKxB,GAHA4I,IAGsB,cAAlB5I,EAAMiJ,SAAyB,CACjC,IAAIhF,EAAQxW,EAAwBuS,EAAM1P,MAAMG,MAC5CyY,EAAU1e,EAAOO,OAAOkZ,GAC5B1Z,OAAOwR,OAAOC,aAAa,8BAC3B,CACE,KAAQiI,EACR,OAAUiF,EACV,WAAclJ,EAAM1P,MAAM0H,YAE9B,CACF,CAEA,SAASmR,IAEPrb,EAAE,wBAAwBI,OAAM,WAE5B,IAgIsBiF,EACtBiW,EACAC,EAnIEvG,QAAQnJ,QAAQ,iCAiIIxG,EAhIXrF,EAAEjF,MAAM+R,MAiInBwO,EAAQpgB,QAAQsgB,YAChBD,EAAW,CACblW,GAAIA,EACJoW,EAAG,MACHxgB,WAAYC,QAAQC,OAAOF,WAC3BG,QAASF,QAAQC,OAAOC,SAE1B4E,EAAE0b,IAAIJ,EACJC,GACA,SAASzM,GACP6M,EAAsB7M,EACxB,GACC,SA1ID,OAAO,CACT,IACA9O,EAAE,wBAAwBI,OAAM,WAI9B,OAwGqBiF,EA3GZrF,EAAEjF,MAAM+R,MA4GfwO,EAAQpgB,QAAQsgB,YAChBD,EAAW,CACblW,GAAIA,EACJoW,EAAG,OAELzb,EAAE0b,IAAIJ,EACJC,GACA,SAASK,GACPC,EAAaD,EACf,GACC,SAnHM,EAwGX,IAAyBvW,EACnBiW,EACAC,CAzGJ,GACF,CAEA,SAASI,EAAuBG,GAE9B9b,EAAE,6BAA6BqL,KAAKyQ,GAEpC9b,EAAE,oCAAoC+b,OAAO,SAE7CV,IAEArb,EAAE,yCAAyC8M,IAAI,IAAIyE,MACrD,CAGA,SAASsK,EAAcG,GAGrB,IAAIC,EAAUD,EAAQ/e,OAGlBif,EAAQ,CAAC,EACb,GAAI,gBAAiBF,GAAkC,IAAvBA,EAAQG,YAAkB,CACxD,IAAIC,EAAUJ,EAAQG,YAAYnU,MAAM,KACxC,IAAI,IAAI9I,KAAKkd,EAGK,IADZvM,EADIuM,EAAQld,GACN8I,MAAM,MACV7I,SACJ+c,EAAMrM,EAAE,IAAMA,EAAE,GAEtB,CAGA,IAAIwM,EAAQ,CAAC,EACb,GAAI,mBAAoBL,GAAqC,IAA1BA,EAAQM,eAAqB,CAC9D,IAAIC,EAAaP,EAAQM,eAAetU,MAAM,KAC9C,IAAI,IAAI9I,KAAKqd,EAAW,CACtB,IACI1M,EACY,IADZA,EADI0M,EAAWrd,GACT8I,MAAM,MACV7I,SACJkd,EAAMxM,EAAE,IAAMrG,WAAWqG,EAAE,IAC/B,CACF,CAEA,IAAS3Q,EAAE,EAAGA,EAAInC,EAAIE,OAAOkC,OAAQD,IAAI,CAGvC,IAAI2E,EAAI9G,EAAIE,OAAOiC,GAEnB,GADY2E,EAAE4E,YAEM,KAAdwT,EAAQ/c,IACVc,EAAE,8BAA8B8M,IAAKjJ,EAAElB,MAAO4N,aAC7C,CACH,IAAIiM,EAAMxc,EAAE,kDAAkD6D,EAAElB,KAAK,MAC/C,KAAdsZ,EAAQ/c,IAAcsd,EAAIvc,SAAS,YACzCD,EAAE,kDAAkD6D,EAAElB,KAAK,MAAMvC,OACrE,CAGIyD,EAAElB,QAAQuZ,IACZrY,EAAE1I,OAAe,OAAI+gB,EAAMrY,EAAElB,MAC7BkB,EAAEP,QAAQ,GACV7G,OAAOwR,OAAOC,aAAa,oBACvB,CAAE,YAAerK,EAAElB,QAKrBkB,EAAElB,QAAQ0Z,GACZxY,EAAE4Y,WAAWJ,EAAMxY,EAAElB,MAEzB,CAGA,GAAI,WAAYqZ,GAA6B,IAAlBA,EAAQ7B,OAAc,CAC7C,IAAIuC,EAAKV,EAAQ7B,OAAOnS,MAAM,KAC9B,GAAiB,GAAb0U,EAAGvd,OAAa,CAClB,IAAIwd,EAASD,EAAG,GACZE,EAAQF,EAAG,GAAG1U,QAGlBvL,OAAOwR,OAAOC,aAAa,uBACvB,CAAC,YAAeyO,EAAQ,IAAOC,EAAO,eAAiB,IAG3DngB,OAAOwR,OAAOC,aAAa,6BACvB,CAAC,YAAeyO,GAEtB,CACJ,MACMlgB,OAAOib,yBACTjb,OAAOwR,OAAOC,aAAa,2BACvB,CAAC,YAAezR,OAAOib,0BAM/B,IAAIlN,EAAOpI,WAAWya,OAAOC,WAAYd,EAAQxR,MACjDzN,EAAIoS,aAAc3E,GAAM,EAE1B,CAkCA,SAASgP,EAAwBhB,EAAOuE,GAEpCpP,EAAe,eACf,IAAInL,EAAQzF,EAAI8Q,gBAAgB,eAAe,GAC/C,QAAqB,IAAVrL,EAAX,CAIA,IAAIwa,EAAW,wFACVD,IACHC,EAAW,IAAKD,EAAa,IAAKC,GAEpC,IAAIC,EAAa,GACjBjd,EAAEgd,GAAUpZ,MAAK,WACf,IAAImN,EAAO/Q,EAAEjF,MACT+R,EAAMiE,EAAKjE,MACf,GAAY,IAAPA,EAAL,CAEA,IAAIjD,EAAMkH,EAAK5Q,SAAS2R,KAAK,wCAAwChF,MACrE,GAAY,IAAPjD,EAAL,CAEA,IAAI8C,EAAMoE,EAAK5Q,SAAS2R,KAAK,uCAAuChF,MAChEoQ,EAAOnM,EAAK5Q,SAAS2R,KAAK,8CAA8ChF,MACxEqQ,EAAOpM,EAAK5Q,SAAS2R,KAAK,8CAA8ChF,MACxEsQ,EAAOrM,EAAK5Q,SAAS2R,KAAK,8CAA8ChF,MACxEuQ,EAAOtM,EAAK5Q,SAAS2R,KAAK,8CAA8ChF,MAC5EmQ,EAAWxW,KAAM,CAAEkG,IAAKA,EAAK2Q,KAAMxQ,EAAKjD,IAAKA,EAAKW,KAAK,CAAC0S,EAAKC,EAAKC,EAAKC,IAN7D,CAHA,CAUZ,IAIA,IADA,IAAIE,EAAa,GACPre,EAAE,EAAGqD,EAAI0a,EAAW9d,OAAQD,EAAEqD,EAAKrD,IAC3CwQ,GAAmBuN,EAAW/d,GAAG2K,KAAK,SAAU2T,GAE9C,GADAD,EAAW9W,KAAM+W,GACZD,EAAWpe,QAAU8d,EAAW9d,OAAS,CAC5C,IAAIuN,EAAW,GACf,IAAK,MAAM+Q,KAAYR,EAAY,CAC/B,IAAI3O,EAAWlM,WAAWsb,SAASC,QAASF,EAASH,MACrDhP,EAASC,UAAUkP,EAAS5T,IAAK9M,EAAIyR,iBACrC9B,EAASjG,KAAM,IAAIrE,WAAWwb,QAAQhI,OAAQtH,GAClD,CACA9L,EAAMyM,YAAavC,EACrB,CACF,GAtCM,CAwCZ,CAEA,SAAS+M,EAAyCjB,EAAOuE,GACvD,KAAI,kBAAmBtgB,OAAOC,QAsF5B,OAAO,EApFP,IAAIsgB,EAAW,4CACVD,IACHC,EAAW,IAAKD,EAAa,IAAKC,GACrChd,EAAEgd,GAAUpZ,MAAK,WACd,IAAIia,EAAQ7d,EAAEjF,MAGd,GAAIiF,EAAEjF,MAAM+W,KAAK,kBAAkB3S,OAAS,EACxC,OAAO,EAEX,GAAIa,EAAEjF,MAAM+W,KAAK,6CAA6ChF,MAAO,CACnE,IAAIgR,EAAa9d,EAAEjF,MAAM+W,KAAK,6CAA6ChF,MAAM9E,MAAM,KACnF+V,EAAUD,EAAW,GAAK,IAAMA,EAAW,GAC3CtG,EAAUsG,EAAW,GACrBnR,EAAMmR,EAAW,GAEjBE,EAAiBvhB,OAAOwhB,mBAAoBzG,GAGhD,IAAMwG,EACF,OAAO,EACX,IAAIhH,EAAcgH,EAAe,GAIjC,KAAO,cAAevhB,OAAOC,WAAa8a,KAAW/a,OAAOC,OAAOwhB,WAC/D,OAAO,EAGX,KAAM,kBAAmBzhB,OAAOC,QAC5B,OAAO,EAEXD,OAAO0hB,gBAAgBnH,EAAarK,GAAK,SAASI,GAE5C,IAAIqR,EAAa3hB,OAAOC,OAAO2hB,cAAcphB,OACzCqhB,EAAa7hB,OAAOC,OAAOwhB,UAAU1G,GACrC+G,EAAgB,EAEpB,IAAM,IAAIrf,KAAKkf,EAEX,IAAI,IAAII,KAAKF,EAAW,CACtB,IAAIG,EAAMH,EAAWE,GAEjBE,EAAgBD,EAAIE,iBAGpBxE,EAAS,IAAMsE,EAAIG,iBAAmB,WAAW7R,EAAKC,WAAWyR,EAAII,iBAAiB,KAGxF,GAAGT,EAAWlf,GAAG4f,UAAUJ,EAC3B,CACI,IAAIK,EAAYX,EAAWlf,GAC3B,GAAG,6BAA8B6f,GACY,QAAxCA,EAAYC,yBAChB,CACC,IAAIC,EAAQb,EAAWlf,GAAG+f,QAC1BlB,EAAUD,EAAW,GAAK,IAAMA,EAAW,GAAK,IAAMoB,OAAOX,GAE7DR,GAAU,KAAM,IAAIoB,MAAOC,UAAUC,KAAKvd,KAAKwd,UAAUlM,UAAU,EAAE,IACrE,IAAImM,EAAQC,WAAWC,uBACnBV,EAAYhX,MACZgX,EAAYjT,SACZiS,GACA,GAEA1S,EAAO,+CACXA,GAAO,OAAQ0T,EAAYhX,MAAM,QACjCsD,GAAOkU,EACPlU,GAAO,SACP,IAAIqU,EAAQ1f,EAAE6d,GAAO/L,KAAK,gCACtB4N,EAAMvgB,OAAS,EACfa,EAAE0f,GAAOC,MAAMtU,GAEfrL,EAAE6d,GAAOtd,OAAO8K,GACpBmU,WAAWI,QAAQX,EAAS9E,EAAQ4D,GACpCQ,GACF,CACJ,CACJ,CAEV,GACF,CACF,GAIJ,CAEA,SAAShF,EAAwBf,EAAOuE,GACpC,IAAIC,EAAW,6DACVD,IACHC,EAAW,IAAKD,EAAa,IAAKC,GACpChd,EAAEgd,GAAUpZ,MAAK,WACf,IAAImN,EAAO/Q,EAAEjF,MACT+R,EAAMiE,EAAKjE,MACXH,EAAMG,EAAI9E,MAAM,KAAK6X,MACrBrI,EAAU1K,EAAItN,QAAS,IAAMmN,EAAK,IAElCqR,EAAiBC,GAAoBzG,GAGzC,IAAMwG,EACF,OAAO,EACX,IAAIla,EAAcka,EAAe,GAC7BhH,EAAcgH,EAAe,GACjC,KAAO,yBAA0Bla,IAAoD,QAApCA,EAAYgc,qBACzD,OAAO,EACX,KAAO,cAAepjB,MAAa8a,KAAW9a,EAAOwhB,WACjD,OAAO,EAGX,IAAIA,EAAYxhB,EAAOwhB,UAAU1G,GAC7BuI,EAAmB,GAClB,qBAAsBjc,IAAgBkM,MAAM7O,SAAS2C,EAAYic,qBAClEA,EAAmB5e,SAAS2C,EAAYic,mBAE5C5B,GAAgBnH,EAAarK,GAAK,SAASI,GAGzC,MAAMiT,EAAuB,GACvBC,EAAkB,GAGxB,IAAM,MAAMC,KAAYhC,EAAW,CAC/B,MACMiC,EAAkBlC,GADPiC,EAASvB,kBAE1B,GAAKwB,EAAkB,CACnB,MAAMC,EAAeD,EAAgB,GACrC,IAAIE,EAASD,GAAcE,WAAaF,EAAaG,UAKrD,QAJgB5hB,IAAX0hB,IACDA,EAAS5hB,EAAU2hB,EAAazd,MAChCyd,EAAaG,UAAYF,GAEF,QAAtBD,EAAa5H,OAAmF,GAAhEzH,EAAK5Q,SAAS2R,KAAK,2BAA2BuO,GAAQlhB,OAAa,CACpG,IAAIqhB,EAAUJ,GAAcE,WAAaF,EAAazd,KACtD,MAAM8d,EAAa,CACb,OAAUD,EACX,aAAgBA,EAChB,OAAU,GACV,QAAW,MACX,QAAW,QACX,IAAS,QAASJ,GAAqC,IAApBA,EAAavW,IAAauW,EAAavW,IAAM,YAChF,QAAW,iBACX,WAAc,iCACd,cAAiBkW,EACjB,YAAe,aAGf,qBAAsBK,IAAiBpQ,MAAM7O,SAASif,EAAaL,qBACpEU,EAA0B,cAAItf,SAASif,EAAaL,mBACpB,GAA/BU,EAA0B,gBAC3BA,EAA0B,cAAIV,GAC7BK,EAAaM,gBAAkBN,EAAaM,eAAevG,QACnB,KAAvCiG,EAAaM,eAAevG,OAC9BsG,EAAmB,OAAIL,EAAaM,eAAevG,OAAO,SAAS+F,EAAStB,iBAAiB,SAAS7R,EAAKC,WAAWkT,EAASrB,iBAAiB,IAEhJ4B,EAAmB,OAAID,EAAQ,KAAKN,EAAStB,iBAAiB,SAAS7R,EAAKC,WAAWkT,EAASrB,iBAAiB,IAEvH,IAAI8B,EAAY5P,EAAK5Q,SAGjBoF,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC5CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAK/C8kB,EAAgBxZ,KAAK2Z,GACrBJ,EAAqBvZ,KACnB5K,MAAM0J,EAAS,CACb,OAAU,OACV,KAAQ,IAAItJ,gBAAgBwkB,KAC3BG,MAAK,SAAUhlB,GAChB,OAAOA,EAASW,MAClB,IAEJ,CACJ,CACJ,CAGAskB,QAAQC,WAAWd,GAAsBY,MAAKG,IAE5C,MAAMC,EAAqB,GAE3B,IAAK,IAAIC,EAAQ,EAAGA,EAAQF,EAAkB5hB,OAAQ8hB,IAAS,CAC7D,IAAIC,EAAiBH,EAAkBE,GAAOrG,MAG9C,GAD0BsG,GAAoC,MAAlBA,GAA4C,IAAlBA,EACjD,CACnB,IAAIvI,EAAW,IAAIpZ,OAAO,mBAAoB,KAC9C2hB,EAAiBA,EAAe1hB,QAAQmZ,EAAU,wDAElD,MAAM/V,EAAcqd,EAAgBgB,GAEpC,IAAIZ,EAASzd,EAAY2d,eACV5hB,IAAX0hB,IACFA,EAAS5hB,EAAUmE,EAAYD,MAC/BC,EAAY2d,UAAYF,GAG1B,MAAMc,EACJ,qEAAuEtV,QAAQ,uBAA/E,sHAC4EA,QAAQ,uBAAyB,8CAE/G,IAAIuV,EAAaphB,EAAE,mCAAqCqgB,EAAS,qBAAuBA,EAAS,iBAAmBzd,EAAYmF,MAAQ,KAAOoZ,EAAsBD,EAAiB,UAGtL,IAA2D,IAAvD,CAAC,OAAQ,QAAQpZ,QAAQlF,EAAYye,cACK,GAA5CD,EAAWtP,KAAK,kBAAkB3S,OAAa,CAE/CiiB,EAAWtP,KAAK,mBAAmBlO,MAAK,SAAU1E,EAAGsW,GACnD,IAAI8L,EAAWthB,EAAEwV,GAC0C,MAAvD8L,EAASxP,KAAK,sBAAsByP,KAAK,YAC3CD,EAASxP,KAAK,sBAAsB0P,QAAQ,aAC5CF,EAASxP,KAAK,sBAAsB2P,OAAOD,QAAQ,cAEnDF,EAASxP,KAAK,sBAAsB2P,OAAOD,QAAQ,iBAErDF,EAASxP,KAAK,sBAAsB2P,OAAOpb,WAAWmN,QAAQjT,OAAO+gB,EAASxP,KAAK,SACrF,IAEAsP,EAAWtP,KAAK,MAAMlO,MAAK,SAAU1E,EAAGsW,GAC7B,GAALtW,GACFc,EAAEwV,GAAGuB,QACT,IAEAqK,EAAWtP,KAAK,sBAAsBlO,MAAK,SAAU1E,EAAGsW,GAC7C,GAALtW,GACFc,EAAEwV,GAAGuB,QACT,IAEAqK,EAAWtP,KAAK,mBAAmB3J,WAAWuZ,SAC9CN,EAAWtP,KAAK,kBAAkB3J,WAAWuZ,SAC7CN,EAAWtP,KAAK,mBAAmBiF,SACnCqK,EAAWtP,KAAK,kBAAkBiF,SAElCqK,EAAWtP,KAAK,sBAAsBxR,OAEtC,IAAIqhB,EAAc3hB,EAAE,yCACpBohB,EAAW7gB,OAAOohB,GAClBP,EAAWtP,KAAK,MAAM8P,SAASD,GAE/BP,EAAW/a,SAAS,SAAS0Q,QAC/B,CAEA,IAAI8K,EAAgBlB,EAAU7O,KAAK,2BAA6BuO,GACpC,GAAxBwB,EAAc1iB,QAChB0iB,EAAc9K,SAGhB4J,EAAUpgB,OAAO6gB,GAEjBJ,EAAmBva,KAAK2a,GAGxB3kB,OAAOwR,OAAOC,aACZ,+BACA,CAAE,KAAQkT,EAAW/V,QAEzB,CACF,CAGArL,EAAE,uDAAuD8hB,YAEzD9hB,EAAE,8EAA8E2X,UAEhF3X,EAAE,wCAAwC+hB,IAAI,SAAS9P,GAAG,SAAQ,WAChEjS,EAAEjF,MACCmF,SAAS,QACTyS,SAAS,mBAAmBjS,YAAY,QACxCiS,SAAS,uDAAuDqP,QACrE,IAEAhiB,EAAE,wCAAwC+hB,IAAI,SAAS9P,GAAG,SAAQ,WAChEjS,EAAEjF,MACCmF,SAAS,QACTyS,SAAS,mBAAmBjS,YAAY,QACxCiS,SAAS,uDAAuDqP,QACrE,IAGAvlB,OAAOwR,OAAOC,aACZ,kCACA,CACE+T,mBAAoBlR,EAAKsB,QAAQ,6BACjC2O,mBAAoBA,GAEvB,GAEL,GACF,GACJ,CAyPA,SAASkB,EAAeC,GAEpB,IADA,IAAIC,EAAY,GACNljB,EAAE,EAAGqD,EAAM4f,EAAQhjB,OAAQD,EAAEqD,EAAKrD,IACxCkjB,EAAU3b,KAAM+C,WAAW2Y,EAAQjjB,KAEvCkjB,EAAUzS,MAAK,SAASC,EAAEC,GAAG,OAAOA,EAAED,CAAE,IAC1C,IAAIyS,EAAQtlB,EAAIuI,WACdgd,EAAWtiB,EAAE2I,QAAS0Z,EAAOD,GAC/B,IAAkB,GAAbE,EAAiB,CAEtB,IADA,IAAIrb,EAAE,EAAG8M,EAAKqO,EAAUjjB,QACH,GAAbmjB,GAAkBrb,EAAE8M,GACrBsO,EAAQD,EAAUnb,GACrBqb,EAAWrb,EAEZA,IAGDob,EADEpb,GAAK8M,EACCqO,EAAUrO,EAAK,GAEfqO,EAAUE,EAEpB,CACA,OAAOD,CACT,CAEA,SAASE,GAAcC,EAASC,EAAQC,GACtC,IAAIxN,EAAOsN,EAAQtN,KACfG,EAAQtY,EAAI4lB,WACZC,EAAaxgB,WAAWygB,gBAAgBxN,GACxCpU,EAAIiU,EAAK9T,MAAQ,GAAKwhB,EAAaF,EAAS,EAC5C9hB,EAAIsU,EAAKpU,OAAS,GAAK8hB,EAAaF,EAAS,EAC7CI,GAA2B,EAY/B,GAXI,6BAA8BrmB,OAAOC,OAAOf,SAA6D,QAAlDc,OAAOC,OAAOf,QAAQmnB,2BAC/EA,GAA2B,GAEzBA,GACCrmB,OAAOC,OAAOf,QAAQonB,sBAAsBva,KAAO/L,OAAOC,OAAOf,QAAQ4M,WAAWC,MAIvFvH,EADe,GACXA,EAAe,GACnBL,EAFe,GAEXA,EAAe,IAEU,GAA1B6hB,EAAO/V,SAASvN,OAAc,CAC/B,IAAI8D,EAASlG,EAAImG,YAGboa,EAFS,IAAIlb,WAAWya,OAAO5Z,EAAO6V,IAAM7X,EAAGgC,EAAO8V,IAAMnY,EAC5DqC,EAAO6V,IAAM7X,EAAGgC,EAAO8V,IAAMnY,GACfoiB,aAClBP,EAAOxT,YAAY,CACf,IAAI7M,WAAWwb,QAAQhI,OAAQ0H,IAEvC,KAAO,CACH,IAAIvQ,EAAO0V,EAAO/V,SAAS,GACvBzJ,EAAS8J,EAAKuB,SAASc,YAAY6T,mBAGnC3F,EAFS,IAAIlb,WAAWya,OAAO5Z,EAAO6V,IAAM7X,EAAGgC,EAAO8V,IAAMnY,EAC5DqC,EAAO6V,IAAM7X,EAAGgC,EAAO8V,IAAMnY,GACfoiB,cACb3d,GAAK0H,EAAKuB,SAASjJ,GACxB0H,EAAKuB,SAAWgP,EAChBmF,EAAOS,YAAYnW,EACvB,CACA,OAAO,CACT,CAEA,SAASoW,GAAsBX,EAASE,EAAQP,GAC9C,IAAIjN,EAAOsN,EAAQtN,KACfG,EAAQtY,EAAI4lB,WACZC,EAAaxgB,WAAWygB,gBAAgBxN,GACxCpU,EAAIiU,EAAK9T,MAAQ,GAAKwhB,EAAaF,EACnC9hB,EAAIsU,EAAKpU,OAAS,GAAK8hB,EAAaF,EACpCI,GAA2B,EAC3B,6BAA8BrmB,OAAOC,OAAOf,SAA6D,QAAlDc,OAAOC,OAAOf,QAAQmnB,2BAC/EA,GAA2B,GAEzBA,GACCrmB,OAAOC,OAAOf,QAAQonB,sBAAsBva,KAAO/L,OAAOC,OAAOf,QAAQ4M,WAAWC,MAIvFvH,EADe,GACXA,EAAe,GACnBL,EAFe,GAEXA,EAAe,IAKnB,IAFA,IAAIwiB,EAAWniB,EAAIL,EAAIK,EAAIL,EACvBwhB,EAAY,GACNljB,EAAE,EAAGqD,EAAM4f,EAAQhjB,OAAQD,EAAEqD,EAAKrD,IACxCkjB,EAAU3b,KAAM+C,WAAW2Y,EAAQjjB,KAEvCkjB,EAAUzS,MAAK,SAASC,EAAEC,GAAG,OAAOA,EAAED,CAAE,IACxC,IAAIyT,EAAWjB,EAAU,GACzB,IAAUljB,EAAE,EAAGqD,EAAI6f,EAAUjjB,OAAQD,EAAEqD,EAAKrD,IAAM,CAC9C,IAAI+H,EAAImb,EAAUljB,GAGlB,GAFK+H,EAAImc,IACPC,EAAWpc,GACRA,EAAImc,EACP,KACN,CACA,OAAOC,EAAS,EACpB,CAivBA,SAASpF,GAAoBqF,EAAUC,EAAYC,GAMjD,IAAM,IAAIC,KAHVD,OAAuC,IAAjBA,EAAgCA,EAAe,KADrED,OAAmC,IAAfA,EAA8BA,EAAa7mB,EAAOO,OAKlE,GAAKsmB,EAAWE,GAAID,IAAiBF,EACjC,MAAO,CAACG,EAAIF,EAAWE,IAE/B,OAAO,IACT,CA+PA,SAAS/T,GAAoBgU,EAAMC,GACjC,IAAI3V,EAAO0V,EAAKlkB,QAAQ,aAAc,IACjCwO,KAAQ4V,QAAQC,KACnBF,EAAW3V,GAEXhO,EAAE0b,IAAKtZ,WAAWwC,KAAKE,UACnB5J,QAAQY,IACPsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAC3C,CACD,QAAU,WACV,OAAU6S,IACT,SAAW8V,GACZF,QAAQC,KAAK7V,GAAQ8V,EACrB,IAAI1hB,WAAWqH,WAAWuE,GAC1B2V,EAAW3V,EACb,GAGN,CAUA,SAASjO,KACP,IACIkB,EAAIjB,EAAE,QAAQG,SAAS,GAAGe,YAE9B,OADYD,EAFK,SAGQA,EAHR,GAMnB,CAUA,SAAS8iB,GAAaC,EAAUC,EAAOC,GACrC,IAAIC,EAAQ,OAERC,GAAS,GAEwB,GAAhCpkB,EAAE2I,QAAQsb,EAHC,CAAC,OAAQ,QAAS,cAIhCE,EAAQF,GAELC,IACHE,GAAS,GAEX,IAAI/Y,EAAO,uCAAuC8Y,EAAM,gCACnDC,IACH/Y,GAAQ,wDACVA,GAAQ,MAAM2Y,EAAS,OACvB3Y,GAAQ,SAER,IAAIgZ,EAAMrkB,EAAEqL,GAEZ,OADArL,EAAE,YAAYO,OAAO8jB,GACdA,CACT,CAWC,SAASC,GAAcvf,EAAKwf,EAAYC,GACrC,IAAIC,EAAM,IAAIC,eACdD,EAAI3P,KAAK,OAAQ/P,GAAK,GACtB0f,EAAIE,aAAe,cACnBF,EAAIG,OAAS,WACT,GAAoB,MAAhB7pB,KAAK8pB,OAAgB,CACrB,IAAIC,EAAW,GACXC,EAAcN,EAAIO,kBAAkB,uBACxC,GAAID,IAAsD,IAAvCA,EAAYjd,QAAQ,cAAsB,CACzD,IACImd,EADgB,yCACQC,KAAKH,GAClB,MAAXE,GAAmBA,EAAQ,KAAIH,EAAWG,EAAQ,GAAGzlB,QAAQ,QAAS,IAC9E,CAEA,IAAIjC,EAAOknB,EAAIO,kBAAkB,gBAI9BG,UAAUC,UAAUte,cAAcgB,QAAQ,YAAc,GAAa,mBAARvK,IAC9DA,EAAO,4BAET,MAAM8nB,EAAO,IAAIC,KAAK,CAACvqB,KAAKa,UAAWkpB,EAAU,CAAEvnB,KAAMA,IACnDgoB,EAAcC,IAAIC,gBAAgBJ,GAExC,GAAIP,EAAU,CAEZ,MAAMlV,EAAI8V,SAASC,cAAc,KACjC/V,EAAE/H,KAAO0d,EACT3V,EAAEgW,SAAWd,EACblV,EAAEiW,cAAc,IAAIC,WAAW,SACjC,MACEtpB,OAAOsY,KAAKyQ,GAGdtU,YAAW,IAAMuU,IAAIO,gBAAgBR,IAAc,IACvD,CAMA,GAAmB,KAAfxqB,KAAK8pB,OAAe,CAItB,MAAMmB,EAAoB,UAE1B,GAHezB,EAAqB,SAEHpR,MAAM6S,GAClB,CACnB,IAAIC,EAAgB,8EACpBA,GAAiB,6EACnB,MACMA,EAAgBpa,QAAQ,qCAI9B,OADAkY,GAAYkC,EAAe,SAAS,IAC7B,CACT,CAEwB,mBAAbzB,GACTA,GAEN,EACAC,EAAIyB,iBAAiB,eAAgB,qCACrCzB,EAAI0B,KAAKnmB,EAAEomB,MAAM7B,GAAY,GAChC,CA8ED,SAAS8B,GAAyC3nB,GAC9C,IAAI4nB,EAAqB,GACzB,GAAI5nB,KAAShC,EAAOO,QAAUP,EAAOO,OAAOyB,GAAyB,iBAAG,CACpE,IAAI6nB,EAAO,GAGP3jB,EAAclG,EAAOO,OAAOyB,GAC5BuY,EAAWvY,EAAMsJ,MAAM,KAAK4G,KAAK,KAIrC,IAAK,IAAIvJ,IAHJ,cAAezC,GAAwC,IAAzBA,EAAY0d,YAC3CrJ,EAAWrU,EAAY0d,WAEZ1d,EAA8B,iBACzC2jB,EAAK9f,KAAMwQ,EAAW,IAAMrU,EAA8B,iBAAEyC,IAE5DkhB,EAAKpnB,SACLmnB,EAAqBC,EAAK3X,OAClC,CAEA,OAAO0X,CACX,CAEA,SAAS3X,GAAsBjQ,EAAO8nB,EAASC,EAAYC,EAAcC,EAAqBC,EAAYC,GACtG,IAAInY,EAAoB,CAAC,EAWzB,GARA8X,OAA6B,IAAZA,EAA2BA,EAAU,KACtDC,OAAmC,IAAfA,EAA8BA,EAAa,KAC/DC,OAAuC,IAAjBA,EAAgCA,EAAe,KACrEC,OAAqD,IAAxBA,GAAuCA,EACpEC,OAAmC,IAAfA,EAA8BA,EAAa,KAC/DC,OAAqC,IAAhBA,EAA+BA,EAAc,OAG3DnoB,KAAShC,EAAOO,QAAU,CAC7B,IAAIyF,EAAWjG,OAAOqqB,mBAAmBpoB,GAKzC,GAJMgE,GAAcA,KAAYhG,EAAOO,SACrCyF,EAAWjG,OAAOsqB,mBAAmBroB,IACjCgE,GAAcA,KAAYhG,EAAOO,SACrCyF,EAAWjG,OAAO2a,kBAAkB1Y,KACjCgE,KAAaA,KAAYhG,EAAOO,QAIjC,OADA2B,QAAQC,IAAI,0BAA0BH,EAAM,UAAUgE,EAAS,0BACxD,EAHPhE,EAAQgE,CAKhB,CACA,IAAIE,EAAclG,EAAOO,OAAOyB,GAC5BuY,EAAWvY,EAAMsJ,MAAM,KAAK4G,KAAK,KAChC,cAAehM,GAAwC,IAAzBA,EAAY0d,UAC7CrJ,EAAWrU,EAAY0d,UACf,aAAc1d,GAAuC,IAAxBA,EAAYokB,WAC/C/P,EAAWrU,EAAYokB,UAE3B,IAAIC,EAAa,CACb,QAAU,MACT,QAAU,QACV,QAAU,aACV,SAAWhQ,EACX,aAAe,WAGhB2P,IACAK,EAAuB,WAAIL,GAE3BC,IACAI,EAAwB,YAAIJ,GAEhC,IAAIK,EAAc,GA0BlB,GAxBIV,EAGgB,KADhBA,EAAUA,EAAQhnB,QAASd,EAAQ,IAAK,MAEtCwoB,EAAYzgB,KAAM+f,GAGhB,mBAAoB9pB,EAAOO,OAAOyB,IAAU,WAAYhC,EAAOO,OAAOyB,GAAuB,iBAC3F8nB,EAAU9pB,EAAOO,OAAOyB,GAAuB,eAAU,UAEzD8nB,EAAUA,EAAQhnB,QAASd,EAAQ,IAAK,IACxCwoB,EAAYzgB,KAAM+f,IAMxBC,EACAQ,EAAsB,UAAIR,EAAWjnB,QAAQ,IAAID,OAAOb,EAAO,KAAMuY,GAChEiQ,EAAY/nB,SACjB8nB,EAAuB,WAAIC,EAAYtY,KAAM,UAI7C+X,EAAsB,CACtB,IAAIQ,EAASpqB,EAAIkd,YAAYrY,QACzBwlB,EAAW,IAAIhlB,WAAWqH,WAAW/M,EAAOO,OAAOyB,GAAOmL,KAE1DW,GADJ2c,EAASA,EAAO5Y,UAAWxR,EAAIyR,gBAAiB4Y,IAC9BlN,SAClB+M,EAAiB,KAAIzc,CACzB,CAcA,OAXIkc,IAC6E,GAA5E1mB,EAAE2I,QAAS+d,EAAa5f,cAAe,CAAC,OAAQ,SAAU,eAE3DmgB,EAAyB,aAAIP,GAGjChY,EAAuB,IAAItM,WAAWwC,KAAKE,UAAU5J,QAAQY,IACpDsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEpDuT,EAA2B,QAAIuY,EAExBvY,CACX,CAQA,IAAI2Y,GAAkB,CAAC,EAEvB,SAASC,GAAyBC,EAAQ7a,GACtC,IAAI8a,EAAgBH,GAAgBE,UAC7BF,GAAgBE,GACvBC,EAAcC,UAAUC,SAAQ,SAASlD,GACjCA,GACFA,EAASgD,EAAc5nB,UAAW4nB,EAAcrN,OAAQzN,EAAU8a,EAAcG,MAAOH,EAAcI,MAE3G,GACJ,CAEA,SAASC,GAAenpB,EAAO8nB,EAASsB,EAAYC,EAAepB,EAAqBC,EAAYC,EAAamB,GAU7G,GARAxB,OAA6B,IAAZA,EAA2BA,EAAU,KACtDsB,OAAmC,IAAfA,EAA6BA,EAAa,KAC9DC,OAAyC,IAAlBA,EAAgCA,EAAgB,KACvEpB,OAAqD,IAAxBA,GAAuCA,EACpEC,OAAmC,IAAfA,EAA8BA,EAAa,KAC/DC,OAAqC,IAAhBA,EAA+BA,EAAc,OAG3DnoB,KAAShC,EAAOO,QAAU,CAC7B,IAAIyF,EAAWjG,OAAOqqB,mBAAmBpoB,GAKzC,GAJMgE,GAAcA,KAAYhG,EAAOO,SACrCyF,EAAWjG,OAAOsqB,mBAAmBroB,IACjCgE,GAAcA,KAAYhG,EAAOO,SACrCyF,EAAWjG,OAAO2a,kBAAkB1Y,KACjCgE,KAAaA,KAAYhG,EAAOO,QAIjC,OADA2B,QAAQC,IAAI,oBAAoBH,EAAM,UAAUgE,EAAS,0BAClD,EAHPhE,EAAQgE,CAKhB,CACA,IAAIuT,EAAUvZ,EAAOO,OAAOyB,GAE5BsB,EAAE,QAAQe,IAAI,SAAU,QAExB,IAAI2N,EAAoBjS,OAAOkS,qBAAsBjQ,EAAO8nB,EAASsB,EAAYC,EAAepB,EAAqBC,EAAYC,GAG7HU,EAAS7Y,EAAuB,IAAI,IAAMK,KAAKkZ,UAAUvZ,EAA2B,SACxF,KAAI6Y,KAAUF,IAgDd,OAxCAA,GAAgBE,GAAU,CACtBE,UAAW,CAAEO,GACbpoB,UAAWlB,EACXyb,OAAQqM,EACRmB,MAAO1R,EAAe,MACtB2R,MAAO3R,EAAe,OAG1BjW,EAAE6O,KAAMH,EAAuB,IAAGA,EAA2B,SAAG,SAASI,GAIrE,GAFAmH,EAAoB,WAAI,YAEpBA,GAAiB,OAAKA,GAAiB,MACvCqR,GAAyBC,EAAQzY,EAAKpC,UACtC1M,EAAE,QAAQe,IAAI,SAAU,YACrB,CACH,IAAIwE,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IACzCsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAElD6E,EAAE6O,KAAKtJ,EAAS,CACZ,QAAU,MACV,QAAU,QACV,QAAU,sBACV,SAAa,aAAc0Q,EAAWA,EAAQ+Q,SAAWtoB,EACzD,aAAe,SAChB,SAASwpB,GAERjS,EAAe,MAAIiS,EAASC,QAC5BlS,EAAe,MAAIiS,EAASN,MAC5B3R,EAAiB,QAAIiS,EAASE,QAE9Bd,GAAyBC,EAAQzY,EAAKpC,UAEtC1M,EAAE,QAAQe,IAAI,SAAU,OAE5B,GAAE,OACL,CAEL,GAAE,SAEK,EA9CCinB,GACAX,GAAgBE,GAAQE,UAAUhhB,KAAKuhB,EA8CnD,CAgCA,SAAS7J,GAAiBnH,EAAarK,EAAKgX,EAAW0E,EAAmBC,GACtE,GAAM3E,GAEC3M,KAAeta,EAAOO,OAA7B,CAGA,IAAI6G,EAAcpH,EAAOO,OAAO+Z,GAC5BuR,EAAYvR,EAAc,IAAMrK,GAGhC2b,GAAexkB,EAAsB,UAAK6I,KAAO7I,EAAsB,SACvE6f,EAAU7f,EAAsB,SAAE6I,IAIlCkb,GAAe7Q,EAAa,KAAMuR,EAAW,UAAU,EAAO,KAAM,MAChE,SAAU7pB,EAAO8nB,EAASgC,EAAWC,GAErC,GAAwB,GAApBD,EAAUrpB,OAAa,CACvB,IAAI4N,EAAOyb,EAAU,GAChB1kB,EAAsB,WACvBA,EAAsB,SAAI,CAAC,GAE/BA,EAAsB,SAAE6I,GAAOI,EAC/B4W,EAAU5W,EACd,MACQsb,GACJA,EAAkBrR,EAAarK,EAEvC,GAzBM,CA2Bd,CAEA,SAASmK,KACL,OAAwB,MAAnBha,EACI,GAEFA,EAAgBoa,qBAAqB,cAChD,CA8QA,SAASwR,GAASC,EAAOC,EAAQC,EAAOC,EAAUC,GAE9C,GAAI/oB,EAAE,2BAA2B2oB,EAAM,QAAQxpB,OAC3CP,QAAQC,IAAI8pB,EAAQ,iCADxB,CAMA,IAAIK,EAAS,GACbA,GAAQ,cAAcL,EAAM,QAAQE,EAAM,KAC1CG,GAAQ,oBAAoBL,EAAM,wCAAwCC,EAAO,mCAAmCD,EAAM,+BAC1HK,GAAU,uCAAyCD,EAAQ,oDAAsDJ,EAAO,UACxHK,GAAQ,UACRA,GAAQ,QACRhpB,EAAE,0BAA0B6oB,EAAM,SAASlJ,MAAMqJ,GACW,GAAvDhpB,EAAE,0BAA0B6oB,EAAM,IAAIF,GAAOxpB,QAChDa,EAAE,2BAA2B2f,MAAMqJ,GAGrChpB,EAAE,2BAA2B2oB,EAAM,cAAc5nB,IAAI,mBAAmB,QACxEf,EAAE,2BAA2B2oB,EAAM,kBAAkB5nB,IAAI,cAAe,OAGxEf,EAAE,2BAA2B2oB,EAAM,QAAQhR,UAG3C,IAAIsR,EAAU,GACdA,GAAS,6BAA6BN,EAAM,KAC/B,YAATE,IACAI,GAAS,uCAAyCpd,QAAQ,wBAA0B,iGACpFod,GAAS,mBAAmBN,EAAM,KAClCM,GAAS,eACTA,GAAS,mCACTA,GAAS,2BAA2BF,EAAM,oBAC1CE,GAAS,0CAA0CL,EAAO,gBAC1DK,GAAS,sBACTA,GAAS,iBAEbA,GAAS,qCACTA,GAAUH,EACVG,GAAS,iBACTA,GAAS,aACTA,GAAS,SACI,YAATJ,GACA7oB,EAAE,sBAAsBO,OAAO0oB,GAC/BjpB,EAAE,IAAI2oB,EAAM,wBAAwBvoB,OAAM,WACpCJ,EAAE,2BAA2B2oB,GAAO1oB,SAAS,WAC7CD,EAAE,WAAW2oB,GAAOvoB,OAE1B,KAEc,cAATyoB,EACL7oB,EAAE,uBAAuBO,OAAO0oB,GAClB,QAATJ,EACL7oB,EAAE,iBAAiBO,OAAO0oB,GACZ,cAATJ,GACL7oB,EAAE,wBAAwBO,OAAO0oB,GAGrC,IAAIC,EAAY,GAChBA,GAAY,mBAAmBP,EAAM,eAAeA,EAAM,uBAAuBC,EAAO,YAC3E,YAATC,EACA7oB,EAAE,mBAAmBO,OAAO2oB,GACd,cAATL,EACL7oB,EAAE,oBAAoBO,OAAO2oB,GACf,QAATL,EACL7oB,EAAE,cAAcO,OAAO2oB,GACT,cAATL,GACL7oB,EAAE,qBAAqBO,OAAO2oB,EA/DlC,CAiEJ,CA+HA,IAAIC,GAAM,CAKRpsB,IAAK,KAKLE,OAAQ,KAKRD,WAAY,KAMZiR,OAAQ,KAKRvR,OAAQ,KAKR0sB,WAAY,KAKZ9rB,KAAM,KAKNoa,wBAAyB,KAKxBxZ,+BAAgC,WAC/B,OAAOA,GACT,EAKAmrB,YAAa,WACX,OAAOtpB,IACT,EAKAtB,UAAW,SAAUC,GACnB,OAAOD,EAAWC,EACpB,EAKAooB,mBAAoB,SAAUroB,GAC5B,OAz4KJ,SAA6BA,GAC3B,IAAIkE,EAAO,KAGX,OAFIlE,KAAad,IACfgF,EAAOhF,EAAac,IACfkE,CACT,CAo4KWmkB,CAAoBroB,EAC7B,EAKAsoB,mBAAoB,SAAUuC,GAC5B,OAz4KJ,SAA6BA,GAC3B,IAAI3mB,EAAO,KAGX,OAFI2mB,KAAazrB,IACf8E,EAAO9E,EAAayrB,IACf3mB,CACT,CAo4KWokB,CAAoBuC,EAC7B,EAKAlS,kBAAmB,SAAUH,GAC3B,OAz4KJ,SAA4BA,GAC1B,IAAItU,EAAO,KAGX,OAFIsU,KAAYnZ,IACd6E,EAAO7E,EAAYmZ,IACdtU,CACT,CAo4KWyU,CAAmBH,EAC5B,EAKAtX,wBAAyB,SAAUlB,GACjC,OAAOkB,EAAyBlB,EAClC,EAKA8qB,WAAY,SAAUvF,EAAUC,EAAOC,GACrC,OAAOH,GAAaC,EAAUC,EAAOC,EACvC,EAKA3gB,mBAAoB,WAClB,OAAOA,GACT,EAKAmM,mBAAoB,SAAUgU,EAAMC,GAClC,OAAOjU,GAAoBgU,EAAMC,EACnC,EAMA9jB,kBAAmB,WACjB,OAAOA,GACT,EAKA8N,eAAgB,SAAS/N,GACvB,OAAO+N,EAAe/N,EACxB,EAKAue,gBAAiB,SAAUnH,EAAarK,EAAKgX,EAAW0E,EAAmBC,GACzEnK,GAAiBnH,EAAarK,EAAKgX,EAAW0E,EAAmBC,EACnE,EAKAT,eAAgB,SAASnpB,EAAO8nB,EAASsB,EAAYC,EAAepB,EAAqBC,EAAYC,EAAamB,GAChHH,GAAenpB,EAAO8nB,EAASsB,EAAYC,EAAepB,EAAqBC,EAAYC,EAAamB,EAC1G,EAKAwB,wBAAyB,SAAS9qB,EAAOgP,EAAW+b,EAAYC,GAC9D,OAAOF,wBAAwB9qB,EAAOgP,EAAW+b,EAAYC,EAC/D,EAKAC,cAAe,SAAU3S,EAAarK,EAAKid,IA5pB7C,SAAwB5S,EAAarK,EAAKid,GACtCA,OAAmC,IAAfA,EAA8BA,EAAa,OAE/DzL,GAAgBnH,EAAarK,GAAK,SAASI,GACzC,IAAIiB,EAAO,IAAI5L,WAAWqH,WAAW/M,EAAOO,OAAO+Z,GAAanN,KAC5DnN,EAAOO,OAAO+Z,GAAa6S,aAC3B7b,EAAO,IAAI5L,WAAWqH,WAAW/M,EAAOO,OAAO+Z,GAAa6S,aAzBtE,SAA0BC,EAAS9b,EAAM4b,GACrCA,OAAmC,IAAfA,EAA8BA,EAAa,OAC/D,IAGI7c,EAHS,IAAI3K,WAAWuE,OAAOwH,QAAQ,CACvCC,iBAAiB,IAEHC,KAAKyb,GAAS,GAChC,GAAI/c,GAAQ,aAAcA,IACtBA,EAAKuB,SAASC,UAAWP,EAAMvR,OAAOM,IAAIyR,iBAGxB,QAAdob,GACA7sB,EAAIoS,aAAapC,EAAKuB,SAASc,aACjB,UAAdwa,GAAwB,CACxB,IAAIG,EAAShd,EAAKuB,SAASc,YAAY6T,kBACvClmB,EAAIqG,UAAU2mB,EAClB,CAER,CASQC,CAAiBjd,EAAMiB,EAAM4b,EACjC,GACJ,CAopBID,CAAe3S,EAAarK,EAAKid,EACnC,EAMAzG,qBAAsB,SAASX,EAASE,EAAQP,GAC9C,OAAOgB,GAAqBX,EAASE,EAAQP,EAC/C,EAMA8H,qBAAsB,WACpB,OAAO9sB,CACT,EAMA+sB,iCAAkC,WAChC,OAAOzsB,CACT,EAKA0sB,mBAAoB,SAAUC,GAC1B,IAAIC,EAAYrqB,EAAE,qCAAqCoqB,EAAW,MAKlE,OAJyB,GAApBC,EAAUlrB,QAAea,EAAE,uBAAuB8M,OAASsd,EAC5DpqB,EAAE,uBAAuB8M,IAAKsd,GAAa7Z,SACjB,GAApB8Z,EAAUlrB,QAAiD,IAAlCa,EAAE,uBAAuB8M,OACxD9M,EAAE,uBAAuB8M,IAAI,IAAIyD,SAC7BvQ,EAAE,uBAAuB8M,OAASsd,CAC9C,EAGAE,cAAe,WACX,OAAO,CACX,EAEAC,qBAAsB,WAClB,OAAO,CACX,EAEA1S,uBAAwB,SAAUjH,GAChC,OAAOiH,EAAwBjH,EACjC,EAEAsH,sBAAuB,SAAU3b,EAAM4b,GACrC,OAAOD,EAAuB3b,EAAM4b,EACtC,EAKAqS,kBAAmB,SAAU9rB,EAAO+rB,EAAS9D,GAC3C,OA5gCJ,SAA4BjoB,EAAO+rB,EAAS9D,GAKxC,GAHAA,OAAqD,IAAxBA,EAAuCA,EAAsB,OAGnF,iBAAkBlqB,OAAOC,OAAOf,UAAkD,QAAtCc,OAAOC,OAAOf,QAAQ+uB,aAEvE,OADA3G,GAAYlY,QAAQ,+BAA+B,SAAQ,IACpD,EAIT4e,OAA6B,IAAZA,EAA2BA,EAAU,UAGtD,IACIE,EAAiBhrB,EADLlD,OAAOgC,UAAWC,IAG7BisB,IACHA,EAAiBjsB,GAInB,IAAIksB,EAAenuB,OAAOC,OAAOO,OAAO0tB,GAGxC,MAAME,KACJD,EAA2B,cAAqC,QAAhCA,EAA2B,cAA+B,WAAhBA,GAItEE,EACJ,mBAAoBF,GAAgB,mBAAoBA,EAA6B,gBAC9B,MAApDA,EAA6B,eAAkB,gBACK,IAApDA,EAA6B,eAAkB,eAM9CG,EAAkBJ,EAAexX,MADb,WAS1B,GAAI0X,GAAcC,IAAwBC,EAAiB,CAEzD,IAAIrc,EAAoBC,GAAsBjQ,EAAO,KAAM,KAAM,KAAMioB,GAEnEqE,EAAkBJ,EAA6B,eAAkB,eACrElc,EAA2B,QAAkB,eAAIsc,CACnD,MAIMtc,EAAoBC,GAAsBjQ,EAAO,KAFrC2nB,GAAyCsE,GAEa,KAAMhE,GAY9E,OARAjY,EAA2B,QAAM,GAAI,EAGrCA,EAA2B,QAAgB,aAAI+b,EAG/CnG,GAAa5V,EAAuB,IAAGA,EAA2B,UAE3D,CACX,CAs8BW8b,CAAmB9rB,EAAO+rB,EAAS9D,EAC5C,EAKAhY,qBAAsB,SAAUjQ,EAAO8nB,EAASC,EAAYC,EAAcC,GACxE,OAAOhY,GAAsBjQ,EAAO8nB,EAASC,EAAYC,EAAcC,EACzE,EAMA7P,2BAA4B,WAC1B,OAAOA,IACT,EAMAmU,2BAA4B,WAC1B,OA7rBJ,WACE,IAAIC,EAAU,GACd,GAAwB,MAAnBpuB,EACH,OAAOouB,EAEP,IAAK,MAAMzjB,KAAU3K,EAAgBoa,qBAAqB,gBAAgB,GAAG7Q,SAC3E6kB,EAAQzkB,KAAKgB,EAAO0jB,SAEtB,OAAOD,CAEX,CAmrBWD,EACT,EAKAhN,mBAAoB,SAAUqF,EAAUC,EAAYC,GAClD,OAAOvF,GAAoBqF,EAAUC,EAAYC,EACnD,EAKA4H,uBAAwB,SAAU1sB,EAAOqO,EAAM4W,GAC7C,OA9rBJ,SAAiCjlB,EAAOqO,EAAM4W,GAE1C,GAAMA,EAAN,CAIA,IAAK5W,EACD,OAAO,EAGqB,GAA5BtQ,OAAOM,IAAIub,OAAOnZ,QAClB1C,OAAOM,IAAIwb,YAAa9b,OAAOM,IAAIub,OAAO,IAG9C,IAAI6B,EACAzX,EAAWhE,EACXjC,OAAOkD,wBAAwBjB,KAC/BgE,EAAWjG,OAAOkD,wBAAwBjB,IAG9C,IAAI2sB,EAAO,KAgBX,GAdK3oB,KAAYjG,OAAOC,OAAO4uB,kBAC3BD,EAAO5uB,OAAOC,OAAO4uB,gBAAgB5oB,GAAsB,aAK1D2oB,GAAQ,eAAgB5uB,OAAOC,OAAOf,SAAW,oBAAqBc,OAAOC,OAAOf,SACrEc,OAAOC,OAAOO,OAAOyF,GACvB2C,IAAM5I,OAAOC,OAAOf,QAAoB,YAAiD,IAA5Cc,OAAOC,OAAOf,QAAyB,kBAClG0vB,EAAO5uB,OAAOC,OAAOf,QAAyB,kBAK7C0vB,GAAQ,UAAW5uB,OAAOC,QAAU,WAAYD,OAAOC,OAAO6uB,OAASC,MAAMC,QAAQhvB,OAAOC,OAAO6uB,MAAc,SAAM9uB,OAAOC,OAAO6uB,MAAc,OAAEpsB,OAAS,EAAG,CACpK,MAAM2E,EAAcrH,OAAOC,OAAOO,OAAOyF,GACzC,IAAK,IAAIue,EAAQ,EAAGA,EAAQxkB,OAAOC,OAAO6uB,MAAMtuB,OAAOkC,OAAQ8hB,IAAS,CACtE,MAAMze,EAAQ/F,OAAOC,OAAO6uB,MAAMtuB,OAAOgkB,GACzC,GAAInd,EAAYuB,KAAO7C,EAAMA,MAAM,CACjC6oB,EAAO7oB,EAAMkpB,WACb,KACF,CACF,CACF,CAEA,IAAKL,EACD,OAAO,EAGXlR,EAASzX,EAAW,KAAO2oB,EAAlB3oB,SADGqK,EAAKC,WAAWqe,GAC6B,IAEzD,IAAIxhB,EAAM,YACN,QAASpN,OAAOC,OAAOO,OAAOyF,IAAoD,IAAtCjG,OAAOC,OAAOO,OAAOyF,GAAUmH,MAC3EA,EAAMpN,OAAOC,OAAOO,OAAOyF,GAAUmH,KAGzC,IAAI4W,EAAa,CACZ,OAAU/hB,EACV,aAAgBA,EAChB,OAAU,GACV,QAAW,MACX,QAAW,QACX,IAAOmL,EACP,QAAW,iBACX,WAAc,iCACd,YAAe,YACf,cAAiB,EACjB,OAAUsQ,GAIX5U,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC3CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEhD6E,EAAE6O,KAAKtJ,EAASkb,GAAY,SAAS3R,GACjC6U,EAAU7U,EACd,GA3EU,CA6Ed,CA8mBWsc,CAAuB1sB,EAAOqO,EAAM4W,EAC7C,EAKAgI,4CAA6C,SAAUjtB,EAAOqO,EAAM4W,GAClE,OAlnBJ,SAAqDjlB,EAAOqO,EAAM4W,GAGhE,IAAItO,EAAQ5Y,OAAOM,IAAI4lB,WACnBlT,EAAUhT,OAAOC,OAAOO,OAAOyB,GACnC,GAA2B,QAAvBjC,OAAOM,IAAI4I,SACb,IAAI0c,EAAQ5S,EAAQ/J,cAEhB2c,EAAQvgB,KAAKC,IAAKtF,OAAOM,IAAI4I,SAAU8J,EAAQ/J,UACrD2c,GAAgB,EAChB,IAAIpZ,EAAM7G,WAAWwC,KAAKgnB,uBAAuBvJ,EAAOhN,GAEpDwW,EAAW9e,EAAKuB,SAASwd,WAC7B,GACc,+BAAZD,GACe,oCAAZA,GACY,6BAAZA,EAEH,IAAI9B,EAAShd,EAAKuB,SAASc,YAAY6T,sBAGvC,KAAI8I,EAAOhf,EAAKuB,SAAS0d,cACrBC,EAAcF,EAAKjqB,KAAKoqB,MAAMH,EAAK5sB,OAAO,IAC1C4qB,EAAS,IAAI3nB,WAAW+pB,OAAOF,EAAYzN,EAAGyN,EAAYG,EAFxB,CAMxC,IAAI5hB,EAAO,IAAIpI,WAAWya,OACxBkN,EAAOjR,IAAM,EAAI7P,EACjB8gB,EAAOhR,IAAM,EAAI9P,EACjB8gB,EAAOjR,IAAM,EAAI7P,EACjB8gB,EAAOhR,IAAM,EAAI9P,GAGfojB,EAAS5vB,OAAOM,IAAIuvB,sBAAsBjb,WAC/B,eAAVgb,IACHA,EAAS,aAEX,IAAI5L,EAAa,CACd,OAAU/hB,EACV,aAAgBA,EAChB,OAAU,GACV,QAAW,MACX,QAAW,QACX,QAAW,iBACX,WAAc,iCACd,KAAQ8L,EAAK0P,SACb,cAAiB,GACjB,OAAU,IACV,MAAS,IACT,YAAe,YACf,IAAOmS,EACP,EAAK,GACL,EAAK,IAIJ9mB,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC7CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAE9C6E,EAAE6O,KAAKtJ,EAASkb,GAAY,SAAS3R,GAChC6U,GACDA,EAAUpe,EAASkb,EAAY3R,EAEnC,GACF,CAijBW6c,CAA4CjtB,EAAOqO,EAAM4W,EAClE,EAKA4I,wCAAyC,SAAUC,EAAmBC,EAAkBC,EAAe,cACrG,OArjBJ,SAAiDF,EAAmBC,EAAkBC,EAAe,cAEjG,IAAIjd,EAAU/S,EAAOO,OAAOuvB,GAC5B/vB,OAAOiT,mBAAoBD,EAAQ5F,KAAK,SAAU2T,GAE9C,IAAImP,EAAO,IAAIvqB,WAAWuE,OAAOimB,IAAIC,GACjC,CACIC,mBAAoBrwB,OAAOM,IAAIyR,gBAC/Bue,mBAAoBvP,EACpBwP,QAASxP,IAGbyP,EAAMN,EAAKO,UACX,oBACAT,EAAiBne,UAEnB6e,EAAgBT,EAAa,8BAO/B,GANAS,GAAgB/qB,WAAWuE,OAAOymB,IAAIvT,UAAUwT,MAAMtT,MAClD4S,EACAM,EAAI5mB,UAER8mB,GAAgB,MAEZ,mBAAoB1d,GAAW,WAAYA,EAAwB,eAAG,CACtE,IAAI6d,EAAU7d,EAAwB,eAAU,OAC5C6d,IAEAH,GADAG,EAAUA,EAAQ9tB,QAASgtB,EAAoB,IAAK,KAC3B,QAASW,EAE1C,CACA,GAAI,mBAAoB1d,GAAW,eAAgBA,EAAwB,eAAG,CAI1E,IAAI8d,EAAU9d,EAAwB,eAAc,WAChD8d,IACAJ,EAAgBI,EAAS,QAASJ,EAE1C,CACA,IAAIK,GAAkB,EACjB,oBAAqB9wB,EAAOf,SAA6C,QAAlCe,EAAOf,QAAQ6xB,kBACvDA,GAAkB,GAEtB,IAAI9e,EAAoBjS,OAAOkS,qBAAsB6d,EAAmBW,EAAe,KAAM,KAAMK,GAGnG,GAAqB,aAAjBd,EAA4B,CAC9B,IAAIe,EAAahB,EAAiBne,SAAS1M,QAAQ2M,UAAU9R,OAAOM,IAAIyR,gBAAiBgP,GAAOpO,YACnE,GAAzBqe,EAAWC,YAA6C,GAA1BD,EAAWE,aAC3CF,EAAWG,OAAO,IAAIxrB,WAAWya,OAC7B4Q,EAAWI,KAAO,KAClBJ,EAAWK,OAAS,KACpBL,EAAWM,MAAQ,KACnBN,EAAWO,IAAM,OAGvBtf,EAA2B,QAAQ,KAAI+e,EAAWvT,SAClDxL,EAA2B,QAAW,QAAIe,EAAQ5F,GACpD,CAGA7J,EAAE6O,KAAMH,EAAuB,IAAGA,EAA2B,SAAG,SAAS7D,GACjE,IAKIojB,EALU,IAAI7rB,WAAWuE,OAAOwH,QAAQ,CACxCC,iBAAiB,EACjB2e,mBAAoBtd,EAAQ5F,IAC5BijB,mBAAoBrwB,OAAOM,IAAIyR,kBAEXH,KAAMxD,GAC1BqjB,EAAQluB,EAAEjD,IAAIkxB,GAAW,SAASlhB,GAClC,OAAOA,EAAKJ,IAAI3E,MAAM,KAAK,EAC/B,IAEA,GAA6D,QAAzDvL,OAAO0xB,WAAWC,cAAcC,qBAAiC,CACjEH,EAAQxxB,EAAOO,OAAOuvB,GAAqC,iBAAE1Z,OAAOob,GACpE,IAAI,IAAIhvB,EAAE,EAAGA,EAAEgvB,EAAM/uB,SAAUD,EAC3B,IAAI,IAAIqH,EAAErH,EAAE,EAAGqH,EAAE2nB,EAAM/uB,SAAUoH,EAC1B2nB,EAAMhvB,KAAOgvB,EAAM3nB,IAClB2nB,EAAMjjB,OAAO1E,IAAK,EAGlC,MAAO,GAA6D,WAAzD9J,OAAO0xB,WAAWC,cAAcC,qBAAoC,CAC3E,IAAIC,EAAS5xB,EAAOO,OAAOuvB,GAAqC,iBAAE1Z,OAAO,IACzE,IAAQ5T,EAAE,EAAGA,EAAEgvB,EAAM/uB,SAAUD,EAAG,CAC9B,IAAIqvB,EAAWD,EAAOxmB,QAASomB,EAAMhvB,KACpB,GAAbqvB,GACAD,EAAOrjB,OAAOsjB,EAAU,EAChC,CACAL,EAAQI,CACZ,CACA5xB,EAAOO,OAAOuvB,GAAqC,iBAAI0B,EACvDzxB,OAAOwR,OAAOC,aAAa,wBACvB,CACI,YAAese,EACf,WAAc9vB,EAAOO,OAAOuvB,GAAqC,iBACjE,eAAiB,GAGjC,GACJ,GACJ,CAkdWD,CAAwCC,EAAmBC,EAAkBC,EACtF,EAKAlT,uBAAwB,SAAShB,EAAOuE,GACtC,OAAOvD,EAAuBhB,EAAOuE,EACvC,EAKAxD,uBAAwB,SAASf,EAAOuE,GACtC,OAAOxD,EAAuBf,EAAOuE,EACvC,EAKAtD,yCAA0C,SAASjB,EAAOuE,GACxD,OAAOtD,EAAyCjB,EAAOuE,EACzD,EAKA2L,QAAS,SAAUC,EAAOC,EAAQC,EAAOC,EAAUC,GACjD,OAAOL,GAAQC,EAAOC,EAAQC,EAAOC,EAAUC,EACjD,EAYAyF,oBAAqB,SAAUC,GAC7B,IAEIC,EADOlU,SAASmU,KAAKnvB,QAAQ,IAAK,IAChBwI,MAAM,KAC5B,IAAK,IAAI9I,KAAKwvB,EAAY,CACxB,IACItI,EADOsI,EAAWxvB,GACL8I,MAAM,KACvB,GAAoB,GAAhBoe,EAAMjnB,OAAa,CACrB,IAAI+T,EAAMkT,EAAM,GACZtZ,EAAMsZ,EAAM,GAChB,GAAIlT,GAAOub,EACT,OAAO3hB,CAEX,CACF,CACA,OAdc,IAehB,EAOA8hB,mBAAoB,SAAUC,EAAW1U,GACvC,OA/YJ,SAA6B0U,EAAW1U,GAEpC,IAAI2U,EAASD,EACTrsB,EAAQ,KACRvF,EAASF,EAAI8Q,gBAAiBpP,EAAUowB,IAI5C,GAHqB,GAAjB5xB,EAAOkC,SACTqD,EAAQvF,EAAO,KAEbuF,EACA,OAAO,EAMX,GALIA,EAAMrH,SACR2zB,EAAStsB,EAAMrH,OAAe,QAI3Bgf,GAAoB,IAAVA,EAKT4U,EAAUD,EAAS,IAAM3U,MALH,CAC1BA,EAAS,KACT,IAAI4U,EAAU,IAEhB,CAGAvsB,EAAMrH,OAAe,OAAI4zB,EACnB,mBAAoBryB,EAAOO,OAAO4xB,KACtCnyB,EAAOO,OAAO4xB,GAA2B,eAAI,CAAC,GAIhDnyB,EAAOO,OAAO4xB,GAA2B,eAAc,WAAI1U,EAG3D,IAAI6U,EAAO5sB,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC1CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAE1C8zB,EAAQ,CACV1pB,QAAS,MACT2pB,QAAS,iBACTlI,SAAU6H,EACV1U,OAAQ4U,GA4BV,OA1BA/uB,EAAE6O,KAAKmgB,EAAMC,GAAO,SAASpkB,GAC3B,IAAIskB,EAActkB,EAAOukB,aAElB5sB,EAAMrH,OAAe,OAC5BqH,EAAMrH,OAAoB,YAAIg0B,EAC9BzyB,EAAOO,OAAO4xB,GAA2B,eAAe,YAAIM,EAGxDzyB,EAAOO,OAAO4xB,GAAyB,cACM,QAA5CnyB,EAAOO,OAAO4xB,GAAyB,cACK,WAA5CnyB,EAAOO,OAAO4xB,GAAyB,cAG1CrsB,EAAMc,SAIR7G,OAAOwR,OAAOC,aAAa,0BACzB,CACE,YAAe2gB,EACf,OAAUE,EACV,eAAiB,GAGvB,KAEO,CACX,CA4UWH,CAAmBC,EAAW1U,EACvC,EAMAkV,yBAA0B,SAAUR,GAElC,OA7aJ,SAAmCA,GACjC,IACIrsB,EAAQ,KACRvF,EAASF,EAAI8Q,gBAAiBpP,EAAUowB,IACvB,GAAjB5xB,EAAOkC,SACTqD,EAAQvF,EAAO,WAIVuF,EAAMrH,OAAe,cACrBqH,EAAMrH,OAAoB,mBAC1BqH,EAAMrH,OAAmB,WAC1B,mBAAoBuB,EAAOO,OAAO4xB,KACtCnyB,EAAOO,OAAO4xB,GAA2B,eAAI,CAAC,GAEhDnyB,EAAOO,OAAO4xB,GAA2B,eAAc,WAAI,KAC3DnyB,EAAOO,OAAO4xB,GAA2B,eAAe,YAAI,KAC5DnyB,EAAOO,OAAO4xB,GAA2B,eAAU,OAAI,KACvDrsB,EAAMc,QACR,CA0ZW+rB,CAAyBR,EAClC,EAOAS,KAAM,WACJ,IAAIve,EAAOhW,KAEPwK,EAAUnD,WAAWwC,KAAKE,UAAU5J,QAAQY,IAC5CsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAI/C,MAAMo0B,EAAgB1zB,MAAMuG,WAAWwC,KAAKE,UAAU5J,QAAQwB,OAAQ0F,WAAWwC,KAAKC,mBAAmB3J,QAAQC,UAAUylB,MAAK,SAAUhlB,GACxI,IAAKA,EAAS4zB,GACZ,KAAM,sBAAwB5zB,EAASipB,OAAS,IAAMjpB,EAAS6zB,WAEjE,OAAO7zB,EAASM,MAClB,IAGMwzB,EAAwB7zB,MAAMuG,WAAWwC,KAAKE,UAAU5J,QAAQyB,eAAgByF,WAAWwC,KAAKC,mBAAmB3J,QAAQC,UAAUylB,MAAK,SAAUhlB,GACxJ,IAAKA,EAAS4zB,GACZ,KAAM,gCAAkC5zB,EAASipB,OAAS,IAAMjpB,EAAS6zB,WAE3E,OAAO7zB,EAASM,MAClB,IAGMyzB,EAAa9zB,MAAMuG,WAAWwC,KAAKE,UAAUS,EAASnD,WAAWwC,KAAKC,mBAAmB,CAAExJ,QAAS,MAAOC,QAAS,kBAAmBC,QAAS,YAAaqlB,MAAK,SAAUhlB,GAChL,IAAKA,EAAS4zB,GACZ,KAAM,mCAAqC5zB,EAASipB,OAAS,IAAMjpB,EAAS6zB,WAE9E,OAAO7zB,EAASW,MAClB,IACMqzB,EAAc/zB,MAAMuG,WAAWwC,KAAKE,UAAUS,EAASnD,WAAWwC,KAAKC,mBAAmB,CAAExJ,QAAS,OAAQC,QAAS,kBAAmBC,QAAS,YAAaqlB,MAAK,SAAUhlB,GAClL,IAAKA,EAAS4zB,GACZ,KAAM,oCAAsC5zB,EAASipB,OAAS,IAAMjpB,EAAS6zB,WAE/E,OAAO7zB,EAASW,MAClB,IACMszB,EAAah0B,MAAMuG,WAAWwC,KAAKE,UAAUS,EAASnD,WAAWwC,KAAKC,mBAAmB,CAAExJ,QAAS,MAAOC,QAAS,kBAAmBC,QAAS,YAAaqlB,MAAK,SAAUhlB,GAChL,IAAKA,EAAS4zB,GACZ,KAAM,mCAAqC5zB,EAASipB,OAAS,IAAMjpB,EAAS6zB,WAE9E,OAAO7zB,EAASW,MAClB,IAGA,IAAIuzB,EAEAC,EACAC,EAEJ,MAAMzV,EAAgB,IAAKiL,IAAIE,SAASlL,UAAWyV,aAE7CrwB,EAAY2a,EAAcmB,IAAI,SAC9BvB,EAASI,EAAcmB,IAAI,UAEjC,GAAG9b,GAAaua,EAAO,CAGnB,MACM+V,EAAY,CACdC,SAAUvwB,EACVwwB,WAAYjW,GAMhB,GAHA2V,GANY,IAAIj1B,GAMWw1B,WAAWH,GAGJ,SAA/B3V,EAAcmB,IAAI,SAAoB,CACvC,MACM4U,EAAY,CAChBC,aAAc3wB,EACd4wB,OAAQ5wB,EACR6wB,cAAe,GACfC,OAAQ,GAAG9wB,KAAaua,KAG1B4V,GARY,IAAI5zB,GAQY6zB,eAAeM,EAC7C,CACJ,CAGAzP,QAAQ8P,IAAI,CAACpB,EAAeG,EAAuBC,EAAYC,EAAaC,EAAYC,EAAsBC,IAAwBnP,MAAKgQ,IAEzIl0B,EAASk0B,EAAU,GACnBj0B,EAAiBi0B,EAAU,GAC3B,MAAMC,EAAcD,EAAU,GACxBE,EAAeF,EAAU,GACzBG,EAAcH,EAAU,GAE9B,IAAII,EAAiBJ,EAAU,IAAIlkB,WAAW,IAAIlC,KAC9CkC,EAAWkkB,EAAU,IAAIlkB,SAE7B,GAAGskB,EACD,IAAK,MAAMlH,KAAW8G,EAAU,GAAGlkB,SC1sLtBukB,ED2sLaD,GC3sLJE,ED2sLoBpH,EAAQtf,MC1sL9C,GAAKymB,EAAQ,KACvBA,EAAQ,GAAKC,EAAQ,IAEnBA,EAAQ,GAAKD,EAAQ,KACvBA,EAAQ,GAAKC,EAAQ,IAEnBA,EAAQ,GAAKD,EAAQ,KACvBA,EAAQ,GAAKC,EAAQ,IAEnBA,EAAQ,GAAKD,EAAQ,KACvBA,EAAQ,GAAKC,EAAQ,IDgsLbF,EC9rLHC,EAbF,IAAgBA,EAASC,ED+sLxBlB,EAAiBY,EAAU,GAE3B,MAAMO,EAAY,IAAIC,UAKtB,GAHA10B,EAAOf,QAAQ8O,aAAc,EAGzB,gBAAiB/N,EAAOf,SAAyC,QAA9Be,EAAOf,QAAQmK,YACpD,IAAK,IAAIlG,KAAalD,EAAOO,OAAQ,CACnC,IAAI2F,EAAclG,EAAOO,OAAO2C,GAChChC,EAAWgF,EAAYyC,IAAMzF,CAC/B,CAGF,IAAK,IAAIA,KAAalD,EAAOO,OAEvB,cADA2F,EAAclG,EAAOO,OAAO2C,KAC2B,IAAzBgD,EAAY0d,YAC5CziB,EAAa+E,EAAY0d,WAAa1gB,GACxCgD,EAAY2d,UAAY9hB,EAAUmB,GAIpC,MAAMyxB,EAAa,IAAIjvB,WAAWuE,OAAO2qB,gBAAgB,CAAC/pB,QAAQ,UAGlE,KAFA3K,EAAey0B,EAAUhjB,KAAKwiB,IAEZU,WAChB,KAAM,yBAIR,MAAM7qB,EAAa,IAAItE,WAAWuE,OAAOC,iBAAiB,CAAC,GAE3D,GAAI,oBADJ/J,EAAmB6J,EAAW2H,KAAKyiB,IACQ,CACzC,IAAIU,GAAWxxB,EAAE,sCACM,GAAnBwxB,GAASryB,QACXqyB,GAASlhB,OAAO,aAAezT,EAAiB40B,gBAAgBjqB,WAAW,GAAGkqB,MAAM,GAAK,0CAE3F70B,EAAmB,IACrB,CAGAC,EAAkBq0B,EAAUQ,gBAAgBZ,EAAa,mBACzD,IAAIla,GAAeC,KAEnB,IAAK,MAAME,KAAeH,GAAc,CACtC,IAAII,GAAWD,EAAYE,qBAAqB,QAAQ,GAAGC,YAE3D,KADIvX,EAAYnD,OAAO2a,kBAAkBH,KAEvC,GAAIA,MAAYva,EAAOO,OACrB2C,EAAYqX,QACT,GAAKA,MAAYpZ,GAAkBA,EAAaoZ,MAAava,EAAOO,OACvE2C,EAAY/B,EAAaoZ,SAEzB,IAAKpT,MAAKnH,EAAOO,OACf,GAAI4G,GAAEmE,MAAM,KAAK4G,KAAK,MAAQqI,GAAU,CACtCrX,EAAYiE,GACZ,KACF,CAKAjE,KAAalD,EAAOO,UAGtB2F,EAAclG,EAAOO,OAAO2C,IACpBonB,SAAW/P,GACvBnZ,EAAYmZ,IAAYrX,EAC1B,CAGAI,EAAE,aAAaqL,KAAKzO,EAAakP,SAAWlP,EAAakP,SAAW,IAGpE,IAAIylB,GAAa30B,EAAa20B,WAG9B70B,EAAOf,QAAQonB,sBAAwB6O,OAAOC,OAAO,CAAC,EAAGn1B,EAAOf,QAAQ4M,YAKxEwI,EAAKrU,OAASA,EACdqU,EAAK9C,OAAOC,aAAa,oBAAqB6C,GA77KpD,WACG,GACI,cAAerU,EAAOf,SACQ,QAA5Be,EAAOf,QAAQm2B,WACjB,mBAAoBp1B,EAAOf,SACQ,QAAjCe,EAAOf,QAAQo2B,gBACjB,gBAAiBr1B,EAAOf,SACQ,QAA9Be,EAAOf,QAAQq2B,aACjB,gBAAiBt1B,EAAOf,SACQ,QAA9Be,EAAOf,QAAQs2B,aACd,WAAYv1B,EAAOf,SACtB,kBAAmBe,EAAOf,SACQ,QAAhCe,EAAOf,QAAQu2B,eACjB,oBAAqBx1B,EAAOf,SACQ,QAAlCe,EAAOf,QAAQw2B,iBACjB,iBAAkBz1B,EAAOf,SACQ,QAA/Be,EAAOf,QAAQy2B,cACjB,kBAAmB11B,EAAOf,SACQ,QAAhCe,EAAOf,QAAQ02B,eACjB,gBAAiB31B,EAAOf,SACQ,QAA9Be,EAAOf,QAAQ22B,aACd,YAAa51B,EAAOf,SACvB,kBAAmBe,EAAOf,SACQ,QAAhCe,EAAOf,QAAQ42B,eACd,YAAa71B,EAAOf,SACvB,eAAgBe,EAAOf,SACQ,QAA7Be,EAAOf,QAAQ62B,YACd,YAAa91B,EAAOf,SACvB,eAAgBe,EAAOf,SACQ,QAA7Be,EAAOf,QAAQ82B,YACjB,eAAgB/1B,EAAOf,SACQ,QAA7Be,EAAOf,QAAQ+2B,YACjB,iBAAkBh2B,EAAOf,SACQ,QAA/Be,EAAOf,QAAQg3B,cACjB,iBAAkBj2B,EAAOf,SACQ,QAA/Be,EAAOf,QAAQi3B,aACjB,CACAhP,QAAQC,KAAK,aAAeD,QAAQC,KAAK,eAEzC,IAAI7V,EAAOtR,EAAOf,QAAQ4M,WACnByF,EAAKxF,OAAOob,QAAQC,OACzBD,QAAQC,KAAK7V,EAAKxF,KAAKwF,EAAK6kB,OAC9B,IAAItqB,EAAa,IAAInG,WAAWqH,WAAWuE,EAAKxF,KAE5CsqB,EAAU,IAAI1wB,WAAWqH,WAAW,aACxCuE,EAAKxF,IAAM,YACXwF,EAAK6kB,MAAQjP,QAAQC,KAAK,aAG1B,IAAIrZ,EAAO9N,EAAOf,QAAQ6O,KACtB2c,EAAS,IAAI/kB,WAAWya,OAAOtb,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,KAE/FA,GADA2c,EAASA,EAAO5Y,UAAUhG,EAAWuqB,IACvBC,UAEd,IAAI31B,EAAS,GAWb,GAVI,cAAeV,EAAOf,UACxByB,EAASV,EAAOf,QAAQq3B,WACJ,GAAjB51B,EAAO+B,SACV/B,EAAS,CAACV,EAAOf,QAAQgK,SAASjJ,EAAOf,QAAQ+J,WAEnDhJ,EAAOf,QAAQ4M,WAAayF,EAC5BtR,EAAOf,QAAQ6O,KAAOA,EACtB9N,EAAOf,QAAQs3B,gBAAkB,GAG5B,kBAAmBv2B,EAAOf,SAAkD,GAAvCe,EAAOf,QAAQu3B,cAAc/zB,OAAc,CACnF,IAAIg0B,EAAWz2B,EAAOf,QAAQu3B,cAC1BA,EAAgB,IAAI9wB,WAAWya,OAAOtb,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,KACtHD,EAAgBA,EAAc3kB,UAAUhG,EAAWuqB,GACnDp2B,EAAOf,QAAQu3B,cAAgBA,EAAcH,SAC/C,EAIM,cAAer2B,EAAOf,SAAwC,QAA5Be,EAAOf,QAAQm2B,WACjD,mBAAoBp1B,EAAOf,SAA6C,QAAjCe,EAAOf,QAAQo2B,gBACtD,gBAAiBr1B,EAAOf,SAA0C,QAA9Be,EAAOf,QAAQq2B,aACnD,gBAAiBt1B,EAAOf,SAA0C,QAA9Be,EAAOf,QAAQs2B,aAA0B,WAAYv1B,EAAOf,SAChG,gBAAiBe,EAAOf,SAA0C,QAA9Be,EAAOf,QAAQ22B,aAA0B,YAAa51B,EAAOf,SACjG,kBAAmBe,EAAOf,SAA4C,QAAhCe,EAAOf,QAAQ42B,eAA4B,YAAa71B,EAAOf,SACrG,eAAgBe,EAAOf,SAAyC,QAA7Be,EAAOf,QAAQ62B,YAAyB,YAAa91B,EAAOf,SAC/F,eAAgBe,EAAOf,SAAyC,QAA7Be,EAAOf,QAAQ82B,YAClD,eAAgB/1B,EAAOf,SAAyC,QAA7Be,EAAOf,QAAQ+2B,cACtDh2B,EAAOf,QAAQs3B,gBAAkB,KAE7B,kBAAmBv2B,EAAOf,SAA4C,QAAhCe,EAAOf,QAAQu2B,eACrD,iBAAkBx1B,EAAOf,SAA2C,QAA/Be,EAAOf,QAAQy2B,cACpD,iBAAkB11B,EAAOf,SAA2C,QAA/Be,EAAOf,QAAQi3B,gBACxDl2B,EAAOf,QAAQs3B,gBAAkB,IAE9B,oBAAqBv2B,EAAOf,SAA6C,QAAlCe,EAAOf,QAAQw2B,kBACzDz1B,EAAOf,QAAQs3B,gBAAkB,IAE9B,iBAAkBv2B,EAAOf,SAA0C,QAA/Be,EAAOf,QAAQg3B,eACtDj2B,EAAOf,QAAQs3B,gBAAkB,IAEnCv2B,EAAOf,QAAQgK,SAAW,kBAC1BjJ,EAAOf,QAAQ+J,SAAW,mBAC1B,IAAI0tB,EAAkB,mBAAoB12B,EAAOf,SAA6C,QAAjCe,EAAOf,QAAQ03B,eAC5E,IAAMD,EACJ,IAAM,IAAIvvB,KAAKnH,EAAOO,OACpB,GAAsC,QAAjCP,EAAOO,OAAO4G,GAAc,UAAc,CAC7CuvB,GAAgB,EAChB,KACF,CAKCA,IACH12B,EAAOf,QAAQs3B,gBAAkB,IAGnC,IAAIpqB,EAAc,GAClB,GAAqB,GAAjBzL,EAAO+B,OAAc,CACvB/B,EAAOuS,MAAK,SAASC,EAAGC,GACtB,OAAOtO,OAAOsO,GAAKtO,OAAOqO,EAC5B,IAOA,IANA,IAAIjK,EAAWvI,EAAO,GAClB0L,EAAS1G,WAAWwC,KAAKgnB,uBAAuBjmB,EAAUmtB,EAAQ9kB,KAAKqH,OACvE3P,EAAWtI,EAAOA,EAAO+B,OAAO,GAChCm0B,EAASlxB,WAAWwC,KAAKgnB,uBAAuBlmB,EAAUotB,EAAQ9kB,KAAKqH,OACvEpM,EAAM,gBACN+C,EAAI,EACA/C,EAAMqqB,GAAUtnB,EAAItP,EAAOf,QAAQs3B,iBACpChqB,EAAMH,GAETD,EAAYpC,KAAKwC,GAEnBA,GAAU,EACV+C,IAEFlD,EAASD,EAAY,GACrByqB,EAASzqB,EAAYA,EAAY1J,OAAO,GAEpCwG,EAAWvD,WAAWwC,KAAK2uB,uBAAuBzqB,EAAQgqB,EAAQ9kB,KAAKqH,OACvE3P,EAAWtD,WAAWwC,KAAK2uB,uBAAuBD,EAAQR,EAAQ9kB,KAAKqH,MAC7E,CACA3Y,EAAOf,QAAqB,YAAIkN,EAEN,GAAtBA,EAAY1J,SACdzC,EAAOf,QAAQs3B,gBAAkBpqB,EAAY1J,OAC7CzC,EAAOf,QAAQgK,SAAWA,EAC1BjJ,EAAOf,QAAQ+J,SAAWA,EAG/B,CAEJ,CA0yKM8tB,GAEA,IAAIC,GAAalC,GAAW3rB,aAAa,GACzCO,EAAastB,GAAYn2B,GACzBoN,EAAYpN,GAGZyT,EAAKrU,OAASA,EACdqU,EAAKpU,eAAiBA,EACtBoU,EAAKzT,KAAOA,EACZyT,EAAK9C,OAAOC,aAAa,cAAe6C,GAv3J9C,SAAyB0iB,GAEvB,GAAKC,SACD,IAAK,IAAIlrB,KAAOkrB,SACLlrB,KAAOob,QAAQC,OACpBD,QAAQC,KAAKrb,GAAKkrB,SAASlrB,IAMrC,IAAIwF,EAAOtR,EAAOf,QAAQ4M,WACnByF,EAAKxF,OAAOob,QAAQC,OACzBD,QAAQC,KAAK7V,EAAKxF,KAAKwF,EAAK6kB,OAC9B,IAAItqB,EAAa,IAAInG,WAAWqH,WAAWuE,EAAKxF,KAEhD,KAAOwF,EAAKxF,OAAOpG,WAAWqH,WAAWC,YACrCtH,WAAWqH,WAAWC,SAASsE,EAAKxF,KAAOD,EAGtCyF,EAAKxF,OAAOirB,EAAWjpB,MAAO,CAC/B,IAAImpB,EAAUF,EAAWjpB,KAAKwD,EAAKxF,KAAKgC,KACpCopB,EAAYxxB,WAAWya,OAAOgX,UAAWF,GAC5BvxB,WAAWya,OAAOgX,UAAWn3B,EAAOf,QAAQu3B,eAC5CY,iBAAkBF,KAC/BxxB,WAAWqH,WAAWC,SAASsE,EAAKxF,KAAKY,IAAK,EACtD,CAEN,CA81JM2qB,CAAgBN,IAv1JtB,SAAmBP,GAEjB,IAAIllB,EAAOtR,EAAOf,QAAQ4M,WACtBA,EAAa,IAAInG,WAAWqH,WAAWuE,EAAKxF,KAG5CgC,EAAO9N,EAAOf,QAAQ6O,KACtB2c,EAAS,IAAI/kB,WAAWya,OAAOtb,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,KAE3FwpB,EAAmB7M,EAAO9E,MAAM,GAEpC,GAAG6Q,GACCA,EAAgB,IAAI9wB,WAAWya,OAAOqW,IACxB3kB,UAAU,IAAInM,WAAWqH,WAAW,aAAclB,QAGhE,GADA2qB,EAAgB/L,EAAOvlB,QAClB,kBAAmBlF,EAAOf,SAAkD,GAAvCe,EAAOf,QAAQu3B,cAAc/zB,OAAc,CACnF,IAAIg0B,EAAWz2B,EAAOf,QAAQu3B,cAC9BA,EAAgB,IAAI9wB,WAAWya,OAAOtb,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,IAAI5xB,OAAO4xB,EAAS,IACpH,CAIJ,IAAIc,EAAYj0B,EAAE,QAAQG,SAAS,GAAG+zB,aAClCD,IACAA,EAAYj0B,EAAE,UAAUa,eAC5BozB,GAAwBj0B,EAAE,WAAWc,SACrCmzB,GAAwBj0B,EAAE,eAAec,SACzCd,EAAE,QAAQc,OAAOmzB,GAIjBp0B,IAEA,IAAIzC,EAAS,GACTyL,EAAc,GACd,gBAAiBnM,EAAOf,QAC1BkN,EAAcnM,EAAOf,QAAQkN,YACtB,cAAenM,EAAOf,UAC7ByB,EAASV,EAAOf,QAAQq3B,WAC1B51B,EAAOuS,MAAK,SAASC,EAAGC,GACtB,OAAOtO,OAAOsO,GAAKtO,OAAOqO,EAC5B,IAGA,IADA,IAAIukB,EAAU,GACU,GAAjB/2B,EAAO+B,QAAY,CACxB,IAAIkjB,EAAQjlB,EAAOyiB,IAAI,IACa,GAAhC7f,EAAE2I,QAAS0Z,EAAO8R,IACpBA,EAAQ1tB,KAAM4b,EAClB,CACAjlB,EAAS+2B,EAIT/xB,WAAWwC,KAAKwvB,sBAAwB,EACxChyB,WAAWgyB,sBAAwB,EACnChyB,WAAWwC,KAAKyvB,kBAAkB,IAElCt3B,EAAM,IAAIqF,WAAWkyB,IAAI,MACtB,CACCp3B,SAAS,CACP,IAAIkF,WAAW2V,QAAQwc,WAAW,CAACC,kBAAmB,CAACC,SAAU,QAElEC,YAAa,KACbC,eAAe,CACfC,QAAS,WAEN,IAAIj5B,EAAU,CACV8W,YAAc,aAOlB,SAASM,EAAS3L,GACd,GAAmB,GAAfA,EAAKjI,OACT,OAAO,KAIP,IAFA,IAAI6T,EAAa5L,EAAK,GAAG6L,UAAUjL,MAAM,KAEjCkL,EAAI,EAAGA,EAAIF,EAAW7T,OAAQ+T,IACtC,GAAGF,EAAWE,GAAKC,MAAMxX,EAAQ8W,aAC7B,OAAOzS,EAAEoH,GAAMuL,SAAS,IAAMK,EAAWE,GAAKE,UAAUzX,EAAQ8W,YAAYtT,SAIhF,OAAO,IACX,CAEA,SAASkU,EAAYjM,GAEjB,IADA,IAAIkM,EAAY,GACVlM,EAAO2L,EAAS3L,IACtBkM,EAAUA,EAAUnU,QAAUiI,EAAK,GAEnC,OAAOkM,CACX,CAED,IAAK,IAAIpU,EAAE,EAAEqD,EAAItF,EAAOkC,OAAQD,EAAEqD,EAAKrD,IAAK,CAC1C,IAAIsD,EAAQvF,EAAOiC,GACf2Q,EAAI7P,EAAE,yCAAyCwC,EAAMG,KAAK,MAAM6Q,QAEpE,GAAIhR,EAAMqyB,SAAWhlB,EAAE5P,SAAS,YAAa,EACvCiU,EAAKrE,EAAEwC,QAAQ,MAAMmB,SACtB9S,YAAY,YAAYoR,KAAK,UAAUpR,YAAY,YACtD,IAAI4S,EAAYD,EAAYa,GAC5BlU,EAAE4D,KAAK0P,GAAU,SAASpU,EAAE0Q,GAC1B5P,EAAE4P,GAAGlP,YAAY,YAAYoR,KAAK,UAAUpR,YAAY,WAC1D,IACIwT,EAAGpC,KAAK,wBAAwB7R,SAAS,YAC3CuC,EAAMsR,eAAc,EACxB,MAAO,IAAKtR,EAAMqyB,UAAYhlB,EAAE5P,SAAS,YAAa,CACpD,IAAIiU,KAAKrE,EAAEwC,QAAQ,MAAMmB,SACtBtT,SAAS,YAAY4R,KAAK,UAAU5R,SAAS,YAC5CgU,EAAGjU,SAAS,cACdiU,EAAG4gB,WACDxhB,EAAYD,EAAYa,GAC5BlU,EAAE4D,KAAK0P,GAAU,SAASpU,EAAE0Q,GACvBA,EAAI5P,EAAE4P,GACN,IAhDYxI,EAgDRiN,EAAQ,EACRC,EAAU,EACVygB,GAlDQ3tB,EAkDWwI,EAjDpB5P,EAAEoH,GAAMuL,SAAS,MAAQhX,EAAQ8W,YAAcrL,EAAK,GAAG/B,KAkD1DrF,EAAE4D,KAAKmxB,GAAM,SAASxuB,EAAEkO,GACtBzU,EAAEyU,GAAK3C,KAAK,mBAAmBlO,MAAK,SAAS1E,EAAE2Q,GACzC7P,EAAE6P,GAAG5P,SAAS,aAChBqU,IACFD,GACF,GACF,IACCA,GAASC,EACX1E,EAAE1P,SAAS,YAAY4R,KAAK,UAAU5R,SAAS,YAE/C0P,EAAElP,YAAY,YAAYoR,KAAK,UAAUpR,YAAY,WACzD,GACF,CACF,CAGAV,EAAE,sBAAsBI,OAC1B,GAGDyV,UAAUsR,EACV6M,iBAAkBA,EAClBd,cAAcA,EACdvtB,SAA2B,GAAjBvI,EAAO+B,OAAczC,EAAOf,QAAQ+J,SAAW,OACzDA,SAA2B,GAAjBtI,EAAO+B,OAAczC,EAAOf,QAAQgK,SAAW,OACzDoD,cAAgC,GAAjB3L,EAAO+B,OAAczC,EAAOf,QAAQs3B,gBAAkB71B,EAAO+B,OAC5E/B,OAAyB,GAAjBA,EAAO+B,OAAc,KAAO/B,EACpCyL,YAAmC,GAAtBA,EAAY1J,OAAc,KAAO0J,EAC9CN,WAAWA,EACX8M,MAAgC,OAA1B9M,EAAWyF,KAAKqH,MAAiB9M,EAAWyF,KAAKqH,MAAQ,UAC/D2f,YAAkC,GAArBh4B,EAAWmC,UAExB81B,WAAW,IAAI7yB,WAAW2V,QAAQmd,YAAY,CAACC,IAAIzP,SAAS0P,eAAe,kBAG/E54B,OAAO64B,iBAAiB,SAAUx1B,EACpC,CA0rJMy1B,CAAUtE,GACVjgB,EAAKhU,IAAMA,EACXgU,EAAK9T,OAASA,EACd8T,EAAK/T,WAAaA,EAClB+T,EAAK7T,SAAWA,EAChB6T,EAAK9C,OAAOC,aAAa,aAAc6C,GAGvCU,IACAV,EAAK9C,OAAOC,aAAa,cAAe6C,GAIxC,IAAIwkB,GAAkBx4B,EAAIE,OAAOF,EAAIE,OAAOkC,OAAS,GAAGq2B,YACpDD,GAAkBx4B,EAAI04B,aAAsB,QAAI,MAClD14B,EAAI04B,aAAsB,QAAIF,GAAkB,IAChDx4B,EAAI04B,aAAoB,MAAI14B,EAAI04B,aAAsB,QAAI,GACtD14B,EAAI04B,aAAoB,MAAI14B,EAAI04B,aAAsB,QAAI,KAC5D14B,EAAI04B,aAAsB,QAAI14B,EAAI04B,aAAoB,MAAI,KAK9D,IA1qHAC,GAEAC,GAwqHIC,IAAsB,EACtBC,GAAYzzB,WAAWwC,KAAKkxB,cAAct5B,OAAOge,SAAS3S,MAC9D,IAAK9K,EAAImG,YAAa,CACpB,GAAI2yB,GAAUrrB,MAAQqrB,GAAUE,KAAM,CACpC,IAAIC,GAAW,KAUf,GATIH,GAAUrrB,OACZwrB,GAAW5zB,WAAWya,OAAOgX,UAAUgC,GAAUrrB,OAC/CqrB,GAAUE,OACZC,GAAW5zB,WAAWya,OAAOgX,UAAUgC,GAAUE,OAE/CF,GAAUhsB,KAAOgsB,GAAUhsB,KAAO9M,EAAIyR,iBACxCwnB,GAASznB,UAAUsnB,GAAUhsB,IAAK9M,EAAIyR,iBACpCqnB,GAAUI,KAAOJ,GAAUI,KAAOl5B,EAAIyR,iBACxCwnB,GAASznB,UAAUsnB,GAAUI,IAAKl5B,EAAIyR,iBACpCzR,EAAIi3B,iBAAiBkC,eAAeF,IACtCj5B,EAAIoS,aAAa6mB,IAAU,OACxB,CACH,IAAIG,GAAWn2B,EAAE,mBAAmBzD,QACpC45B,GAAW/zB,WAAWya,OAAOC,WAAWqZ,KAC3BD,eAAeF,IAE1BtmB,GADe1P,EAAE,mBAAmBzD,QACP,SAAUihB,GACrCwY,GAASznB,UAAUiP,EAAOzgB,EAAIyR,iBAC9BzR,EAAIoS,aAAa6mB,IAAU,EAC7B,IAEAj5B,EAAIoS,aAAapS,EAAIm2B,cAEzB,CACF,MACEn2B,EAAIoS,aAAapS,EAAIm2B,eAEvB,GAAGlC,EAAe,CAChB,IAAIvpB,GAAS,IAAIrF,WAAWuE,OAAOwH,QAAQ,CACvCC,iBAAiB,IAEjBgoB,GAAcr5B,EAAI8Q,gBAAgB,eAAe,GACrD,IAAK,MAAMic,KAAWpd,EACpB,GAAwB,MAApBod,EAAQxb,SAAiB,CACzB,IAAIvB,GAAOtF,GAAO4G,KAAKyb,GAAS,GAChC/c,GAAKuB,SAASC,UAAU,YAAaxR,EAAIyR,iBACzC4nB,GAAYnnB,YAAY,CAAClC,KACzBqpB,GAAYtiB,eAAc,EAC9B,CAEJ,CACA8hB,IAAsB,CACxB,CAEA/1B,IACA9C,EAAIkR,OAAOC,aAAa,UAAW,CAAE,aAAe,IAp1H1D,WAmEE,GAlEAlO,EAAE,sBAAsBc,OAAOgB,KAAKC,IAAI,GAAqB,EAAlBhF,EAAIgM,gBAAkBstB,OAAO,CACtEC,YAAY,WACZr0B,IAAK,EACLF,IAAKhF,EAAIgM,cAAc,EACvBwH,OAAQ,SAASK,EAAIC,GACfA,EAAG+J,MAAQ7d,EAAIsG,UAAU0F,cAAc,GACzC/I,EAAE,sBAAsBq2B,OAAO,QAAQt5B,EAAIw5B,WAC3Cv2B,EAAE,oBAAoBS,KAAK,QAAQ,WACjCjE,OAAOyU,YAAW,WAAWjR,EAAE,oBAAoBM,KAAK,OAAO,GAAE,IACnE,KACUuQ,EAAG+J,OAAS7d,EAAIy5B,MAC1Bz5B,EAAI05B,OAAO5lB,EAAG+J,MAClB,IAEF5a,EAAE,sBAAsBI,OAAM,WAC5B,IAAI2Q,EAAO/Q,EAAEjF,MACb,GAAIgW,EAAK9Q,SAAS,UAChB,OAAO,EACTD,EAAE,uBAAuBU,YAAY,UACrCqQ,EAAK7Q,SAAS,UACd,IAAIw2B,EAAU35B,EAAI45B,mBAAmB,iCAAiC,GACtED,EAAQE,QAAQC,QAAUH,EAAQI,eAClCJ,EAAQE,QAAQG,QAAQF,QAAUH,EAAQI,eAC1CJ,EAAQE,QAAQG,QAAQC,YAAYH,QAAUH,EAAQI,eACtDJ,EAAQO,SAASC,MAAMC,WACd,YAAaj6B,GAAcA,EAASk6B,QAAQC,UAC5C,gBAAiBn6B,IAAsC,OAAzBA,EAASo6B,aAC5Cp6B,EAASo6B,YAAYH,UAC3B,IACAn3B,EAAE,uBAAuBI,OAAM,WAC7B,IAAI2Q,EAAO/Q,EAAEjF,MACb,GAAIgW,EAAK9Q,SAAS,UAChB,OAAO,EACTD,EAAE,sBAAsBU,YAAY,UACpCqQ,EAAK7Q,SAAS,UACR,gBAAiBhD,GAAsC,OAAzBA,EAASo6B,aACvCp6B,EAASo6B,YAAYrf,aAC3B,IAAIye,EAAU35B,EAAI45B,mBAAmB,iCAAiC,GACtED,EAAQO,SAASC,MAAMjf,aACvBye,EAAQE,QAAQC,QAAU,KAC1BH,EAAQE,QAAQG,QAAQF,QAAU,KAClCH,EAAQE,QAAQG,QAAQC,YAAYH,QAAU,IAChD,IACA72B,EAAE,8BACDI,OAAM,WACL,IAAIm3B,EAAajd,IACb,WAAYid,EACd1b,EAAc0b,GAGdx6B,EAAIoS,aAAapS,EAAIm2B,cAEzB,IACAlzB,EAAE,0BACDI,OAAM,WACDrD,EAAIw5B,WAAax5B,EAAIsG,UAAU0F,cAAc,EAC7C/I,EAAE,oBAAoBS,KAAK,QAAQ,WACjCjE,OAAOyU,YAAW,WAAWjR,EAAE,oBAAoBM,KAAK,OAAO,GAAE,IACnE,IAEFvD,EAAIy6B,QACR,IACAx3B,EAAE,2BACDI,OAAM,WACLrD,EAAI06B,SACN,IACM,gBAAiB/6B,EAAOf,SACU,QAAjCe,EAAOf,QAAqB,YAAa,CAC9C,IAAI+7B,EAAS,IAAIt1B,WAAW2V,QAAQ4f,kBACpC56B,EAAI66B,YAAY,CAACF,IACjB13B,EAAE,2BAA2BI,OAAM,WACjC,IAAI0X,EAAO/a,EAAI45B,mBAAmB,wCAAwC,GACtE7e,GAAqC,GAA7BA,EAAK+f,cAAc14B,QAC7B2Y,EAAKggB,kBACHhgB,GAAQA,EAAKigB,SAASV,OACxBr3B,EAAEjF,MAAM2F,YAAY,YAEpBV,EAAEjF,MAAMmF,SAAS,YACf4X,GAAQA,EAAK2J,KAAK4V,OACpBr3B,EAAE,uBAAuBU,YAAY,YAErCV,EAAE,uBAAuBE,SAAS,WACtC,IACAF,EAAE,uBAAuBI,OAAM,WAC7B,IAAI0X,EAAO/a,EAAI45B,mBAAmB,wCAAwC,GACtE7e,GAAiC,GAAzBA,EAAKkgB,UAAU74B,QACzB2Y,EAAKmgB,cACHngB,GAAQA,EAAK2J,KAAK4V,OACpBr3B,EAAEjF,MAAM2F,YAAY,YAEpBV,EAAEjF,MAAMmF,SAAS,YACf4X,GAAQA,EAAKigB,SAASV,OACxBr3B,EAAE,2BAA2BU,YAAY,YAEzCV,EAAE,2BAA2BE,SAAS,WAC1C,IACAnD,EAAIkR,OAAOgE,GAAG,CACZimB,QAAU,WACR,IAAIpgB,EAAO/a,EAAI45B,mBAAmB,wCAAwC,GACtE7e,GAAqC,GAA7BA,EAAK+f,cAAc14B,OAC7Ba,EAAE,2BAA2BU,YAAY,YAEzCV,EAAE,2BAA2BE,SAAS,YACpC4X,GAAiC,GAAzBA,EAAKkgB,UAAU74B,OACzBa,EAAE,uBAAuBU,YAAY,YAErCV,EAAE,uBAAuBE,SAAS,WACtC,GAEJ,MACEF,EAAE,sBAAsB+W,QAE5B,CAsuHMohB,GA/tHAzC,GAAgBh5B,EAAOf,QAEvBg6B,GAu1BN,WAEI,IAAIyC,GAAkB,EACtB,IAAM,IAAIv0B,KAAKnH,EAAOO,OAAS,CAC3B,IAAI2F,EAAclG,EAAOO,OAAO4G,GAC5Bw0B,EAAe,KAGnB,GAFM,kBAAmB37B,GAAYmH,KAAKnH,EAAO47B,gBAC7CD,EAAe37B,EAAO47B,cAAcz0B,IACnCjB,GAAeA,EAAY4V,OAA8B,QAArB5V,EAAY4V,OAChD6f,IAA8D,QAA5CA,EAAaz7B,aAAa27B,gBACmB,QAA7CF,EAAaz7B,aAAa47B,iBACiB,QAA3CH,EAAaz7B,aAAa67B,eAA4B,CACzEL,GAAkB,EAClB,KACJ,CACJ,CACA,IAAMA,EACJ,OAAO,KAGT,GAAI,kBAAmB17B,EAAOf,SACM,OAAhCe,EAAOf,QAAQ+c,gBACd1Y,EAAE,4CAA4Cb,OAAS,CAEjD,oBAAqB0M,UAC1BA,QAAQ,mBAAqB,yCAE/B,IACI+M,EAAW,uCAAuC/M,QAAQ,mBAAmB,cACjF6c,GAFuB,eAEG,QAAShsB,EAAOf,QAAQ+c,cAAeE,EAAU,gBAC3E5Y,EAAE,wBAAwBI,OAAM,WACzBJ,EAAEjF,MAAMoF,SAASF,SAAS,YAEzB0N,EAAe,eAEf3N,EAAE,kCAAkCqL,KAAK,uCAAuCQ,QAAQ,mBAAmB,eAEnH,GAEJ,CAEA,IAioEE6sB,EAjoEEC,EAAoB,IAAIv2B,WAAW2V,QAAQ4gB,kBAAkB,CAC3D5zB,IAAK7J,QAAQqK,QACbwC,MAAO,gCACPxK,KAAK6E,WAAW2V,QAAQ6gB,YACxBC,cAAc,EACdC,WAAY,YACZC,cA2nEJL,EAAal7B,EACb,mBAAoBd,EAAOf,SACxB,kBAAmBe,EAAOf,SAC1B,qBAAsBe,EAAOf,UAElC+8B,EAAa,CACX,mBAAsBh8B,EAAOf,QAAQq9B,eACrC,kBAAqBt8B,EAAOf,QAAQs9B,cACpC,qBAAwBv8B,EAAOf,QAAQu9B,mBAGpCR,GAroECS,eAAgB,CACd/4B,MAAO,CACLg5B,eAAgB,KAGpBzE,eAAgB,CACZ0E,eAAgB,SAASnnB,GACrBgG,EAAsBhG,EAAM3V,KAAM2V,EAAMiG,GAC5C,KAGX,GAAIjd,QAAQoL,eAAiD,GAAhCpL,QAAQoL,cAAcnH,OAAc,CAE9D,IADA,IAAIm6B,EAAY,GACP/yB,EAAE,EAAGC,EAAKtL,QAAQoL,cAAcnH,OAAQoH,EAAEC,EAAMD,IACvD+yB,EAAU7yB,KACRrE,WAAWwC,KAAKE,UACd5J,QAAQoL,cAAcC,GACtBnE,WAAWwC,KAAKC,mBAAmB3J,QAAQC,UAIjDw9B,EAAkBW,UAAYA,CACjC,CA+DA,SAASC,EAAuB3oB,GAC5B,GAAMA,EAAI4oB,cAAV,CAED,GAAuB,MAAlBv7B,EACD,OAAO,EACX,IAAIw7B,EAAS18B,EAAI28B,mBAAmBz7B,GACpC,KAAK+B,EAAE,4CAA4Cb,OAAS,GACvDa,EAAE,yDAAyDb,OAAS,GADzE,CAIA,IAAIsZ,EAAmB,kBAC8E,GAAhGzY,EAAE,IAAIyY,EAAiB,+DAA+DtZ,SACvFsZ,EAAmB,gBAGvB,IAAIkhB,GAAc,EAClB35B,EAAE,IAAIyY,EAAiB,+DAA+D7U,MAAK,WACvF,IACIkJ,EADO9M,EAAEjF,MACE+R,MACXH,EAAMG,EAAI9E,MAAM,KAAK6X,MACrBrI,EAAU1K,EAAItN,QAAS,IAAMmN,EAAK,IAClCsJ,EAAUxZ,OAAOwhB,mBAAoBzG,GACzC,GAAKvB,GAAWA,EAAQ,IAAMrF,EAAIoG,YAE9B,OADA2iB,GAAc,GACP,CAEf,IACKA,IAED35B,EAAE,IAAIyY,EAAiB,sEAAsE7H,EAAI4G,QAAQ,IAAI5G,EAAI2X,UAAU,MAAMpoB,SAAS4W,SAC1I4hB,EAAkBzJ,QAASuK,EAAQ,CAAC,GAtB9B,CANA,CA+Bb,CA8EA,OA7KAd,EAAkBiB,WAAa,WAC5B,IAGIp3B,EAAOuC,EAHP80B,EAAa9+B,KAAKkC,QAAUlC,KAAKgC,IAAIE,OACrCA,EAAS,GACT4pB,EAAc,EAElB,MAAMiT,EAAkB,GACxB,IAAI,IAAI56B,EAAE,EAAGqD,EAAIs3B,EAAW16B,OAAQD,EAAEqD,IAAOrD,EAEzC,KADAsD,EAAQq3B,EAAW36B,cACGkD,WAAWK,MAAMtG,KAAOqG,aAAiBJ,WAAWK,MAAMs3B,SAC1Eh/B,KAAK89B,cAAiBr2B,EAAMw3B,iBAAmBx3B,EAAMy3B,oBAAuB,CAC9E,IAAIv3B,EAAW,KACVF,EAAMG,QAAQhF,IACf+E,EAAW/C,EAAwB6C,EAAMG,OAC7C,IAAIC,EAAc,KACbF,IACDE,EAAclG,EAAOO,OAAOyF,IAC1BE,IACFA,EAAclG,EAAOO,OAAOuF,EAAMrH,OAAe,SAC/CyH,IACFA,EAAclG,EAAOO,OAAOuF,EAAMG,OACrC,IAAI01B,EAAe,KAQnB,GAPI,kBAAmB37B,KACnB27B,EAAe37B,EAAO47B,cAAc51B,MAEjC21B,EAAe37B,EAAO47B,cAAc91B,EAAMrH,OAAe,SACtDk9B,IACHA,EAAe37B,EAAO47B,cAAc91B,EAAMG,QAE5CC,GAAeA,EAAY4V,OAA8B,QAArB5V,EAAY4V,OAChD6f,IAA8D,QAA5CA,EAAaz7B,aAAa27B,gBACmB,QAA7CF,EAAaz7B,aAAa47B,iBACiB,QAA3CH,EAAaz7B,aAAa67B,eAA4B,CAC1E1zB,EAAM3C,WAAWwC,KAAK6mB,QAAQjpB,EAAMuC,KAAOvC,EAAMuC,IAAI,GAAKvC,EAAMuC,KAG1C,IAAnBhK,KAAKm/B,WAAwBn/B,KAAKgK,MACjChK,KAAKgK,IAAMA,GAIf,MAAMo1B,EAAcv3B,GAA8B,gBAAiB,YAC/Du3B,GACFL,EAAgBrzB,KAAK0zB,GAGvBl9B,EAAOwJ,KAAKjE,GAEP,qBAAsBI,IAAgBoN,MAAM7O,SAASyB,EAAYmd,mBAClE8G,GAAe1lB,SAASyB,EAAYmd,kBAEpC8G,GAAe,EACtB,CACL,CAQJ,OANA9rB,KAAK8rB,YAA6B,GAAfA,EAAmB,GAAKA,EAExCiT,EAAgB36B,SACjBpE,KAAKg+B,aAA0B,YAAIe,EAAgBlrB,KAAK,MAGnD3R,CACV,EAmCAR,OAAOwR,OAAOgE,GAAG,CACd,wBAA2B,SAAUrB,GAGjC,IAAIwpB,EAAmB1U,SAAS2U,iBAAiB,uCAAuCl7B,OACxF,GAAwB,GAApBi7B,EAIJ,IAAM,IAAK7iB,KAAS7a,EAAOO,OAAS,CAChC,IAAIwS,EAAU/S,EAAOO,OAAOsa,GAG5B,GAAsB,QAAjB9H,EAAQ+I,OAIN,mBAAoB/I,GACO,MAA7BA,EAAwB,iBAI7B2qB,EAAmB1U,SAAS2U,iBAC1B,8CAA8C5qB,EAAQpK,OACtDlG,OACsB,GAApBi7B,GAAJ,CAKA,IAAIE,EAAgB7qB,EAAwB,eAC5C,GAAM,WAAYA,EAAwB,gBACE,MAAvCA,EAAwB,eAAU,QACK,IAAvCA,EAAwB,eAAU,OAAU,CAGlCrN,WAAWwC,KAAKE,UAAU5J,QAAQY,IACxCsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SADhD,IAGI8zB,EAAQ,CACR1pB,QAAS,MACT2pB,QAAS,iBACTlI,SAAUzP,EACV4C,OAAQ1K,EAAwB,eAAU,QAE9CzP,EAAE6O,KAAK3T,QAAQqK,QAAS0pB,GAAO,WAC3BsK,EAAsB3oB,EAC1B,GACJ,MACM+nB,EAAkBI,aAA0B,YAAIuB,EAA2B,YAC3E3B,EAAkBI,aAAqB,OAAIuB,EAAsB,MAvBvE,CAyBJ,CACJ,EACA,sBAAyB,SAAU1pB,GAC/B2oB,EAAsB3oB,EAC1B,EACA,4BAA+B,SAAUA,GACrC,GAAK5Q,EAAE,8DAA8Db,OAAS,EAC1Eo6B,EAAsB3oB,QAKtB,GAHyB,GAArB7T,EAAIub,OAAOnZ,QACXpC,EAAIwb,YAAYxb,EAAIub,OAAO,IAE3B,kBAAmB5b,EAAOf,SAA2C,OAAhCe,EAAOf,QAAQ+c,cAAwB,CAC5E,IAAIE,EAAW,uCAAuC/M,QAAQ,uBAAuB,cACrF7L,EAAE,kCAAkCqL,KAAKuN,GACpC5Y,EAAE,wCAAwCC,SAAS,WACpDD,EAAE,wBAAwBI,QACxBJ,EAAE,wCAAwCC,SAAS,WACrDD,EAAE,wCAAwCM,MAClD,CAER,IAEHvD,EAAIk4B,WAAW0D,GACfA,EAAkBxB,WACXwB,CACV,CA5kCa4B,GACXr9B,EAAsB,YAAIy4B,GAEpB,UAAWD,IACgB,QAA1BA,GAAqB,MA6qC9B,WACE,IAAMh5B,EAAuB,gBAAqC,GAAhCA,EAAO89B,eAAer7B,OAEtD,OADAa,EAAE,iBAAiBG,SAAS4W,UACrB,EAKT,IADA,IAAI0jB,EAAa,GACRv7B,EAAE,EAAGqD,EAAI7F,EAAO89B,eAAer7B,OAAQD,EAAEqD,EAAKrD,IAEhD,UADCw7B,EAAYh+B,EAAO89B,eAAet7B,KAEjC,YAAaw7B,EAAUnP,QACM,MAA5BmP,EAAUnP,MAAMoP,SAA+C,SAA5BD,EAAUnP,MAAMoP,UAEzDF,EAAWh0B,KAAKi0B,GAGpB,GAA0B,GAArBD,EAAWt7B,OAEd,OADAa,EAAE,iBAAiBG,SAAS4W,UACrB,EAGT,IAAI6jB,EAAS,OAETx9B,EAASL,EAAIK,OAGjB,GAFKV,EAAOf,QAAQq3B,UAAU7zB,OAAS,IACrC/B,EAASV,EAAOf,QAAQq3B,WACX,MAAV51B,GAAqC,MAAnBL,EAAI8L,YAEzB,IADAzL,EAAS,GACA8B,EAAE,EAAGqD,EAAIxF,EAAI8L,YAAY1J,OAAQD,EAAEqD,EAAKrD,IAAK,CACpD,IAAImW,EAAQtY,EAAI4lB,WACZ1Z,EAAMlM,EAAI8L,YAAY3J,GACtBmjB,EAAQjgB,WAAWwC,KAAK2uB,uBAAuBtqB,EAAKoM,GACxDjY,EAAOqJ,KAAK4b,EACd,CAEF,GAAe,MAAVjlB,EAEH,OADA4C,EAAE,iBAAiBG,SAAS4W,UACrB,EAEJ3Z,EAAO,GAAKA,EAAOA,EAAO+B,OAAO,IACpC/B,EAAO4N,UAET,IAAI6vB,EAAe,GACnB,IAAS37B,EAAE,EAAGqD,EAAInF,EAAO+B,OAAQD,EAAEqD,EAAKrD,IAAK,CACrCmjB,EAAQjlB,EAAO8B,GACnB/B,EAAkBC,OAAOqJ,KAAK4b,GAC9B,IAAIyY,EAAYzY,EAKhByY,GAHIA,EADAA,EAAY,GACAh5B,KAAKQ,MAAMw4B,GAEXh5B,KAAKQ,MAAgB,IAAVw4B,GAAe,KACpBC,iBACtBF,GAAgB,kBAAkBxY,EAAM,KAAKyY,EAAU,WAC3D,CAIA,IAHA96B,EAAE,gBAAgBqL,KAAKwvB,GAGd37B,EAAE,EAAGqD,EAAIk4B,EAAWt7B,OAAQD,EAAEqD,EAAKrD,IAAK,CAK/C,IAJA,IAAIw7B,EAAYD,EAAWv7B,GACvB87B,EAAO,KACPC,EAAU,EACVC,EAAY,KACD,MAARF,GAAgBC,EAAUP,EAAUS,KAAKh8B,SAC9C67B,EAAON,EAAUS,KAAKF,IACA,cACpBC,EAAYR,EAAUS,KAAKF,GAC3BD,EAAO,KACPC,GAAW,GAGf,GAAa,MAARD,EAAL,CAEA,IAAII,EAAW75B,OAAOy5B,EAAK55B,OAASw5B,EAChC3G,EAAY1yB,OAAOy5B,EAAKl6B,QAAU85B,EAEtCz9B,EAAkBE,QAAQoJ,KAAK,CAC7B,KAAQi0B,EAAU3yB,MAClB,IAAO,CACL,MAASqzB,EACT,OAAUnH,GAEZ,KAAQ,CACN,MAASmH,EACT,OAAUnH,GAEZ,UAAY,EACZ,SAAYyG,EACZ,MAASM,EAAK31B,GACd,WAA2B,MAAb61B,EAAoBA,EAAU71B,GAAK,KACjD,KAAU,SAAU21B,GAAsB,QAAbA,EAAKK,MAlB1B,CAoBZ,CAGA,GAAwC,GAApCl+B,EAAkBE,QAAQ8B,OAE5B,OADAa,EAAE,iBAAiBG,SAAS4W,UACrB,EAIT,IAAIvU,EAAQzF,EAAI8Q,gBAAgB,SAkBhC,IAjBqB,GAAhBrL,EAAMrD,QACTqD,EAAQ,IAAIJ,WAAWK,MAAMmT,OAAO,QAAQ,CAC1CS,SAAU,IAAIjU,WAAWkU,SAAS,CAChC,QAAW,IAAIlU,WAAWk5B,MAAM,CAC9BC,UAAW,UACXC,YAAa,GACb7kB,YAAa,UACbD,YAAa,QAInB3Z,EAAIuY,SAAS9S,GACbA,EAAMsR,eAAc,IAEpBtR,EAAQA,EAAM,GAGPtD,EAAE,EAAGqD,EAAKpF,EAAkBE,QAAQ8B,OAAQD,EAAEqD,EAAKrD,IAAK,CAC/D,IAAIu8B,EAASt+B,EAAkBE,QAAQ6B,GACvCc,EAAE,mBAAmBO,OAAO,kBAAkBrB,EAAE,KAAKu8B,EAAO94B,KAAK,YACnE,CAEA,IAAI+4B,EAAW,IAAIt5B,WAAW2V,QAAQ4jB,YAAYn5B,EAAM,CACtDo5B,cAAe,CAAC,+BAChBr+B,KAAK6E,WAAW2V,QAAQC,UACxByjB,OAAQ,KACR9G,eAAgB,CACd,SAAY,SAAS/jB,GACnB,GAAmB,MAAf7V,KAAK0gC,OACP,OAAO,EAET5jB,EAAuBjH,GAEvB,IAAI6qB,EAAS1gC,KAAK0gC,OAEdpZ,EAAQH,EAAe/kB,EAAkBC,QAE7C4C,EAAE,gBAAgB8M,IAAIuV,GAEtBE,GAAckZ,EAAQj5B,EAAO6f,GAE7B0B,GAAYlY,QAAQ,kBAAkB,QAAO,GAAM3L,SAAS,SAC5DsC,EAAMsR,eAAc,EACtB,EACA,WAAc,WACZtR,EAAMsR,eAAc,GACpB9T,EAAE,mBAAmB+W,SACrBhc,KAAK0gC,OAAS,KACdj5B,EAAMsL,iBACR,KAGJ/Q,EAAI66B,YAAY,CAAC8D,IACjBx+B,EAAoB,UAAIw+B,EAGxB17B,EAAE,mBAAmBuQ,QAAO,WAC1B,IAAIQ,EAAO/Q,EAAEjF,MACT0gC,EAASt+B,EAAkBE,QAAQ8D,SAAU4P,EAAKjE,QACtD,GAAsC,GAAjC2uB,EAAOI,SAASC,OAAO38B,OAAc,CAExC,IADA,IAAI28B,EAAS,GACJ58B,EAAE,EAAGqD,EAAIk5B,EAAOI,SAASC,OAAO38B,OAAQD,EAAEqD,EAAKrD,IAAI,CAC1D,IAAI68B,EAASN,EAAOI,SAASC,OAAO58B,GAOpC48B,GALwB,GAApBC,EAAOC,UACD,4BAA4BD,EAAO12B,GAAG,sCAAsC02B,EAAOx/B,KAAK,YAAYw/B,EAAOx/B,KAAK,SAEhH,mBAAmBw/B,EAAO12B,GAAG,sCAAsC02B,EAAOx/B,KAAK,KAAKw/B,EAAOx/B,KAAK,iBAG5G,CACAyD,EAAE,wBAAwBqL,KAAKywB,GAC/B97B,EAAE,wBAAwBS,MAC5B,MACET,EAAE,wBAAwBqL,KAAK,IAC/BrL,EAAE,wBAAwBM,OAW5B,OATAiD,IACIm4B,EAASrE,QACXqE,EAASzjB,aACTyjB,EAASD,OAASA,EAClBC,EAASvE,aAETuE,EAASD,OAASA,EAClBC,EAASvE,aAEJ,CACT,IAEAn3B,EAAE,iCAAiCI,OAAM,WAEvC,OADAJ,EAAE,iBAAiBI,SACZ,CACT,IACAJ,EAAE,gBAAgBuQ,QAAO,WACvB,GAAKmrB,EAASrE,QAAU70B,EAAMw3B,gBAAkB,CAC9C,IAAIjpB,EAAO/Q,EAAEjF,MACTsnB,EAAQ7Y,WAAWuH,EAAKjE,OAE5ByV,GAAcmZ,EAASD,OAAQj5B,EAAO6f,EACxC,CACF,IACAriB,EAAE,iBAAiBI,OAAM,WACvB,IAAIs6B,EAAYgB,EAASD,OAAOI,SAC5BI,EAAqB,GACrB,WAAYvB,IACZuB,EAAqBj8B,EAAEjD,IAAK29B,EAAUwB,QAAQ,SAAUC,GACpD,IAAsB,GAAlBA,EAAEC,aAAsB,MAAMD,EAAEC,aAAgBV,EAASD,OAAOY,MAClE,OAAOF,EAAEG,WACf,KAGJ,IAAInV,EAAS,IAAI/kB,WAAWya,OACxB6e,EAASl5B,MAAMkK,SAAS,GAAG4B,SAASc,YAAY2jB,WAIhDzpB,EAAWvM,EAAIwL,WAAWgB,UAC1BgzB,EAAqB,KAKrBzZ,GAA2B,EAI/B,GAHI,6BAA8BrmB,OAAOC,OAAOf,SAA6D,QAAlDc,OAAOC,OAAOf,QAAQmnB,2BAC/EA,GAA2B,GAEzBA,GACCrmB,OAAOC,OAAOf,QAAQonB,sBAAsBva,KAAO/L,OAAOC,OAAOf,QAAQ4M,WAAWC,IACvF,CAEA,IAAIg0B,EAAe9/B,EAAOf,QAAQonB,sBAC5ByZ,EAAah0B,OAAOob,QAAQC,OAChCD,QAAQC,KAAK2Y,EAAah0B,KAAKg0B,EAAa3J,OAG9CvpB,GADAizB,EAAqB,IAAIn6B,WAAWqH,WAAW+yB,EAAah0B,MAC9Be,UAG9B4d,EAAO5Y,UAAUxR,EAAIwL,WAAYg0B,EACnC,CAEA,IAAIlzB,EAAoBjH,WAAWqH,WAAWC,SAASJ,IAAalH,WAAWqH,WAAWC,SAASJ,GAAUF,GAGzGrE,EAAM3C,WAAWwC,KAAKE,UAAU5J,QAAQY,IACvCsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAEhD,IAAIshC,EAAc,CAClBA,QAAyB,MACzBA,QAAyB,QACzBA,QAAyB,YAUzB,GATAA,EAAoB,OAAI/W,SAASgX,cAAc,iBAAiB9hB,MAChE6hB,EAAwB,WAAI,iCAC5BA,EAAyB,YAAI,OAC7BA,EAAiB,IAAInzB,EACrBmzB,EAAiB,IAAI/W,SAASgX,cAAc,cAAc9hB,MAC1D6hB,EAAsB,SAAI/B,EAAU3yB,MACpC00B,EAAYf,EAASD,OAAOY,MAAQ,WAAalV,EAAOjN,OAAO,KAAM7Q,GACrEozB,EAAYf,EAASD,OAAOY,MAAQ,UAAY3W,SAASgX,cAAc,gBAAgB9hB,MAElF,SAAU8gB,EAASD,QAAUC,EAASD,OAAOJ,KAAO,CACvD,IAAIsB,EAAexZ,GAAsBuY,EAASD,OAAQjyB,WAAW6Y,GAAQllB,EAAkBC,QAC/Fq/B,EAAYf,EAASD,OAAOY,MAAQ,qBAAuBM,EAC3DF,EAAYf,EAASD,OAAOY,MAAQ,qBAAuBM,CAC7D,CAEA,IAAIC,EAAc,GACdC,EAAc,GACdC,EAAgB,GACpB98B,EAAE4D,KAAK7G,EAAIE,QAAQ,SAASiC,EAAG2E,GAC7B,IAAMA,aAAazB,WAAWK,MAAMtG,KAAS0H,aAAazB,WAAWK,MAAMs3B,OACnEl2B,EAAEm2B,iBAAoB,WAAYn2B,GAAO,WAAYA,EAAE1I,OAAS,CAElE,IAAIuH,EAAW,KACVmB,EAAElB,QAAQhF,IACX+E,EAAW/C,EAAwBkE,EAAElB,OACzC,IAAIC,EAAc,KASlB,GARKF,IACDE,EAAclG,EAAOO,OAAOyF,IAC1BE,IACFA,EAAclG,EAAOO,OAAO4G,EAAE1I,OAAe,SAC3CyH,IACFA,EAAclG,EAAOO,OAAO4G,EAAElB,QAG5BC,EACJ,OAGF,KAAM,OAAQA,GACZ,OAGFg6B,EAAYn2B,KAAK5C,EAAE1I,OAAe,QAGlC,IAAI4hC,EAAM,UACL,sBAAuBrgC,EAAOf,SAAWe,EAAOf,QAAQuL,kBAAkBC,WAAW,QACtF41B,EAAM,IAEN,WAAYl5B,EAAE1I,QAAU0I,EAAE1I,OAAe,OAAEgE,OAAS,IACtD49B,EAAMl5B,EAAE1I,OAAe,QACzB0hC,EAAYp2B,KAAMs2B,GAGbn6B,GAAgB,YAAaA,EAChCk6B,EAAcr2B,KAAKtF,SAAS,IAAI0C,EAAEwW,QAAQzX,EAAYyX,UAEtDyiB,EAAcr2B,KAAKtF,SAAS,IAAI0C,EAAEwW,SACtC,CAEN,IAEAuiB,EAAY5xB,UACZ6xB,EAAY7xB,UACZ8xB,EAAc9xB,UAGd,IAAIgyB,EAAsBjgC,EAAIsG,UAAUV,KACxC,GAAKq6B,KAAuBv/B,EAAgC,CAC1D,IAAIw/B,EAAOx/B,EAA8Bu/B,GACzC,GAAIC,KAAQvgC,EAAOO,OAAS,CACxB,IAAIigC,EAAwBxgC,EAAOO,OAAOggC,GACrC,OAAQC,GAAyB,gBAAiBxgC,EAAOf,SAAyC,QAA9Be,EAAOf,QAAQmK,YACpF82B,EAAYn2B,KAAKy2B,EAAsB73B,IAEjC,cAAe63B,EACrBN,EAAYn2B,KAAKy2B,EAAsB5c,WAGvCsc,EAAYn2B,KAAKw2B,GAEhB,sBAAuBvgC,EAAOf,SAAWe,EAAOf,QAAQuL,kBAAkBC,WAAW,MACtF01B,EAAYp2B,KAAK,IAEjBo2B,EAAYp2B,KAAK,WAErBq2B,EAAcr2B,KAAK,IACvB,CACF,CAkCA,GA/BIw1B,EAAmB98B,OAAS,GAC5Ba,EAAE4D,KAAMq4B,GAAoB,SAAU/8B,EAAGsY,GACrC,IAAIvB,EAAUgI,GAAoBzG,GAClC,GAAIvB,EAAU,CACV,IAAInS,EAAcmS,EAAQ,GACQ,QAA5BnS,EAAYyH,cAAsD,WAA5BzH,EAAYyH,cAAyD,IAA5BzH,EAAYyH,eACxF,cAAezH,GAAwC,IAAzBA,EAAYwc,UAC3Csc,EAAYn2B,KAAK3C,EAAYwc,WAE7Bsc,EAAYn2B,KAAK3C,EAAYnB,MAC5B,sBAAuBjG,EAAOf,SAC9Be,EAAOf,QAAQuL,kBAAkBC,WAAW,MAC/C01B,EAAYp2B,KAAK,IAEjBo2B,EAAYp2B,KAAK,WAEnBq2B,EAAcr2B,KAAK,KAE3B,CACJ,IAGC,sBAAuB/J,EAAOf,SAA+C,QAApCe,EAAOf,QAAQuL,oBAC3D01B,EAAY5xB,UACZ6xB,EAAY7xB,UACZ8xB,EAAc9xB,WAGhByxB,EAAYf,EAASD,OAAOY,MAAQ,WAAaO,EAAYhuB,KAAK,KAClE6tB,EAAYf,EAASD,OAAOY,MAAQ,WAAaQ,EAAYjuB,KAAK,KAE/B,MAA9B8sB,EAASD,OAAO0B,YACdzgC,EAAOf,QAAQ8O,YAAc,CAClC,IAAID,EAAO9N,EAAOf,QAAQ6O,KACtB4yB,EAAU,IAAIh7B,WAAWya,OAAOtb,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,IAAIjJ,OAAOiJ,EAAK,KAC5FsY,GACCrmB,OAAOC,OAAOf,QAAQonB,sBAAsBva,KAAO/L,OAAOC,OAAOf,QAAQ4M,WAAWC,KAGvF40B,EAAQ7uB,UAAUxR,EAAIwL,WAAYg0B,GAEpCE,EAAYf,EAASD,OAAO0B,WAAa,WAAaC,EACtDX,EAAYf,EAASD,OAAO0B,WAAa,WAAa,WAEjD,sBAAuBzgC,EAAOf,SAA+C,QAApCe,EAAOf,QAAQuL,mBACzD01B,EAAYn2B,KAAK,YACZ/J,EAAOf,QAAQuL,kBAAkBC,WAAW,MAC7C01B,EAAYp2B,KAAK,IAEjBo2B,EAAYp2B,KAAK,WAErBq2B,EAAcr2B,KAAK,OAEnBm2B,EAAYS,QAAQ,YACpBR,EAAYQ,QAAQ,WACpBP,EAAcO,QAAQ,KAE5B,CACAZ,EAAoB,OAAIG,EAAYhuB,KAAK,KACzC6tB,EAAoB,OAAII,EAAYjuB,KAAK,KACzC6tB,EAAuB,UAAIK,EAAcluB,KAAK,KAE9C,MAAM0uB,EAAoB5X,SAAS2U,iBAAiB,qCACpD,GAAIiD,EACF,IAAK,MAAMC,KAASD,EAClBb,EAAYc,EAAM56B,MAAQ46B,EAAM3iB,MAIpC,IAAIT,EAAS,GACTqjB,EAAY,GAChB,IAAM,IAAKjmB,KAAS7a,EAAOO,OAAS,CAChC,IAAIwS,EAAU/S,EAAOO,OAAOsa,GACxB+iB,EAAgB7qB,EAAwB,eACrC,mBAAoBA,GACL,MAAjB6qB,IAEG,gBAAiBA,GACY,MAAhCA,EAA2B,aACK,IAAhCA,EAA2B,aAC5BngB,EAAO1T,KAAM6zB,EAA2B,aAEtC,mBAAoBA,GACc,MAAnCA,EAA8B,gBACK,IAAnCA,EAA8B,gBAC/BkD,EAAU/2B,KAAM6zB,EAA8B,gBAEtD,CACqB,GAAhBngB,EAAOhb,SACVs9B,EAAyB,YAAItiB,EAAOvL,KAAK,MAEnB,GAAnB4uB,EAAUr+B,SACbs9B,EAA4B,eAAIe,EAAU5uB,KAAK,MAIjD,MAAM6uB,EAAY,IAAIr7B,WAAWuE,OAAO+2B,IAClCC,EAAgB,GAChBC,EAAkB,GACxB,GAAInhC,OAAO0xB,WAAW0P,WAAWC,cAAgBrhC,OAAO0xB,WAAW0P,WAAWE,uBAC5E,IAAK,IAAI9c,EAAQ,EAAGA,EAAQxkB,OAAO0xB,WAAW0P,WAAWC,aAAa3+B,OAAQ8hB,IAAS,CACrF,IAAI+c,EAAevhC,OAAO0xB,WAAW0P,WAAWC,aAAa7c,GACzD6B,GACCrmB,OAAOC,OAAOf,QAAQonB,sBAAsBva,KAAO/L,OAAOC,OAAOf,QAAQ4M,WAAWC,KAGvFw1B,EAAa1vB,SAASC,UAAUxR,EAAIwL,WAAYg0B,GAElDoB,EAAcl3B,KAAKg3B,EAAUpQ,MAAM2Q,IACnCJ,EAAgBn3B,KAAKhK,OAAO0xB,WAAW0P,WAAWI,mBAAmBhd,GAEvE,CAGE0c,EAAcx+B,OAAS,IACzBs9B,EAAYf,EAASD,OAAOY,MAAM,mBAAqBsB,EAAc/uB,KAAK,KAC1E6tB,EAAYf,EAASD,OAAOY,MAAM,qBAAuBuB,EAAgBhvB,KAAK,MAIhF,MAAMsvB,EAAcxY,SAAS0P,eAAe,gBAe5C,OAdA8I,EAAYC,UAAW,EACvBD,EAAYE,UAAUC,IAAI,WAE1Br+B,EAAE,qBAAqBI,QACvB2jB,GAAYlY,QAAQ,iBAAkB,QAAQ,GAAM3L,SAAS,qBAE7DokB,GAAavf,EAAK03B,GAAa,KAC7B,MAAMyB,EAAcxY,SAAS0P,eAAe,gBAC5C8I,EAAYC,UAAW,EACvBD,EAAYE,UAAUrnB,OAAO,WAE7B/W,EAAE,iCAAiCI,OAAO,KAGrC,CACT,IACArD,EAAIkR,OAAOgE,GAAG,CACZ,QAAW,WACT,GAAKypB,EAASrE,QAAU70B,EAAMw3B,gBAAkB,CAE5C,IAAI3X,EAAQH,EAAe/kB,EAAkBC,QAE7C4C,EAAE,gBAAgB8M,IAAIuV,GAEtBE,GAAcmZ,EAASD,OAAQj5B,EAAO6f,EAC1C,CACF,IAEF5lB,OAAOwR,OAAOgE,GAAG,CACbqsB,eAAgB,SAAS9oB,GACR,SAARA,EAAEnQ,IACHrF,EAAE,mBAAmBuQ,QAE7B,EACAguB,eAAgB,SAAS/oB,GACR,SAARA,EAAEnQ,IACHq2B,EAASzjB,YAEjB,GAEN,CArqDIumB,GAEAx+B,EAAE,iBAAiBG,SAAS4W,SAEzBra,EAAsB,eAAoC,GAA/BA,EAAO+hC,cAAct/B,OAmqDvD,WACE,IAAMzC,EAAsB,eAAoC,GAA/BA,EAAO+hC,cAAct/B,OAEpD,OADAa,EAAE,yBAAyBG,SAAS4W,UAC7B,EAIT,IAAIF,EAAeC,KACnB,GAA2B,GAAvBD,EAAa1X,OAEf,OADAa,EAAE,yBAAyBG,SAAS4W,UAC7B,EAET,IAAI2nB,EAAmB,CAAC,EACxB,IAAK,IAAIvoB,KAASzZ,EAAO+hC,cACrBC,EAAiBjiC,OAAOgC,UAAU0X,IAAUA,EAGhD,IAAIwoB,EAAsB,GAE1B,IAAK,MAAM3nB,KAAeH,EAAc,CACtC,IAAII,EAAWD,EAAYE,qBAAqB,QAAQ,GAAGC,YAEzD,KADEhB,EAAQ1Z,OAAO2a,kBAAmBH,IAEhC,GAAIA,KAAYva,EAAO+P,cACnB0J,EAAQc,OACP,GAAMA,KAAYpZ,GAAkBA,EAAaoZ,KAAava,EAAO+P,cACtE0J,EAAQtY,EAAaoZ,QAErB,IAAK,IAAI2nB,KAAOliC,EAAO+hC,cACnB,GAAIG,EAAI52B,MAAM,KAAK4G,KAAK,MAAQqI,EAAU,CACtCd,EAAQyoB,EACR,KACJ,CAKZ,GAAOzoB,KAASzZ,EAAO+hC,eAGjBtoB,KAASzZ,EAAO+hC,eAAmBtoB,KAASzZ,EAAOO,OAAU,CAC/D,IAAIwS,EAAU/S,EAAOO,OAAOkZ,GAC5BwoB,EAAoBjiC,EAAO+hC,cAActoB,GAAOlQ,OAAS,kBAAkBkQ,EAAM,KAAK1G,EAAQ1H,MAAM,WACxG,CACJ,CAGA,IAAK,IAAI7I,EAAI,EAAGA,EAAIy/B,EAAoBx/B,OAAQD,IAC9Cc,EAAE,uBAAuBO,OAAOo+B,EAAoBz/B,IAGtD,GAAuD,GAAlDc,EAAE,uBAAuB8R,KAAK,UAAU3S,OAE3C,OADAa,EAAE,yBAAyBG,SAAS4W,UAC7B,EAIT,IAAI8nB,EAAkB,IAAIz8B,WAAWkU,SAAS,CAC1C,QAAW,IAAIlU,WAAWk5B,MAAM,CAC5B/kB,YAAa,EACbI,YAAa,OACbD,YAAa,GACbE,cAAe,EACf4kB,YAAa,EACbsD,OAAQ,YAEZ,SAAY,IAAI18B,WAAWk5B,MAAM,CAC7B/kB,YAAa,EACbI,YAAa,SACbD,YAAa,GACbE,cAAe,EACf4kB,YAAa,EACbsD,OAAQ,YAEZ,UAAa,IAAI18B,WAAWk5B,MAAM,CAC9B/kB,YAAa,EACbI,YAAa,MACbD,YAAa,GACbE,cAAe,EACf4kB,YAAa,EACbsD,OAAQ,cAGZC,EAAS,IAAI38B,WAAWK,MAAMmT,OAAO,eAAgB,CACrDS,SAAUwoB,IAEdpiC,OAAOM,IAAIuY,SAASypB,GACpBA,EAAOjrB,eAAc,GAErB,IAAIkrB,EAAiB,IAAI58B,WAAW2V,QAAQknB,iBAAiB,CAACF,GAAQ,CAClEG,cAAc,EACdC,YAAa,CACT,KAAQ,GACR,MAAS,EACT,IAAO,GAEXC,WAAY,oBACZC,UAAW,IAAIj9B,WAAWC,KAAK,IAAI,KACnC+X,MAAM,CACF7D,YAAa,EACbI,YAAa,OACbD,YAAa,EACbE,cAAe,EACf4kB,YAAa,GACbD,UAAW,iBAGnByD,EAAeM,aAAe,SAASxV,GACnC,IAAI3T,EAAQnW,EAAE,uBAAuB8M,MACjCsO,EAAU3e,OAAOC,OAAOO,OAAOkZ,GACnC,GAAMA,KAAS1Z,OAAOC,OAAOO,OAA7B,CAEA,IACIsiC,EADU9iC,OAAOC,OAAO+hC,cAActoB,GACjB,OAAEqpB,OACvBC,EAAgBF,EAAGv3B,MAAM,UACzB03B,EAAe,GACd,oBAAqBjjC,OAAOC,QAC1ByZ,KAAS1Z,OAAOC,OAAO4uB,iBACvB,iBAAkB7uB,OAAOC,OAAO4uB,gBAAgBnV,KAEnDupB,EADSjjC,OAAOC,OAAO4uB,gBAAgBnV,GAAqB,aAAEqpB,OAC5Cx3B,MAAM,WAE5B,IAAIygB,EAAWrN,EAAe,MAC1B/P,EAAO,iCAEX,IAAK,IAAIuE,KADTvE,GAAO,mCACOye,EAAQ6V,WAEb3/B,EAAE2I,QAAQiH,EAAG8vB,IAAiB,IAGzB,IAANH,GAAcv/B,EAAE2I,QAAQiH,EAAG6vB,IAAkB,KAEjDp0B,GAAO,WAAaod,EAAS7Y,GAAK,YAAcka,EAAQ6V,WAAW/vB,GAAK,cAE5EvE,GAAO,WACPA,GAAO,SAEP,IAAIu0B,EAAa7kC,KAAKyH,MAAMzF,IAAIkd,YAC5B4lB,EAAQ9kC,KAAKyH,MAAMzF,IAAI+iC,gBAEvBC,EAAY,IAAI39B,WAAW+pB,OAAOyT,EAAW/R,KAAK+R,EAAW5R,KACjE+R,EAAUjnB,MAAS9Y,EAAE,SAASoB,QAAUrG,KAAKokC,YAAYtR,MAASgS,EAClE,IAAIG,EAAS,IAAI59B,WAAW4W,MAAMinB,SAAS,eACvCF,EACA,KACA10B,EACA,CAAC6J,KAAM,CAACjU,EAAG,GAAIL,EAAG,IAAKs/B,OAAQ,CAAC1hB,GAAI,EAAG4N,GAAI,KAC3C,GAEJ4T,EAAOG,UAAW,EAClBH,EAAOI,gBAAkB,cAEzBtW,EAAQtR,MAAQwnB,EAChBvjC,OAAOM,IAAIoc,SAAU6mB,EA1Cb,CA2CZ,EAEAvjC,OAAOM,IAAIk4B,WAAW+J,GACtB9hC,EAAS,iBAAmB8hC,EAE5Bh/B,EAAE,iDAAiDI,OAAM,WAErD,OADAJ,EAAE,yBAAyBI,SACpB,CACX,IACAJ,EAAE,mBAAmBI,OAAM,WAEzB,OADAJ,EAAE,uBAAuB8M,IAAI,IAAIyD,UAC1B,CACT,IACAvQ,EAAE,uBAAuBuQ,QAAQ,WAC7B,IAAI7R,EAAQsB,EAAEjF,MAAM+R,MAGpB,GAFAkyB,EAAe/mB,aACf8mB,EAAOjxB,kBACO,IAATpP,EAAL,CAEAsB,EAAE,uBAAuBE,SAAS,WAAWM,KAAK,WAAW,IAG7D,IAAImqB,EAAiBhrB,EAAyBjB,GAEzCisB,IACDA,EAAiBjsB,GACrB,IAAI2hC,EAAYha,GAAyCsE,GAEzD9C,GAAgBnpB,EAAO,KAAM2hC,EAAW,MAAM,EAAO,KAAM,MACvD,SAASC,EAAOC,EAASC,EAAWC,GAElC,KAAOH,KAAS5jC,EAAOO,QAAU,CAC7B,IAAIyF,EAAWjG,OAAOqqB,mBAAmBpoB,GACzC,IAAKgE,KAAaA,KAAYhG,EAAOO,QAIjC,OADA2B,QAAQC,IAAI,oBAAoByhC,EAAM,UAAU59B,EAAS,0BAClD,EAHP49B,EAAQ59B,CAKhB,CAEA,IAAI+M,EAAU/S,EAAOO,OAAOqjC,GACxBI,EAAUhkC,EAAO+hC,cAAc6B,GAO/BrS,EALU,IAAI7rB,WAAWuE,OAAOwH,QAAQ,CACxCC,iBAAiB,EACjB2e,mBAAoBtd,EAAoB,WACxCqd,mBAAoBrwB,OAAOM,IAAIyR,kBAEXH,KAAM,CAC1B9Q,KAAM,oBACNmP,SAAU8zB,IAEdzB,EAAO9vB,YAAagf,GAEd,gBAAiByS,GAAmC,QAAvBA,EAAQjyB,YACjC,cAAeiyB,GAAiC,IAArBA,EAAQC,UACrC3B,EAAe5kB,MAAMzD,YAAc+pB,EAAQC,UAE3C3B,EAAe5kB,MAAMzD,YAAc,OAEvCqoB,EAAe5kB,MAAMzD,YAAc,cACf,GAApBsX,EAAU9uB,QAAe8uB,EAAU,GAAG3f,UAAY2f,EAAU,GAAG3f,SAASjJ,GAAG8B,WAAW,kCACtF63B,EAAe5kB,MAAM1D,YAAc,GAEnCsoB,EAAe5kB,MAAM1D,YAAc,EACvCsoB,EAAe7H,WACfn3B,EAAE,uBAAuBU,YAAY,WAAWkgC,WAAW,WAEjE,GAnDU,CAoDd,IACA5gC,EAAE,uBAAuBU,YAAY,WAAWkgC,WAAW,YAE3DnkC,OAAOwR,OAAOgE,GAAG,CACbqsB,eAAgB,SAAS9oB,GAET,iBAARA,EAAEnQ,IAAoE,IAA3CrF,EAAE,8BAA8Bb,QAC7Da,EAAE,uBAAuB8M,IAAI9M,EAAE,2CAA2C8M,OAAOyD,QAEvF,EACAguB,eAAgB,SAAS/oB,GACrB,GAAa,iBAARA,EAAEnQ,GAGL,OADArF,EAAE,uBAAuB8M,IAAI,IAAIyD,UAC1B,CAEb,GAGN,CAr5DMswB,GAEF7gC,EAAE,yBAAyBG,SAAS4W,SAEjC,gBAAiB2e,IACe,QAAhCA,GAA2B,aAC9B11B,EAAE,6CAA6CI,OAAM,WAEnD,OADAJ,EAAE,uBAAuBI,SAClB,CACT,IAGI,YAAas1B,IACgB,QAA5BA,GAAuB,QAw5DhC,WAEE,IAyBItb,EAAQ,IAAIhY,WAAWk5B,MAC3BlhB,EAAM0mB,SAAS,CACX,IAAI1+B,WAAW2+B,KAAK,CAACC,WA3BD,CACtB,MAAS,CACPzqB,YAAa,EACb0qB,YAAa,SACb1F,UAAW,QACXC,YAAa,EACb9kB,YAAa,EACbE,cAAe,EACfD,YAAa,WAEf,KAAQ,CACND,YAAa,EACbE,cAAe,EACfD,YAAa,UACbuqB,gBAAiB,QAEnB,QAAW,CACTxqB,YAAa,EACbE,cAAe,EACfD,YAAa,UACbuqB,gBAAiB,OACjB3F,UAAW,QACXC,YAAa,SAOjB,IAAInlB,EAAW,IAAIjU,WAAWkU,SAAS,CAAC,QAAW8D,IAE/C+mB,EAAkB,CACpBhiC,OAAQ,IAAIiD,WAAW2V,QAAQqpB,QAC7Bh/B,WAAWi/B,QAAQC,KAAM,CACvBC,SAAS,EACTC,UAAU,EACVC,WAAW,EACXtI,eAAgB,CACduI,aAAc,CACZrrB,SAAUA,IAGd9Y,KAAK6E,WAAW2V,QAAQC,YAG5B2pB,KAAM,IAAIv/B,WAAW2V,QAAQqpB,QAC3Bh/B,WAAWi/B,QAAQO,QAAS,CAC1BL,SAAS,EACTC,UAAU,EACVC,WAAW,EACXtI,eAAgB,CACduI,aAAc,CACZrrB,SAAUA,IAGd9Y,KAAK6E,WAAW2V,QAAQC,YAG5B6pB,UAAW,IAAIz/B,WAAW2V,QAAQqpB,QAChCh/B,WAAWi/B,QAAQO,QAAS,CAC1BL,SAAS,EACTC,UAAU,EACVC,WAAW,EACXtI,eAAgB,CACduI,aAAc,CACZrrB,SAAUA,IAGd9Y,KAAK6E,WAAW2V,QAAQC,YAG5B8pB,MAAO,IAAI1/B,WAAW2V,QAAQqpB,QAC5Bh/B,WAAWi/B,QAAQC,KAAM,CACzBj8B,GAAI,eACJk8B,SAAS,EACTC,UAAU,EACVC,WAAW,EACXtI,eAAgB,CACd4I,YAAa,EACbL,aAAc,CACZrrB,SAAUA,IAGd9Y,KAAM6E,WAAW2V,QAAQC,aAsD7B,SAASgqB,EAAmBpxB,GAC1B,IAAIyE,EAAQzE,EAAIyE,MACZpP,EAAQ2K,EAAI3K,MACZg8B,EAAUrxB,EAAIqxB,QACdC,EAAM,GAGV,GAAsB,iBAAlBtxB,EAAImF,OAAO1Q,IAKb,GAHA68B,EAAMr2B,QAAQ,kBAAoB,MAGK,IAAnC+E,EAAItC,SAAS6zB,WAAWhjC,OAAa,CAEvC,QAAyBR,IAAtBiS,EAAImF,OAAOqsB,OAAqB,CACjC,MAAMC,EAAiBzxB,EAAItC,SAAS6zB,WAAW,GAAGvgC,QAC5C0gC,EAAkB1xB,EAAItC,SAAS6zB,WAAW,GAAGvgC,QACnDgP,EAAItC,SAAS6zB,WAAW,GAAGI,KAAKD,EAAgB9jB,EAAI6jB,EAAe7jB,EAAG8jB,EAAgBlW,EAAIiW,EAAejW,GACzGxb,EAAItC,SAAS6zB,WAAW,GAAGI,KAAKF,EAAe7jB,EAAI8jB,EAAgB9jB,EAAG6jB,EAAejW,EAAIkW,EAAgBlW,GAEzGxb,EAAImF,OAAOqsB,QAAS,CACtB,KAAwB,YAAbxxB,EAAIrT,OACbqT,EAAImF,OAAOqsB,YAASzjC,GAItB,MAAM6jC,EAAI5xB,EAAItC,SAAS6zB,WAAW,GAC5BM,EAAI7xB,EAAItC,SAAS6zB,WAAW,GAC5BO,EAAI9xB,EAAItC,SAAS6zB,WAAW,GAE5BQ,EAAK7gC,KAAK8gC,KAAK9gC,KAAKoH,IAAIu5B,EAAEjkB,EAAIgkB,EAAEhkB,EAAG,GAAK1c,KAAKoH,IAAIu5B,EAAErW,EAAIoW,EAAEpW,EAAG,IAC5DyW,EAAK/gC,KAAK8gC,KAAK9gC,KAAKoH,IAAIu5B,EAAEjkB,EAAIkkB,EAAElkB,EAAG,GAAK1c,KAAKoH,IAAIu5B,EAAErW,EAAIsW,EAAEtW,EAAG,IAC5D0W,EAAKhhC,KAAK8gC,KAAK9gC,KAAKoH,IAAIw5B,EAAElkB,EAAIgkB,EAAEhkB,EAAG,GAAK1c,KAAKoH,IAAIw5B,EAAEtW,EAAIoW,EAAEpW,EAAG,IAClE,IAAI2W,EAA6E,IAA3DjhC,KAAKkhC,MAAMH,EAAKA,EAAKF,EAAKA,EAAKG,EAAKA,IAAO,EAAID,EAAKF,IAAc7gC,KAAKmhC,GAEzFjzB,MAAM+yB,KACRA,EAAiB,GAGnBb,EAAMr2B,QAAQ,kBAAoB,IAAMk3B,EAAeG,QAAQ,GAAK,GACtE,OAIEhB,GADW,GAATj8B,EACK4F,QAAQ,kBAAoB,IAAMo2B,EAAQiB,QAAQ,GAAK,IAAM7tB,EAE7DxJ,QAAQ,kBAAoB,IAAMo2B,EAAQiB,QAAQ,GAAK,IAAM7tB,EAA7DxJ,eAIX,IAAIs3B,EAAUnjC,EAAE,2BACO,GAAlBmjC,EAAQhkC,QACXgkC,EAAUpf,GAAYme,IACd1hC,KAAK,KAAK,0BAElB2iC,EAAQ93B,KAAK,MAAM62B,EAAI,OAE3B,CAEA,IAAI,IAAIhvB,KA7GRiuB,EAAgBhiC,OAAO8O,OAAOgE,GAAG,CAC/BklB,SAAU,WACRpT,GAAYlY,QAAQ,2BAA2B,QAAO,GAAMrL,KAAK,KAAK,yBACxE,EACAyX,WAAY,WACVjY,EAAE,2BAA2B+W,QAC/B,IAEFoqB,EAAgBQ,KAAK1zB,OAAOgE,GAAG,CAC7BklB,SAAU,WACRpT,GAAYlY,QAAQ,yBAAyB,QAAO,GAAMrL,KAAK,KAAK,yBACtE,EACAyX,WAAY,WACVjY,EAAE,2BAA2B+W,QAC/B,IAEFoqB,EAAgBU,UAAU5zB,OAAOgE,GAAG,CAClCklB,SAAU,WACRpT,GAAYlY,QAAQ,8BAA+B,QAAQ,GAAMrL,KAAK,KAAM,yBAC9E,EACAyX,WAAY,WACVjY,EAAE,2BAA2B+W,QAC/B,IAEFoqB,EAAgBW,MAAM7zB,OAAOgE,GAAG,CAC9BklB,SAAU,WACRpT,GAAYlY,QAAQ,0BAA2B,QAAQ,GAAMrL,KAAK,KAAM,yBAC1E,EACAyX,WAAY,WACVjY,EAAE,2BAA2B+W,QAC/B,IAGFoqB,EAAgBU,UAAUI,QAAU,SAAS3zB,EAAU80B,GACnD,IAAIC,EAAMp9B,EACN7D,WAAWwC,KAAKkD,QAASwG,EAASwd,WAAY,eAAkB,GAChEuX,EAAOtoC,KAAKuoC,cAAch1B,GAC1BrI,EAAQ,IAERo9B,EAAOtoC,KAAKuoC,cAAch1B,EAAS6zB,WAAW,IAC9Cl8B,EAAQ,GAEZlL,KAAKkT,OAAOC,aAAak1B,EAAW,CAChCnB,QAASoB,EAAK,GACdhuB,MAAOguB,EAAK,GACZp9B,MAAOA,EACPqI,SAAUA,GAElB,EA6De6yB,EAAiB,CAC9B,IAAIoC,EAAUpC,EAAgBjuB,GAC9BqwB,EAAQt1B,OAAOgE,GAAG,CAChB,QAAW+vB,EACX,eAAkBA,IAEpBjlC,EAAIk4B,WAAWsO,GACfrmC,EAASgW,EAAI,WAAaqwB,CAC5B,CACAvjC,EAAE,iBAAiBuQ,QAAO,WACtB,IAAIQ,EAAO/Q,EAAEjF,MACbgW,EAAKe,KAAK,UAAUlO,MAAK,WACrB,IAAIkJ,EAAM9M,EAAGjF,MAAOyF,KAAK,SACpBsM,KAAOq0B,GAAmBA,EAAgBr0B,GAAKuqB,QAClD8J,EAAgBr0B,GAAKmL,YAC3B,IACAkpB,EAAgBpwB,EAAKjE,OAAOqqB,UAChC,IACA16B,OAAOwR,OAAOgE,GAAG,CACbqsB,eAAgB,SAAS9oB,GACR,WAARA,EAAEnQ,IACHrF,EAAE,iBAAiBuQ,QAE3B,EACAguB,eAAgB,SAAS/oB,GACrB,GAAa,WAARA,EAAEnQ,GAAkB,CACrB,IAAIm+B,EAAa,GACjBxjC,EAAE,wBAAwB4D,MAAK,WAC3B,IAAIkJ,EAAM9M,EAAGjF,MAAOyF,KAAK,SACpBsM,KAAOq0B,GAAmBA,EAAgBr0B,GAAKuqB,SAChDmM,EAAa12B,EACrB,IACmB,IAAd02B,GACDrC,EAAgBqC,GAAYvrB,YACpC,CACJ,IAGJjY,EAAE,iBAAiBI,OAAM,WACvBJ,EAAE,mBAAmBI,OACvB,GAGF,CAxoEIqjC,IAEAzjC,EAAE,YAAYG,SAAS4W,SACvB/W,EAAE,wBAAwB+W,SAC1B/W,EAAE,sBAAsB+W,SACxB/W,EAAE,2BAA2B+W,UAksH3BhG,EAAK9C,OAAOC,aAAa,iBAAkB6C,GA7jHjD,WACI,GAA+B,GAA1B/Q,EAAE,cAAcb,OAArB,CAGF,IAAIukC,EAAQ,IAAIthC,WAAW2V,QAAQ6B,UACjC,YACA,KACA,CACE,aAAgBF,IAGpB3c,EAAIk4B,WAAYyO,GAEhB,IAAIC,EAAQ,IAAIvhC,WAAW2V,QAAQ6B,UACjC,kBACA5Z,EAAE,oBAAoBQ,KAAK,QAC3B,CACE,aAAgBkZ,IAGpB3c,EAAIk4B,WAAY0O,GAChB5mC,EAAIkR,OAAOgE,GAAG,CACV,gBAAmB,WACfjS,EAAE,8BAA8B8M,IAAK/P,EAAIsG,UAAUV,MAAO4N,QAC9D,EACA,QAAWuK,EACX,YAAeI,EACf,gBAAmBJ,IAEvB9a,EAAE,2BAA2BuQ,QAAO,WACV,KAAjBvQ,EAAEjF,MAAM+R,MACT9M,EAAE,sCAAsCS,OAExCT,EAAE,sCAAsCM,OAE5Cwa,GACJ,IACA9a,EAAE,4CAA4CuQ,OAAOuK,GAErD9a,EAAE,wBAAwBI,OAAM,WAE9B,OADAJ,EAAE,qBAAqBI,SAChB,CACT,IAEAib,IAEArb,EAAE,yDAAyDiS,GAAG,SAAS,SAASuD,GAC7C,wBAA5BxV,EAAEwV,EAAEouB,QAAQpjC,KAAK,SAChB+C,GACR,IAEAvD,EAAE,qBAAqB6jC,QAAO,WAC5B,IAAIC,EAAQ9jC,EAAE,yCAAyC8M,MACvD,GAAa,IAATg3B,EAEF,OADA/f,GAAYlY,QAAQ,6BAA6B,SAAQ,IAClD,EAET,IAAIyP,EAAQpgB,QAAQsgB,YAChBD,EAAWxM,KAAKC,MAAMD,KAAKkZ,UAAUlqB,IAGzC,GAFAwd,EAAe,KAAIuoB,EACnBvoB,EAAY,EAAI,MACZ9e,OAAOib,wBAA0B,CACnC,IAAIqsB,EAAUtnC,OAAOib,wBAA0B,IAAMhb,EAAOO,OAAOR,OAAOib,yBAA2C,iBAAE9I,OACvH2M,EAAiB,OAAKwoB,CACxB,CASA,OARA/jC,EAAE6O,KAAKyM,EACLC,GACA,SAASzM,GACP6M,EAAsB7M,EACxB,GACC,SAGI,CACT,IAEArS,OAAOwR,OAAOgE,GAAG,CACbqsB,eAAgB,SAAS9oB,GACR,aAARA,EAAEnQ,IACHyV,GAER,GA/EM,CAkFZ,CA4+GMkpB,GAIA,IAAIC,IAAqC,EACrCC,GAAU5pB,IACd,GAAI,WAAY4pB,GAAS,CAEvB,IADA,IAAIjoB,GAAUioB,GAAQjnC,OACbiC,GAAI,EAAGA,GAAInC,EAAIE,OAAOkC,OAAQD,MACjC2E,GAAI9G,EAAIE,OAAOiC,KACLuJ,aAEM,KAAdwT,GAAQ/c,MACV+kC,IAAqC,EACrCpgC,GAAEiQ,eAAc,IAItB+H,EAAaqoB,GACf,CAsBA,GAnBAlkC,EAAE,2CAA2C4D,MAAK,WAChD,IAAIugC,EAAKnkC,EAAEjF,MACP0D,EAAY0lC,EAAGr3B,MACfs3B,EAASrnC,EAAI8Q,gBAAgBpP,GAAW,GACxC2lC,IAGFD,EAAG7xB,YAAY,UAAW8xB,EAAOl6B,YAI5Bi6B,EAAGlkC,SAAS,aAAcmkC,EAAOp6B,WAAci6B,IAClDE,EAAG/jC,QAIT,IAGIw1B,GAAqB,CACvB74B,EAAI45B,mBAAmB,gCAAgC,GAAG0N,kBACjDnlC,GAAI,EAAb,IAAK,IAAWqD,GAAMtF,EAAOkC,OAAQD,GAAIqD,GAAKrD,KAAK,CACjD,IAAI2E,GAAI5G,EAAOiC,IACXsd,GAAMxc,EAAE,kDAAoD6D,GAAElB,KAAO,MACpEkzB,GAAU54B,QAAU4G,GAAEm2B,iBAAmBxd,GAAIvc,SAAS,YACzDD,EAAE,kDAAoD6D,GAAElB,KAAO,MAAMvC,OACzE,CACF,CAGAJ,EAAE,kEAAkE4D,MAAK,WACvE,IAAIugC,EAAKnkC,EAAEjF,MACP0D,EAAY0lC,EAAGr3B,MACfnK,EAAOlE,EACPA,KAAad,IACfgF,EAAOhD,EAAwBlB,IAC7BkE,KAAQjG,EAAOO,QAEU,QADTP,EAAOO,OAAO0F,GAChBsH,SACdk6B,EAAGjkC,SAAS,UAElB,IAGAF,EAAE,sBAAsBq2B,OAAO,QAASt5B,EAAIw5B,WAC5Cx5B,EAAIkR,OAAOgE,GAAG,CACZ2iB,QAAS,WAEP50B,EAAE,sDAAsD4D,MAAK,WAC3D,IAAImN,EAAO/Q,EAAEjF,MAETgK,EAAMrB,EADCqN,EAAKvQ,KAAK,MAAMhB,QAAQ,UAAW,KACL,GAC9B,MAAPuF,GAAsB,IAAPA,IAEjBgM,EAAKe,KAAK,0BAA0BtR,KAAK,WAAYuE,GAEjDgM,EAAK9Q,SAAS,YAChB8Q,EAAKe,KAAK,0BAA0BtR,KAAK,MAAOuE,GAGtD,IAEA/E,EAAE,sBAAsBq2B,OAAO,QAASt7B,KAAKw7B,UAC/C,IAIF95B,OAAOwR,OAAOgE,GAAG,CACf,kBAAqB,SAAUrB,GAG7B,IAAIjO,EAAOiO,EAAIoG,YACXjS,EAAMrB,EAAyBf,GAAM,GACzC,GAAW,MAAPoC,GAAsB,IAAPA,EAAW,CAC5B,IAAIu/B,EAAO,kCAAoC3hC,EAAO,0BACtD3C,EAAEskC,GAAM9jC,KAAK,WAAYuE,GACrB/E,EAAE,kCAAoC2C,GAAM1C,SAAS,YACvDD,EAAEskC,GAAM9jC,KAAK,MAAOuE,EACxB,CACF,IAIF/E,EAAE,eAAeiS,GAAG,QAAS,uBAAuB,WAClD,IAAIlB,EAAO/Q,EAAEjF,MACToF,EAAS4Q,EAAK5Q,SACdkF,EAAK0L,EAAKvQ,KAAK,QAAQuL,OAAO,GAC9BsN,EAAMrZ,EAAE,YAAcqF,GAC1B,GAAIlF,EAAOF,SAAS,UAClBD,EAAE,IAAMqF,GAAI3E,YAAY,UACxB2Y,EAAI3Y,YAAY,UAChBP,EAAOO,YAAY,UACnBjE,OAAOwR,OAAOC,aAAa,iBAAkB,CAAE,GAAM7I,QAChD,CACL,IAAIk/B,EAAYvkC,EAAE,mCACM,GAApBukC,EAAUplC,SACZolC,EAAU7jC,YAAY,UACtBjE,OAAOwR,OAAOC,aAAa,iBAAkB,CAAE,GAAMq2B,EAAUl+B,SAAS,KAAKmN,QAAQhT,KAAK,QAAQuL,OAAO,MAE3GsN,EAAIhT,SAAS,KAAKmN,QAAQpT,QAC1BD,EAAOD,SAAS,UAChBzD,OAAOwR,OAAOC,aAAa,iBAAkB,CAAE,GAAM7I,IACrD9B,GACF,CAGA,OAFAwN,EAAKQ,QAEE,CACT,IAGM,kBAAmB7U,EAGvBsD,EAAE,kBAAkBI,QAFpBJ,EAAE,kBAAkBG,SAASG,OAKuB,GAAlDN,EAAE,sCAAsCb,SAC1Ca,EAAE,yCAAyCU,YAAY,UACvDV,EAAE,6BAA6BU,YAAY,WAG7CV,EAAE,eAAeiS,GAAG,QAAS,mBAAmB,WAC9C,IAAIlB,EAAO/Q,EAAEjF,MACToF,EAAS4Q,EAAK5Q,SACdkF,EAAK0L,EAAKvQ,KAAK,QAAQuL,OAAO,GAC9BsN,EAAMrZ,EAAE,YAAcqF,GACtBm/B,EAAc,GAClB,GAAIrkC,EAAOF,SAAS,UAClBD,EAAE,IAAMqF,GAAI3E,YAAY,UACxB2Y,EAAI3Y,YAAY,UAChBP,EAAOO,YAAY,UACnB8jC,EAAc,iBACT,CACL,IAAID,EAAYvkC,EAAE,+BACM,GAApBukC,EAAUplC,SACZolC,EAAU7jC,YAAY,UACtBjE,OAAOwR,OAAOC,aAAa,aAAc,CAAE,GAAMq2B,EAAUl+B,SAAS,KAAKmN,QAAQhT,KAAK,QAAQuL,OAAO,MAEvGsN,EAAI5Y,OACJ4Y,EAAIhT,SAAS,KAAKmN,QAAQpT,QAC1BD,EAAOD,SAAS,UAChBskC,EAAc,YAChB,CACAzzB,EAAKQ,OAEL,IAAIkzB,EAAOzkC,EAAE,SAUb,OATsC,GAAlCA,EAAE,sBAAsBb,OAC1BslC,EAAKnkC,OACGmkC,EAAKpkC,GAAG,aAChBokC,EAAKhkC,OAGY,IAAf+jC,GACF/nC,OAAOwR,OAAOC,aAAas2B,EAAa,CAAE,GAAMn/B,KAE3C,CACT,IAEArF,EAAE,eAAeiS,GAAG,QAAS,yBAAyB,WACpD,IAAIlB,EAAO/Q,EAAEjF,MACToF,EAAS4Q,EAAK5Q,SACdkF,EAAK0L,EAAKvQ,KAAK,QAAQuL,OAAO,GAC9BsN,EAAMrZ,EAAE,YAAcqF,GACtBm/B,EAAc,GAClB,GAAIrkC,EAAOF,SAAS,UAClBD,EAAE,IAAMqF,GAAI3E,YAAY,UACxB2Y,EAAI3Y,YAAY,UAChBP,EAAOO,YAAY,UACf8jC,EAAc,sBACb,CACL,IAAID,EAAYvkC,EAAE,qCACM,GAApBukC,EAAUplC,SACZolC,EAAU7jC,YAAY,UACtBjE,OAAOwR,OAAOC,aAAa,kBAAmB,CAAE,GAAMq2B,EAAUl+B,SAAS,KAAKmN,QAAQhT,KAAK,QAAQuL,OAAO,MAE5GsN,EAAI5Y,OACJ4Y,EAAIhT,SAAS,KAAKmN,QAAQpT,QAC1BD,EAAOD,SAAS,UACZskC,EAAc,iBACpB,CACAzzB,EAAKQ,OAEL,IAAIkzB,EAAOzkC,EAAE,eAcb,OAb4C,GAAxCA,EAAE,4BAA4Bb,QAChCslC,EAAKnkC,OACLN,EAAE,YAAYU,YAAY,sBAC1Bb,KACU4kC,EAAKpkC,GAAG,cAClBL,EAAE,YAAYE,SAAS,sBACvBukC,EAAKhkC,OACLZ,KAIiB,IAAf2kC,GACF/nC,OAAOwR,OAAOC,aAAas2B,EAAa,CAAE,GAAMn/B,KAC3C,CACT,IAGArF,EAAE,eAAeI,OAAM,WACrBJ,EAAEjF,MAAMuX,YAAY,SACtB,IAGAtS,EAAE,qCAAqCiS,GAAG,QAAS,UAAU,WAC3DjS,EAAE,eAAeU,YAAY,SAC/B,IAGAV,EAAE,oBAAoBI,QACtBP,IAEAG,EAAE,mDAAmD2X,UACrD3X,EAAE,kCAAkC2X,UACpC5G,EAAK9C,OAAOC,aAAa,YAAa6C,EAAK,IAE5C2zB,OAAOC,IACN/lC,QAAQ+lC,MAAMA,GACd,MAAMC,EAAW,oCACQ/4B,QAAQ,4CAChB3Q,QAAQiR,aAAaN,QAAQ,iCAC9C6Z,SAAS0P,eAAe,UAAUyP,mBAAmB,WAAYD,EAAS,IAE3EE,SAAQ,KACP9kC,EAAE,QAAQe,IAAI,SAAU,QACxBf,EAAE,YAAY+kC,OAAO,SAGlB/U,GACD9X,EAAsB8X,EACpB,CACExR,EAAGzhB,EAAImY,KAAKjU,EAAI,EAChBmrB,EAAGrvB,EAAImY,KAAKtU,EAAI,GAEtB,GAEJ,GAUF,OAPAuoB,GAAIlb,OAAS,IAAI7L,WAAW4iC,OACxB7b,GAAK,KACL,CAAC,cAAc,aAAa,cAAc,YACzC,aAAa,eACd,EACA,CAAC8b,WAAW,IAET9b,EACT,CA/7MgB,GAq8MhB1sB,OAAOwR,OAAOgE,GAAG,CACb,WAAa,SAASrB,GAyBpB,GAvBM,mBAAoBA,EAAIlU,OAAOf,SACM,QAArCiV,EAAIlU,OAAOf,QAAQ03B,kBAEvBvvB,EAAc,CAAC,GACHiE,MAAQ8D,QAAQ,yBAC5B/H,EAAYnB,KAAO,iBACnBiO,EAAIlU,OAAOO,OAAuB,eAAI6G,EAEtC8M,EAAI5T,WAAWyJ,KAAK,IAAIrE,WAAWK,MAAMmT,OAAO,iBAAiB,CAC/DnN,aAAa,EACboN,UAAWjF,EAAI7T,IAAI8Y,UACnBlQ,SAAUiL,EAAI7T,IAAI4I,SAClBD,SAAUkL,EAAI7T,IAAI2I,SAClBqD,cAAe6H,EAAI7T,IAAIgM,cACvB3L,OAAQwT,EAAI7T,IAAIK,OAChBmL,WAAYqI,EAAI7T,IAAIwL,WACpB8M,MAAOzE,EAAI7T,IAAIwL,WAAWyF,KAAKqH,SAEjCzE,EAAI7T,IAAIi4B,aAAc,GAMxB,cAAepkB,EAAIlU,OAAOf,SACO,QAAhCiV,EAAIlU,OAAOf,QAAQm2B,WACpB,mBAAoBlhB,EAAIlU,OAAOf,SACQ,QAArCiV,EAAIlU,OAAOf,QAAQo2B,gBACrB,gBAAiBnhB,EAAIlU,OAAOf,SACQ,QAAlCiV,EAAIlU,OAAOf,QAAQq2B,aACrB,gBAAiBphB,EAAIlU,OAAOf,SACQ,QAAlCiV,EAAIlU,OAAOf,QAAQs2B,aAClB,WAAYrhB,EAAIlU,OAAOf,SAC1B,kBAAmBiV,EAAIlU,OAAOf,SACQ,QAApCiV,EAAIlU,OAAOf,QAAQu2B,eACrB,oBAAqBthB,EAAIlU,OAAOf,SACQ,QAAtCiV,EAAIlU,OAAOf,QAAQw2B,iBACrB,iBAAkBvhB,EAAIlU,OAAOf,SACQ,QAAnCiV,EAAIlU,OAAOf,QAAQy2B,cACrB,kBAAmBxhB,EAAIlU,OAAOf,SACQ,QAApCiV,EAAIlU,OAAOf,QAAQ02B,eACrB,gBAAiBzhB,EAAIlU,OAAOf,SACQ,QAAlCiV,EAAIlU,OAAOf,QAAQ22B,aAClB,YAAa1hB,EAAIlU,OAAOf,SAC3B,kBAAmBiV,EAAIlU,OAAOf,SACQ,QAApCiV,EAAIlU,OAAOf,QAAQ42B,eAClB,YAAa3hB,EAAIlU,OAAOf,SAC3B,eAAgBiV,EAAIlU,OAAOf,SACQ,QAAjCiV,EAAIlU,OAAOf,QAAQ62B,YAClB,YAAa5hB,EAAIlU,OAAOf,SAC3B,eAAgBiV,EAAIlU,OAAOf,SACQ,QAAjCiV,EAAIlU,OAAOf,QAAQ82B,YACrB,eAAgB7hB,EAAIlU,OAAOf,SACQ,QAAjCiV,EAAIlU,OAAOf,QAAQ+2B,YACrB,iBAAkB9hB,EAAIlU,OAAOf,SACQ,QAAnCiV,EAAIlU,OAAOf,QAAQg3B,cACrB,iBAAkB/hB,EAAIlU,OAAOf,SACQ,QAAnCiV,EAAIlU,OAAOf,QAAQi3B,aACrB,CAEA,IAAI/c,EAAY,KACXzT,WAAWqH,WAAWC,SAAS,eAAemM,UACjDA,EAAY,IAAIzT,WAAWya,OAAOza,WAAWqH,WAAWC,SAAS,eAAemM,WACxEzT,WAAWqH,WAAWC,SAAS,aAAamM,YACpDA,EAAY,IAAIzT,WAAWya,OAAOza,WAAWqH,WAAWC,SAAS,aAAamM,YAEhF,IAAIqvB,EAAW,CAACl8B,WAAW,EAAEm8B,cAAc,iBAC3C,GAAK,gBAAiBv0B,EAAIlU,OAAOf,SACe,GAAzCiV,EAAIlU,OAAOf,QAAQkN,YAAY1J,OAAa,CAMjD,IALA,IAAI0J,EAAc+H,EAAIlU,OAAOf,QAAQkN,YACjCC,EAASD,EAAY,GACrBE,EAAgBF,EAAY1J,OAC5B6J,EAAa,EACbC,EAAM,gBACFA,EAAMH,GACZE,GAAc,EACdC,EAAM,gBAAkBnH,KAAKoH,IAAI,EAAGF,GAEtCk8B,EAAqB,WAAIl8B,EACzBk8B,EAAwB,cAAIp8B,EAC5Bo8B,EAAwB,cAAIn8B,CAC9B,CAEA,GAAK,cAAe6H,EAAIlU,OAAOf,SAA4C,QAAhCiV,EAAIlU,OAAOf,QAAQm2B,UAAqB,CACjFlhB,EAAI7T,IAAIi4B,aAAc,EACtB,IAAIr5B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIo8B,EAAM,IAAIhjC,WAAWK,MAAM4iC,IAAI,MAC/B,CACA,qDAEC1pC,GAELypC,EAAIvvB,UAAYA,EAMhBjF,EAAIlU,OAAOO,OAAY,IALV,CACR,KAAO,MACP,MAAQ,gBACR,KAAO,aAGZ2T,EAAI5T,WAAWyJ,KAAK2+B,EACtB,CAEA,GAAK,mBAAoBx0B,EAAIlU,OAAOf,SAAiD,QAArCiV,EAAIlU,OAAOf,QAAQo2B,eAA0B,CAC3FnhB,EAAI7T,IAAIi4B,aAAc,EAClBr5B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIs8B,EAAc,IAAIljC,WAAWK,MAAM4iC,IAAI,YACvC,CAAC,wEACD,wEACA,wEACA,yEACC1pC,GAEL2pC,EAAYzvB,UAAYA,EAMxBjF,EAAIlU,OAAOO,OAAO,aALG,CACnB,KAAO,YACJ,MAAQ,mBACR,KAAO,aAGZ2T,EAAI5T,WAAWyJ,KAAK6+B,EACtB,CAEA,GAAK,gBAAiB10B,EAAIlU,OAAOf,SAA8C,QAAlCiV,EAAIlU,OAAOf,QAAQq2B,YAAuB,CACrFphB,EAAI7T,IAAIi4B,aAAc,EAClBr5B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIgpB,EAAc,IAAI5vB,WAAWK,MAAM4iC,IAAI,cACvC,CAAC,iDACD,iDACA,kDACC1pC,GAEDq2B,EAAYnc,UAAYA,EAM5BjF,EAAIlU,OAAOO,OAAoB,YALV,CACnB,KAAO,cACJ,MAAQ,cACR,KAAO,aAGZ2T,EAAI5T,WAAWyJ,KAAKurB,EACtB,CAEA,GAAK,gBAAiBphB,EAAIlU,OAAOf,SAA8C,QAAlCiV,EAAIlU,OAAOf,QAAQs2B,aAA0B,WAAYrhB,EAAIlU,OAAOf,QAAU,CACzHiV,EAAI7T,IAAIi4B,aAAc,EAClBr5B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIu8B,EAAW,IAAInjC,WAAWK,MAAM4iC,IAAI,eAAe,kEAAkEz0B,EAAIlU,OAAOf,QAAQ6pC,OAAO7pC,GACnJ4pC,EAAS1vB,UAAYA,EAMrBjF,EAAIlU,OAAOO,OAAO,aALA,CACb,KAAO,YACP,MAAQ,eACR,KAAO,aAGZ2T,EAAI5T,WAAWyJ,KAAK8+B,EACtB,CACA,IACE,GAAK,oBAAqB30B,EAAIlU,OAAOf,SAAkD,QAAtCiV,EAAIlU,OAAOf,QAAQw2B,gBAA2B,CACzFx2B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIy8B,EAAO,IAAIrjC,WAAWK,MAAMijC,OAC5B,OACA,CAACnoC,KAAMooC,OAAOxK,KAAKyK,UAAUC,UACzB98B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEzGy8B,EAAK5vB,UAAYA,EAMjBjF,EAAIlU,OAAOO,OAAa,KALV,CACT,KAAO,OACP,MAAQ,mBACV,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAKg/B,GACpB70B,EAAI7T,IAAIi4B,aAAc,EACtBpkB,EAAI7T,IAAIgpC,aAAe,CACzB,CACA,GAAK,iBAAkBn1B,EAAIlU,OAAOf,SAA+C,QAAnCiV,EAAIlU,OAAOf,QAAQy2B,aAAwB,CACnFz2B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIg9B,EAAO,IAAI5jC,WAAWK,MAAMijC,OAC5B,OACA,CAACnoC,KAAMooC,OAAOxK,KAAKyK,UAAUK,OACzBl9B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEzGg9B,EAAKnwB,UAAYA,EAMjBjF,EAAIlU,OAAOO,OAAa,KALV,CACT,KAAO,OACP,MAAQ,gBACV,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAKu/B,GACpBp1B,EAAI7T,IAAIi4B,aAAc,EACtBpkB,EAAI7T,IAAIgpC,aAAe,CACzB,CACA,GAAK,kBAAmBn1B,EAAIlU,OAAOf,SAAgD,QAApCiV,EAAIlU,OAAOf,QAAQ02B,cAAyB,CACrF12B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIk9B,EAAO,IAAI9jC,WAAWK,MAAMijC,OAC5B,OACA,CAACnoC,KAAMooC,OAAOxK,KAAKyK,UAAUO,QAC3Bp9B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEvGk9B,EAAKrwB,UAAYA,EAMjBjF,EAAIlU,OAAOO,OAAa,KALV,CACT,KAAO,OACP,MAAQ,iBACV,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAKy/B,GACpBt1B,EAAI7T,IAAIi4B,aAAc,EACtBpkB,EAAI7T,IAAIgpC,aAAe,CAC1B,CACA,GAAK,kBAAmBn1B,EAAIlU,OAAOf,SAAgD,QAApCiV,EAAIlU,OAAOf,QAAQu2B,cAAyB,CACpFv2B,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC5D,IAAIo9B,EAAO,IAAIhkC,WAAWK,MAAMijC,OAC5B,OACA,CAAC38B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEtGo9B,EAAKvwB,UAAYA,EAMjBjF,EAAIlU,OAAOO,OAAa,KALV,CACT,KAAO,OACP,MAAQ,iBACR,KAAO,aAGZ2T,EAAI5T,WAAWyJ,KAAK2/B,GACpBx1B,EAAI7T,IAAIi4B,aAAc,EACtBpkB,EAAI7T,IAAIgpC,aAAe,CACzB,CACA,GAAK,gBAAiBn1B,EAAIlU,OAAOf,SAA8C,QAAlCiV,EAAIlU,OAAOf,QAAQ22B,aAA0B,YAAa1hB,EAAIlU,OAAOf,QAAW,CACtHA,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIq9B,EAAO,IAAIjkC,WAAWK,MAAM6jC,KAAK,CAClCpzB,IAAKtC,EAAIlU,OAAOf,QAAQ4qC,QACxBhpC,KAAM,OACNoF,KAAM,YACNoG,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEpGq9B,EAAKxwB,UAAYA,EAMjBjF,EAAIlU,OAAOO,OAAa,KALV,CACX,KAAO,OACP,MAAQ,YACR,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAK4/B,GACpBz1B,EAAI7T,IAAIi4B,aAAc,CACzB,CACA,GAAK,kBAAmBpkB,EAAIlU,OAAOf,SAAgD,QAApCiV,EAAIlU,OAAOf,QAAQ42B,eAA4B,YAAa3hB,EAAIlU,OAAOf,QAAW,CAC1HA,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIw9B,EAAU,IAAIpkC,WAAWK,MAAM6jC,KAAK,CACrCpzB,IAAKtC,EAAIlU,OAAOf,QAAQ4qC,QACxBhpC,KAAM,SACNoF,KAAM,cACNoG,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEpGw9B,EAAQ3wB,UAAYA,EAMpBjF,EAAIlU,OAAOO,OAAgB,QALV,CACd,KAAO,UACP,MAAQ,cACR,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAK+/B,GACpB51B,EAAI7T,IAAIi4B,aAAc,CACzB,CACA,GAAK,eAAgBpkB,EAAIlU,OAAOf,SAA6C,QAAjCiV,EAAIlU,OAAOf,QAAQ62B,YAAyB,YAAa5hB,EAAIlU,OAAOf,QAAW,CACpHA,EAAU,CACZqN,WAAY,EACZm8B,cAAc,gBACdp8B,cAAc,IAEW,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAWk8B,EAASn8B,eAAiBpN,EAAQoN,cACxDpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAIy9B,EAAU,IAAIrkC,WAAWK,MAAM6jC,KAAK,CACrCpzB,IAAKtC,EAAIlU,OAAOf,QAAQ4qC,QACxBhpC,KAAM,mBACNoF,KAAM,cACNoG,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAanqC,EAAQqN,aAEpGy9B,EAAQ5wB,UAAYA,EAMpBjF,EAAIlU,OAAOO,OAAgB,QALV,CACd,KAAO,UACP,MAAQ,cACR,KAAO,aAGV2T,EAAI5T,WAAWyJ,KAAKggC,GACpB71B,EAAI7T,IAAIi4B,aAAc,CACzB,CAEA,IAAI0R,EAAiB,sMAGpB,GAAI,WAAY91B,EAAIlU,OAAOf,QAAQ,CACjC,IAAIgrC,EAAS/1B,EAAIlU,OAAOf,QAAQgrC,OAEhC,GAAK,eAAgB/1B,EAAIlU,OAAOf,SAA6C,QAAjCiV,EAAIlU,OAAOf,QAAQ82B,WAAsB,CAC/E92B,EAAU,CACZqN,WAAY,EACZm8B,cAAe,gBACfp8B,cAAe,IAEU,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAak8B,EAASn8B,eAAiBpN,EAAQoN,cAC1DpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAI49B,EAAS,IAAIxkC,WAAWK,MAAMs3B,KAAK,CACrCp3B,KAAM,SACNoC,IAAK,sBAAwB4hC,EAAS,mBACtCnkC,MAAO,+BACP8F,UAAW,KACX8R,MAAO,SACP7R,WAAY,IAAInG,WAAWqH,WAAW,aACtC7B,YAAa8+B,EACX39B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAcnqC,EAAQqN,WAClGA,WAAYrN,EAAQqN,aAGxB49B,EAAO/wB,UAAYA,EAMnBjF,EAAIlU,OAAOO,OAAe,OALV,CACd,KAAQ,SACN,MAAS,WACT,KAAQ,aAGZ2T,EAAI5T,WAAWyJ,KAAKmgC,GACpBh2B,EAAI7T,IAAIi4B,aAAc,CACxB,CACF,CACA,GAAK,eAAgBpkB,EAAIlU,OAAOf,SAA6C,QAAjCiV,EAAIlU,OAAOf,QAAQ+2B,WAAsB,CAC/E/2B,EAAU,CACZqN,WAAY,EACZm8B,cAAe,gBACfp8B,cAAe,IAEU,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAak8B,EAASn8B,eAAiBpN,EAAQoN,cAC1DpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAI69B,EAAU,IAAIzkC,WAAWK,MAAMs3B,KAAK,CACtCp3B,KAAM,UACNoC,IAAK,4CACLvC,MAAO,oCACP8F,UAAW,KACX8R,MAAO,SACP3S,OAAQ,YACRc,WAAY,IAAInG,WAAWqH,WAAW,aACtC7B,YAAa8+B,EACX39B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAcnqC,EAAQqN,WAClGA,WAAYrN,EAAQqN,aAGxB69B,EAAQhxB,UAAYA,EAMpBjF,EAAIlU,OAAOO,OAAgB,QALV,CACf,KAAQ,UACN,MAAS,WACT,KAAQ,aAGZ2T,EAAI5T,WAAWyJ,KAAKogC,GACpBj2B,EAAI7T,IAAIi4B,aAAc,CACxB,CACA,GAAK,iBAAkBpkB,EAAIlU,OAAOf,SAA+C,QAAnCiV,EAAIlU,OAAOf,QAAQg3B,aAAwB,CACnFh3B,EAAU,CACZqN,WAAY,EACZm8B,cAAe,gBACfp8B,cAAe,IAEU,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAak8B,EAASn8B,eAAiBpN,EAAQoN,cAC1DpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAI89B,EAAW,IAAI1kC,WAAWK,MAAMs3B,KAAK,CACvCp3B,KAAM,WACNoC,IAAK,2CACLvC,MAAO,2BACP8F,UAAW,KACX8R,MAAO,SACP7R,WAAY,IAAInG,WAAWqH,WAAW,aACtC7B,YAAa8+B,EACX39B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAcnqC,EAAQqN,WAClGA,WAAYrN,EAAQqN,aAGxB89B,EAASjxB,UAAYA,EAMrBjF,EAAIlU,OAAOO,OAAiB,SALV,CAChB,KAAQ,WACN,MAAS,aACT,KAAQ,aAGZ2T,EAAI5T,WAAWyJ,KAAKqgC,GACpBl2B,EAAI7T,IAAIi4B,aAAc,CACxB,CACA,GAAK,iBAAkBpkB,EAAIlU,OAAOf,SAA+C,QAAnCiV,EAAIlU,OAAOf,QAAQi3B,aAAwB,CACnFj3B,EAAU,CACZqN,WAAY,EACZm8B,cAAe,gBACfp8B,cAAe,IAEU,GAAvBm8B,EAASl8B,aACXrN,EAAQqN,WAAak8B,EAASl8B,WAC9BrN,EAAQwpC,cAAgBD,EAASC,eAE/BD,EAASl8B,WAAak8B,EAASn8B,eAAiBpN,EAAQoN,cAC1DpN,EAAQoN,cAAgBm8B,EAASn8B,cAEjCpN,EAAQoN,cAAgBpN,EAAQoN,cAAgBm8B,EAASl8B,WAC3D,IAAI+9B,EAAe,IAAI3kC,WAAWK,MAAMs3B,KAAK,CAC3Cp3B,KAAM,eACNoC,IAAK,iDACLvC,MAAO,uCACP8F,UAAW,KACX8R,MAAO,SACP3S,OAAQ,YACRc,WAAY,IAAInG,WAAWqH,WAAW,aACtC7B,YAAa8+B,EACX39B,cAAepN,EAAQoN,cAAeo8B,cAAexpC,EAAQwpC,cAAeW,aAAcnqC,EAAQqN,WAClGA,WAAYrN,EAAQqN,aAGxB+9B,EAAalxB,UAAYA,EAMzBjF,EAAIlU,OAAOO,OAAqB,aALV,CACpB,KAAQ,eACN,MAAS,eACT,KAAQ,aAGZ2T,EAAI5T,WAAWyJ,KAAKsgC,GACpBn2B,EAAI7T,IAAIi4B,aAAc,CACxB,CACF,CAAE,MAAMxf,GACP,CACF,CAEC,GAAG,6BAA8B5E,EAAIlU,OAAO,CAE1C,IAAIsqC,EAAkB5kC,WAAWwC,KAAKE,UAAU5J,QAAQY,IACrDsG,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAE9C,GAAID,QAAQoL,eAAiBpL,QAAQoL,cAAcnH,OAAS,EAAI,CAC5D6nC,EAAkB,GAClB,IAAK,IAAIzgC,EAAE,EAAGC,EAAKtL,QAAQoL,cAAcnH,OAAQoH,EAAEC,EAAMD,IACvDygC,EAAgBvgC,KACdrE,WAAWwC,KAAKE,UACd5J,QAAQoL,cAAcC,GACtBnE,WAAWwC,KAAKC,mBAAmB3J,QAAQC,SAIrD,CAGA,IAAK,IAAIkK,KAAMuL,EAAIlU,OAAiC,yBAAG,CAErD,IAAIoH,EAAc8M,EAAIlU,OAAiC,yBAAE2I,GAEzD,GAAM,eAAgBvB,GAAkB,YAAaA,EAArD,CAGA,IAAIlE,EAAYgR,EAAInS,UAAUqF,EAAYlE,WAEtC0H,EAAiB,CACnBrK,OAAO6G,EAAYlE,UAClB2H,QAAQ,QACRC,WAAW,iCACXC,OAAQ3D,EAA4B,iBAAI,SAASA,EAAYmjC,iBAAmB,YAChFt/B,IAAI,IAEsB,cAAzBL,EAAeG,SACjBH,EAA4B,aAAI,GAGlC,IAAIhI,EAAM,IAAIC,OAAO,+BAAkC,KACvD,GAAOynC,aAA2Bxb,MAG5BzmB,EAAMmiC,OAAOnqC,IAAIiqC,GAAiB,SAAS7D,GAAW,OAAOA,EAAQ3jC,QAAQF,EAAK,cAAcwE,EAAY7I,WAAW,YAAY6I,EAAY1I,QAAS,SAF5J,IAAI2J,EAAMiiC,EAAgBxnC,QAAQF,EAAK,cAAcwE,EAAY7I,WAAW,YAAY6I,EAAY1I,SAKtG0I,EAAYiE,MAAQjE,EAAYqjC,WAChCrjC,EAAYnB,KAAOmB,EAAYlE,UAC/BkE,EAAYsR,WAAY,EACxBtR,EAAYjB,WAAa,QACzB+N,EAAIlU,OAAOO,OAAO2C,GAAakE,EAC/B8M,EAAI5T,WAAWyJ,KAAK,IAAIrE,WAAWK,MAAMtG,IAAIyD,EAAUmF,EACpDuC,EACA,CAACmB,aAAY,EACb4B,OAA8B,QAAtBvG,EAAYoE,OAAoB,EAAI,EAC5CoC,OAAO,EACPzH,WAAsC,QAA1BiB,EAAYjB,WACxBG,MAAM,KAET4N,EAAI7T,IAAIi4B,aAAc,CAnCZ,CAqCZ,CACF,CAEF,EAED,UAAa,SAASpkB,GACpB,IAAI7T,EAAM6T,EAAI7T,IACTA,EAAIsI,MAAMjD,WAAWK,MAAMijC,OAAO0B,OACpCzB,OAAOxK,KAAKjpB,MAAMm1B,gBAAgBjlC,WAAWK,MAAMijC,OAAO0B,MAAMrqC,EAAIsI,IAAIiiC,UAAW,eAAe,WAG9F,IAFA,IAAIC,EAAWxqC,EAAIE,OACfuqC,GAAc,EACTtoC,EAAEqoC,EAASpoC,OAAO,EAAGD,GAAG,IAAKA,EAElC,IADIsD,EAAQ+kC,EAASroC,cACAkD,WAAWK,MAAMijC,SACL,IAArBljC,EAAM0H,aAAyC,IAAlB1H,EAAMqyB,QAAkB,CAC7DryB,EAAMc,QAAO,GACbkkC,GAAc,EACd,KACJ,CAEJ,IAAKA,EACD,IAAStoC,EAAEqoC,EAASpoC,OAAO,EAAGD,GAAG,IAAKA,EAAG,CACrC,IAAIsD,EACJ,IADIA,EAAQ+kC,EAASroC,cACAkD,WAAWK,MAAMijC,OAAQ,CAC1CljC,EAAMilC,SAAQ,GACd,KACJ,CACJ,CAER,IAIEhrC,OAAO4sB,eACLrpB,EAAE,oBAAoBG,SAASF,SAAS,WAC1CD,EAAE,oBAAoBI,QAI1BJ,EAAE,eAAeI,OAAM,WAAYJ,EAAE,+CAA+CI,OAAS,IAC7FJ,EAAE,qBAAqBI,OAAM,WAAYJ,EAAE,qDAAqDI,OAAS,GAC5G,IAIHJ,EAAE0lB,UAAUgiB,OAAM,WAEhB1nC,EAAE,QAAQe,IAAI,SAAU,QACxBf,EAAE,YAAY+kC,OAAO,CACnB4C,OAAO,EACLC,WAAW,EACXC,WAAW,EACXC,eAAe,EACfC,YAAa,kBACbC,UAAW,MAEd7nC,SAASO,YAAY,iBACrB2F,SAAS,uBAAuB3F,YAAY,iBAE7C0B,WAAW6lC,cAAgB,GAE3BxrC,OAAO6yB,OACPtvB,EAAG,YAAae,IAAI,aAAa,QACnC","sources":["webpack://assets/./src/modules/WFS.js","webpack://assets/./src/modules/WMS.js","webpack://assets/./src/legacy/map.js","webpack://assets/./node_modules/ol/extent.js"],"sourcesContent":["export default class WFS {\n\n    constructor() {\n        this._defaultGetFeatureParameters = {\n            repository: lizUrls.params.repository,\n            project: lizUrls.params.project,\n            SERVICE: 'WFS',\n            REQUEST: 'GetFeature',\n            VERSION: '1.0.0',\n            OUTPUTFORMAT: 'GeoJSON'\n        };\n\n        this._defaultDescribeFeatureTypeParameters = {\n            repository: lizUrls.params.repository,\n            project: lizUrls.params.project,\n            SERVICE: 'WFS',\n            REQUEST: 'DescribeFeatureType',\n            VERSION: '1.0.0',\n            OUTPUTFORMAT: 'JSON'\n        };\n    }\n\n    /**\n     * @param {Object} options - optional parameters which can override this._defaultParameters\n     * @return {Promise} Promise object represents data\n     * @memberof WFS\n     */\n    async getFeature(options) {\n        const response = await fetch(lizUrls.wms, {\n            method: \"POST\",\n            body: new URLSearchParams({\n                ...this._defaultGetFeatureParameters,\n                ...options\n            })\n        });\n        return await response.json();\n    }\n\n    /**\n     * @param {Object} options - optional parameters which can override this._defaultParameters\n     * @return {Promise} Promise object represents data\n     * @memberof WFS\n     */\n    async describeFeatureType(options) {\n        const response = await fetch(lizUrls.wms, {\n            method: \"POST\",\n            body: new URLSearchParams({\n                ...this._defaultDescribeFeatureTypeParameters,\n                ...options\n            })\n        });\n        return await response.json();\n    }\n}\n","export default class WMS {\n\n    constructor() {\n        this._defaultGetFeatureInfoParameters = {\n            repository: lizUrls.params.repository,\n            project: lizUrls.params.project,\n            SERVICE: 'WMS',\n            REQUEST: 'GetFeatureInfo',\n            VERSION: '1.3.0',\n            SRS: 'EPSG:4326',\n            INFO_FORMAT: 'text/html'\n        };\n    }\n\n    /**\n     * @param {Object} options - optional parameters which can override this._defaultGetFeatureInfoParameters\n     * @return {Promise} Promise object represents data\n     * @memberof WMS\n     */\n    async getFeatureInfo(options) {\n        const response = await fetch(lizUrls.wms, {\n            method: \"POST\",\n            body: new URLSearchParams({\n                ...this._defaultGetFeatureInfoParameters,\n                ...options\n            })\n        });\n        return await response.text();\n    }\n}\n","/**\n* Class: lizMap\n* @package   lizmap\n* @subpackage view\n* @author    3liz\n* @copyright 2011 3liz\n* @link      http://3liz.com\n* @license    Mozilla Public License : http://www.mozilla.org/MPL/\n*/\n\nimport {extend} from 'ol/extent';\n\nimport WFS from '../modules/WFS.js';\nimport WMS from '../modules/WMS.js';\n\nwindow.lizMap = function() {\n  /**\n   * PRIVATE Property: config\n   * {object} The map config\n   */\n  var config = null;\n  /**\n * PRIVATE Property: keyValueConfig\n * {object} Config to replace keys by values\n */\n  var keyValueConfig = null;\n  /**\n   * PRIVATE Property: capabilities\n   * {object} The wms capabilities\n   */\n  var capabilities = null;\n  /**\n   * PRIVATE Property: wmtsCapabilities\n   * {object} The wmts capabilities\n   */\n  var wmtsCapabilities = null;\n  /**\n   * PRIVATE Property: wfsCapabilities\n   * {object} The wfs capabilities\n   */\n  var wfsCapabilities = null;\n  /**\n   * PRIVATE Property: map\n   * {<OpenLayers.Map>} The map\n   */\n  var map = null;\n  /**\n   * PRIVATE Property: baselayers\n   * {Array(<OpenLayers.Layer>)} Ordered list of base layers\n   */\n  var baselayers = [];\n  /**\n   * PRIVATE Property: layers\n   * {Array(<OpenLayers.Layer>)} Ordered list of layers\n   */\n  var layers = [];\n  /**\n   * PRIVATE Property: controls\n   * {Object({key:<OpenLayers.Control>})} Dictionary of controls\n   */\n  var controls = {};\n  /**\n   * PRIVATE Property: printCapabilities\n   * {Object({scales:[Float],layouts:[Object]})} Print capabilities\n   */\n  var printCapabilities = {scales:[],layouts:[]};\n  /**\n   * PRIVATE Property: tree\n   * {object} The layer's tree\n   */\n  var tree = {config:{type:'group'}};\n\n  /**\n   * PRIVATE Property: getFeatureInfoVendorParams\n   * {object} Additional QGIS Server parameter for click tolerance in pixels\n   */\n  var defaultGetFeatureInfoTolerances = {\n    'FI_POINT_TOLERANCE': 25,\n    'FI_LINE_TOLERANCE': 10,\n    'FI_POLYGON_TOLERANCE': 5\n  };\n\n  /**\n   * PRIVATE Property: externalBaselayersReplacement\n   *\n   */\n  var externalBaselayersReplacement = {\n    'osm': 'osm-mapnik',\n    'osm-toner': 'osm-stamen-toner',\n    'opentopomap': 'open-topo-map',\n    'osm-cycle': 'osm-cyclemap',\n    'gsat': 'google-satellite',\n    'ghyb': 'google-hybrid',\n    'gphy': 'google-terrain',\n    'gmap': 'google-street',\n    'bmap': 'bing-road',\n    'baerial': 'bing-aerial',\n    'bhybrid': 'bing-hybrid',\n    'ignmap': 'ign-scan',\n    'ignplan': 'ign-plan',\n    'ignphoto': 'ign-photo',\n    'igncadastral': 'ign-cadastral'\n  };\n\n  /**\n   * PRIVATE Property: externalBaselayersReplacement\n   *\n   */\n  var startupBaselayersReplacement = {\n    'osm-mapnik': 'osm',\n    'osm-stamen-toner': 'osm-toner',\n    'open-topo-map': 'opentopomap',\n    'osm-cyclemap': 'osm-cycle',\n    'google-satellite': 'gsat',\n    'google-hybrid': 'ghyb',\n    'google-terrain': 'gphy',\n    'google-street': 'gmap',\n    'bing-road': 'bmap',\n    'bing-aerial': 'baerial',\n    'bing-hybrid': 'bhybrid',\n    'ign-scan': 'ignmap',\n    'ign-plan': 'ignplan',\n    'ign-photo': 'ignphoto',\n    'ign-cadastral': 'igncadastral',\n    'empty': 'emptyBaselayer'\n  };\n\n  /**\n   * PRIVATE Property: cleanNameMap\n   *\n   */\n  var cleanNameMap = {\n  };\n\n  /**\n   * PRIVATE Property: layerIdMap\n   *\n   */\n  var layerIdMap = {\n  };\n  /**\n   * PRIVATE Property: shortNameMap\n   *\n   */\n  var shortNameMap = {\n  };\n  /**\n   * PRIVATE Property: typeNameMap\n   *\n   */\n  var typeNameMap = {\n  };\n\n  /**\n   * Permalink args\n   */\n  var permalinkArgs = null;\n\n  /**\n   * PRIVATE Property: layerCleanNames\n   *\n   */\n  var layerCleanNames = {};\n\n  /**\n   * PRIVATE Property: lizmapLayerFilterActive. Contains layer name if filter is active\n   *\n   */\n  var lizmapLayerFilterActive = null;\n\n  /**\n   * PRIVATE Property: editionPending. True when an edition form has already been displayed. Used to prevent double-click on launchEdition button\n   *\n   */\n  var editionPending = false;\n\n  var lastLonLatInfo = null;\n\n  /**\n   * Get the metadata written in the configuration file by the desktop Lizmap plugin.\n   *\n   * This method should be used EVERY TIME we need to add \"if\" conditions\n   * to adapt the code for configuration parameters changes across versions.\n   * This will ease in the future the review of the code to remove all the \"if\"\n   * conditions: we will just need to search for \"getLizmapDesktopPluginMetadata\"\n   * and not: \"if 'someproperty' in someconfig\".\n   *\n   * For very old configuration files, which have not the needed metadata, we\n   * return fake versions for each property.\n   *\n   * Dependencies:\n   * config\n   */\n  function getLizmapDesktopPluginMetadata()\n  {\n    // Default fake versions if the properties does not yet exist in configuration file\n    // lizmap/modules/lizmap/lib/Project/Project.php\n    var plugin_metadata = {\n      lizmap_plugin_version_str: \"3.1.8\",\n      lizmap_plugin_version: 30108,\n      lizmap_web_client_target_version: 30200,\n      project_valid: null,\n      qgis_desktop_version: 30000\n    };\n\n    if (!('metadata' in config)) {\n      return plugin_metadata;\n    }\n    if ('lizmap_plugin_version' in config['metadata']) {\n      plugin_metadata['lizmap_plugin_version'] = config['metadata']['lizmap_plugin_version'];\n    }\n    if ('lizmap_web_client_target_version' in config['metadata']) {\n      plugin_metadata['lizmap_web_client_target_version'] = config['metadata']['lizmap_web_client_target_version'];\n    }\n    if ('project_valid' in config['metadata']) {\n      plugin_metadata['project_valid'] = config['metadata']['project_valid'];\n    }\n    if ('qgis_desktop_version' in config['metadata']) {\n      plugin_metadata['qgis_desktop_version'] = config['metadata']['qgis_desktop_version'];\n    }\n\n    return plugin_metadata;\n\n  }\n\n  function performCleanName(aName) {\n    var accentMap = {\n        \"à\": \"a\",    \"á\": \"a\",    \"â\": \"a\",    \"ã\": \"a\",    \"ä\": \"a\",    \"ç\": \"c\",    \"è\": \"e\",    \"é\": \"e\",    \"ê\": \"e\",    \"ë\": \"e\",    \"ì\": \"i\",    \"í\": \"i\",    \"î\": \"i\",    \"ï\": \"i\",    \"ñ\": \"n\",    \"ò\": \"o\",    \"ó\": \"o\",    \"ô\": \"o\",    \"õ\": \"o\",    \"ö\": \"o\",    \"ù\": \"u\",    \"ú\": \"u\",    \"û\": \"u\",    \"ü\": \"u\",    \"ý\": \"y\",    \"ÿ\": \"y\",\n        \"À\": \"A\",    \"Á\": \"A\",    \"Â\": \"A\",    \"Ã\": \"A\",    \"Ä\": \"A\",    \"Ç\": \"C\",    \"È\": \"E\",    \"É\": \"E\",    \"Ê\": \"E\",    \"Ë\": \"E\",    \"Ì\": \"I\",    \"Í\": \"I\",    \"Î\": \"I\",    \"Ï\": \"I\",    \"Ñ\": \"N\",    \"Ò\": \"O\",    \"Ó\": \"O\",    \"Ô\": \"O\",    \"Õ\": \"O\",    \"Ö\": \"O\",    \"Ù\": \"U\",    \"Ú\": \"U\",    \"Û\": \"U\",    \"Ü\": \"U\",    \"Ý\": \"Y\",\n        \"-\":\" \", \"'\": \" \", \"(\": \" \", \")\": \" \"};\n    var normalize = function( term ) {\n        var ret = \"\";\n        for ( var i = 0; i < term.length; i++ ) {\n            ret += accentMap[ term.charAt(i) ] || term.charAt(i);\n        }\n        return ret;\n    };\n    var theCleanName = normalize(aName);\n    var reg = new RegExp('\\\\W', 'g');\n    return theCleanName.replace(reg, '_');\n  }\n\n  /**\n   * PRIVATE function: cleanName\n   * cleaning layerName for class and layer\n   */\n  function cleanName(aName){\n    if ( aName in cleanNameMap )\n        return aName;\n\n    if ( aName == undefined ) {\n        console.log( \"An undefined name has been clean\" );\n        return '';\n    }\n\n    var theCleanName = performCleanName( aName );\n    if ( (theCleanName in cleanNameMap) && cleanNameMap[theCleanName] != aName ){\n        var i = 1;\n        var nCleanName = theCleanName+i;\n        while( (nCleanName in cleanNameMap) && cleanNameMap[nCleanName] != aName ){\n          i += 1;\n          nCleanName = theCleanName+i;\n        }\n        theCleanName = nCleanName;\n    }\n    cleanNameMap[theCleanName] = aName;\n    return theCleanName;\n  }\n\n  function getNameByCleanName( cleanName ){\n    var name = null;\n    if( cleanName in cleanNameMap )\n      name = cleanNameMap[cleanName];\n    return name;\n  }\n\n  function getNameByShortName( shortName ){\n    var name = null;\n    if( shortName in shortNameMap )\n      name = shortNameMap[shortName];\n    return name;\n  }\n\n  function getNameByTypeName( typeName ){\n    var name = null;\n    if( typeName in typeNameMap )\n      name = typeNameMap[typeName];\n    return name;\n  }\n\n  function getLayerNameByCleanName( cleanName ){\n    var layerName = null;\n    if( cleanName in layerCleanNames )\n      layerName = layerCleanNames[cleanName];\n    if ( layerName == null && cleanName in cleanNameMap ) {\n      layerName = cleanNameMap[cleanName];\n      layerCleanNames[cleanName] = layerName;\n    }\n    return layerName;\n  }\n\n\n  /**\n   * PRIVATE function: updateMobile\n   * Determine if we should display the mobile version.\n   */\n  function updateMobile(){\n    var isMobile = mCheckMobile();\n    var contentIsMobile = $('#content').hasClass('mobile');\n    if (isMobile == contentIsMobile)\n      return;\n\n    if (isMobile) {\n      // Add mobile class to content\n      $('#content, #headermenu').addClass('mobile');\n\n      // Hide switcher\n      if( $('#button-switcher').parent().hasClass('active') )\n        $('#button-switcher').click();\n\n      // Hide tooltip-layer\n      if( $('#button-tooltip-layer').parent().hasClass('active') )\n        $('#button-tooltip-layer').click();\n\n      if( $('#menu').is(':visible'))\n        $('#menu').hide();\n\n      $('#map-content').append($('#toolbar'));\n\n      $('#toggleLegend')\n        .attr('data-original-title',$('#toggleLegendOn').attr('value'))\n        .parent().attr('class','legend');\n\n      // autocompletion items for locatebylayer feature\n      $('div.locate-layer select').show();\n      $('span.custom-combobox').hide();\n    }\n    else\n    {\n      // Remove mobile class to content\n      $('#content, #headermenu').removeClass('mobile');\n\n      // Show switcher\n      if( !( $('#button-switcher').parent().hasClass('active') ) )\n        $('#button-switcher').click();\n\n      if( !$('#menu').is(':visible'))\n        $('#content span.ui-icon-open-menu').click();\n      else\n        $('#map-content').show();\n\n      $('#toolbar').insertBefore($('#switcher-menu'));\n\n      $('#toggleLegend')\n        .attr('data-original-title',$('#toggleMapOnlyOn').attr('value'))\n        .parent().attr('class','map');\n\n      // autocompletion items for locatebylayer feature\n      $('div.locate-layer select').hide();\n      $('span.custom-combobox').show();\n    }\n\n  }\n\n\n  /**\n   * PRIVATE function: updateContentSize\n   * update the content size\n   */\n  function updateContentSize(){\n\n    updateMobile();\n\n    // calculate height height\n    var h = $(window).innerHeight();\n    h = h - $('#header').height();\n    $('#map').height(h);\n\n    // Update body padding top by summing up header+headermenu\n    $('body').css('padding-top', $('#header').outerHeight() );\n\n    // calculate map width depending on theme configuration\n    // (fullscreen map or not, mobile or not)\n    var w = $('body').parent()[0].offsetWidth;\n    w -= parseInt($('#map-content').css('margin-left'));\n    w -= parseInt($('#map-content').css('margin-right'));\n    if ($('#menu').is(':hidden') || $('#map-content').hasClass('fullscreen')) {\n      $('#map-content').css('margin-left','auto');\n    } else {\n      w -= $('#menu').width();\n      $('#map-content').css('margin-left', $('#menu').width());\n    }\n    $('#map').width(w);\n\n    if ( $('#right-dock-tabs').is(':visible') ){\n      $('#right-dock-content').css( 'max-height', $('#right-dock').height() - $('#right-dock-tabs').height() );\n    }\n\n    if(map){\n      updateMapSize();\n    }\n  }\n\n\n  /**\n   * PRIVATE function: updateMapSize\n   * query OpenLayers to update the map size\n   */\n function updateMapSize(){\n    //manage WMS max width and height\n    var wmsMaxWidth = 3000;\n    var wmsMaxHeight = 3000;\n    if( ('wmsMaxWidth' in config.options) && config.options.wmsMaxWidth )\n        wmsMaxWidth = Number(config.options.wmsMaxWidth);\n    if( ('wmsMaxHeight' in config.options) && config.options.wmsMaxHeight )\n        wmsMaxHeight = Number(config.options.wmsMaxHeight);\n    var removeSingleTile = false;\n    var newMapSize = map.getCurrentSize();\n    var replaceSingleTileSize = newMapSize.clone();\n    if( newMapSize.w > wmsMaxWidth || newMapSize.h > wmsMaxHeight ){\n        removeSingleTile = true;\n        var wmsMaxMax = Math.max(wmsMaxWidth, wmsMaxHeight);\n        var wmsMinMax = Math.min(wmsMaxWidth, wmsMaxHeight);\n        var mapMax = Math.max(newMapSize.w, newMapSize.h);\n        var mapMin = Math.min(newMapSize.w, newMapSize.h);\n        if( mapMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(mapMax/2), Math.round(mapMax/2));\n        else if( wmsMaxMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMaxMax/2), Math.round(wmsMaxMax/2));\n        else\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMinMax/2), Math.round(wmsMinMax/2));\n    }\n    // Update singleTile layers\n    for(var i=0, len=map.layers.length; i<len; ++i) {\n        var layer = map.layers[i];\n        if( !(layer instanceof OpenLayers.Layer.WMS) )\n            continue;\n        var qgisName = null;\n        if ( layer.name in cleanNameMap )\n            qgisName = getLayerNameByCleanName(layer.name);\n        var configLayer = null;\n        if ( qgisName )\n            configLayer = config.layers[qgisName];\n        if ( !configLayer )\n            configLayer = config.layers[layer.params['LAYERS']];\n        if ( !configLayer )\n            configLayer = config.layers[layer.name];\n        if ( !configLayer )\n            continue;\n        if( configLayer.singleTile != \"True\" )\n            continue;\n        if( removeSingleTile && layer.singleTile) {\n          layer.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n        } else if( !removeSingleTile && !layer.singleTile) {\n          replaceSingleTileSize.h = parseInt(replaceSingleTileSize.h * layer.ratio, 10);\n          replaceSingleTileSize.w = parseInt(replaceSingleTileSize.w * layer.ratio, 10);\n          layer.addOptions({singleTile:true, tileSize: replaceSingleTileSize});\n        }\n    }\n\n    var center = map.getCenter();\n    map.updateSize();\n    map.setCenter(center);\n    map.baseLayer.redraw();\n\n    updateMiniDockSize();\n  }\n\n  /**\n   * PRIVATE function: updateMiniDockSize\n   * update the minidock size\n   */\n  function updateMiniDockSize() {\n      if ( $('#mini-dock .tab-pane:visible').length == 0 )\n        return 0;\n      // the mini-dock menu-content visible\n      var mdmcv = $('#mini-dock .tab-pane:visible h3 ~ .menu-content:first');\n      mdmcv.css( 'max-height', '100%' )\n      var h = $('#mini-dock').height();\n      h -= $('#mini-dock .tab-pane:visible h3').height();\n      h -= (parseInt(mdmcv.css('margin-top')) ? parseInt(mdmcv.css('margin-top')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('margin-bottom')) ? parseInt(mdmcv.css('margin-bottom')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('padding-top')) ? parseInt(mdmcv.css('padding-top')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('padding-bottom')) ? parseInt(mdmcv.css('padding-bottom')) : 0 ) ;\n\n      mdmcv.css( 'max-height', h ).css('overflow-x', 'hidden').css('overflow-y', 'auto');\n  }\n\n  /**\n   * PRIVATE function: getLayerLegendGraphicUrl\n   * get the layer legend graphic\n   *\n   * Parameters:\n   * name - {text} the layer name\n   * withScale - {boolean} url with scale parameter\n   *\n   * Dependencies:\n   * lizUrls.wms\n   *\n   * Returns:\n   * {text} the url\n   */\n  function getLayerLegendGraphicUrl(name, withScale) {\n    var layer = null\n    $.each(layers,function(i,l) {\n      if (layer == null && l.name == name)\n        layer = l;\n    });\n    if (layer == null )\n      return null;\n    var qgisName = null;\n    if ( name in cleanNameMap )\n        qgisName = getLayerNameByCleanName(name);\n    var layerConfig = null;\n    if ( qgisName )\n        layerConfig = config.layers[qgisName];\n    if ( !layerConfig )\n        layerConfig = config.layers[layer.params['LAYERS']];\n    if ( !layerConfig )\n        layerConfig = config.layers[layer.name];\n    if ( !layerConfig )\n        return null;\n    if ( 'externalWmsToggle' in layerConfig && layerConfig.externalWmsToggle == 'True'\n      && 'externalAccess' in layerConfig && layerConfig.externalAccess\n      && 'layers' in layerConfig.externalAccess && 'url' in layerConfig.externalAccess) {\n        var externalAccess = layerConfig.externalAccess;\n        var legendParams = {SERVICE: \"WMS\",\n                      VERSION: \"1.3.0\",\n                      REQUEST: \"GetLegendGraphic\",\n                      LAYER: externalAccess.layers,\n                      STYLE: externalAccess.styles,\n                      SLD_VERSION: \"1.1.0\",\n                      EXCEPTIONS: \"application/vnd.ogc.se_inimage\",\n                      FORMAT: \"image/png\",\n                      TRANSPARENT: \"TRUE\",\n                      WIDTH: 150,\n                      DPI: 96};\n\n        var legendParamsString = OpenLayers.Util.getParameterString(\n             legendParams\n            );\n        return OpenLayers.Util.urlAppend(externalAccess.url, legendParamsString);\n    }\n    var legendParams = {SERVICE: \"WMS\",\n                  VERSION: \"1.3.0\",\n                  REQUEST: \"GetLegendGraphic\",\n                  LAYER: layer.params['LAYERS'],\n                  STYLE: layer.params['STYLES'],\n                  EXCEPTIONS: \"application/vnd.ogc.se_inimage\",\n                  FORMAT: \"image/png\",\n                  TRANSPARENT: \"TRUE\",\n                  WIDTH: 150,\n                  LAYERFONTSIZE: 9,\n                  ITEMFONTSIZE: 9,\n                  SYMBOLSPACE: 1,\n                  ICONLABELSPACE: 2,\n                  DPI: 96,\n                  RULELABEL:\"AUTO\"\n                };\n    if (layerConfig.id==layerConfig.name)\n      legendParams['LAYERFONTBOLD'] = \"TRUE\";\n    else {\n      legendParams['LAYERFONTSIZE'] = 0;\n      legendParams['LAYERSPACE'] = 0;\n      legendParams['LAYERFONTBOLD'] = \"FALSE\";\n      legendParams['LAYERTITLE'] = \"FALSE\";\n    }\n    if (withScale)\n      legendParams['SCALE'] = map.getScale();\n    var legendParamsString = OpenLayers.Util.getParameterString(\n         legendParams\n        );\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    return OpenLayers.Util.urlAppend(service, legendParamsString);\n  }\n\n  /**\n   * PRIVATE function: getLayerScale\n   * get the layer scales based on children layer\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   * minScale - {Float} the nested min scale\n   * maxScale - {Float} the nested max scale\n   *\n   * Dependencies:\n   * config\n   *\n   * Returns:\n   * {Object} the min and max scales\n   */\n  function getLayerScale(nested,minScale,maxScale) {\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      var layerConfig = config.layers[qgisLayerName];\n      if (layer.nestedLayers.length != 0)\n         return getLayerScale(layer,minScale,maxScale);\n      if (layerConfig) {\n        if (minScale == null)\n          minScale=layerConfig.minScale;\n        else if (layerConfig.minScale<minScale)\n          minScale=layerConfig.minScale;\n        if (maxScale == null)\n          maxScale=layerConfig.maxScale;\n        else if (layerConfig.maxScale>maxScale)\n          maxScale=layerConfig.maxScale;\n      }\n    }\n    if ( minScale < 1 )\n      minScale = 1;\n    return {minScale:minScale,maxScale:maxScale};\n  }\n\n  /**\n   * PRIVATE function: getLayerOrder\n   * get the layer order and calculate it if it's a QGIS group\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   *\n   * Dependencies:\n   * config\n   *\n   * Returns:\n   * {Integer} the layer's order\n   */\n  function getLayerOrder(nested) {\n    // there is no layersOrder in the project\n    if (!('layersOrder' in config))\n      return -1;\n\n    // the nested is a layer and not a group\n    if (nested.nestedLayers.length == 0) {\n      var qgisLayerName = nested.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[nested.name];\n      else if ( nested.name in shortNameMap )\n        qgisLayerName = shortNameMap[nested.name];\n      if (qgisLayerName in config.layersOrder)\n        return config.layersOrder[nested.name];\n      else\n        return -1;\n    }\n\n    // the nested is a group\n    var order = -1;\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      var lOrder = -1;\n      if (layer.nestedLayers.length != 0)\n        lOrder = getLayerScale(layer);\n      else if (qgisLayerName in config.layersOrder)\n        lOrder = config.layersOrder[qgisLayerName];\n      else\n        lOrder = -1;\n      if (lOrder != -1) {\n        if (order == -1 || lOrder < order)\n          order = lOrder;\n      }\n    }\n    return order;\n  }\n\n  function beforeLayerTreeCreated() {\n     if (\n       (('osmMapnik' in config.options)\n        && config.options.osmMapnik == 'True') ||\n       (('osmStamenToner' in config.options)\n        && config.options.osmStamenToner == 'True') ||\n       (('openTopoMap' in config.options)\n        && config.options.openTopoMap == 'True') ||\n       (('osmCyclemap' in config.options)\n        && config.options.osmCyclemap == 'True'\n        && ('OCMKey' in config.options)) ||\n       (('googleStreets' in config.options)\n        && config.options.googleStreets == 'True') ||\n       (('googleSatellite' in config.options)\n        && config.options.googleSatellite == 'True') ||\n       (('googleHybrid' in config.options)\n        && config.options.googleHybrid == 'True') ||\n       (('googleTerrain' in config.options)\n        && config.options.googleTerrain == 'True') ||\n       (('bingStreets' in config.options)\n        && config.options.bingStreets == 'True'\n        && ('bingKey' in config.options)) ||\n       (('bingSatellite' in config.options)\n        && config.options.bingSatellite == 'True'\n        && ('bingKey' in config.options)) ||\n       (('bingHybrid' in config.options)\n        && config.options.bingHybrid == 'True'\n        && ('bingKey' in config.options)) ||\n       (('ignTerrain' in config.options)\n        && config.options.ignTerrain == 'True') ||\n       (('ignStreets' in config.options)\n        && config.options.ignStreets == 'True') ||\n       (('ignSatellite' in config.options)\n        && config.options.ignSatellite == 'True') ||\n       (('ignCadastral' in config.options)\n        && config.options.ignCadastral == 'True')\n       ) {\n         Proj4js.defs['EPSG:3857'] = Proj4js.defs['EPSG:900913'];\n\n         var proj = config.options.projection;\n         if ( !(proj.ref in Proj4js.defs) )\n           Proj4js.defs[proj.ref]=proj.proj4;\n         var projection = new OpenLayers.Projection(proj.ref);\n\n         var projOSM = new OpenLayers.Projection('EPSG:3857');\n         proj.ref = 'EPSG:3857';\n         proj.proj4 = Proj4js.defs['EPSG:3857'];\n\n         // Transform the bbox\n         var bbox = config.options.bbox;\n         var extent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n         extent = extent.transform(projection,projOSM);\n         bbox = extent.toArray();\n\n         var scales = [];\n         if ('mapScales' in config.options)\n           scales = config.options.mapScales;\n         if ( scales.length == 0 )\n           scales = [config.options.maxScale,config.options.minScale];\n\n         config.options.projection = proj;\n         config.options.bbox = bbox;\n         config.options.zoomLevelNumber = 16;\n\n         // Transform the initial bbox\n         if ( 'initialExtent' in config.options && config.options.initialExtent.length == 4 ) {\n           var initBbox = config.options.initialExtent;\n           var initialExtent = new OpenLayers.Bounds(Number(initBbox[0]),Number(initBbox[1]),Number(initBbox[2]),Number(initBbox[3]));\n           initialExtent = initialExtent.transform(projection,projOSM);\n           config.options.initialExtent = initialExtent.toArray();\n         }\n\n         // Specify zoom level number\n         if (\n             (('osmMapnik' in config.options) && config.options.osmMapnik == 'True') ||\n             (('osmStamenToner' in config.options) && config.options.osmStamenToner == 'True') ||\n             (('openTopoMap' in config.options) && config.options.openTopoMap == 'True') ||\n             (('osmCyclemap' in config.options) && config.options.osmCyclemap == 'True' && ('OCMKey' in config.options)) ||\n             (('bingStreets' in config.options) && config.options.bingStreets == 'True' && ('bingKey' in config.options)) ||\n             (('bingSatellite' in config.options) && config.options.bingSatellite == 'True' && ('bingKey' in config.options)) ||\n             (('bingHybrid' in config.options) && config.options.bingHybrid == 'True' && ('bingKey' in config.options)) ||\n             (('ignTerrain' in config.options) && config.options.ignTerrain == 'True') ||\n             (('ignStreets' in config.options) && config.options.ignStreets == 'True')) {\n           config.options.zoomLevelNumber = 23;\n         }\n         if ((('googleStreets' in config.options) && config.options.googleStreets == 'True') ||\n             (('googleHybrid' in config.options) && config.options.googleHybrid == 'True') ||\n             (('ignCadastral' in config.options) && config.options.ignCadastral == 'True')) {\n           config.options.zoomLevelNumber = 20;\n         }\n         if ( 'googleSatellite' in config.options && config.options.googleSatellite == 'True'){\n           config.options.zoomLevelNumber = 21;\n         }\n         if ( 'ignSatellite' in config.options && config.options.ignSatellite == 'True' ) {\n           config.options.zoomLevelNumber = 22;\n         }\n         config.options.maxScale = 591659030.3224756;\n         config.options.minScale = 2257.0000851534865;\n         var hasBaselayers = (('emptyBaselayer' in config.options) && config.options.emptyBaselayer == \"True\");\n         if ( !hasBaselayers ) {\n           for ( var l in config.layers ) {\n             if ( config.layers[l][\"baseLayer\"] == \"True\" ) {\n               hasBaselayers = true;\n               break;\n             }\n           }\n         }\n         // for minRes evaluating to scale 100\n         // zoomLevelNumber is equal to 24\n         if ( hasBaselayers ) {\n           config.options.zoomLevelNumber = 24;\n         }\n\n         var resolutions = [];\n         if (scales.length != 0 ) {\n           scales.sort(function(a, b) {\n             return Number(b) - Number(a);\n           });\n           var maxScale = scales[0];\n           var maxRes = OpenLayers.Util.getResolutionFromScale(maxScale, projOSM.proj.units);\n           var minScale = scales[scales.length-1];\n           var minRes = OpenLayers.Util.getResolutionFromScale(minScale, projOSM.proj.units);\n           var res = 156543.03390625;\n           var n = 1;\n           while ( res > minRes && n < config.options.zoomLevelNumber) {\n             if ( res < maxRes ) {\n               //Add extra scale\n               resolutions.push(res);\n             }\n             res = res/2;\n             n++;\n           }\n           maxRes = resolutions[0];\n           minRes = resolutions[resolutions.length-1];\n           //Add extra scale\n           var maxScale = OpenLayers.Util.getScaleFromResolution(maxRes, projOSM.proj.units);\n           var minScale = OpenLayers.Util.getScaleFromResolution(minRes, projOSM.proj.units);\n         }\n         config.options['resolutions'] = resolutions;\n\n         if (resolutions.length != 0 ) {\n           config.options.zoomLevelNumber = resolutions.length;\n           config.options.maxScale = maxScale;\n           config.options.minScale = minScale;\n         }\n         return true;\n      }\n      return false;\n  }\n\n  /**\n   * PRIVATE function: getLayerTree\n   * get the layer tree\n   * create OpenLayers WMS base or not layer {<OpenLayers.Layer.WMS>}\n   * push these layers in layers or baselayers\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   * pNode - {Object} the nested tree node\n   *\n   * Dependencies:\n   * config\n   * layers\n   * baselayers\n   */\n  function getLayerTree(nested,pNode) {\n    pNode.children = [];\n\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n      ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    if (lizUrls.publicUrlList && lizUrls.publicUrlList.length > 1 ) {\n        service = [];\n        for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n          service.push(\n            OpenLayers.Util.urlAppend(\n              lizUrls.publicUrlList[j],\n              OpenLayers.Util.getParameterString(lizUrls.params)\n            )\n          );\n        }\n    }\n\n    var wmtsFormat = new OpenLayers.Format.WMTSCapabilities({});\n\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var serviceUrl = service\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( ('useLayerIDs' in config.options) && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      // The found name is not in config\n      if (!(qgisLayerName in config.layers)) {\n        continue;\n      }\n      var layerConfig = config.layers[qgisLayerName];\n      var layerName = cleanName(qgisLayerName);\n      layerCleanNames[layerName] = qgisLayerName;\n\n      if ( qgisLayerName.toLowerCase() == 'hidden' )\n        continue;\n      if ( qgisLayerName == 'Overview' ) {\n        config.options.hasOverview = true;\n        continue;\n      }\n      if ( !layerConfig )\n        continue;\n\n      if ( layerConfig.groupAsLayer == 'True' )\n        layerConfig.type = 'layer';\n\n      var wmsStyles = $.map(layer.styles, function(s){\n          return s.name;\n      });\n      if ( wmsStyles.length != 0 ) {\n          layerConfig.styles = wmsStyles;\n      } else if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n          layerConfig.styles = [''];\n      } else {\n          layerConfig.styles = ['default'];\n      }\n      // if the layer is not the Overview and had a config\n      // creating the {<OpenLayers.Layer.WMS>} and the tree node\n      var node = {name:layerName,config:layerConfig,parent:pNode};\n      var styles = ('styles' in layerConfig) ? layerConfig.styles[0] : 'default' ;\n      if( !( typeof lizLayerStyles === 'undefined' )\n        && layerName in lizLayerStyles\n        && lizLayerStyles[ layerName ]\n      ){\n        styles = lizLayerStyles[ layerName ];\n      }\n      var layerWmsParams = {\n          layers:layer.name\n          ,styles: styles\n          ,version:'1.3.0'\n          ,exceptions:'application/vnd.ogc.se_inimage'\n          ,format:(layerConfig.imageFormat) ? layerConfig.imageFormat : 'image/png'\n          ,dpi:96\n      };\n      if (layerWmsParams.format != 'image/jpeg')\n          layerWmsParams['transparent'] = true;\n\n      //Manage attribution\n      if (typeof layer.attribution == \"object\") {\n          // Update href if needed\n          if ( 'href' in layer.attribution &&\n               layer.attribution.href != '' &&\n               layer.attribution.href.indexOf('://') == -1) {\n            layer.attribution.href = 'http://'+layer.attribution.href;\n          }\n          // Update attribution\n          if ( !('title' in layer.attribution) || layer.attribution.title == '' ) {\n              layer.attribution.title = layer.attribution.href.split('://')[1];\n          } else\n          if ( !('href' in layer.attribution) || layer.attribution.href == '' ) {\n              layer.attribution = layer.attribution.title;\n          }\n      }\n\n      var wmtsLayer = null;\n      if ( layerConfig.cached == 'True' && wmtsCapabilities ) {\n          $.each(wmtsCapabilities.contents.layers, function(i, l) {\n            if ( l.identifier != layer.name)\n              return true;\n            var wmtsOptions = {\n                layer: layer.name,\n                matrixSet: config.options.projection.ref,\n                name: layerName,\n                params: layerWmsParams,\n                attribution:layer.attribution,\n                isBaseLayer: (layerConfig.baseLayer == 'True'),\n                alwaysInRange: false,\n                url: serviceUrl\n            };\n            if ( $.inArray( config.options.projection.ref.toUpperCase(), ['EPSG:3857','EPSG:900913'] ) != -1\n              && ('resolutions' in config.options)\n              && config.options.resolutions.length != 0 ) {\n                var resolutions = config.options.resolutions;\n                var maxRes = resolutions[0];\n                var numZoomLevels = resolutions.length;\n                var zoomOffset = 0;\n                var res = 156543.03390625;\n                while ( res > maxRes ) {\n                    zoomOffset += 1;\n                    res = 156543.03390625 / Math.pow(2, zoomOffset);\n                }\n                wmtsOptions['zoomOffset'] = zoomOffset;\n                wmtsOptions['maxResolution'] = maxRes;\n                wmtsOptions['numZoomLevels'] = numZoomLevels;\n                wmtsOptions['minZoomLevel'] = zoomOffset;\n                wmtsOptions['resolutions'] = resolutions;\n            }\n            wmtsLayer = wmtsFormat.createLayer(wmtsCapabilities, wmtsOptions);\n            wmtsLayer.yx = {};\n            wmtsLayer.reverseAxisOrder = function() {\n                var projCode = this.projection.getCode();\n                return parseFloat('1.3.0') >= 1.3 &&\n                    !!(this.yx[projCode] || (OpenLayers.Projection.defaults[projCode] &&\n                    OpenLayers.Projection.defaults[projCode].yx));\n            };\n            return false;\n          });\n      }\n\n      // Override WMS url if external WMS server\n      var extConfig = null;\n      if ('externalAccess' in layerConfig && layerConfig.externalAccess\n       && 'layers' in layerConfig.externalAccess && 'url' in layerConfig.externalAccess ) {\n          extConfig = layerConfig.externalAccess;\n          extConfig.layers = decodeURI(extConfig.layers);\n          serviceUrl = extConfig.url;\n          layerWmsParams = {\n            layers: extConfig.layers\n            ,styles:(extConfig.styles) ? extConfig.styles : ''\n            ,crs:(extConfig.crs) ? extConfig.crs : 'EPSG:3857'\n            ,format:(extConfig.format) ? extConfig.format : 'image/png'\n            ,transparent:(extConfig.transparent) ? extConfig.transparent : 'true'\n            ,exceptions:'application/vnd.ogc.se_inimage'\n          }\n      }\n\n        // Add optional filter at start\n        if( !( typeof lizLayerFilter === 'undefined' )\n          && qgisLayerName in lizLayerFilter\n          && lizLayerFilter[ qgisLayerName ]\n        ){\n          layerWmsParams['FILTER'] = qgisLayerName+':'+lizLayerFilter[ qgisLayerName ];\n        }\n\n      if (layerConfig.baseLayer == 'True' && wmtsLayer != null) {\n          // creating the base layer\n          baselayers.push( wmtsLayer );\n      }\n      else if (layerConfig.type == 'layer' && wmtsLayer != null) {\n          wmtsLayer.options.minScale = layerConfig.maxScale;\n          wmtsLayer.options.maxScale =(layerConfig.minScale != null && layerConfig.minScale < 1) ? 1 : layerConfig.minScale;\n          if ( layer.nestedLayers.length != 0 ) {\n              var scales = getLayerScale(layer,null,null);\n              wmtsLayer.options.minScale = scales.maxScale;\n              wmtsLayer.options.maxScale = scales.minScale;\n          }\n          wmtsLayer.isVisible = (layerConfig.toggled=='True');\n          wmtsLayer.visibility = false;\n          wmtsLayer.transitionEffect = null;\n          wmtsLayer.removeBackBufferDelay = 250;\n          wmtsLayer.order = getLayerOrder(layer);\n          layers.push( wmtsLayer );\n      }\n      else if (layerConfig.baseLayer == 'True') {\n        // creating the base layer\n          baselayers.push(new OpenLayers.Layer.WMS(layerName,serviceUrl\n              ,layerWmsParams\n              ,{isBaseLayer:true\n               ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n               ,buffer:0\n               ,singleTile:(layerConfig.singleTile == 'True')\n               ,ratio:1\n               ,attribution:layer.attribution\n              }));\n      }\n      else if (layerConfig.type == 'layer') {\n          var wmsLayer = new OpenLayers.Layer.WMS(layerName,serviceUrl\n              ,layerWmsParams\n              ,{isBaseLayer:false\n               ,minScale:layerConfig.maxScale\n               ,maxScale:(layerConfig.minScale != null && layerConfig.minScale < 1) ? 1 : layerConfig.minScale\n               ,isVisible:(layerConfig.toggled=='True')\n               ,visibility:false\n               ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n               ,buffer:0\n               ,transitionEffect:(layerConfig.singleTile == 'True')?'resize':null\n               ,removeBackBufferDelay:250\n               ,singleTile:(layerConfig.singleTile == 'True' || (layerConfig.cached == 'True' && !wmtsCapabilities))\n               ,ratio:1\n               ,order:getLayerOrder(layer)\n               ,attribution:layer.attribution\n              });\n          if ( layer.nestedLayers.length != 0 ) {\n              var scales = getLayerScale(layer,null,null);\n              wmsLayer.minScale = scales.maxScale;\n              wmsLayer.options.minScale = scales.maxScale;\n              wmsLayer.maxScale = scales.minScale;\n              wmsLayer.options.maxScale = scales.minScale;\n          }\n          // External WMS layers - respect the image format of the WMS source layer\n          // We do not want to respect the configuration layerConfig.imageFormat\n          // to avoid requesting a format not compatible with the external WMS server\n          // Fix the jpeg WMS layers requesting png\n          if (extConfig && 'format' in layerWmsParams && 'params' in wmsLayer\n              && wmsLayer.params['FORMAT'] != layerWmsParams.format) {\n              wmsLayer.params['FORMAT'] = layerWmsParams.format;\n          }\n          layers.push( wmsLayer );\n      }\n      // creating the layer tree because it's a group, has children and is not a base layer\n      if (layerConfig.type == 'group' && layer.nestedLayers.length != 0 && layerConfig.baseLayer == 'False')\n          getLayerTree(layer,node);\n      if (layerConfig.baseLayer != 'True')\n          pNode.children.push(node);\n\n      // Add bbox from WMS data into lizmap configuration (used by switcher-layers-actions\n      layerConfig.bbox = layer.bbox;\n\n    }\n  }\n\n  /**\n   * PRIVATE function: analyseNode\n   * analyse Node Config\n   * define if the node has to be a child of his parent node\n   *\n   * Parameters:\n   * aNode - {Object} a node config\n   *\n   * Returns:\n   * {Boolean} maintains the node in the tree\n   */\n  function analyseNode(aNode) {\n    var nodeConfig = aNode.config;\n    if (nodeConfig.type == 'layer' && nodeConfig.baseLayer != 'True')\n      return true;\n    else if (nodeConfig.type == 'layer')\n      return false;\n\n    if (!('children' in aNode))\n      return false;\n    var children = aNode.children;\n    var result = false;\n    var removeIdx = [];\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      var analyse = analyseNode(child);\n      if (!analyse)\n        removeIdx.push(i);\n      result = (result || analyse);\n    }\n    removeIdx.reverse();\n    for (var i=0, len=removeIdx.length; i<len; i++) {\n      children.splice(removeIdx[i],1);\n    }\n    return result;\n  }\n\n  /**\n   * PRIVATE function: getSwitcherLine\n   * get the html table line <tr> of a config node for the switcher\n   *\n   * Parameters:\n   * aNode - {Object} a config node\n   *\n   * Returns:\n   * {String} the <tr> html corresponding to the node\n   */\n  function getSwitcherLine(aNode, aParent) {\n    var html = '';\n    var nodeConfig = aNode.config;\n    var parentConfig = null;\n\n    if( aParent ){\n      parentConfig = aParent.config;\n    }\n\n    if( 'geometryType' in nodeConfig &&\n        ( nodeConfig.geometryType == \"none\" || nodeConfig.geometryType == \"unknown\" || nodeConfig.geometryType == \"\" )\n    ){\n      nodeConfig.displayInLegend = 'False';\n    }\n\n    html += '<tr id=\"'+nodeConfig.type+'-'+aNode.name+'\"';\n    html += ' class=\"liz-'+nodeConfig.type;\n    if (aParent){\n      html += ' child-of-group-'+aParent.name;\n    }\n    if (('children' in aNode) && aNode['children'].length!=0){\n      html += ' expanded parent';\n    }\n\n    // Legend properties\n    // Read the plugin metadata to get the legend options\n    // depending on the configuration version\n    let lizmap_plugin_metadata = getLizmapDesktopPluginMetadata();\n    if (lizmap_plugin_metadata.lizmap_web_client_target_version >= 30600) {\n      var legendOption = nodeConfig.legend_image_option;\n    } else {\n      var legendOption = 'hide_at_startup';\n      if (nodeConfig.noLegendImage && nodeConfig.noLegendImage == 'True') {\n        legendOption = 'disabled';\n      }\n    }\n\n    // Expand layer legend at startup\n    if (nodeConfig.type == 'layer' && legendOption == 'expand_at_startup') {\n      html += ' expanded ';\n    }\n\n    if (('displayInLegend' in nodeConfig && nodeConfig.displayInLegend == 'False') ||\n        (parentConfig && 'displayInLegend' in parentConfig && parentConfig.displayInLegend == 'False')){\n      html += ' liz-hidden';\n    }\n    if ( parentConfig && 'mutuallyExclusive' in parentConfig && parentConfig.mutuallyExclusive == 'True' ){\n      html += ' mutually-exclusive';\n    }\n\n    html += '\">';\n\n    function truncateWithEllipsis(str,n){\n      return (str.length > n) ? str.substr(0,n-1)+'&hellip;' : str;\n    }\n\n    html += '<td><button class=\"btn checkbox\" name=\"'+nodeConfig.type+'\" value=\"'+aNode.name+'\" title=\"'+lizDict['tree.button.checkbox']+'\"></button>';\n    html += '<span class=\"label\" title=\"'+truncateWithEllipsis($('<div>'+nodeConfig.abstract+'</div>').text(),50)+'\">'+nodeConfig.title+'</span>';\n    html += '</td>';\n\n    html += '<td class=\"loading\">';\n    if (nodeConfig.type == 'layer'){\n      html += '<span class=\"loading\">&nbsp;</span>';\n    }\n    html += '</td>';\n\n    var legendLink = '';\n    if (nodeConfig.link){\n      legendLink = nodeConfig.link;\n    }\n    if (legendLink != '' ){\n      html += '<td><button class=\"btn link\" name=\"link\" title=\"'+lizDict['tree.button.link']+'\" value=\"'+legendLink+'\"/></td>';\n    }\n    else{\n      html += '<td></td>';\n    }\n\n    if (nodeConfig.cached && nodeConfig.cached == 'True' && nodeConfig.type == 'layer' && ('removeCache' in config.options)){\n      html += '<td><button class=\"btn removeCache\" name=\"removeCache\" title=\"'+lizDict['tree.button.removeCache']+'\" value=\"'+aNode.name+'\"/></td>';\n    }\n    else{\n      html += '<td></td>';\n    }\n\n    html += '</tr>';\n\n    if (nodeConfig.type == 'layer'\n    && (legendOption != 'disabled')\n    && ('displayInLegend' in nodeConfig && nodeConfig.displayInLegend == 'True')) {\n      var url = getLayerLegendGraphicUrl(aNode.name, false);\n      if ( url != null && url != '' ) {\n        html += '<tr id=\"legend-'+aNode.name+'\" class=\"child-of-layer-'+aNode.name+' legendGraphics\">';\n        html += '<td colspan=\"2\"><div class=\"legendGraphics\">';\n        html += '<img data-src=\"'+url+'\" src=\"'+lizUrls.basepath + 'assets/css/images/download_layer.gif' + '\"/>';\n        html += '</div></td>';\n        html += '</tr>';\n      }\n    }\n\n    return html;\n  }\n\n  /**\n   * PRIVATE function: getSwitcherNode\n   * get the html of a config node for the switcher\n   *\n   * Parameters:\n   * aNode - {Object} a config node\n   *\n   * Returns:\n   * {String} the html corresponding to the node\n   */\n  function getSwitcherNode(aNode,aLevel) {\n    var html = '';\n    if (aLevel == 0) {\n      html += '<div class=\"without-blocks no-group\">';\n      html += '<table class=\"tree\">';\n    }\n\n    var children = aNode.children;\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      if (aLevel == 0)\n        html += getSwitcherLine(child);\n      else\n        html += getSwitcherLine(child,aNode);\n\n      if (('children' in child) && child['children'].length!=0)\n        html += getSwitcherNode(child, aLevel+1);\n    }\n\n    if (aLevel == 0) {\n      html += '</table>';\n      html += '</div>';\n    }\n    return html;\n  }\n\n  function initProjections(firstLayer) {\n    // Insert or update projection list\n    if ( lizProj4 ) {\n        for( var ref in lizProj4 ) {\n            if ( !(ref in Proj4js.defs) ) {\n              Proj4js.defs[ref]=lizProj4[ref];\n          }\n        }\n    }\n\n    // get and define projection\n    var proj = config.options.projection;\n    if ( !(proj.ref in Proj4js.defs) )\n      Proj4js.defs[proj.ref]=proj.proj4;\n    var projection = new OpenLayers.Projection(proj.ref);\n\n    if ( !(proj.ref in OpenLayers.Projection.defaults) ) {\n        OpenLayers.Projection.defaults[proj.ref] = projection;\n\n        // test extent for inverted axis\n        if ( proj.ref in firstLayer.bbox ) {\n            var wmsBbox = firstLayer.bbox[proj.ref].bbox;\n            var wmsBounds = OpenLayers.Bounds.fromArray( wmsBbox );\n            var initBounds = OpenLayers.Bounds.fromArray( config.options.initialExtent );\n            if ( !initBounds.intersectsBounds( wmsBounds ) )\n                OpenLayers.Projection.defaults[proj.ref].yx = true;\n        }\n    }\n  }\n\n  /**\n   * PRIVATE function: createMap\n   * creating the map {<OpenLayers.Map>}\n   * @param {array} initialExtent initial extent in EPSG:4326 projection\n   */\n  function createMap(initialExtent) {\n    // get projection\n    var proj = config.options.projection;\n    var projection = new OpenLayers.Projection(proj.ref);\n\n    // get and define the max extent\n    var bbox = config.options.bbox;\n    var extent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n\n    var restrictedExtent = extent.scale(3);\n\n    if(initialExtent){\n        initialExtent = new OpenLayers.Bounds(initialExtent);\n        initialExtent.transform(new OpenLayers.Projection('EPSG:4326'), projection);\n    }else{\n        initialExtent = extent.clone();\n        if ( 'initialExtent' in config.options && config.options.initialExtent.length == 4 ) {\n          var initBbox = config.options.initialExtent;\n          initialExtent = new OpenLayers.Bounds(Number(initBbox[0]),Number(initBbox[1]),Number(initBbox[2]),Number(initBbox[3]));\n        }\n    }\n\n    // calculate the map height\n    var mapHeight = $('body').parent()[0].clientHeight;\n    if(!mapHeight)\n        mapHeight = $('window').innerHeight();\n    mapHeight = mapHeight - $('#header').height();\n    mapHeight = mapHeight - $('#headermenu').height();\n    $('#map').height(mapHeight);\n\n    // Make sure interface divs size are updated before creating the map\n    // This avoid the request of each singlettile layer 2 times on startup\n    updateContentSize();\n\n    var scales = [];\n    var resolutions = [];\n    if ('resolutions' in config.options)\n      resolutions = config.options.resolutions;\n    else if ('mapScales' in config.options)\n      scales = config.options.mapScales;\n    scales.sort(function(a, b) {\n      return Number(b) - Number(a);\n    });\n    // remove duplicate scales\n    var nScales = [];\n    while (scales.length != 0){\n      var scale = scales.pop(0);\n      if ($.inArray( scale, nScales ) == -1 )\n        nScales.push( scale );\n    }\n    scales = nScales;\n\n\n    // creating the map\n    OpenLayers.Util.IMAGE_RELOAD_ATTEMPTS = 3; // Avoid some issues with tiles not displayed\n    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;\n    OpenLayers.Util.DEFAULT_PRECISION=20; // default is 14 : change needed to avoid rounding problem with cache\n\n    map = new OpenLayers.Map('map'\n      ,{\n        controls:[\n          new OpenLayers.Control.Navigation({mouseWheelOptions: {interval: 100}})\n        ]\n        ,tileManager: null // prevent bug with OL 2.13 : white tiles on panning back\n        ,eventListeners:{\n         zoomend: function(){\n            // private treeTable\n            var options = {\n                childPrefix : \"child-of-\"\n            };\n\n            function childrenOf(node) {\n                return $(node).siblings(\"tr.\" + options.childPrefix + node[0].id);\n            }\n\n            function parentOf(node) {\n                if (node.length == 0 )\n                return null;\n\n                var classNames = node[0].className.split(' ');\n\n                for(var key=0; key<classNames.length; key++) {\n                if(classNames[key].match(options.childPrefix)) {\n                    return $(node).siblings(\"#\" + classNames[key].substring(options.childPrefix.length));\n                }\n                }\n\n                return null;\n            }\n\n            function ancestorsOf(node) {\n                var ancestors = [];\n                while(node = parentOf(node)) {\n                ancestors[ancestors.length] = node[0];\n                }\n                return ancestors;\n            }\n           //layer visibility\n           for (var i=0,len=layers.length; i<len; i++) {\n             var layer = layers[i];\n             var b = $('#switcher button[name=\"layer\"][value=\"'+layer.name+'\"]').first();\n\n             if (layer.inRange && b.hasClass('disabled')) {\n               var tr = b.parents('tr').first();\n               tr.removeClass('disabled').find('button').removeClass('disabled');\n               var ancestors = ancestorsOf(tr);\n               $.each(ancestors,function(i,a) {\n                 $(a).removeClass('disabled').find('button').removeClass('disabled');\n               });\n               if (tr.find('button[name=\"layer\"]').hasClass('checked'))\n                 layer.setVisibility(true);\n             } else if (!layer.inRange && !b.hasClass('disabled')) {\n               var tr = b.parents('tr').first();\n               tr.addClass('disabled').find('button').addClass('disabled');\n               if (tr.hasClass('liz-layer'))\n                 tr.collapse();\n               var ancestors = ancestorsOf(tr);\n               $.each(ancestors,function(i,a) {\n                    a = $(a);\n                    var count = 0;\n                    var checked = 0;\n                    var aDesc = childrenOf(a);\n                    $.each(aDesc,function(j,trd) {\n                      $(trd).find('button.checkbox').each(function(i,b){\n                        if ($(b).hasClass('disabled'))\n                          checked++;\n                        count++;\n                      });\n                    });\n                 if (count == checked)\n                   a.addClass('disabled').find('button').addClass('disabled');\n                 else\n                   a.removeClass('disabled').find('button').removeClass('disabled');\n               });\n             }\n           }\n\n           //pan button\n           $('#navbar button.pan').click();\n         }\n        }\n\n       ,maxExtent:extent\n       ,restrictedExtent: restrictedExtent\n       ,initialExtent:initialExtent\n       ,maxScale: scales.length == 0 ? config.options.minScale : \"auto\"\n       ,minScale: scales.length == 0 ? config.options.maxScale : \"auto\"\n       ,numZoomLevels: scales.length == 0 ? config.options.zoomLevelNumber : scales.length\n       ,scales: scales.length == 0 ? null : scales\n       ,resolutions: resolutions.length == 0 ? null : resolutions\n       ,projection:projection\n       ,units:projection.proj.units !== null ? projection.proj.units : \"degrees\"\n       ,allOverlays:(baselayers.length == 0)\n    });\n    map.addControl(new OpenLayers.Control.Attribution({div:document.getElementById('attribution')}));\n\n    // add handler to update the map size\n    window.addEventListener('resize', updateContentSize);\n  }\n\n  /**\n   * Get features for locate by layer tool\n   */\n  function updateLocateFeatureList(aName) {\n    var locate = config.locateByLayer[aName];\n    // clone features reference\n    var features = {};\n    for ( var fid in locate.features ) {\n        features[fid] = locate.features[fid];\n    }\n    // filter by filter field name\n    if ('filterFieldName' in locate) {\n        var filterValue = $('#locate-layer-'+cleanName(aName)+'-'+locate.filterFieldName).val();\n        if ( filterValue != '-1' ) {\n          for (var fid in features) {\n            var feat = features[fid];\n            if (feat.properties[locate.filterFieldName] != filterValue)\n              delete features[fid];\n          }\n        } else\n          features = {}\n    }\n    // filter by vector joins\n    if ( 'vectorjoins' in locate && locate.vectorjoins.length != 0 ) {\n        var vectorjoins = locate.vectorjoins;\n        for ( var i=0, len =vectorjoins.length; i< len; i++) {\n            var vectorjoin = vectorjoins[i];\n            var jName = vectorjoin.joinLayer;\n            if ( jName in config.locateByLayer ) {\n                var jLocate = config.locateByLayer[jName];\n                var jVal = $('#locate-layer-'+cleanName(jName)).val();\n                if ( jVal == '-1' ) continue;\n                var jFeat = jLocate.features[jVal];\n                for (var fid in features) {\n                  var feat = features[fid];\n                  if ( feat.properties[vectorjoin.targetFieldName] != jFeat.properties[vectorjoin.joinFieldName] )\n                    delete features[fid];\n                }\n            }\n        }\n    }\n    // create the option list\n    const placeHolder = config.layers[aName].title;\n    var options = '<option value=\"-1\" label=\"'+placeHolder+'\"></option>';\n    for (var fid in features) {\n      var feat = features[fid];\n      options += '<option value=\"'+feat.id+'\">'+feat.properties[locate.fieldName]+'</option>';\n    }\n    // add option list\n    $('#locate-layer-'+cleanName(aName)).html(options);\n  }\n\n    function clearDrawLayer(layer_name) {\n      var layer = map.getLayersByName(layer_name);\n      if (layer.length == 0) {\n          return;\n      }\n      layer[0].destroyFeatures();\n    }\n\n  /**\n   * Zoom to locate feature\n   */\n  function zoomToLocateFeature(aName) {\n    // clean locate layer\n    clearDrawLayer('locatelayer');\n\n    // get locate by layer val\n    var locate = config.locateByLayer[aName];\n    var layerName = cleanName(aName);\n    var proj = new OpenLayers.Projection(locate.crs);\n    var val = $('#locate-layer-'+layerName).val();\n    if (val == '-1') {\n\n      // Trigger event\n      lizMap.events.triggerEvent('lizmaplocatefeaturecanceled',\n        {\n          'featureType': aName\n        }\n      );\n    } else {\n      // zoom to val\n      var feat = locate.features[val];\n      var format = new OpenLayers.Format.GeoJSON({\n          ignoreExtraDims: true\n      });\n      feat = format.read(feat)[0];\n\n      if( feat.geometry != null){\n        feat.geometry.transform(proj, map.getProjection());\n        // Show geometry if asked\n        if (locate.displayGeom == 'True') {\n            var layer = map.getLayersByName('locatelayer')[0];\n            if( typeof layer === 'undefined' )\n              return;\n            var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, null );\n            getFeatureUrlData['options']['PROPERTYNAME'] = ['geometry',locate.fieldName].join(',');\n            getFeatureUrlData['options']['FEATUREID'] = val;\n            // Get data\n            $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n              if ( !data.features )\n                data = JSON.parse(data);\n              if( data.features.length != 0) {\n                feat = format.read(data.features[0])[0];\n                feat.geometry.transform(proj, map.getProjection());\n              }\n              layer.addFeatures([feat]);\n            }).fail(function(){\n              layer.addFeatures([feat]);\n            });\n        }\n        //zoom to extent\n        map.zoomToExtent(feat.geometry.getBounds());\n\n      }\n\n      var fid = val.split('.')[1];\n\n      // Trigger event\n      lizMap.events.triggerEvent('lizmaplocatefeaturechanged',\n        {\n          'featureType': aName,\n          'featureId': fid\n        }\n      );\n    }\n  }\n\n  /**\n   * Get features for locate by layer tool\n   */\n  function getLocateFeature(aName) {\n    var locate = config.locateByLayer[aName];\n\n    // get fields to retrieve\n    var fields = ['geometry',locate.fieldName];\n    // if a filter field is defined\n    if ('filterFieldName' in locate)\n      fields.push( locate.filterFieldName );\n    // check for join fields\n    if ( 'filterjoins' in locate ) {\n      var filterjoins = locate.filterjoins;\n      for ( var i=0, len=filterjoins.length; i<len; i++) {\n          var filterjoin = filterjoins[i];\n          fields.push( filterjoin.targetFieldName );\n      }\n    }\n    if ( 'vectorjoins' in locate ) {\n      var vectorjoins = locate.vectorjoins;\n      for ( var i=0, len=vectorjoins.length; i<len; i++) {\n          var vectorjoin = vectorjoins[i];\n          fields.push( vectorjoin.targetFieldName );\n      }\n    }\n\n    // Get WFS url and options\n    var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, 'extent' );\n    getFeatureUrlData['options']['PROPERTYNAME'] = fields.join(',');\n\n    var layerName = cleanName(aName);\n\n    // Get data\n    $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n      var lConfig = config.layers[aName];\n      locate['features'] = {};\n      if ( !data.features )\n        data = JSON.parse(data);\n      var features = data.features;\n      if( locate.crs != 'EPSG:4326' && features.length != 0) {\n          // load projection to be sure to have the definition\n          loadProjDefinition( locate.crs, function() {\n              // in QGIS server > 2.14 GeoJSON is in EPSG:4326\n              if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' )\n                locate.crs = 'EPSG:4326';\n          });\n      }\n\n      if ('filterFieldName' in locate) {\n        // create filter combobox for the layer\n        features.sort(function(a, b) {\n            var aProperty = a.properties[locate.filterFieldName];\n            var bProperty = b.properties[locate.filterFieldName];\n            if (isNaN(aProperty)) {\n                if (isNaN(bProperty)) {  // a and b are strings\n                    return aProperty.localeCompare(bProperty);\n                } else {         // a string and b number\n                    return 1;  // a > b\n                }\n            } else {\n                if (isNaN(bProperty)) {  // a number and b string\n                    return -1;  // a < b\n                } else {         // a and b are numbers\n                    return parseFloat(aProperty) - parseFloat(bProperty);\n                }\n            }\n        });\n        var filterPlaceHolder = '';\n        if ( 'filterFieldAlias' in locate && locate.filterFieldAlias!='')\n          filterPlaceHolder += locate.filterFieldAlias+' ';\n        else\n          filterPlaceHolder += locate.filterFieldName;\n        filterPlaceHolder +=' ('+ lConfig.title + ')';\n        var fOptions = '<option value=\"-1\"></option>';\n        var fValue = '-1';\n        for (var i=0, len=features.length; i<len; i++) {\n          var feat = features[i];\n          if ( fValue != feat.properties[locate.filterFieldName] ) {\n            fValue = feat.properties[locate.filterFieldName];\n            fOptions += '<option value=\"'+fValue+'\">'+fValue+'</option>';\n          }\n        }\n\n\n        // add filter values list\n        $('#locate-layer-'+layerName).parent().before('<div class=\"locate-layer\"><select id=\"locate-layer-'+layerName+'-'+locate.filterFieldName+'\">'+fOptions+'</select></div><br/>');\n        // listen to filter select changes\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName).change(function(){\n          var filterValue = $(this).children(':selected').val();\n          updateLocateFeatureList( aName );\n          if (filterValue == '-1')\n            $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').val('');\n          $('#locate-layer-'+layerName+' ~ span > input').val('');\n          $('#locate-layer-'+layerName).val('-1');\n          zoomToLocateFeature(aName);\n        });\n        // add combobox to the filter select\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName).combobox({\n          position: { my : \"right top\", at: \"right bottom\" },\n          \"selected\": function(evt, ui){\n            if ( ui.item ) {\n              var self = $(this);\n              var uiItem = $(ui.item);\n              window.setTimeout(function(){\n                self.val(uiItem.val()).change();\n              }, 1);\n            }\n          }\n        });\n\n        // add place holder to the filter combobox input\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').attr('placeholder', filterPlaceHolder).val('');\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').autocomplete('close');\n        updateMiniDockSize();\n      }\n\n      // create combobox for the layer\n      features.sort(function(a, b) {\n            var aProperty = a.properties[locate.fieldName];\n            var bProperty = b.properties[locate.fieldName];\n            if (isNaN(aProperty)) {\n                if (isNaN(bProperty)) {  // a and b are strings\n                    return aProperty.localeCompare(bProperty);\n                } else {         // a string and b number\n                    return 1;  // a > b\n                }\n            } else {\n                if (isNaN(bProperty)) {  // a number and b string\n                    return -1;  // a < b\n                } else {         // a and b are numbers\n                    return parseFloat(aProperty) - parseFloat(bProperty);\n                }\n            }\n      });\n      var placeHolder = '';\n      if ('filterFieldName' in locate) {\n          if ( 'fieldAlias' in locate && locate.fieldAlias!='' )\n              placeHolder += locate.fieldAlias+' ';\n          else\n              placeHolder += locate.fieldName+' ';\n          placeHolder += '('+lConfig.title+')';\n      } else {\n          placeHolder = lConfig.title;\n      }\n      var options = '<option value=\"-1\"></option>';\n      for (var i=0, len=features.length; i<len; i++) {\n        var feat = features[i];\n        locate.features[feat.id.toString()] = feat;\n        if ( !('filterFieldName' in locate) )\n          options += '<option value=\"'+feat.id+'\">'+feat.properties[locate.fieldName]+'</option>';\n      }\n      // listen to select changes\n      $('#locate-layer-'+layerName).html(options).change(function() {\n        var val = $(this).children(':selected').val();\n        if (val == '-1') {\n          $('#locate-layer-'+layerName+' ~ span > input').val('');\n          // update to join layer\n          if ( 'filterjoins' in locate && locate.filterjoins.length != 0 ) {\n              var filterjoins = locate.filterjoins;\n              for (var i=0, len=filterjoins.length; i<len; i++) {\n                  var filterjoin = filterjoins[i];\n                  var jName = filterjoin.joinLayer;\n                  if ( jName in config.locateByLayer ) {\n                      // update joined select options\n                      var oldVal = $('#locate-layer-'+cleanName(jName)).val();\n                      updateLocateFeatureList( jName );\n                      $('#locate-layer-'+cleanName(jName)).val( oldVal );\n                      return;\n                  }\n              }\n          }\n          // zoom to parent selection\n          if ( 'vectorjoins' in locate && locate.vectorjoins.length == 1 ) {\n              var jName = locate.vectorjoins[0].joinLayer;\n              if ( jName in config.locateByLayer ) {\n                zoomToLocateFeature( jName );\n                return;\n              }\n          }\n          // clear the map\n          zoomToLocateFeature( aName );\n        } else {\n          // zoom to val\n          zoomToLocateFeature( aName );\n          // update joined layer\n          if ( 'filterjoins' in locate && locate.filterjoins.length != 0 ) {\n              var filterjoins = locate.filterjoins;\n              for (var i=0, len=filterjoins.length; i<len; i++) {\n                  var filterjoin = filterjoins[i];\n                  var jName = filterjoin.joinLayer;\n                  if ( jName in config.locateByLayer ) {\n                      // update joined select options\n                      updateLocateFeatureList( jName );\n                      $('#locate-layer-'+cleanName(jName)).val('-1');\n                      $('#locate-layer-'+cleanName(jName)+' ~ span > input').val('');\n                  }\n              }\n          }\n        }\n        $(this).blur();\n        return;\n      });\n      $('#locate-layer-'+layerName).combobox({\n    \"minLength\": ('minLength' in locate) ? locate.minLength : 0,\n        \"position\": { my : \"right top\", at: \"right bottom\" },\n        \"selected\": function(evt, ui){\n          if ( ui.item ) {\n            var self = $(this);\n            var uiItem = $(ui.item);\n            window.setTimeout(function(){\n              self.val(uiItem.val()).change();\n            }, 1);\n          }\n        }\n      });\n      $('#locate-layer-'+layerName+' ~ span > input').attr('placeholder', placeHolder).val('');\n      $('#locate-layer-'+layerName+' option[value=-1]').attr('label', placeHolder);\n      $('#locate-layer-'+layerName+' ~ span > input').autocomplete('close');\n      if ( ('minLength' in locate) && locate.minLength > 0 )\n        $('#locate-layer-'+layerName).parent().addClass('no-toggle');\n      if(mCheckMobile()){\n        // autocompletion items for locatebylayer feature\n        $('div.locate-layer select').show();\n        $('span.custom-combobox').hide();\n      }\n    },'json');\n  }\n\n  /**\n   * create the layer switcher\n   */\n  function getSwitcherLi(aNode, aLevel) {\n    var nodeConfig = aNode.config;\n    var html = '<li id=\"'+nodeConfig.type+'-'+aNode.name+'\">';\n\n    // add checkbox to display children or legend image\n    html += '<input type=\"checkbox\" id=\"open'+nodeConfig.type+aNode.name+'\" name=\"open'+nodeConfig.type+aNode.name+'\" checked=\"checked\"></input><label for=\"open'+nodeConfig.type+aNode.name+'\">&nbsp;</label>';\n    // add button to manage visibility\n    html += '<button class=\"checkbox\" name=\"'+nodeConfig.type+'-'+aNode.name+'-visibility\" value=\"0\" title=\"'+lizDict['tree.button.checkbox']+'\"></button>';\n    // add layer title\n    html += '<span class=\"label\" title=\"'+nodeConfig.abstract+'\">'+nodeConfig.title+'</span>';\n\n    // Read the plugin metadata to get the legend options\n    // depending on the configuration version\n    let lizmap_plugin_metadata = getLizmapDesktopPluginMetadata();\n    if (lizmap_plugin_metadata.lizmap_web_client_target_version >= 30600) {\n      var legendOption = nodeConfig.legend_image_option;\n    } else {\n      var legendOption = 'hide_at_startup';\n      if (nodeConfig.noLegendImage && nodeConfig.noLegendImage == 'True') {\n        legendOption = 'disabled';\n      }\n    }\n\n    if (('children' in aNode) && aNode['children'].length!=0) {\n      html += getSwitcherUl(aNode, aLevel+1);\n    } else if (nodeConfig.type == 'layer' && legendOption != 'disabled') {\n      var url = getLayerLegendGraphicUrl(aNode.name, false);\n      if ( url != null && url != '' ) {\n          html += '<ul id=\"legend-layer-'+aNode.name+'\">';\n          html += '<li><div><img data-src=\"'+url+'\" src=\"'+lizUrls.basepath + 'assets/css/images/download_layer.gif' + '\"/></div></li>';\n          html += '</ul>';\n      }\n    }\n    html += '</li>';\n    return html;\n  }\n\n  function getSwitcherUl(aNode, aLevel) {\n    var html = '<ul class=\"level'+aLevel+'\">';\n    var children = aNode.children;\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      html += getSwitcherLi(child,aLevel);\n    }\n    html += '</ul>';\n    return html;\n  }\n\n  function createSwitcher() {\n    // set the switcher content\n    $('#switcher-layers').html(getSwitcherNode(tree,0));\n    $('#switcher table.tree').treeTable({\n      stringExpand: lizDict['tree.button.expand'],\n      stringCollapse: lizDict['tree.button.collapse'],\n      onNodeShow: function() {\n        var self = $(this);\n        self.addClass('visible');\n        if (self.find('div.legendGraphics').length != 0) {\n          var name = self.attr('id').replace('legend-','');\n          var url = getLayerLegendGraphicUrl(name, true);\n          if ( url != null && url != '' ) {\n              var limg = self.find('div.legendGraphics img');\n              limg.attr('data-src', url );\n              limg.attr('src', limg.attr('data-src') );\n          }\n        }\n      },\n      onNodeHide: function() {\n        var self = $(this);\n        self.removeClass('visible');\n      }\n    });\n    $(\"#switcher table.tree tbody\").on(\"mousedown\", \"tr td span\", function(event) {\n      // Only act on left button click\n      if(event.which === 1){\n        var wasSelected = $(this).parents('tr:first').hasClass('selected');\n        var isSelected = !wasSelected;\n        $(\"#switcher table.tree tbody tr\").removeClass('selected');\n        $(this).parents('tr:first').toggleClass(\"selected\", isSelected);\n        $('#switcher-layers-actions').toggleClass('active', isSelected);\n\n        // Trigger event\n        var id = $(this).parents('tr:first').attr('id');\n        var itemType = id.split('-')[0];\n        var itemName = id.split('-')[1];\n        lizMap.events.triggerEvent(\"lizmapswitcheritemselected\",\n          { 'name': itemName, 'type': itemType, 'selected': isSelected}\n        );\n      }\n    });\n\n  // === Private functions\n  var options = {\n    childPrefix : \"child-of-\"\n  };\n\n  function childrenOf(node) {\n    return $(node).siblings(\"tr.\" + options.childPrefix + node[0].id);\n  }\n\n  function descendantsOf(node) {\n    var descendants = [];\n    var children = [];\n    if (node && node[0])\n      children = childrenOf(node);\n    for (var i=0, len=children.length; i<len; i++) {\n      descendants.push(children[i]);\n      descendants = descendants.concat(descendantsOf([children[i]]));\n    }\n    return descendants;\n  }\n\n  function parentOf(node) {\n    if (node.length == 0 )\n      return null;\n\n    var classNames = node[0].className.split(' ');\n\n    for(var key=0; key<classNames.length; key++) {\n      if(classNames[key].match(options.childPrefix)) {\n        return $(node).siblings(\"#\" + classNames[key].substring(options.childPrefix.length));\n      }\n    }\n\n    return null;\n  }\n\n  function ancestorsOf(node) {\n    var ancestors = [];\n    while(node = parentOf(node)) {\n      ancestors[ancestors.length] = node[0];\n    }\n    return ancestors;\n  }\n\n    // activate checkbox buttons\n    $('#switcher button.checkbox')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n\n      // get tr of the button\n      var selfTr = self.parents('tr').first();\n      // get the parent of the tr of the button\n      var parentTr = parentOf( selfTr );\n      // get the siblings of the tr of the button\n      var siblingsTr = [];\n      if ( parentTr && parentTr.length != 0) {\n        for (var c=0, childrenParentTr=childrenOf(parentTr); c<childrenParentTr.length; c++){\n            var siblingTr = $(childrenParentTr[c]);\n            if( siblingTr.attr('id') != selfTr.attr('id') )\n              siblingsTr.push( siblingTr );\n        }\n      }\n      var ancestors = [];\n      if( selfTr.hasClass('liz-layer') ) {\n          // manage the button layer\n          if( !self.hasClass('checked') ) {\n              self.removeClass('partial').addClass('checked');\n              selfTr.find('button.checkbox[name=\"layer\"]').each(function(i,b){\n                var name = $(b).val();\n                var layer = map.getLayersByName(name)[0];\n                if( typeof layer !== 'undefined' )\n                  layer.setVisibility(true);\n              });\n          } else {\n              self.removeClass('partial').removeClass('checked');\n              selfTr.find('button.checkbox[name=\"layer\"]').each(function(i,b){\n                var name = $(b).val();\n                var layer = map.getLayersByName(name)[0];\n                if( typeof layer !== 'undefined' )\n                  layer.setVisibility(false);\n              });\n          }\n          if( selfTr.hasClass('mutually-exclusive') ){\n              if( self.hasClass('checked') ) {\n                  for(var s=0, slen=siblingsTr.length; s<slen; s++) {\n                      var siblingTr = $(siblingsTr[s]);\n                      var siblingButt = siblingTr.find('button.checkbox');\n                      if( siblingButt.hasClass('checked') ){\n                        siblingButt.removeClass('partial').removeClass('checked');\n                        if( siblingButt.attr('name') == 'layer') {\n                            var name = $(siblingButt).val();\n                            var layer = map.getLayersByName(name)[0];\n                            if( typeof layer !== 'undefined' )\n                              layer.setVisibility(false);\n                        }\n                      }\n                  }\n                  if ( parentTr && parentTr.length != 0) {\n                      var parentButt = parentTr.find('button.checkbox');\n                      parentButt.removeClass('partial').addClass('checked');\n                  }\n              } else if ( parentTr && parentTr.length != 0) {\n                  var parentButt = parentTr.find('button.checkbox');\n                  parentButt.removeClass('partial').removeClass('checked');\n              }\n              ancestors = ancestorsOf(parentTr);\n          } else {\n            ancestors = ancestorsOf(selfTr);\n          }\n      } else {\n          // manage the button group\n          var descendants = descendantsOf(selfTr);\n          var mutuallyExclusiveGroups = [];\n          $.each(descendants,function(i,tr) {\n            tr = $(tr);\n            var butt = tr.find('button.checkbox');\n            if( !self.hasClass('checked') ) {\n                butt.removeClass('partial').addClass('checked');\n                if( tr.hasClass('liz-layer') && butt.attr('name') == 'layer') {\n                    if( tr.hasClass('mutually-exclusive') ){\n                        var pTr = parentOf(tr);\n                        var pId = pTr.attr('id');\n                        if( mutuallyExclusiveGroups.indexOf(pId) != -1 ) {\n                            butt.removeClass('partial').removeClass('checked');\n                            return;\n                        }\n                        mutuallyExclusiveGroups.push(pId);\n                    }\n                    var name = $(butt).val();\n                    var layer = map.getLayersByName(name)[0];\n                    if( typeof layer !== 'undefined' )\n                      layer.setVisibility(true);\n                }\n            } else {\n                butt.removeClass('partial').removeClass('checked');\n                if( tr.hasClass('liz-layer') && butt.attr('name') == 'layer') {\n                    var name = $(butt).val();\n                    var layer = map.getLayersByName(name)[0];\n                    if( typeof layer !== 'undefined' )\n                      layer.setVisibility(false);\n                }\n            }\n          });\n          if( !self.hasClass('checked') )\n              self.removeClass('partial').addClass('checked');\n          else\n              self.removeClass('partial').removeClass('checked');\n          ancestors = ancestorsOf(selfTr);\n      }\n      // manage ancestors\n      $.each(ancestors,function(i,tr) {\n        tr = $(tr);\n        var count = 0;\n        var checked = 0;\n        var pchecked = 0;\n        var trDesc = childrenOf(tr);\n        $.each(trDesc,function(j,trd) {\n          $(trd).find('button.checkbox').each(function(i,b){\n            b = $(b);\n            if ( b.hasClass('checked') )\n              checked++;\n            else if ( b.hasClass('partial')&& b.hasClass('checked') )\n              pchecked++;\n            count++;\n          });\n        });\n        var trButt = tr.find('button.checkbox');\n        if (count==checked)\n          trButt.removeClass('partial').addClass('checked');\n        else if (checked==0 && pchecked==0)\n          trButt.removeClass('partial').removeClass('checked');\n        else\n          trButt.addClass('partial').addClass('checked');\n      });\n    });\n\n    // activate link buttons\n    $('#switcher button.link')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n      var windowLink = self.val();\n      // Test if the link is internal\n      var mediaRegex = /^(\\/)?media\\//;\n      if(mediaRegex.test(windowLink)){\n        var mediaLink = OpenLayers.Util.urlAppend(lizUrls.media\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        )\n        windowLink = mediaLink+'&path=/'+windowLink;\n      }\n      // Open link in a new window\n      window.open(windowLink);\n    });\n\n    // Activate removeCache button\n    $('#switcher button.removeCache')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n      var removeCacheServerUrl = OpenLayers.Util.urlAppend(\n         lizUrls.removeCache\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      var windowLink = removeCacheServerUrl + '&layer=' + self.val();\n      // Open link in a new window\n      if (confirm(lizDict['tree.button.removeCache'] + ' ?'))\n        window.open(windowLink);\n    });\n\n    var projection = map.projection;\n\n    //manage WMS max width and height\n    var wmsMaxWidth = 3000;\n    var wmsMaxHeight = 3000;\n    if( ('wmsMaxWidth' in config.options) && config.options.wmsMaxWidth )\n        wmsMaxWidth = Number(config.options.wmsMaxWidth);\n    if( ('wmsMaxHeight' in config.options) && config.options.wmsMaxHeight )\n        wmsMaxHeight = Number(config.options.wmsMaxHeight);\n    var removeSingleTile = false;\n    var mapSize = map.size;\n    var replaceSingleTileSize = new OpenLayers.Size(wmsMaxWidth, wmsMaxHeight);\n    if( mapSize.w > wmsMaxWidth || mapSize.h > wmsMaxHeight ){\n        removeSingleTile = true;\n        var wmsMaxMax = Math.max(wmsMaxWidth, wmsMaxHeight);\n        var wmsMinMax = Math.min(wmsMaxWidth, wmsMaxHeight);\n        var mapMax = Math.max(mapSize.w, mapSize.h);\n        var mapMin = Math.min(mapSize.w, mapSize.h);\n        if( mapMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(mapMax/2), Math.round(mapMax/2));\n        else if( wmsMaxMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMaxMax/2), Math.round(wmsMaxMax/2));\n        else\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMinMax/2), Math.round(wmsMinMax/2));\n    }\n\n    // get the baselayer select content\n    // and adding baselayers to the map\n    var select = [];\n    baselayers.reverse();\n    for (var i=0,len=baselayers.length; i<len; i++) {\n      var baselayer = baselayers[i]\n      baselayer.units = projection.proj.units;\n      // Update singleTile layers\n      if( removeSingleTile && (baselayer instanceof OpenLayers.Layer.WMS) && baselayer.singleTile ) {\n          baselayer.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n      }\n      try{ // because google maps layer can be created but not added\n          map.addLayer(baselayer);\n          var qgisName = baselayer.name;\n          if ( baselayer.name in cleanNameMap )\n              qgisName = getLayerNameByCleanName(baselayer.name);\n          var blConfig = config.layers[qgisName];\n          if (blConfig)\n            select += '<option value=\"'+baselayer.name+'\">'+blConfig.title+'</option>';\n          else\n            select += '<option value=\"'+baselayer.name+'\">'+baselayer.name+'</option>';\n\n      } catch(e) {\n          var qgisName = baselayer.name;\n          if ( baselayer.name in cleanNameMap )\n              qgisName = getLayerNameByCleanName(baselayer.name);\n          console.log(qgisName+\" can't be added to the map!\");\n      }\n    }\n\n    if (baselayers.length!=0) {\n      // active the select element for baselayers\n      $('#switcher-baselayer-select').append(select);\n      $('#switcher-baselayer-select')\n        .change(function() {\n          var val = $(this).val();\n          var blName = map.getLayersByName(val)[0];\n          map.setBaseLayer( blName );\n\n          // Trigger event\n          lizMap.events.triggerEvent(\"lizmapbaselayerchanged\",\n            { 'layer': blName}\n          );\n\n          $(this).blur();\n        });\n      // Hide switcher-baselayer if only one base layer inside\n      if (baselayers.length==1){\n        $('#switcher-baselayer').hide();\n      }\n      else if ( 'startupBaselayer' in config.options ) {\n          var startupBaselayer = config.options['startupBaselayer'];\n          if ( startupBaselayer in startupBaselayersReplacement )\n            startupBaselayer = startupBaselayersReplacement[startupBaselayer];\n          else if ( startupBaselayer in config.layers )\n            startupBaselayer = cleanName(startupBaselayer);\n\n          if ( $('#switcher-baselayer-select option[value=\"'+startupBaselayer+'\"]').length != 0)\n            $('#switcher-baselayer-select').val(startupBaselayer).change();\n      }\n    } else {\n      // hide elements for baselayers\n      $('#switcher-baselayer').hide();\n      map.addLayer(new OpenLayers.Layer.Vector('baselayer',{\n        maxExtent:map.maxExtent\n       ,maxScale: map.maxScale\n       ,minScale: map.minScale\n       ,numZoomLevels: map.numZoomLevels\n       ,scales: map.scales\n       ,projection: map.projection\n       ,units: map.projection.proj.units\n      }));\n    }\n\n    // adding layers to the map\n    layers.sort(function(a, b) {\n      if (a.order == b.order)\n        return 0;\n      return a.order > b.order ? 1 : -1;\n    });\n    layers.reverse();\n    for (var i=0,len=layers.length; i<len; i++) {\n      var l = layers[i];\n      l.units = projection.proj.units;\n      l.events.on({\n        loadstart: function(evt) {\n          $('#layer-'+evt.object.name+' span.loading').addClass('loadstart');\n        },\n        loadend: function(evt) {\n          $('#layer-'+evt.object.name+' span.loading').removeClass('loadstart');\n        }\n      });\n      // Add only layers with geometry\n      var qgisName = null;\n      if ( l.name in cleanNameMap )\n          qgisName = getLayerNameByCleanName(l.name);\n      var aConfig = null;\n      if ( qgisName )\n          aConfig = config.layers[qgisName];\n      if ( !aConfig )\n          aConfig = config.layers[l.params['LAYERS']];\n      if ( !aConfig )\n          aConfig = config.layers[l.name];\n      if ( !aConfig )\n          continue;\n      if( 'geometryType' in aConfig &&\n        ( aConfig.geometryType == \"none\" || aConfig.geometryType == \"unknown\" || aConfig.geometryType == \"\" )\n      ){\n        continue;\n      }\n      // Update singleTile layers\n      if( removeSingleTile && (l instanceof OpenLayers.Layer.WMS) && l.singleTile ) {\n          l.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n      }\n      map.addLayer(l);\n\n    }\n\n    // Add Locate by layer\n    if ('locateByLayer' in config) {\n      var locateByLayerList = [];\n      for (var lname in config.locateByLayer) {\n        if ( 'order' in config.locateByLayer[lname] )\n          locateByLayerList[ config.locateByLayer[lname].order ] = lname;\n        else\n          locateByLayerList.push( lname );\n      }\n      var locateContent = [];\n      for (var l in locateByLayerList) {\n        var lname = locateByLayerList[l];\n        var lConfig = config.layers[lname];\n        var html = '<div class=\"locate-layer\">';\n        html += '<select id=\"locate-layer-'+cleanName(lname)+'\" class=\"label\">';\n        html += '<option>'+lConfig.title+'...</option>';\n        html += '</select>';\n        html += '</div>';\n        //constructing the select\n        locateContent.push(html);\n      }\n      $('#locate .menu-content').html(locateContent.join('<hr/>'));\n      map.addLayer(new OpenLayers.Layer.Vector('locatelayer',{\n        styleMap: new OpenLayers.StyleMap({\n          pointRadius: 6,\n          fill: false,\n          stroke: true,\n          strokeWidth: 3,\n          strokeColor: 'yellow',\n          strokeOpacity: 0.8\n        })\n      }));\n\n        var featureTypes = getVectorLayerFeatureTypes();\n        if (featureTypes.length == 0 ){\n          config.locateByLayer = {};\n          $('#button-locate').parent().remove();\n          $('#locate-menu').remove();\n        } else {\n          for (const featureType of featureTypes) {\n            var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n            var lname = lizMap.getNameByTypeName( typeName );\n            if ( !lname ) {\n                if (typeName in config.locateByLayer)\n                    lname = typeName\n                else if ( (typeName in shortNameMap) && (shortNameMap[typeName] in config.locateByLayer))\n                    lname = shortNameMap[typeName];\n                else {\n                    for (var lbl in config.locateByLayer) {\n                        if (lbl.split(' ').join('_') == typeName) {\n                            lname = lbl;\n                            break;\n                        }\n                    }\n                }\n            }\n\n            if ( !(lname in config.locateByLayer) )\n                continue;\n\n            var locate = config.locateByLayer[lname];\n            locate['crs'] = featureType.getElementsByTagName('SRS')[0].textContent;\n            loadProjDefinition( locate.crs, function() {\n                new OpenLayers.Projection(locate.crs);\n            });\n            var bbox = featureType.getElementsByTagName('LatLongBoundingBox')[0];\n            locate['bbox'] = [\n              parseFloat(bbox.getAttribute('minx'))\n              , parseFloat(bbox.getAttribute('miny'))\n              , parseFloat(bbox.getAttribute('maxx'))\n              , parseFloat(bbox.getAttribute('maxy'))\n            ];\n          }\n\n          // get joins\n          for (var lName in config.locateByLayer) {\n            var locate = config.locateByLayer[lName];\n            if ('vectorjoins' in locate && locate['vectorjoins'].length != 0) {\n              var vectorjoin = locate['vectorjoins'][0];\n              locate['joinFieldName'] = vectorjoin['targetFieldName'];\n              for (var jName in config.locateByLayer) {\n                var jLocate = config.locateByLayer[jName];\n                if (jLocate.layerId == vectorjoin.joinLayerId) {\n                  vectorjoin['joinLayer'] = jName;\n                  locate['joinLayer'] = jName;\n                  jLocate['joinFieldName'] = vectorjoin['joinFieldName'];\n                  jLocate['joinLayer'] = lName;\n                  jLocate['filterjoins'] = [{\n                      'targetFieldName': vectorjoin['joinFieldName'],\n                      'joinFieldName': vectorjoin['targetFieldName'],\n                      'joinLayerId': locate.layerId,\n                      'joinLayer': lName\n                  }];\n                }\n              }\n            }\n          }\n\n          // get locate by layers features\n          for (var lname in config.locateByLayer) {\n            getLocateFeature(lname);\n          }\n          $('.btn-locate-clear').click(function() {\n            clearDrawLayer('locatelayer');\n            $('#locate select').val('-1');\n            $('div.locate-layer span > input').val('');\n\n            if( lizMap.lizmapLayerFilterActive ){\n                lizMap.events.triggerEvent('lizmaplocatefeaturecanceled',\n                  {'featureType': lizMap.lizmapLayerFilterActive}\n                );\n            }\n            return false;\n\n          });\n          $('#locate-close').click(function() {\n            $('.btn-locate-clear').click(); // deactivate locate and filter\n            $('#button-locate').click();\n            return false;\n          });\n        }\n    }\n\n    $('#switcher span.label').tooltip({\n      viewport: '#dock'\n    });\n\n  }\n\n  /**\n   * PRIVATE function: createNavbar\n   * create the navigation bar (zoom, scales, etc)\n   */\n  function createNavbar() {\n    $('#navbar div.slider').height(Math.max(50,map.numZoomLevels*5)).slider({\n      orientation:'vertical',\n      min: 0,\n      max: map.numZoomLevels-1,\n      change: function(evt,ui) {\n        if (ui.value > map.baseLayer.numZoomLevels-1) {\n          $('#navbar div.slider').slider('value',map.getZoom())\n          $('#zoom-in-max-msg').show('slow', function() {\n            window.setTimeout(function(){$('#zoom-in-max-msg').hide('slow')},1000)\n          });\n        } else if ( ui.value != map.zoom )\n          map.zoomTo(ui.value);\n      }\n    });\n    $('#navbar button.pan').click(function(){\n      var self = $(this);\n      if (self.hasClass('active'))\n        return false;\n      $('#navbar button.zoom').removeClass('active');\n      self.addClass('active');\n      var navCtrl = map.getControlsByClass('OpenLayers.Control.Navigation')[0];\n      navCtrl.zoomBox.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.zoomBox.handler.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.zoomBox.handler.dragHandler.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.handlers.wheel.activate();\n      if ( ( !('edition' in controls) || !controls.edition.active )\n           && ('featureInfo' in controls) && controls.featureInfo !== null )\n          controls.featureInfo.activate();\n    });\n    $('#navbar button.zoom').click(function(){\n      var self = $(this);\n      if (self.hasClass('active'))\n        return false;\n      $('#navbar button.pan').removeClass('active');\n      self.addClass('active');\n      if ( ('featureInfo' in controls) && controls.featureInfo !== null )\n            controls.featureInfo.deactivate();\n      var navCtrl = map.getControlsByClass('OpenLayers.Control.Navigation')[0];\n      navCtrl.handlers.wheel.deactivate();\n      navCtrl.zoomBox.keyMask = null;\n      navCtrl.zoomBox.handler.keyMask = null;\n      navCtrl.zoomBox.handler.dragHandler.keyMask = null;\n    });\n    $('#navbar button.zoom-extent')\n    .click(function(){\n      var url_params = getUrlParameters();\n      if( 'layers' in url_params ){\n        runPermalink( url_params );\n      }\n      else{\n        map.zoomToExtent(map.initialExtent);\n      }\n    });\n    $('#navbar button.zoom-in')\n    .click(function(){\n      if (map.getZoom() == map.baseLayer.numZoomLevels-1)\n          $('#zoom-in-max-msg').show('slow', function() {\n            window.setTimeout(function(){$('#zoom-in-max-msg').hide('slow')},1000)\n          });\n      else\n        map.zoomIn();\n    });\n    $('#navbar button.zoom-out')\n    .click(function(){\n      map.zoomOut();\n    });\n    if ( ('zoomHistory' in config.options)\n        && config.options['zoomHistory'] == \"True\") {\n      var hCtrl =  new OpenLayers.Control.NavigationHistory();\n      map.addControls([hCtrl]);\n      $('#navbar button.previous').click(function(){\n        var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n        if (ctrl && ctrl.previousStack.length != 0)\n          ctrl.previousTrigger();\n        if (ctrl && ctrl.previous.active)\n          $(this).removeClass('disabled');\n        else\n          $(this).addClass('disabled');\n        if (ctrl && ctrl.next.active)\n          $('#navbar button.next').removeClass('disabled');\n        else\n          $('#navbar button.next').addClass('disabled');\n      });\n      $('#navbar button.next').click(function(){\n        var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n        if (ctrl && ctrl.nextStack.length != 0)\n          ctrl.nextTrigger();\n        if (ctrl && ctrl.next.active)\n          $(this).removeClass('disabled');\n        else\n          $(this).addClass('disabled');\n        if (ctrl && ctrl.previous.active)\n          $('#navbar button.previous').removeClass('disabled');\n        else\n          $('#navbar button.previous').addClass('disabled');\n      });\n      map.events.on({\n        moveend : function() {\n          var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n          if (ctrl && ctrl.previousStack.length != 0)\n            $('#navbar button.previous').removeClass('disabled');\n          else\n            $('#navbar button.previous').addClass('disabled');\n          if (ctrl && ctrl.nextStack.length != 0)\n            $('#navbar button.next').removeClass('disabled');\n          else\n            $('#navbar button.next').addClass('disabled');\n        }\n      });\n    } else {\n      $('#navbar > .history').remove();\n    }\n  }\n\n  /**\n   * PRIVATE function: createToolbar\n   * create the tool bar (collapse switcher, etc)\n   */\n  function createToolbar() {\n    var configOptions = config.options;\n\n    var info = addFeatureInfo();\n    controls['featureInfo'] = info;\n\n    if ( ('print' in configOptions)\n        && configOptions['print'] == 'True')\n      addPrintControl();\n    else\n      $('#button-print').parent().remove();\n\n    if ( config['tooltipLayers'] && config.tooltipLayers.length != 0)\n        addTooltipControl();\n    else\n      $('#button-tooltip-layer').parent().remove();\n\n    if (('geolocation' in configOptions)\n      && configOptions['geolocation'] == 'True'){\n      $('#geolocation button.btn-geolocation-close').click(function () {\n        $('#button-geolocation').click();\n        return false;\n      });\n    }\n\n    if ( ('measure' in configOptions)\n        && configOptions['measure'] == 'True')\n      addMeasureControls();\n    else {\n      $('#measure').parent().remove();\n      $('#measure-length-menu').remove();\n      $('#measure-area-menu').remove();\n      $('#measure-perimeter-menu').remove();\n    }\n  }\n\n  /**\n   * PRIVATE function: deactivateToolControls\n   * Deactivate Openlayers controls\n   */\n  function deactivateToolControls( evt ) {\n    for (var id in controls) {\n      var ctrl = controls[id];\n      if(ctrl){\n        if (evt && ('object' in evt) && ctrl == evt.object){\n          continue;\n        }\n        if (ctrl.type == OpenLayers.Control.TYPE_TOOL){\n          ctrl.deactivate();\n        }\n      }\n    }\n    return true;\n  }\n\n  function displayGetFeatureInfo(text, xy){\n    var eventLonLatInfo = map.getLonLatFromPixel(xy);\n\n    if (map.popups.length != 0)\n        map.removePopup(map.popups[0]);\n\n    var popup = null;\n    var popupContainerId = null;\n    if( 'popupLocation' in config.options && config.options.popupLocation != 'map' ){\n      popupContainerId = 'popupcontent';\n\n      // create content\n      var popupReg = new RegExp('lizmapPopupTable', 'g');\n      text = text.replace( popupReg, 'table table-condensed table-striped table-bordered lizmapPopupTable');\n      var pcontent = '<div class=\"lizmapPopupContent\">'+text+'</div>';\n      var hasPopupContent = (!(!text || text == null || text == ''));\n      $('#popupcontent div.menu-content').html(pcontent);\n      if ( !$('#mapmenu .nav-list > li.popupcontent').is(':visible') )\n        $('#mapmenu .nav-list > li.popupcontent').show();\n\n      // Warn user no data has been found\n      if( !hasPopupContent ){\n        pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.no.result']+'</h4></div>';\n        $('#popupcontent div.menu-content').html(pcontent);\n        window.setTimeout(function(){\n            if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') && config.options.popupLocation != 'right-dock')\n                $('#button-popupcontent').click();\n        },2000);\n      }\n\n      // Display dock if needed\n      if(\n        !$('#mapmenu .nav-list > li.popupcontent').hasClass('active')\n          && (!mCheckMobile() || ( mCheckMobile() && hasPopupContent ) )\n          && (lastLonLatInfo == null || eventLonLatInfo.lon != lastLonLatInfo.lon || eventLonLatInfo.lat != lastLonLatInfo.lat)\n      ){\n          $('#button-popupcontent').click();\n      }\n      else if(\n        $('#mapmenu .nav-list > li.popupcontent').hasClass('active')\n          && ( mCheckMobile() && hasPopupContent )\n      ){\n          $('#button-popupcontent').click();\n      }\n      // Resize minidock if displayed\n      if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') && config.options.popupLocation == 'minidock' )\n          updateMiniDockSize();\n\n    }\n    else{\n      if (!text || text == null || text == '')\n          return false;\n      // Use openlayers map popup anchored\n      popupContainerId = \"liz_layer_popup\";\n      popup = new OpenLayers.Popup.LizmapAnchored(\n          popupContainerId,\n          eventLonLatInfo,\n          null,\n          text,\n          null,\n          true,\n          function() {\n            map.removePopup(this);\n            if(mCheckMobile()){\n              $('#navbar').show();\n              $('#overview-box').show();\n            }\n\n            // clean locate layer\n            clearDrawLayer('locatelayer');\n            return false;\n          }\n      );\n      popup.panMapIfOutOfView = true;\n      map.addPopup(popup);\n\n      // Activate Boostrap 2 tabs here as they are not\n      // automatically activated when created in popup anchored\n      $('#' + popupContainerId + ' a[data-toggle=\"tab\"]').on( 'click',function (e) {\n        e.preventDefault();\n        $(this).tab('show');\n      });\n\n      popup.verifySize();\n      // Hide navbar and overview in mobile mode\n      if(mCheckMobile()){\n          $('#navbar').hide();\n          $('#overview-box').hide();\n      }\n    }\n    lastLonLatInfo = eventLonLatInfo;\n\n    // Display related children objects\n    addChildrenFeatureInfo( popup, popupContainerId );\n    // Display geometries\n    addGeometryFeatureInfo( popup, popupContainerId );\n    // Display the plots of the children layers features filtered by popup item\n    addChildrenDatavizFilteredByPopupFeature( popup, popupContainerId );\n\n    // Trigger event\n    lizMap.events.triggerEvent(\"lizmappopupdisplayed\",\n        {'popup': popup, 'containerId': popupContainerId}\n    );\n  }\n\n\n  /**\n   * PRIVATE function: createPermalink\n   * create the permalink tool\n   */\n  function createPermalink() {\n      if ( $('#permalink').length == 0 )\n        return;\n\n    var pLink = new OpenLayers.Control.Permalink(\n      'permalink',\n      null,\n      {\n        \"createParams\": createPermalinkArgs\n      }\n    );\n    map.addControl( pLink );\n\n    var eLink = new OpenLayers.Control.Permalink(\n      'permalink-embed',\n      $('#permalink-embed').attr('href'),\n      {\n        \"createParams\": createPermalinkArgs\n      }\n    );\n    map.addControl( eLink );\n    map.events.on({\n        \"changebaselayer\": function() {\n            $('#switcher-baselayer-select').val( map.baseLayer.name ).change();\n        },\n        'moveend': updatePermalinkInputs,\n        'changelayer': onMapChangelayer,\n        'changebaselayer': updatePermalinkInputs\n    });\n    $('#select-embed-permalink').change(function(){\n        if ( $(this).val() == 'p') {\n            $('#span-embed-personalized-permalink').show();\n        } else {\n            $('#span-embed-personalized-permalink').hide();\n        }\n        updatePermalinkInputs();\n    });\n    $('#span-embed-personalized-permalink input').change(updatePermalinkInputs);\n\n    $('.btn-permalink-clear').click(function(){\n      $('#button-permaLink').click();\n      return false;\n    });\n\n    bindGeobookmarkEvents();\n\n    $('#permalink-box ul.permalink-tabs a[data-toggle=\"tab\"]').on('shown', function(e){\n        if($(e.target).attr('href') == '#tab-embed-permalink')\n            updateMiniDockSize();\n    });\n\n    $('#geobookmark-form').submit(function(){\n      var bname = $('#geobookmark-form input[name=\"bname\"]').val();\n      if( bname == '' ){\n        mAddMessage(lizDict['geobookmark.name.required'],'error',true);\n        return false;\n      }\n      var gburl = lizUrls.geobookmark;\n      var gbparams = JSON.parse(JSON.stringify(permalinkArgs));\n      gbparams['name'] = bname;\n      gbparams['q'] = 'add';\n      if( lizMap.lizmapLayerFilterActive ) {\n        var afilter = lizMap.lizmapLayerFilterActive + ':' + config.layers[lizMap.lizmapLayerFilterActive]['filteredFeatures'].join();\n        gbparams['filter'] =  afilter;\n      }\n      $.post(gburl,\n        gbparams,\n        function(data) {\n          setGeobookmarkContent(data);\n        }\n        ,'text'\n      );\n\n      return false;\n    });\n\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'permaLink' ) {\n                updatePermalinkInputs();\n            }\n        }\n    });\n\n  }\n\n\n  function createPermalinkArgs(){\n\n    var args = OpenLayers.Control.Permalink.prototype.createParams.apply(\n        this, arguments\n    );\n\n    // Replace zoom, lat, lon by bbox\n    delete args['zoom'];\n    delete args['lat'];\n    delete args['lon'];\n    args['bbox'] = map.getExtent().toBBOX();\n    args['crs'] = map.projection.projCode;\n\n    // Add layer filter and style if needed\n    var filter = [];\n    var style = [];\n    var opacity = [];\n    for ( var  lName in config.layers ) {\n\n      var lConfig = config.layers[lName];\n      if ( !('request_params' in lConfig)\n        || lConfig['request_params'] == null )\n          continue;\n\n      if ( ('filter' in lConfig['request_params'])\n        && lConfig['request_params']['filter'] != null\n        && lConfig['request_params']['filter'] != \"\" ) {\n          filter.push( lConfig['request_params']['filter'] );\n      }\n\n    }\n    if ( filter.length > 0 )\n      args['filter'] = filter.join(';');\n\n    // Layers style\n    for (var i=0,len=layers.length; i<len; i++) {\n      var layer = layers[i];\n      if( layer.isVisible &&\n         (layer.params['STYLES'] != 'default' || layer.params['STYLES'] != '') ){\n        style.push( layer.name + ':' + layer.params['STYLES'] );\n      }\n      if( layer.opacity && layer.opacity != 1 ){\n        opacity.push( layer.name + ':' + layer.opacity );\n      }\n    }\n    if ( style.length > 0 )\n      args['layerStyles'] = style.join(';');\n    if ( opacity.length > 0 ) {\n      args['layerOpacities'] = opacity.join(';');\n    }\n\n    // Add permalink args to Lizmap global variable\n    permalinkArgs = args;\n\n    return args;\n\n  }\n\n  function getUrlParameters(){\n    const urlParameters = {};\n\n    if (window.location.search.length > 1) {\n      for (const keyValue of window.location.search.slice(1).split(\"&\")) {\n        const [key, value] = keyValue.split(\"=\");\n        urlParameters[decodeURIComponent(key)] = decodeURIComponent(value);\n      }\n    }\n    return urlParameters;\n  }\n\n  function updatePermalinkInputs() {\n    if ( !$('#permaLink').hasClass('active') )\n        return;\n\n    var pHref = $('#permalink').attr('href');\n\n    $('#input-share-permalink').val(pHref);\n\n    var iframeSize = $('#select-embed-permalink').val();\n    pHref = $('#permalink-embed').attr('href');\n    var pIframe = '';\n    if ( iframeSize == 's' ) {\n        pIframe = '<iframe width=\"400\" height=\"300\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    } else if ( iframeSize == 'm' ) {\n        pIframe = '<iframe width=\"600\" height=\"450\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }else if ( iframeSize == 'l' ) {\n        pIframe = '<iframe width=\"800\" height=\"600\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }else if ( iframeSize == 'p' ) {\n        var w = $('#input-embed-width-permalink').val();\n        var h = $('#input-embed-height-permalink').val();\n        pIframe = '<iframe width=\"'+w+'\" height=\"'+h+'\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }\n    $('#input-embed-permalink').val(pIframe);\n  }\n\n  function onMapChangelayer(event) {\n    // Update permalink\n    updatePermalinkInputs()\n\n    // Trigger lizmap event\n    if (event.property == 'visibility'){\n      var lname = getLayerNameByCleanName(event.layer.name);\n      var lconfig = config.layers[lname]\n      lizMap.events.triggerEvent(\"lizmaplayerchangevisibility\",\n      {\n        'name': lname,\n        'config': lconfig,\n        'visibility': event.layer.visibility\n      });\n    }\n  }\n\n  function bindGeobookmarkEvents(){\n\n    $('.btn-geobookmark-del').click(function(){\n      if (confirm(lizDict['geobookmark.confirm.delete'] )){\n        var gbid = $(this).val();\n        removeGeoBookmark(gbid);\n      }\n      return false;\n    });\n    $('.btn-geobookmark-run').click(function(){\n      var id = $(this).val();\n      runGeoBookmark( id );\n\n      return false;\n    });\n  }\n\n  function setGeobookmarkContent( gbData ){\n    // set content\n    $('div#geobookmark-container').html(gbData);\n    // unbind previous click events\n    $('div#geobookmark-container button').unbind('click');\n    // Bind events\n    bindGeobookmarkEvents();\n    // Remove bname val\n    $('#geobookmark-form input[name=\"bname\"]').val('').blur();\n  }\n\n  // Set the map accordingly to\n  function runPermalink( pparams ){\n\n    // Activate layers\n    var players = pparams.layers;\n\n    // Get styles and tranform into obj\n    var slist = {};\n    if( 'layerStyles' in pparams && pparams.layerStyles != ''){\n      var lstyles = pparams.layerStyles.split(';');\n      for(var i in lstyles){\n        var a = lstyles[i];\n        var b = a.split(':');\n        if( b.length == 2)\n          slist[b[0]] = b[1];\n      }\n    }\n\n    // Get opacities and tranform into obj\n    var olist = {};\n    if( 'layerOpacities' in pparams && pparams.layerOpacities != ''){\n      var lopacities = pparams.layerOpacities.split(';');\n      for(var i in lopacities){\n        var a = lopacities[i];\n        var b = a.split(':');\n        if( b.length == 2)\n          olist[b[0]] = parseFloat(b[1]);\n      }\n    }\n\n    for( var i=0; i < map.layers.length; i++){\n\n      // Activate and deactivate layers\n      var l = map.layers[i];\n      var lbase = l.isBaseLayer;\n      if( lbase ){\n        if( players[i] == 'B' )\n          $('#switcher-baselayer-select').val( l.name ).change();\n      }else{\n        var btn = $('#switcher button.checkbox[name=\"layer\"][value=\"'+l.name+'\"]');\n        if ( ( (players[i] == 'T') != btn.hasClass('checked') ) )\n          $('#switcher button.checkbox[name=\"layer\"][value=\"'+l.name+'\"]').click();\n      }\n\n      // Set style\n      if( l.name in slist ){\n        l.params['STYLES'] = slist[l.name];\n        l.redraw( true );\n        lizMap.events.triggerEvent(\"layerstylechanged\",\n            { 'featureType': l.name}\n        );\n      }\n\n      // Set opacity\n      if( l.name in olist ){\n        l.setOpacity(olist[l.name]);\n      }\n    }\n\n    // Filter\n    if( 'filter' in pparams && pparams.filter != '' ){\n        var sp = pparams.filter.split(':');\n        if( sp.length == 2 ){\n          var flayer = sp[0];\n          var ffids = sp[1].split();\n\n          // Select feature\n          lizMap.events.triggerEvent('layerfeatureselected',\n              {'featureType': flayer, 'fid': ffids, 'updateDrawing': false}\n          );\n          // Filter selected feature\n          lizMap.events.triggerEvent('layerfeaturefilterselected',\n              {'featureType': flayer}\n          );\n        }\n    }else{\n      if( lizMap.lizmapLayerFilterActive ){\n        lizMap.events.triggerEvent('layerfeatureremovefilter',\n            {'featureType': lizMap.lizmapLayerFilterActive}\n        );\n      }\n    }\n\n    // Zoom to bbox\n    var bbox = OpenLayers.Bounds.fromString( pparams.bbox );\n    map.zoomToExtent( bbox, true );\n\n  }\n\n  function runGeoBookmark( id ){\n    var gburl = lizUrls.geobookmark;\n    var gbparams = {\n      id: id,\n      q: 'get'\n    };\n    $.get(gburl,\n      gbparams,\n      function(geoparams) {\n        runPermalink(geoparams);\n      }\n      ,'json'\n    );\n  }\n\n  function removeGeoBookmark( id ){\n    var gburl = lizUrls.geobookmark;\n    var gbparams = {\n      id: id,\n      q: 'del',\n      repository: lizUrls.params.repository,\n      project: lizUrls.params.project\n    };\n    $.get(gburl,\n      gbparams,\n      function(data) {\n        setGeobookmarkContent(data);\n      }\n      ,'text'\n    );\n  }\n\n  function addGeometryFeatureInfo( popup, containerId ) {\n      // clean locate layer\n      clearDrawLayer('locatelayer');\n      var layer = map.getLayersByName('locatelayer')[0];\n      if( typeof layer === 'undefined' )\n        return;\n\n      // build selector\n      var selector = 'div.lizmapPopupContent div.lizmapPopupDiv > input.lizmap-popup-layer-feature-geometry';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n      // get geometries and crs\n      var geometries = [];\n      $(selector).each(function(){\n        var self = $(this);\n        var val = self.val();\n        if ( val == '' )\n            return;\n        var crs = self.parent().find('input.lizmap-popup-layer-feature-crs').val();\n        if ( crs == '' )\n            return;\n        var fid = self.parent().find('input.lizmap-popup-layer-feature-id').val();\n        var minx = self.parent().find('input.lizmap-popup-layer-feature-bbox-minx').val();\n        var miny = self.parent().find('input.lizmap-popup-layer-feature-bbox-miny').val();\n        var maxx = self.parent().find('input.lizmap-popup-layer-feature-bbox-maxx').val();\n        var maxy = self.parent().find('input.lizmap-popup-layer-feature-bbox-maxy').val();\n        geometries.push( { fid: fid, geom: val, crs: crs, bbox:[minx,miny,maxx,maxy] } );\n      });\n\n      // load proj and build features from popup\n      var projLoaded = [];\n      for ( var i=0, len=geometries.length; i<len; i++ ) {\n        loadProjDefinition(geometries[i].crs, function( aProj ) {\n          projLoaded.push( aProj );\n          if ( projLoaded.length == geometries.length ) {\n            var features = [];\n            for (const geomInfo of geometries) {\n                var geometry = OpenLayers.Geometry.fromWKT( geomInfo.geom );\n                geometry.transform(geomInfo.crs, map.getProjection());\n                features.push( new OpenLayers.Feature.Vector( geometry ) );\n            }\n            layer.addFeatures( features );\n          }\n        });\n      }\n  }\n\n  function addChildrenDatavizFilteredByPopupFeature(popup, containerId) {\n    if ('datavizLayers' in lizMap.config) {\n      // build selector\n      var selector = 'div.lizmapPopupContent div.lizmapPopupDiv';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n     $(selector).each(function(){\n        var mydiv = $(this);\n\n        // Do not add plots if already present\n        if( $(this).find('div.lizdataviz').length > 0 )\n            return true;\n\n        if ($(this).find('input.lizmap-popup-layer-feature-id:first').val()) {\n          var getLayerId = $(this).find('input.lizmap-popup-layer-feature-id:first').val().split('.');\n          var popupId = getLayerId[0] + '_' + getLayerId[1];\n          var layerId = getLayerId[0];\n          var fid = getLayerId[1];\n\n          var getLayerConfig = lizMap.getLayerConfigById( layerId );\n\n          // verifiying  related children objects\n          if ( !getLayerConfig )\n              return true;\n          var featureType = getLayerConfig[0];\n\n          // We do not want to deactivate the display of filtered children dataviz\n          // when children popup are not displayed : comment the 2 following lines\n          if ( !('relations' in lizMap.config) || !(layerId in lizMap.config.relations) )\n              return true;\n\n          //If dataviz exists, get config\n          if( !('datavizLayers' in lizMap.config ))\n              return true;\n\n          lizMap.getLayerFeature(featureType, fid, function(feat) {\n                // Where there is all plots\n                var plotLayers = lizMap.config.datavizLayers.layers;\n                var lrelations = lizMap.config.relations[layerId];\n                var nbPlotByLayer = 1;\n\n                for ( var i in plotLayers) {\n\n                    for(var x in lrelations){\n                      var rel = lrelations[x];\n                      // Id of the layer which is the child of layerId\n                      var getChildrenId = rel.referencingLayer;\n\n                      // Filter of the plot\n                      var filter = '\"' + rel.referencingField + '\" IN (\\''+feat.properties[rel.referencedField]+'\\')';\n\n\n                        if(plotLayers[i].layer_id==getChildrenId)\n                        {\n                            var plot_config=plotLayers[i];\n                            if('popup_display_child_plot' in plot_config\n                              && plot_config.popup_display_child_plot == \"True\"\n                            ){\n                              var plot_id=plotLayers[i].plot_id;\n                              popupId = getLayerId[0] + '_' + getLayerId[1] + '_' + String(nbPlotByLayer);\n                              // Be sure the id is unique ( popup can be displayed in atlas tool too)\n                              popupId+= '_' + new Date().valueOf()+btoa(Math.random()).substring(0,12);\n                              var phtml = lizDataviz.buildPlotContainerHtml(\n                                  plot_config.title,\n                                  plot_config.abstract,\n                                  popupId,\n                                  false\n                              );\n                              var html = '<div class=\"lizmapPopupChildren lizdataviz\">';\n                              html+= '<h4>'+ plot_config.title+'</h4>';\n                              html+= phtml\n                              html+= '</div>';\n                              var haspc = $(mydiv).find('div.lizmapPopupChildren:last');\n                              if( haspc.length > 0 )\n                                  $(haspc).after(html);\n                              else\n                                  $(mydiv).append(html);\n                              lizDataviz.getPlot(plot_id, filter, popupId);\n                              nbPlotByLayer++;\n                            }\n                        }\n                    }\n                }\n          });\n        }\n      });\n    }else{\n      return false;\n    }\n  }\n\n  function addChildrenFeatureInfo( popup, containerId ) {\n      var selector = 'div.lizmapPopupContent input.lizmap-popup-layer-feature-id';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n      $(selector).each(function(){\n        var self = $(this);\n        var val = self.val();\n        var fid = val.split('.').pop();\n        var layerId = val.replace( '.' + fid, '' );\n\n        var getLayerConfig = getLayerConfigById( layerId );\n\n        // verifiying  related children objects\n        if ( !getLayerConfig )\n            return true;\n        var layerConfig = getLayerConfig[1];\n        var featureType = getLayerConfig[0];\n        if ( !('popupDisplayChildren' in layerConfig) || layerConfig.popupDisplayChildren != 'True')\n            return true;\n        if ( !('relations' in config) || !(layerId in config.relations) )\n            return true;\n\n        // Display related children objects\n        var relations = config.relations[layerId];\n        var popupMaxFeatures = 10;\n        if ( 'popupMaxFeatures' in layerConfig && !isNaN(parseInt(layerConfig.popupMaxFeatures)) )\n            popupMaxFeatures = parseInt(layerConfig.popupMaxFeatures);\n        popupMaxFeatures == 0 ? 10 : popupMaxFeatures;\n        getLayerFeature(featureType, fid, function(feat) {\n\n          // Array of Promise w/ fetch to request children popup content\n          const popupChidrenRequests = [];\n          const rConfigLayerAll = [];\n\n          // Build POST query for every child based on QGIS relations\n          for ( const relation of relations ){\n              const rLayerId = relation.referencingLayer;\n              const rGetLayerConfig = getLayerConfigById( rLayerId );\n              if ( rGetLayerConfig ) {\n                  const rConfigLayer = rGetLayerConfig[1];\n                  let clname = rConfigLayer?.shortname || rConfigLayer.cleanname;\n                  if ( clname === undefined ) {\n                      clname = cleanName(rConfigLayer.name);\n                      rConfigLayer.cleanname = clname;\n                  }\n                  if ( rConfigLayer.popup == 'True' && self.parent().find('div.lizmapPopupChildren.'+clname).length == 0) {\n                      let wmsName = rConfigLayer?.shortname || rConfigLayer.name;\n                      const wmsOptions = {\n                            'LAYERS': wmsName\n                          ,'QUERY_LAYERS': wmsName\n                          ,'STYLES': ''\n                          ,'SERVICE': 'WMS'\n                          ,'VERSION': '1.3.0'\n                          ,'CRS': (('crs' in rConfigLayer) && rConfigLayer.crs != '') ? rConfigLayer.crs : 'EPSG:4326'\n                          ,'REQUEST': 'GetFeatureInfo'\n                          ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n                          ,'FEATURE_COUNT': popupMaxFeatures\n                          ,'INFO_FORMAT': 'text/html'\n                      };\n\n                      if ( 'popupMaxFeatures' in rConfigLayer && !isNaN(parseInt(rConfigLayer.popupMaxFeatures)) )\n                          wmsOptions['FEATURE_COUNT'] = parseInt(rConfigLayer.popupMaxFeatures);\n                      if ( wmsOptions['FEATURE_COUNT'] == 0 )\n                          wmsOptions['FEATURE_COUNT'] = popupMaxFeatures;\n                      if ( rConfigLayer.request_params && rConfigLayer.request_params.filter &&\n                            rConfigLayer.request_params.filter !== '' )\n                          wmsOptions['FILTER'] = rConfigLayer.request_params.filter+' AND \"'+relation.referencingField+'\" = \\''+feat.properties[relation.referencedField]+'\\'';\n                      else\n                          wmsOptions['FILTER'] = wmsName+':\"'+relation.referencingField+'\" = \\''+feat.properties[relation.referencedField]+'\\'';\n\n                    var parentDiv = self.parent();\n\n                    // Fetch queries\n                    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n                      , OpenLayers.Util.getParameterString(lizUrls.params)\n                    );\n\n                    // Keep `rConfigLayer` in array with same order that fetch queries\n                    // for later user when Promise.allSettled resolves\n                    rConfigLayerAll.push(rConfigLayer);\n                    popupChidrenRequests.push(\n                      fetch(service, {\n                        \"method\": \"POST\",\n                        \"body\": new URLSearchParams(wmsOptions)\n                      }).then(function (response) {\n                        return response.text();\n                      })\n                    );\n                  }\n              }\n          }\n\n          // Fetch GetFeatureInfo query for every children popups\n          Promise.allSettled(popupChidrenRequests).then(popupChildrenData => {\n\n            const childPopupElements = [];\n\n            for (let index = 0; index < popupChildrenData.length; index++) {\n              let popupChildData = popupChildrenData[index].value;\n\n              var hasPopupContent = (!(!popupChildData || popupChildData == null || popupChildData == ''))\n              if (hasPopupContent) {\n                var popupReg = new RegExp('lizmapPopupTable', 'g');\n                popupChildData = popupChildData.replace(popupReg, 'table table-condensed table-striped lizmapPopupTable');\n\n                const configLayer = rConfigLayerAll[index];\n\n                var clname = configLayer.cleanname;\n                if (clname === undefined) {\n                  clname = cleanName(configLayer.name);\n                  configLayer.cleanname = clname;\n                }\n\n                const resizeTablesButtons =\n                  '<button class=\"compact-tables btn btn-small\" data-original-title=\"' + lizDict['popup.table.compact'] + '\"><i class=\"icon-resize-small\"></i></button>'+\n                  '<button class=\"explode-tables btn btn-small hide\" data-original-title=\"' + lizDict['popup.table.explode'] + '\"><i class=\"icon-resize-full\"></i></button>';\n\n                var childPopup = $('<div class=\"lizmapPopupChildren ' + clname + '\" data-layername=\"' + clname + '\" data-title=\"' + configLayer.title + '\">' + resizeTablesButtons + popupChildData + '</div>');\n\n                //Manage if the user choose to create a table for children\n                if (['qgis', 'form'].indexOf(configLayer.popupSource) !== -1 &&\n                  childPopup.find('.lizmap_merged').length != 0) {\n                  // save inputs\n                  childPopup.find(\".lizmapPopupDiv\").each(function (i, e) {\n                    var popupDiv = $(e);\n                    if (popupDiv.find(\".lizmapPopupHeader\").prop(\"tagName\") == 'TR') {\n                      popupDiv.find(\".lizmapPopupHeader\").prepend(\"<th></th>\");\n                      popupDiv.find(\".lizmapPopupHeader\").next().prepend(\"<td></td>\");\n                    } else {\n                      popupDiv.find(\".lizmapPopupHeader\").next().prepend(\"<span></span>\");\n                    }\n                    popupDiv.find(\".lizmapPopupHeader\").next().children().first().append(popupDiv.find(\"input\"));\n                  });\n\n                  childPopup.find(\"h4\").each(function (i, e) {\n                    if (i != 0)\n                      $(e).remove();\n                  });\n\n                  childPopup.find(\".lizmapPopupHeader\").each(function (i, e) {\n                    if (i != 0)\n                      $(e).remove();\n                  });\n\n                  childPopup.find(\".lizmapPopupDiv\").contents().unwrap();\n                  childPopup.find(\".lizmap_merged\").contents().unwrap();\n                  childPopup.find(\".lizmapPopupDiv\").remove();\n                  childPopup.find(\".lizmap_merged\").remove();\n\n                  childPopup.find(\".lizmapPopupHidden\").hide();\n\n                  var tChildPopup = $(\"<table class='lizmap_merged'></table>\");\n                  childPopup.append(tChildPopup);\n                  childPopup.find('tr').appendTo(tChildPopup);\n\n                  childPopup.children('tbody').remove();\n                }\n\n                var oldPopupChild = parentDiv.find('div.lizmapPopupChildren.' + clname);\n                if (oldPopupChild.length != 0){\n                  oldPopupChild.remove();\n                }\n\n                parentDiv.append(childPopup);\n\n                childPopupElements.push(childPopup);\n\n                // Trigger event for single popup children\n                lizMap.events.triggerEvent(\n                  \"lizmappopupchildrendisplayed\",\n                  { 'html': childPopup.html() }\n                );\n              }\n            }\n\n            // Handle compact-tables/explode-tables behaviour\n            $('.lizmapPopupChildren .popupAllFeaturesCompact table').DataTable();\n\n            $('.lizmapPopupChildren .compact-tables, .lizmapPopupChildren .explode-tables').tooltip();\n\n            $('.lizmapPopupChildren .compact-tables').off('click').on('click',function() {\n              $(this)\n                .addClass('hide')\n                .siblings('.explode-tables').removeClass('hide')\n                .siblings('.popupAllFeaturesCompact, .lizmapPopupSingleFeature').toggle();\n            });\n\n            $('.lizmapPopupChildren .explode-tables').off('click').on('click',function () {\n              $(this)\n                .addClass('hide')\n                .siblings('.compact-tables').removeClass('hide')\n                .siblings('.popupAllFeaturesCompact, .lizmapPopupSingleFeature').toggle();\n            });\n\n            // Trigger event for all popup children\n            lizMap.events.triggerEvent(\n              \"lizmappopupallchildrendisplayed\",\n              {\n                parentPopupElement: self.parents('.lizmapPopupSingleFeature'),\n                childPopupElements: childPopupElements\n              }\n            );\n          });\n        });\n      });\n  }\n\n  function addFeatureInfo() {\n      // Verifying layers\n      var popupsAvailable = false;\n      for ( var l in config.layers ) {\n          var configLayer = config.layers[l];\n          var editionLayer = null;\n          if ( ('editionLayers' in config) && (l in config.editionLayers) )\n              editionLayer = config.editionLayers[l];\n          if( (configLayer && configLayer.popup && configLayer.popup == 'True')\n           || (editionLayer && ( editionLayer.capabilities.modifyGeometry == 'True'\n                              || editionLayer.capabilities.modifyAttribute == 'True'\n                              || editionLayer.capabilities.deleteFeature == 'True') ) ){\n              popupsAvailable = true;\n              break;\n          }\n      }\n      if ( !popupsAvailable )\n        return null;\n\n      // Create the dock if needed\n      if( 'popupLocation' in config.options &&\n          config.options.popupLocation != 'map' &&\n          !$('#mapmenu .nav-list > li.popupcontent > a').length ) {\n          // Verifying the message\n          if ( !('popup.msg.start' in lizDict) )\n            lizDict['popup.msg.start'] = 'Click to the map to get informations.';\n          // Initialize dock\n          var popupContainerId = 'popupcontent';\n          var pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.start']+'</h4></div>';\n          addDock(popupContainerId, 'Popup', config.options.popupLocation, pcontent, 'icon-comment');\n          $('#button-popupcontent').click(function(){\n              if($(this).parent().hasClass('active')) {\n                  // clean locate layer\n                  clearDrawLayer('locatelayer');\n                  // remove information\n                  $('#popupcontent div.menu-content').html('<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.start']+'</h4></div>');\n              }\n          });\n\n      }\n\n      var WMSGetFeatureInfo = new OpenLayers.Control.WMSGetFeatureInfo({\n            url: lizUrls.service,\n            title: 'Identify features by clicking',\n            type:OpenLayers.Control.TYPE_TOGGLE,\n            queryVisible: true,\n            infoFormat: 'text/html',\n            vendorParams: getFeatureInfoTolerances(),\n            handlerOptions: {\n              click: {\n                pixelTolerance: 10\n              }\n            },\n            eventListeners: {\n                getfeatureinfo: function(event) {\n                    displayGetFeatureInfo(event.text, event.xy);\n                }\n            }\n     });\n     if (lizUrls.publicUrlList && lizUrls.publicUrlList.length != 0 ) {\n        var layerUrls = [];\n        for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n          layerUrls.push(\n            OpenLayers.Util.urlAppend(\n              lizUrls.publicUrlList[j],\n              OpenLayers.Util.getParameterString(lizUrls.params)\n            )\n          );\n        }\n        WMSGetFeatureInfo.layerUrls = layerUrls;\n     }\n     WMSGetFeatureInfo.findLayers = function() {\n        var candidates = this.layers || this.map.layers;\n        var layers = [];\n        var maxFeatures = 0;\n        var layer, url;\n        const filterTokenList = [];\n        for(var i=0, len=candidates.length; i<len; ++i) {\n            layer = candidates[i];\n            if( (layer instanceof OpenLayers.Layer.WMS || layer instanceof OpenLayers.Layer.WMTS)\n             && (!this.queryVisible || (layer.getVisibility() && layer.calculateInRange())) ) {\n                var qgisName = null;\n                if ( layer.name in cleanNameMap )\n                    qgisName = getLayerNameByCleanName(layer.name);\n                var configLayer = null;\n                if ( qgisName )\n                    configLayer = config.layers[qgisName];\n                if ( !configLayer )\n                    configLayer = config.layers[layer.params['LAYERS']];\n                if ( !configLayer )\n                    configLayer = config.layers[layer.name];\n                 var editionLayer = null;\n                 if( 'editionLayers' in config ) {\n                     editionLayer = config.editionLayers[qgisName];\n                     if ( !editionLayer )\n                        editionLayer = config.editionLayers[layer.params['LAYERS']];\n                     if ( !editionLayer )\n                        editionLayer = config.editionLayers[layer.name];\n                 }\n                 if( (configLayer && configLayer.popup && configLayer.popup == 'True')\n                  || (editionLayer && ( editionLayer.capabilities.modifyGeometry == 'True'\n                                     || editionLayer.capabilities.modifyAttribute == 'True'\n                                     || editionLayer.capabilities.deleteFeature == 'True') ) ){\n                    url = OpenLayers.Util.isArray(layer.url) ? layer.url[0] : layer.url;\n                    // if the control was not configured with a url, set it\n                    // to the first layer url\n                    if(this.drillDown === false && !this.url) {\n                        this.url = url;\n                    }\n\n                    // Filtertoken\n                    const filterToken = configLayer?.['request_params']?.['filtertoken'];\n                    if (filterToken) {\n                      filterTokenList.push(filterToken);\n                    }\n\n                    layers.push(layer);\n\n                    if ( 'popupMaxFeatures' in configLayer && !isNaN(parseInt(configLayer.popupMaxFeatures)) )\n                        maxFeatures += parseInt(configLayer.popupMaxFeatures);\n                    else\n                        maxFeatures += 10;\n                 }\n            }\n        }\n        this.maxFeatures = maxFeatures == 0 ? 10 : maxFeatures;\n\n        if(filterTokenList.length){\n          this.vendorParams['filtertoken'] = filterTokenList.join(';');\n        }\n\n        return layers;\n     };\n     function refreshGetFeatureInfo( evt ) {\n         if ( !evt.updateDrawing )\n            return;\n        if ( lastLonLatInfo == null )\n            return true;\n        var lastPx = map.getPixelFromLonLat(lastLonLatInfo);\n        if ( $('#liz_layer_popup  div.lizmapPopupContent').length < 1\n          && $('#popupcontent div.menu-content div.lizmapPopupContent').length < 1)\n            return;\n\n        var popupContainerId = \"liz_layer_popup\";\n        if ( $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id').length == 0 )\n            popupContainerId = 'popupcontent';\n\n        // Refresh if needed\n        var refreshInfo = false;\n        $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id').each(function(){\n            var self = $(this);\n            var val = self.val();\n            var fid = val.split('.').pop();\n            var layerId = val.replace( '.' + fid, '' );\n            var aConfig = lizMap.getLayerConfigById( layerId );\n            if ( aConfig && aConfig[0] == evt.featureType ) {\n                refreshInfo = true;\n                return false;\n            }\n        });\n        if ( refreshInfo  ) {\n            //lastLonLatInfo = null;\n            $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id[value=\"'+evt.layerId+'.'+evt.featureId+'\"]').parent().remove();\n            WMSGetFeatureInfo.request( lastPx, {} );\n        }\n        return;\n     }\n     lizMap.events.on({\n        \"layerFilterParamChanged\": function( evt ) {\n            // Continue only if there is a popup displayed\n            // This would avoid useless GETFILTERTOKEN requests\n            let nbPopupDisplayed = document.querySelectorAll('input.lizmap-popup-layer-feature-id').length;\n            if (nbPopupDisplayed == 0) {\n              return;\n            }\n\n            for ( var  lName in config.layers ) {\n                var lConfig = config.layers[lName];\n\n                // Do not request if the layer has no popup\n                if ( lConfig.popup != 'True' )\n                    continue;\n\n                // Do not request if the layer has no request parameters\n                if ( !('request_params' in lConfig)\n                  || lConfig['request_params'] == null )\n                    continue;\n\n                // Do not get the filter token if the popup is not displayed\n                nbPopupDisplayed = document.querySelectorAll(\n                  `input.lizmap-popup-layer-feature-id[value^=${lConfig.id}]`\n                ).length;\n                if (nbPopupDisplayed == 0) {\n                  continue;\n                }\n\n                // Get the filter token only if there is a request_params filter\n                var requestParams = lConfig['request_params'];\n                if ( ('filter' in lConfig['request_params'])\n                  && lConfig['request_params']['filter'] != null\n                  && lConfig['request_params']['filter'] != \"\" ) {\n\n                    // Get filter token\n                    var surl = OpenLayers.Util.urlAppend(lizUrls.wms\n                        ,OpenLayers.Util.getParameterString(lizUrls.params)\n                    );\n                    var sdata = {\n                        service: 'WMS',\n                        request: 'GETFILTERTOKEN',\n                        typename: lName,\n                        filter: lConfig['request_params']['filter']\n                    };\n                    $.post(lizUrls.service, sdata, function(){\n                        refreshGetFeatureInfo(evt);\n                    });\n                }else{\n                      WMSGetFeatureInfo.vendorParams['filtertoken'] = requestParams['filtertoken'];\n                      WMSGetFeatureInfo.vendorParams['filter'] = requestParams['filter'];\n                }\n            }\n        },\n        \"layerSelectionChanged\": function( evt ) {\n            refreshGetFeatureInfo(evt);\n        },\n        \"lizmapeditionfeaturedeleted\": function( evt ) {\n            if ( $('div.lizmapPopupContent input.lizmap-popup-layer-feature-id').length > 1 ) {\n                refreshGetFeatureInfo(evt);\n            } else {\n                if (map.popups.length != 0)\n                    map.removePopup(map.popups[0]);\n\n                if( 'popupLocation' in config.options && config.options.popupLocation != 'map' ){\n                    var pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.no.result']+'</h4></div>';\n                    $('#popupcontent div.menu-content').html(pcontent);\n                    if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') )\n                        $('#button-popupcontent').click();\n                    if ( !$('#mapmenu .nav-list > li.popupcontent').hasClass('active') )\n                        $('#mapmenu .nav-list > li.popupcontent').hide();\n                }\n            }\n        }\n     });\n     map.addControl(WMSGetFeatureInfo);\n     WMSGetFeatureInfo.activate();\n     return WMSGetFeatureInfo;\n  }\n\n  function getPrintScale( aScales ) {\n      var newScales = [];\n      for ( var i=0, len = aScales.length; i<len; i++ ) {\n          newScales.push( parseFloat(aScales[i]) );\n      }\n      newScales.sort(function(a,b){return b-a;});\n    var scale = map.getScale();\n  var scaleIdx = $.inArray( scale, newScales );\n    if ( scaleIdx == -1 ) {\n    var s=0, slen=newScales.length;\n    while ( scaleIdx == -1 && s<slen ) {\n      if ( scale > newScales[s] )\n        scaleIdx = s;\n      else\n       s++;\n    }\n    if( s == slen ) {\n      scale = newScales[slen-1];\n    } else {\n      scale = newScales[scaleIdx];\n    }\n    }\n    return scale;\n  }\n\n  function drawPrintBox( aLayout, aLayer, aScale ) {\n    var size = aLayout.size;\n    var units = map.getUnits();\n    var unitsRatio = OpenLayers.INCHES_PER_UNIT[units];\n    var w = size.width / 72 / unitsRatio * aScale / 2;\n    var h = size.height / 72 / unitsRatio * aScale / 2;\n    var printInProjectProjection = true;\n    if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n      printInProjectProjection = false;\n    }\n    if (printInProjectProjection\n      && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n    ) {\n      // If we change the projection, we need to increase a little bit the size of the rectangle\n      var qgis_dpi = 96;\n      w = w * qgis_dpi / 72;\n      h = h * qgis_dpi / 72;\n    }\n    if ( aLayer.features.length == 0 ) {\n        var center = map.getCenter();\n        var bounds = new OpenLayers.Bounds(center.lon - w, center.lat - h,\n            center.lon + w, center.lat + h);\n        var geom = bounds.toGeometry();\n        aLayer.addFeatures([\n            new OpenLayers.Feature.Vector( geom )\n        ]);\n    } else {\n        var feat = aLayer.features[0];\n        var center = feat.geometry.getBounds().getCenterLonLat();\n        var bounds = new OpenLayers.Bounds(center.lon - w, center.lat - h,\n            center.lon + w, center.lat + h);\n        var geom = bounds.toGeometry();\n        geom.id = feat.geometry.id;\n        feat.geometry = geom;\n        aLayer.drawFeature(feat);\n    }\n    return true;\n  }\n\n  function getPrintGridInterval( aLayout, aScale, aScales ) {\n    var size = aLayout.size;\n    var units = map.getUnits();\n    var unitsRatio = OpenLayers.INCHES_PER_UNIT[units];\n    var w = size.width / 72 / unitsRatio * aScale;\n    var h = size.height / 72 / unitsRatio * aScale;\n    var printInProjectProjection = true;\n    if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n      printInProjectProjection = false;\n    }\n    if (printInProjectProjection\n      && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n    ) {\n      // If we change the projection, we need to increase a little bit the size of the rectangle\n      var qgis_dpi = 96;\n      w = w * qgis_dpi / 72;\n      h = h * qgis_dpi / 72;\n    }\n\n      var refScale = w > h ? w : h;\n      var newScales = [];\n      for ( var i=0, len = aScales.length; i<len; i++ ) {\n          newScales.push( parseFloat(aScales[i]) );\n      }\n      newScales.sort(function(a,b){return b-a;});\n      var theScale = newScales[0];\n      for ( var i=0, len=newScales.length; i<len; i++ ) {\n          var s = newScales[i];\n          if ( s > refScale )\n            theScale = s;\n          if ( s < refScale )\n            break;\n      }\n      return theScale/10;\n  }\n  function addPrintControl() {\n    if ( !config['printTemplates'] || config.printTemplates.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    // Filtering print templates by removing atlas ones\n    var pTemplates = [];\n    for( var i=0, len=config.printTemplates.length; i<len; i++ ){\n        var pTemplate = config.printTemplates[i];\n        if('atlas' in pTemplate\n          && 'enabled' in pTemplate.atlas\n          && (pTemplate.atlas.enabled === '1' || pTemplate.atlas.enabled === 'true'))\n            continue;\n        pTemplates.push(pTemplate);\n    }\n    // remove print tool if only atlas print configured\n    if ( pTemplates.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    var ptTomm = 0.35277; //conversion pt to mm\n\n    var scales = map.scales;\n    if ( config.options.mapScales.length > 2 )\n      scales = config.options.mapScales;\n    if ( scales == null && map.resolutions != null ) {\n      scales = [];\n      for( var i=0, len=map.resolutions.length; i<len; i++ ){\n        var units = map.getUnits();\n        var res = map.resolutions[i];\n        var scale = OpenLayers.Util.getScaleFromResolution(res, units);\n        scales.push(scale);\n      }\n    }\n    if ( scales == null ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n    if ( scales[0] < scales[scales.length-1] )\n      scales.reverse();\n\n    var scaleOptions = '';\n    for( var i=0, len=scales.length; i<len; i++ ){\n        var scale = scales[i];\n        printCapabilities.scales.push(scale);\n        var scaleText = scale;\n        if (scaleText > 10)\n            scaleText = Math.round(scaleText)\n        else\n            scaleText = Math.round(scaleText*100)/100\n        scaleText = scaleText.toLocaleString()\n        scaleOptions += '<option value=\"'+scale+'\">'+scaleText+'</option>';\n    }\n    $('#print-scale').html(scaleOptions);\n\n    // creating printCapabilities layouts\n    for( var i=0, len=pTemplates.length; i<len; i++ ){\n      var pTemplate = pTemplates[i];\n      var pMap = null;\n      var pMapIdx = 0;\n      var pOverview = null;\n      while( pMap == null && pMapIdx < pTemplate.maps.length) {\n        pMap = pTemplate.maps[pMapIdx];\n        if( pMap['overviewMap'] ) {\n          pOverview = pTemplate.maps[pMapIdx];\n          pMap = null;\n          pMapIdx += 1;\n        }\n      }\n      if ( pMap == null )\n        continue;\n      var mapWidth = Number(pMap.width) / ptTomm;\n      var mapHeight = Number(pMap.height) / ptTomm;\n      //for some strange reason we need to provide a \"map\" and a \"size\" object with identical content\n      printCapabilities.layouts.push({\n        \"name\": pTemplate.title,\n        \"map\": {\n          \"width\": mapWidth,\n          \"height\": mapHeight\n        },\n        \"size\": {\n          \"width\": mapWidth,\n          \"height\": mapHeight\n        },\n        \"rotation\": false,\n        \"template\": pTemplate,\n        \"mapId\": pMap.id,\n        \"overviewId\": pOverview != null ? pOverview.id : null,\n        \"grid\": (('grid' in pMap) && pMap.grid == \"True\")\n      });\n    }\n\n    // if no printCapabilities layouts removed print\n    if( printCapabilities.layouts.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    // creating the print layer\n    var layer = map.getLayersByName('Print');\n    if ( layer.length == 0 ) {\n      layer = new OpenLayers.Layer.Vector('Print',{\n        styleMap: new OpenLayers.StyleMap({\n          \"default\": new OpenLayers.Style({\n            fillColor: \"#D43B19\",\n            fillOpacity: 0.2,\n            strokeColor: \"#CE1F2D\",\n            strokeWidth: 1\n          })\n        })\n      });\n      map.addLayer(layer);\n      layer.setVisibility(false);\n    } else\n      layer = layer[0];\n\n    // creating print menu\n    for( var i=0, len= printCapabilities.layouts.length; i<len; i++ ){\n      var layout = printCapabilities.layouts[i];\n      $('#print-template').append('<option value=\"'+i+'\">'+layout.name+'</option>');\n    }\n\n    var dragCtrl = new OpenLayers.Control.DragFeature(layer,{\n      geometryTypes: ['OpenLayers.Geometry.Polygon'],\n      type:OpenLayers.Control.TYPE_TOOL,\n      layout: null,\n      eventListeners: {\n        \"activate\": function(evt) {\n          if (this.layout == null)\n            return false;\n\n          deactivateToolControls(evt);\n\n          var layout = this.layout;\n          // get print scale\n          var scale = getPrintScale( printCapabilities.scales );\n          // update the select\n          $('#print-scale').val(scale);\n          // draw print box\n          drawPrintBox( layout, layer, scale );\n\n          mAddMessage(lizDict['print.activate'],'info',true).addClass('print');\n          layer.setVisibility(true);\n        },\n        \"deactivate\": function() {\n          layer.setVisibility(false);\n          $('#message .print').remove();\n          this.layout = null;\n          layer.destroyFeatures();\n        }\n      }\n    });\n    map.addControls([dragCtrl]);\n    controls['printDrag'] = dragCtrl;\n\n    // set event listener to button-print\n    $('#print-template').change(function() {\n      var self = $(this);\n      var layout = printCapabilities.layouts[parseInt( self.val() )];\n      if ( layout.template.labels.length != 0 ) {\n        var labels = '';\n        for (var i=0, len=layout.template.labels.length; i<len; i++){\n          var tLabel = layout.template.labels[i];\n          var label = '';\n          if (tLabel.htmlState == 0) {\n            label = '<input type=\"text\" name=\"'+tLabel.id+'\" class=\"print-label\" placeholder=\"'+tLabel.text+'\" value=\"'+tLabel.text+'\"><br>'\n          } else {\n            label = '<textarea name=\"'+tLabel.id+'\" class=\"print-label\" placeholder=\"'+tLabel.text+'\">'+tLabel.text+'</textarea><br>'\n          }\n          labels += label;\n        }\n        $('#print .print-labels').html(labels);\n        $('#print .print-labels').show();\n      } else {\n        $('#print .print-labels').html('');\n        $('#print .print-labels').hide();\n      }\n      updateMiniDockSize();\n      if (dragCtrl.active) {\n        dragCtrl.deactivate();\n        dragCtrl.layout = layout;\n        dragCtrl.activate();\n      } else {\n        dragCtrl.layout = layout;\n        dragCtrl.activate();\n      }\n      return false;\n    });\n\n    $('#print button.btn-print-clear').click(function() {\n      $('#button-print').click();\n      return false;\n    });\n    $('#print-scale').change(function() {\n      if ( dragCtrl.active && layer.getVisibility() ) {\n        var self = $(this);\n        var scale = parseFloat(self.val());\n        // draw print box\n        drawPrintBox( dragCtrl.layout, layer, scale );\n      }\n    });\n    $('#print-launch').click(function() {\n      var pTemplate = dragCtrl.layout.template;\n      var pTableVectorLayers = [];\n      if( 'tables' in pTemplate )\n          pTableVectorLayers = $.map( pTemplate.tables, function( t ){\n              if( t.composerMap == -1 || ('map'+t.composerMap) == dragCtrl.layout.mapId )\n                return t.vectorLayer;\n          });\n      // Print Extent\n      // Clone it to fix transform\n      var extent = new OpenLayers.Bounds(\n          dragCtrl.layer.features[0].geometry.getBounds().toArray()\n      );\n\n      // Projection code and reverseAxisOrder\n      var projCode = map.projection.getCode();\n      var project_projection = null;\n      // We print the map in the QGIS project projection, not in the web map projection\n      // This allow to avoid error of wrong scales when using external baselayers in EPSG:3857\n      // and the project in for example in Lambert 93\n      // Caveat: the map printed does not exactly matches the drawn rectangle\n      var printInProjectProjection = true;\n      if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n        printInProjectProjection = false;\n      }\n      if (printInProjectProjection\n        && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n      ) {\n        // If we print in the QGIS project projection\n        var project_proj = config.options.qgisProjectProjection;\n        if (!(project_proj.ref in Proj4js.defs)) {\n          Proj4js.defs[project_proj.ref]=project_proj.proj4;\n        }\n        project_projection = new OpenLayers.Projection(project_proj.ref);\n        projCode = project_projection.getCode();\n\n        // Reproject extent\n        extent.transform(map.projection, project_projection);\n      }\n\n      var reverseAxisOrder = (OpenLayers.Projection.defaults[projCode] && OpenLayers.Projection.defaults[projCode].yx);\n\n      // Build URL\n      var url = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n          );\n      let printParams = {};\n      printParams['SERVICE'] = 'WMS';\n      printParams['VERSION'] = '1.3.0';\n      printParams['REQUEST'] = 'GetPrint';\n      printParams['FORMAT'] = document.querySelector('#print-format').value;\n      printParams['EXCEPTIONS'] = 'application/vnd.ogc.se_inimage';\n      printParams['TRANSPARENT'] = 'true';\n      printParams['SRS'] = projCode;\n      printParams['DPI'] = document.querySelector('#print-dpi').value;\n      printParams['TEMPLATE'] = pTemplate.title;\n      printParams[dragCtrl.layout.mapId + ':extent'] = extent.toBBOX(null, reverseAxisOrder);\n      printParams[dragCtrl.layout.mapId + ':scale'] = document.querySelector('#print-scale').value;\n\n      if ( 'grid' in dragCtrl.layout && dragCtrl.layout.grid ) {\n        var gridInterval = getPrintGridInterval( dragCtrl.layout, parseFloat(scale), printCapabilities.scales );\n        printParams[dragCtrl.layout.mapId + ':grid_interval_x='] = gridInterval;\n        printParams[dragCtrl.layout.mapId + ':grid_interval_y='] = gridInterval;\n      }\n\n      var printLayers = [];\n      var styleLayers = [];\n      var opacityLayers = [];\n      $.each(map.layers, function(i, l) {\n        if ( (l instanceof OpenLayers.Layer.WMS) || (l instanceof OpenLayers.Layer.WMTS) ){\n            if( l.getVisibility() && ('params' in l) && ('LAYERS' in l.params)) {\n              // Get config\n              var qgisName = null;\n              if ( l.name in cleanNameMap )\n                  qgisName = getLayerNameByCleanName(l.name);\n              var configLayer = null;\n              if ( qgisName )\n                  configLayer = config.layers[qgisName];\n              if ( !configLayer )\n                  configLayer = config.layers[l.params['LAYERS']];\n              if ( !configLayer )\n                  configLayer = config.layers[l.name];\n\n              // If the layer has no config it is not a QGIS layer\n              if ( !configLayer )\n                return;\n\n              // If the layer has no id it is not a QGIS layer or group\n              if (!('id' in configLayer))\n                return;\n\n              // Add layer to the list of printed layers\n              printLayers.push(l.params['LAYERS']);\n\n              // Optionnaly add layer style if needed (same order as layers )\n              var lst = 'default';\n              if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n                  lst = '';\n              }\n              if( 'STYLES' in l.params && l.params['STYLES'].length > 0 )\n                lst = l.params['STYLES'];\n              styleLayers.push( lst );\n\n              // Get qgis layer opacity\n              if ( configLayer && ('opacity' in configLayer) )\n                opacityLayers.push(parseInt(255*l.opacity*configLayer.opacity));\n              else\n                opacityLayers.push(parseInt(255*l.opacity));\n            }\n        }\n      });\n\n      printLayers.reverse();\n      styleLayers.reverse();\n      opacityLayers.reverse();\n\n      // Get active baselayer, and add the corresponding QGIS layer if needed\n      var activeBaseLayerName = map.baseLayer.name;\n      if ( activeBaseLayerName in externalBaselayersReplacement ) {\n        var exbl = externalBaselayersReplacement[activeBaseLayerName];\n        if( exbl in config.layers ) {\n            var activeBaseLayerConfig = config.layers[exbl];\n            if ( 'id' in activeBaseLayerConfig && 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' ){\n                printLayers.push(activeBaseLayerConfig.id);\n            }\n            else if ( 'shortname' in activeBaseLayerConfig ){\n                printLayers.push(activeBaseLayerConfig.shortname);\n            }\n            else{\n                printLayers.push(exbl);\n            }\n            if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n                styleLayers.push('');\n            } else {\n                styleLayers.push('default');\n            }\n            opacityLayers.push(255);\n        }\n      }\n\n      // Add table vector layer without geom\n      if( pTableVectorLayers.length > 0 ) {\n          $.each( pTableVectorLayers, function( i, layerId ){\n              var aConfig = getLayerConfigById( layerId );\n              if( aConfig ) {\n                  var layerConfig = aConfig[1];\n                  if( ( layerConfig.geometryType == \"none\" || layerConfig.geometryType == \"unknown\" || layerConfig.geometryType == \"\" ) ) {\n                      if ( 'shortname' in layerConfig && layerConfig.shortname != '' )\n                          printLayers.push(layerConfig.shortname);\n                      else\n                          printLayers.push(layerConfig.name);\n                      if ( 'qgisServerVersion' in config.options &&\n                           config.options.qgisServerVersion.startsWith('3.') ) {\n                        styleLayers.push('');\n                      } else {\n                        styleLayers.push('default');\n                      }\n                      opacityLayers.push(255);\n                  }\n              }\n          });\n      }\n\n      if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' ) {\n        printLayers.reverse();\n        styleLayers.reverse();\n        opacityLayers.reverse();\n      }\n\n      printParams[dragCtrl.layout.mapId + ':LAYERS'] = printLayers.join(',');\n      printParams[dragCtrl.layout.mapId + ':STYLES'] = styleLayers.join(',');\n\n      if ( dragCtrl.layout.overviewId != null\n          && config.options.hasOverview ) {\n        var bbox = config.options.bbox;\n        var oExtent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n        if (printInProjectProjection\n          && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n        ) {\n          // If we print in the QGIS project projection\n          oExtent.transform(map.projection, project_projection);\n        }\n        printParams[dragCtrl.layout.overviewId + ':extent'] = oExtent;\n        printParams[dragCtrl.layout.overviewId + ':LAYERS'] = 'Overview';\n\n        if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' ) {\n            printLayers.push('Overview');\n            if ( config.options.qgisServerVersion.startsWith('3.') ) {\n                styleLayers.push('');\n            } else {\n                styleLayers.push('default');\n            }\n            opacityLayers.push(255);\n        } else {\n            printLayers.unshift('Overview');\n            styleLayers.unshift('default');\n            opacityLayers.unshift(255);\n        }\n      }\n      printParams['LAYERS'] = printLayers.join(',');\n      printParams['STYLES'] = styleLayers.join(',');\n      printParams['OPACITIES'] = opacityLayers.join(',');\n\n      const customPrintLabels = document.querySelectorAll('#print .print-labels .print-label');\n      if (customPrintLabels){\n        for (const label of customPrintLabels) {\n          printParams[label.name] = label.value;\n        }\n      }\n\n      var filter = [];\n      var selection = [];\n      for ( var  lName in config.layers ) {\n          var lConfig = config.layers[lName];\n          var requestParams = lConfig['request_params'];\n          if ( !('request_params' in lConfig)\n            || requestParams == null )\n              continue;\n            if ( ('filtertoken' in requestParams)\n            && requestParams['filtertoken'] != null\n            && requestParams['filtertoken'] != \"\" ) {\n              filter.push( requestParams['filtertoken'] );\n          }\n          if ( ('selectiontoken' in requestParams)\n            && requestParams['selectiontoken'] != null\n            && requestParams['selectiontoken'] != \"\" ) {\n              selection.push( requestParams['selectiontoken'] );\n          }\n      }\n      if ( filter.length !=0 ){\n        printParams['FILTERTOKEN'] = filter.join(';');\n      }\n      if ( selection.length !=0 ){\n        printParams['SELECTIONTOKEN'] = selection.join(';');\n      }\n\n      // if user has made a visible draw, print it with redlining\n      const formatWKT = new OpenLayers.Format.WKT();\n      const highlightGeom = [];\n      const highlightSymbol = [];\n      if (lizMap.mainLizmap.digitizing.featureDrawn && lizMap.mainLizmap.digitizing.featureDrawnVisibility){\n        for (let index = 0; index < lizMap.mainLizmap.digitizing.featureDrawn.length; index++) {\n          var draw_feature = lizMap.mainLizmap.digitizing.featureDrawn[index];\n          if (printInProjectProjection\n            && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n          ) {\n            // If we print in the QGIS project projection\n            draw_feature.geometry.transform(map.projection, project_projection);\n          }\n          highlightGeom.push(formatWKT.write(draw_feature));\n          highlightSymbol.push(lizMap.mainLizmap.digitizing.getFeatureDrawnSLD(index));\n\n        }\n      }\n\n      if (highlightGeom.length > 0) {\n        printParams[dragCtrl.layout.mapId+':HIGHLIGHT_GEOM'] = highlightGeom.join(';');\n        printParams[dragCtrl.layout.mapId+':HIGHLIGHT_SYMBOL'] = highlightSymbol.join(';');\n      }\n\n      // Display spinner and message while waiting for print\n      const printLaunch = document.getElementById('print-launch');\n      printLaunch.disabled = true;\n      printLaunch.classList.add('spinner');\n\n      $(\"#message .print a\").click();\n      mAddMessage(lizDict['print.started'], 'info', true).addClass('print-in-progress');\n\n      downloadFile(url, printParams, () => {\n        const printLaunch = document.getElementById('print-launch');\n        printLaunch.disabled = false;\n        printLaunch.classList.remove('spinner');\n\n        $(\"#message .print-in-progress a\").click();\n      });\n\n      return false;\n    });\n    map.events.on({\n      \"zoomend\": function() {\n        if ( dragCtrl.active && layer.getVisibility() ) {\n            // get scale\n            var scale = getPrintScale( printCapabilities.scales );\n            // update the select\n            $('#print-scale').val(scale);\n            // draw print box\n            drawPrintBox( dragCtrl.layout, layer, scale );\n        }\n      }\n    });\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'print' ) {\n                $('#print-template').change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'print' ) {\n                dragCtrl.deactivate();\n            }\n        }\n    });\n  }\n\n  function addTooltipControl() {\n    if ( !config['tooltipLayers'] || config.tooltipLayers.length == 0 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n\n    // Verifying WFS layers\n    var featureTypes = getVectorLayerFeatureTypes();\n    if (featureTypes.length == 0 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n    var tooltipLayersDic = {};\n    for (var lname in config.tooltipLayers) {\n        tooltipLayersDic[lizMap.cleanName(lname)] = lname;\n    }\n\n    var tooltipLayersSorted = [];\n\n    for (const featureType of featureTypes) {\n      var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n      var lname = lizMap.getNameByTypeName( typeName );\n        if ( !lname ) {\n            if (typeName in config.locateByLayer)\n                lname = typeName\n            else if ( (typeName in shortNameMap) && (shortNameMap[typeName] in config.locateByLayer))\n                lname = shortNameMap[typeName];\n            else {\n                for (var ttl in config.tooltipLayers) {\n                    if (ttl.split(' ').join('_') == typeName) {\n                        lname = ttl;\n                        break;\n                    }\n                }\n            }\n        }\n\n        if ( !(lname in config.tooltipLayers) )\n            continue;\n\n        if ( (lname in config.tooltipLayers) && (lname in config.layers) ) {\n            var lConfig = config.layers[lname];\n            tooltipLayersSorted[config.tooltipLayers[lname].order] = '<option value=\"'+lname+'\">'+lConfig.title+'</option>';\n        }\n    }\n\n    // Display layers order as declared in plugin\n    for (var i = 0; i < tooltipLayersSorted.length; i++) {\n      $('#tooltip-layer-list').append(tooltipLayersSorted[i]);\n    }\n\n    if ( $('#tooltip-layer-list').find('option').length == 1 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n\n    // Define vector layer for tooltip\n    var tooltipStyleMap = new OpenLayers.StyleMap({\n        'default': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: \"blue\",\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        }),\n        'selected': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: \"yellow\",\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        }),\n        'temporary': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: 'red',\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        })\n    });\n    var tlayer = new OpenLayers.Layer.Vector('tooltipLayer', {\n        styleMap: tooltipStyleMap\n    });\n    lizMap.map.addLayer(tlayer);\n    tlayer.setVisibility(true);\n\n    var tooltipControl = new OpenLayers.Control.HighlightFeature([tlayer],{\n        displayPopup: true,\n        popupOffset: {\n            'left': 45,\n            'right': 0,\n            'top': 5\n        },\n        popupTitle: \"State information\",\n        popupSize: new OpenLayers.Size(200,375),\n        style:{\n            pointRadius: 6,\n            strokeColor: \"cyan\",\n            strokeWidth: 3,\n            strokeOpacity: 1,\n            fillOpacity: 0.2,\n            fillColor: \"transparent\"\n        }\n    });\n    tooltipControl.addInfoPopup = function(feature) {\n        var lname = $('#tooltip-layer-list').val();//feature.layer.name.split(\"@\")[1];\n        var lconfig = lizMap.config.layers[lname];\n        if( !(lname in lizMap.config.layers) )\n          return;\n        var tconfig = lizMap.config.tooltipLayers[lname];\n        var tf = tconfig['fields'].trim();\n        var tooltipFields = tf.split(/[\\s,]+/);\n        var hiddenFields = [];\n        if ( 'attributeLayers' in lizMap.config\n            && lname in lizMap.config.attributeLayers\n            && 'hiddenFields' in lizMap.config.attributeLayers[lname]) {\n            var hf = lizMap.config.attributeLayers[lname]['hiddenFields'].trim();\n            hiddenFields = hf.split(/[\\s,]+/);\n        }\n        var cAliases = lconfig['alias'];\n        var html = '<div id=\"tooltipPopupContent\">';\n        html+= '<table class=\"lizmapPopupTable\">';\n        for (var a in feature.attributes){\n            // Do no show hiddenfields\n            if( ($.inArray(a, hiddenFields) > -1) )\n                continue;\n            // show only tootlip fields if some fields given\n            if( tf != '' && !($.inArray(a, tooltipFields) > -1) )\n                continue;\n            html+= '<tr><th>' + cAliases[a] + '</th><td>' + feature.attributes[a] + '</td></tr>';\n        }\n        html+= '</table>';\n        html+= '</div>';\n\n        var oMapExtent = this.layer.map.getExtent();\n        var nReso = this.layer.map.getResolution();\n\n        var oPopupPos = new OpenLayers.LonLat(oMapExtent.left,oMapExtent.top);\n        oPopupPos.lon += ( $('#dock').width() + this.popupOffset.left ) * nReso;\n        var tpopup = new OpenLayers.Popup.Anchored('tooltipPopup',\n            oPopupPos,\n            null,//new OpenLayers.Size(250,300),\n            html,\n            {size: {w: 14, h: 14}, offset: {x: -7, y: -7}},\n            false\n        );\n        tpopup.autoSize = true;\n        tpopup.backgroundColor = 'transparent';\n\n        feature.popup = tpopup;\n        lizMap.map.addPopup( tpopup );\n    };\n\n    lizMap.map.addControl(tooltipControl);\n    controls['tooltip-layer'] = tooltipControl;\n\n    $('#tooltip-layer button.btn-tooltip-layer-clear').click(function() {\n        $('#button-tooltip-layer').click();\n        return false;\n    });\n    $('#tooltip-cancel').click(function() {\n      $('#tooltip-layer-list').val('').change();\n      return false;\n    });\n    $('#tooltip-layer-list').change( function() {\n        var aName = $(this).val();\n        tooltipControl.deactivate();\n        tlayer.destroyFeatures();\n        if ( aName == '' )\n            return;\n        $('#tooltip-layer-list').addClass('loading').attr('disabled','');\n\n        // Get selected features\n        var selectionLayer = getLayerNameByCleanName( aName );\n\n        if( !selectionLayer )\n            selectionLayer = aName;\n        var featureid = getVectorLayerSelectionFeatureIdsString( selectionLayer );\n\n        getFeatureData( aName, null, featureid, null, false, null, null,\n            function(fName, fFilter, fFeatures, fAliases ){\n              // get layer name for config\n              if ( !(fName in config.layers) ) {\n                  var qgisName = lizMap.getNameByCleanName(aName);\n                  if ( qgisName && (qgisName in config.layers)) {\n                      fName = qgisName;\n                  } else {\n                      console.log('getFeatureData: \"'+fName+'\" and \"'+qgisName+'\" not found in config');\n                      return false;\n                  }\n              }\n\n              var lConfig = config.layers[fName];\n              var tconfig = config.tooltipLayers[fName];\n\n              var gFormat = new OpenLayers.Format.GeoJSON({\n                  ignoreExtraDims: true,\n                  externalProjection: lConfig['featureCrs'],\n                  internalProjection: lizMap.map.getProjection()\n              });\n              var tfeatures = gFormat.read( {\n                  type: 'FeatureCollection',\n                  features: fFeatures\n              } );\n              tlayer.addFeatures( tfeatures );\n\n              if ( ('displayGeom' in tconfig) && tconfig.displayGeom == 'True' )\n                  if ( ('colorGeom' in tconfig) && tconfig.colorGeom != '' )\n                      tooltipControl.style.strokeColor = tconfig.colorGeom;\n                  else\n                      tooltipControl.style.strokeColor = 'cyan';\n              else\n                  tooltipControl.style.strokeColor = 'transparent';\n              if (tfeatures.length != 0 && tfeatures[0].geometry && tfeatures[0].geometry.id.startsWith('OpenLayers_Geometry_LineString') )\n                  tooltipControl.style.strokeWidth = 10;\n              else\n                  tooltipControl.style.strokeWidth = 3;\n              tooltipControl.activate();\n              $('#tooltip-layer-list').removeClass('loading').removeAttr('disabled');\n\n        });\n    });\n    $('#tooltip-layer-list').removeClass('loading').removeAttr('disabled');\n\n    lizMap.events.on({\n        minidockopened: function(e) {\n            // Load layer automatically when there is only one\n            if (e.id == 'tooltip-layer' && $(\"#tooltip-layer-list option\").length === 2) {\n              $('#tooltip-layer-list').val($(\"#tooltip-layer-list option:nth-child(2)\").val()).change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'tooltip-layer' ) {\n              // deactivate tooltip on close\n              $('#tooltip-layer-list').val('').change();\n              return false;\n            }\n        }\n    });\n\n  }\n\n  function getLayerConfigById( aLayerId, aConfObjet, aIdAttribute ) {\n    // Set function parameters if not given\n    aConfObjet = typeof aConfObjet !== 'undefined' ?  aConfObjet : config.layers;\n    aIdAttribute = typeof aIdAttribute !== 'undefined' ?  aIdAttribute : 'id';\n\n    // Loop through layers to get the one by id\n    for ( var lx in aConfObjet ) {\n        if ( aConfObjet[lx][aIdAttribute] == aLayerId )\n            return [lx, aConfObjet[lx] ];\n    }\n    return null;\n  }\n\n\n  function addMeasureControls() {\n    // style the sketch fancy\n    var sketchSymbolizers = {\n      \"Point\": {\n        pointRadius: 4,\n        graphicName: \"square\",\n        fillColor: \"white\",\n        fillOpacity: 1,\n        strokeWidth: 1,\n        strokeOpacity: 1,\n        strokeColor: \"#333333\"\n      },\n      \"Line\": {\n        strokeWidth: 3,\n        strokeOpacity: 1,\n        strokeColor: \"#666666\",\n        strokeDashstyle: \"dash\"\n      },\n      \"Polygon\": {\n        strokeWidth: 2,\n        strokeOpacity: 1,\n        strokeColor: \"#666666\",\n        strokeDashstyle: \"dash\",\n        fillColor: \"white\",\n        fillOpacity: 0.3\n      }\n    };\n    var style = new OpenLayers.Style();\n    style.addRules([\n        new OpenLayers.Rule({symbolizer: sketchSymbolizers})\n        ]);\n    var styleMap = new OpenLayers.StyleMap({\"default\": style});\n\n    var measureControls = {\n      length: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Path, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      area: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Polygon, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      perimeter: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Polygon, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      angle: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Path, {\n        id: 'angleMeasure',\n        persist: true,\n        geodesic: true,\n        immediate: true,\n        handlerOptions: {\n          maxVertices: 3,\n          layerOptions: {\n            styleMap: styleMap\n          }\n        },\n        type: OpenLayers.Control.TYPE_TOOL\n        }\n      )\n    };\n    measureControls.length.events.on({\n      activate: function() {\n        mAddMessage(lizDict['measure.activate.length'],'info',true).attr('id','lizmap-measure-message');\n      },\n      deactivate: function() {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.area.events.on({\n      activate: function() {\n        mAddMessage(lizDict['measure.activate.area'],'info',true).attr('id','lizmap-measure-message');\n      },\n      deactivate: function() {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.perimeter.events.on({\n      activate: function () {\n        mAddMessage(lizDict['measure.activate.perimeter'], 'info', true).attr('id', 'lizmap-measure-message');\n      },\n      deactivate: function () {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.angle.events.on({\n      activate: function () {\n        mAddMessage(lizDict['measure.activate.angle'], 'info', true).attr('id', 'lizmap-measure-message');\n      },\n      deactivate: function () {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n\n    measureControls.perimeter.measure = function(geometry, eventType) {\n        var stat, order;\n        if( OpenLayers.Util.indexOf( geometry.CLASS_NAME, 'LineString' ) > -1) {\n            stat = this.getBestLength(geometry);\n            order = 1;\n        } else {\n            stat = this.getBestLength(geometry.components[0]);\n            order = 1;\n        }\n        this.events.triggerEvent(eventType, {\n            measure: stat[0],\n            units: stat[1],\n            order: order,\n            geometry: geometry\n        });\n    };\n\n    function handleMeasurements(evt) {\n      var units = evt.units;\n      var order = evt.order;\n      var measure = evt.measure;\n      var out = \"\";\n\n      // Angle\n      if (evt.object.id === \"angleMeasure\") {\n\n        out = lizDict['measure.handle'] + \" 0°\";\n\n        // Three points are needed to measure an angle\n        if (evt.geometry.components.length === 3){\n          // Invert first and second points and use a flag to make this change occurs once until next measurement\n          if(evt.object.invert === undefined){\n            const firstComponent = evt.geometry.components[0].clone();\n            const secondComponent = evt.geometry.components[1].clone();\n            evt.geometry.components[0].move(secondComponent.x - firstComponent.x, secondComponent.y - firstComponent.y);\n            evt.geometry.components[1].move(firstComponent.x - secondComponent.x, firstComponent.y - secondComponent.y);\n\n            evt.object.invert = true;\n          } else if (evt.type === \"measure\"){\n            evt.object.invert = undefined;\n          }\n\n          // Display angle ABC between three points. B is center\n          const A = evt.geometry.components[0];\n          const B = evt.geometry.components[1];\n          const C = evt.geometry.components[2];\n\n          const AB = Math.sqrt(Math.pow(B.x - A.x, 2) + Math.pow(B.y - A.y, 2));\n          const BC = Math.sqrt(Math.pow(B.x - C.x, 2) + Math.pow(B.y - C.y, 2));\n          const AC = Math.sqrt(Math.pow(C.x - A.x, 2) + Math.pow(C.y - A.y, 2));\n          let angleInDegrees = (Math.acos((BC * BC + AB * AB - AC * AC) / (2 * BC * AB)) * 180) / Math.PI;\n\n          if (isNaN(angleInDegrees)) {\n            angleInDegrees = 0;\n          }\n\n          out = lizDict['measure.handle'] + \" \" + angleInDegrees.toFixed(2) + \"°\";\n        }\n        // Other measurement tools\n      }else{\n        if (order == 1) {\n          out += lizDict['measure.handle'] + \" \" + measure.toFixed(3) + \" \" + units;\n        } else {\n          out += lizDict['measure.handle'] + \" \" + measure.toFixed(3) + \" \" + units + \"<sup>2</\" + \"sup>\";\n        }\n      }\n\n      var element = $('#lizmap-measure-message');\n      if ( element.length == 0 ) {\n        element = mAddMessage(out);\n        element.attr('id','lizmap-measure-message');\n      } else {\n        element.html('<p>'+out+'</p>');\n      }\n    }\n\n    for(var key in measureControls) {\n      var control = measureControls[key];\n      control.events.on({\n        \"measure\": handleMeasurements,\n        \"measurepartial\": handleMeasurements\n      });\n      map.addControl(control);\n      controls[key+'Measure'] = control;\n    }\n    $('#measure-type').change(function() {\n        var self = $(this);\n        self.find('option').each(function() {\n            var val = $( this ).attr('value');\n            if ( val in measureControls && measureControls[val].active )\n              measureControls[val].deactivate();\n        });\n        measureControls[self.val()].activate();\n    });\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'measure' ) {\n                $('#measure-type').change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'measure' ) {\n                var activeCtrl = '';\n                $('#measure-type option').each(function() {\n                    var val = $( this ).attr('value');\n                    if ( val in measureControls && measureControls[val].active )\n                        activeCtrl = val;\n                });\n                if ( activeCtrl != '' )\n                    measureControls[activeCtrl].deactivate();\n            }\n        }\n    });\n\n    $('#measure-stop').click(function(){\n      $('#button-measure').click();\n    });\n\n    return measureControls;\n  }\n\n  /**\n   * PRIVATE function: loadProjDefinition\n   * load CRS definition and activate it\n   *\n   * Parameters:\n   * aCRS - {String}\n   * aCallbalck - {function ( proj )}\n   *\n   */\n  function loadProjDefinition( aCRS, aCallback ) {\n    var proj = aCRS.replace(/^\\s+|\\s+$/g, ''); // trim();\n    if ( proj in Proj4js.defs ) {\n      aCallback( proj );\n    } else {\n      $.get( OpenLayers.Util.urlAppend(\n          lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        ), {\n          'REQUEST':'GetProj4'\n         ,'authid': proj\n        }, function ( aText ) {\n          Proj4js.defs[proj] = aText;\n          new OpenLayers.Projection(proj);\n          aCallback( proj );\n        }\n      );\n    }\n  }\n\n  /**\n   * PRIVATE function: mCheckMobile\n   * Check wether in mobile context.\n   *\n   *\n   * Returns:\n   * {Boolean} True if in mobile context.\n   */\n  function mCheckMobile() {\n    var minMapSize = 450;\n    var w = $('body').parent()[0].offsetWidth;\n    var leftW = w - minMapSize;\n    if(leftW < minMapSize || w < minMapSize)\n      return true;\n    return false;\n  }\n\n  /**\n   * PRIVATE function: mAddMessage\n   * Write message to the UI\n   *\n   *\n   * Returns:\n   * {jQuery Object} The message added.\n   */\n  function mAddMessage( aMessage, aType, aClose ) {\n    var mType = 'info';\n    var mTypeList = ['info', 'error', 'success'];\n    var mClose = false;\n\n    if ( $.inArray(aType, mTypeList) != -1 )\n      mType = aType;\n\n    if ( aClose )\n      mClose = true;\n\n    var html = '<div class=\"alert alert-block alert-'+mType+' fade in\" data-alert=\"alert\">';\n    if ( mClose )\n      html += '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">×</a>';\n    html += '<p>'+aMessage+'</p>';\n    html += '</div>';\n\n    var elt = $(html);\n    $('#message').append(elt);\n    return elt;\n  }\n\n  /**\n   * PRIVATE function: downloadFile\n   * Send an ajax POST request to download a file\n   *\n   * @param {String} url\n   * @param {Array} parameters\n   * @param {Function} callback optionnal callback executed when download ends\n   *\n   */\n   function downloadFile( url, parameters, callback ) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('POST', url, true);\n      xhr.responseType = 'arraybuffer';\n      xhr.onload = function () {\n          if (this.status === 200) {\n              var filename = \"\";\n              var disposition = xhr.getResponseHeader('Content-Disposition');\n              if (disposition && disposition.indexOf('attachment') !== -1) {\n                  var filenameRegex = /filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/;\n                  var matches = filenameRegex.exec(disposition);\n                  if (matches != null && matches[1]) filename = matches[1].replace(/['\"]/g, '');\n              }\n\n              let type = xhr.getResponseHeader('Content-Type');\n\n              // Firefox >= 98 opens blob in its pdf viewer\n              // This is a hack to force download as in Chrome\n              if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1 && type == 'application/pdf'){\n                type = 'application/octet-stream';\n              }\n              const blob = new File([this.response], filename, { type: type });\n              const downloadUrl = URL.createObjectURL(blob);\n\n              if (filename) {\n                // use HTML5 a[download] attribute to specify filename\n                const a = document.createElement('a');\n                a.href = downloadUrl;\n                a.download = filename;\n                a.dispatchEvent(new MouseEvent('click'));\n              } else {\n                window.open(downloadUrl);\n              }\n\n              setTimeout(() => URL.revokeObjectURL(downloadUrl), 100); // cleanup\n          }\n\n          // Note 31/01/2022\n          // REMOVE WHEN THE QGIS SERVER BUG HAS BEEN FIXED\n          // Related PR for QGIS Master https://github.com/qgis/QGIS/pull/47051\n          // It should be fixed for 3.24.1 and 3.22.5\n          if (this.status == 400) {\n            // Check for parenthesis inside the layer name\n            // There is a bug to be fixed in QGIS Server WFS request for this context\n            var typeName = parameters['TYPENAME'];\n            const parenthesis_regex = /[\\(\\)]/g;\n            const has_parenthesis = typeName.match(parenthesis_regex);\n            if (has_parenthesis) {\n              var error_message = 'The selected features cannot be exported due to a known bug in QGIS Server.';\n              error_message += '<br/>Please ask the map editor to remove the parenthesis in the layer name.';\n            } else {\n              var error_message = lizDict['layer.export.unknown.export.error'];\n            };\n\n            mAddMessage(error_message, 'error', true);\n            return false;\n          }\n          // Execute callback if any\n          if (typeof callback === 'function'){\n            callback();\n          }\n      };\n      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n      xhr.send($.param(parameters, true));\n   }\n\n  /**\n   * PRIVATE function: exportVectorLayer\n   *\n   */\n  function exportVectorLayer( aName, eformat, restrictToMapExtent ) {\n\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : null;\n\n      // right not set\n      if ( !('exportLayers' in lizMap.config.options) || lizMap.config.options.exportLayers != 'True' ) {\n        mAddMessage(lizDict['layer.export.right.required'],'error',true);\n        return false;\n      }\n\n      // Set function parameters if not given\n      eformat = typeof eformat !== 'undefined' ?  eformat : 'GeoJSON';\n\n      // Get selected features\n      var cleanName = lizMap.cleanName( aName );\n      var selectionLayer = getLayerNameByCleanName( cleanName );\n\n      if (!selectionLayer) {\n        selectionLayer = aName;\n      }\n\n      // Get the layer Lizmap configuration\n      var config_layer = lizMap.config.layers[selectionLayer];\n\n      // Check if the layer is spatial\n      const is_spatial = (\n        config_layer['geometryType'] && config_layer['geometryType'] != 'none' && config_layer != 'unknown'\n      ) ? true : false;\n\n      // Check if there is a selection token\n      const has_selection_token = (\n        'request_params' in config_layer && 'selectiontoken' in config_layer['request_params']\n        && config_layer['request_params']['selectiontoken'] != null\n        && config_layer['request_params']['selectiontoken'] != ''\n      ) ? true : false;\n\n      // Check for parenthesis inside the layer name\n      // There is a bug to be fixed in QGIS Server WFS request for this context\n      const parenthesis_regex = /[\\(\\)]/g;\n      const has_parenthesis = selectionLayer.match(parenthesis_regex);\n\n      // If there is a selection, use the selectiontoken,\n      // not a list of features ids to avoid to have too big urls\n      // There is some cases when we do not want to use the selection token\n      // * Layers with no selection token\n      // * Layers with parenthesis inside the layer name (Bug to be fixed in QGIS Server WFS request)\n      // * Layers with no geometry, because there is no request_params (as it is only for Openlayers layers)\n      if (is_spatial && has_selection_token && !has_parenthesis) {\n        // Get the WFS URL with no filter\n        var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, null, restrictToMapExtent );\n        // Add the SELECTIONTOKEN parameter\n        var selection_token = config_layer['request_params']['selectiontoken'];\n        getFeatureUrlData['options']['SELECTIONTOKEN'] = selection_token;\n      } else {\n        // Get the WFS feature ids\n        var featureid = getVectorLayerSelectionFeatureIdsString( selectionLayer );\n        // Restrict the WFS URL for these IDS\n        var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, featureid, null, restrictToMapExtent );\n      }\n\n      // Force download\n      getFeatureUrlData['options']['dl'] = 1;\n\n      // Set export format\n      getFeatureUrlData['options']['OUTPUTFORMAT'] = eformat;\n\n      // Download file\n      downloadFile(getFeatureUrlData['url'], getFeatureUrlData['options']);\n\n      return false;\n  }\n\n  function getVectorLayerSelectionFeatureIdsString( aName ) {\n      var featureidParameter = '';\n      if( aName in config.layers && config.layers[aName]['selectedFeatures'] ){\n          var fids = [];\n\n          // Get WFS typename\n          var configLayer = config.layers[aName];\n          var typeName = aName.split(' ').join('_');\n          if ( 'shortname' in configLayer && configLayer.shortname != '' )\n              typeName = configLayer.shortname;\n\n          for( var id in configLayer['selectedFeatures'] ) {\n              fids.push( typeName + '.' + configLayer['selectedFeatures'][id] );\n          }\n          if( fids.length )\n              featureidParameter = fids.join();\n      }\n\n      return featureidParameter;\n  }\n\n  function getVectorLayerWfsUrl( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent, startIndex, maxFeatures ) {\n      var getFeatureUrlData = {};\n\n      // Set function parameters if not given\n      aFilter = typeof aFilter !== 'undefined' ?  aFilter : null;\n      aFeatureId = typeof aFeatureId !== 'undefined' ?  aFeatureId : null;\n      geometryName = typeof geometryName !== 'undefined' ?  geometryName : null;\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : false;\n      startIndex = typeof startIndex !== 'undefined' ?  startIndex : null;\n      maxFeatures = typeof maxFeatures !== 'undefined' ?  maxFeatures : null;\n\n      // Build WFS request parameters\n      if ( !(aName in config.layers) ) {\n          var qgisName = lizMap.getNameByCleanName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByShortName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByTypeName(aName);\n          if ( qgisName && (qgisName in config.layers)) {\n              aName = qgisName;\n          } else {\n              console.log('getVectorLayerWfsUrl: \"'+aName+'\" and \"'+qgisName+'\" not found in config');\n              return false;\n          }\n      }\n      var configLayer = config.layers[aName];\n      var typeName = aName.split(' ').join('_');\n      if ( 'shortname' in configLayer && configLayer.shortname != '' )\n        typeName = configLayer.shortname;\n      else if ( 'typename' in configLayer && configLayer.typename != '' )\n          typeName = configLayer.typename;\n\n      var wfsOptions = {\n          'SERVICE':'WFS'\n          ,'VERSION':'1.0.0'\n          ,'REQUEST':'GetFeature'\n          ,'TYPENAME':typeName\n          ,'OUTPUTFORMAT':'GeoJSON'\n      };\n\n      if( startIndex )\n          wfsOptions['STARTINDEX'] = startIndex;\n\n      if( maxFeatures )\n          wfsOptions['MAXFEATURES'] = maxFeatures;\n\n      var filterParam = [];\n\n      if( aFilter ){\n          // Remove layerName followed by :\n          aFilter = aFilter.replace( aName + ':', '');\n          if ( aFilter != '' )\n            filterParam.push( aFilter );\n      }else{\n          // If not filter passed, check if a filter does not exists for the layer\n          if( 'request_params' in config.layers[aName] && 'filter' in config.layers[aName]['request_params'] ){\n            var aFilter = config.layers[aName]['request_params']['filter'];\n            if( aFilter ){\n                aFilter = aFilter.replace( aName + ':', '');\n                filterParam.push( aFilter );\n            }\n          }\n      }\n\n      // optionnal parameter filterid or EXP_FILTER\n      if( aFeatureId )\n          wfsOptions['FEATUREID'] = aFeatureId.replace(new RegExp(aName, 'g'), typeName);\n      else if( filterParam.length )\n          wfsOptions['EXP_FILTER'] = filterParam.join( ' AND ' );\n\n\n      // Calculate bbox from map extent if needed\n      if( restrictToMapExtent ) {\n          var extent = map.getExtent().clone();\n          var projFeat = new OpenLayers.Projection(config.layers[aName].crs);\n          extent = extent.transform( map.getProjection(), projFeat );\n          var bbox = extent.toBBOX();\n          wfsOptions['BBOX'] = bbox;\n      }\n\n      // Optionnal parameter geometryname\n      if( geometryName\n        && $.inArray( geometryName.toLowerCase(), ['none', 'extent', 'centroid'] ) != -1\n      ){\n          wfsOptions['GEOMETRYNAME'] = geometryName;\n      }\n\n      getFeatureUrlData['url'] = OpenLayers.Util.urlAppend(lizUrls.wms\n              ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      getFeatureUrlData['options'] = wfsOptions;\n\n      return getFeatureUrlData;\n  }\n\n    /**\n     * storage for callbacks given to getFeatureData\n     *\n     * used to avoid multiple request for the same feature\n     * @type {{}}\n     */\n  var featureDataPool = {};\n\n  function callFeatureDataCallBacks(poolId, features) {\n      var callbacksData = featureDataPool[poolId];\n      delete featureDataPool[poolId];\n      callbacksData.callbacks.forEach(function(callback) {\n          if (callback) {\n            callback(callbacksData.layerName, callbacksData.filter, features, callbacksData.alias, callbacksData.types);\n          }\n      });\n  }\n\n  function getFeatureData(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack) {\n      // Set function parameters if not given\n      aFilter = typeof aFilter !== 'undefined' ?  aFilter : null;\n      aFeatureID = typeof aFeatureID !== 'undefined' ? aFeatureID : null;\n      aGeometryName = typeof aGeometryName !== 'undefined' ? aGeometryName : null;\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : false;\n      startIndex = typeof startIndex !== 'undefined' ?  startIndex : null;\n      maxFeatures = typeof maxFeatures !== 'undefined' ?  maxFeatures : null;\n\n      // get layer configs\n      if ( !(aName in config.layers) ) {\n          var qgisName = lizMap.getNameByCleanName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByShortName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByTypeName(aName);\n          if ( qgisName && (qgisName in config.layers)) {\n              aName = qgisName;\n          } else {\n              console.log('getFeatureData: \"'+aName+'\" and \"'+qgisName+'\" not found in config');\n              return false;\n          }\n      }\n      var aConfig = config.layers[aName];\n\n      $('body').css('cursor', 'wait');\n\n      var getFeatureUrlData = lizMap.getVectorLayerWfsUrl( aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures );\n\n      // see if a request for the same feature is not already made\n      var poolId = getFeatureUrlData['url'] + \"|\" + JSON.stringify(getFeatureUrlData['options']);\n      if (poolId in featureDataPool) {\n          // there is already a request, let's store our callback and wait...\n          if (aCallBack) {\n              featureDataPool[poolId].callbacks.push(aCallBack);\n          }\n          return;\n      }\n      // no request yet, let's do it and store the callback and its parameters\n      featureDataPool[poolId] = {\n          callbacks: [ aCallBack ],\n          layerName: aName,\n          filter: aFilter,\n          alias: aConfig['alias'],\n          types: aConfig['types']\n      };\n\n      $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n\n          aConfig['featureCrs'] = 'EPSG:4326';\n\n          if (aConfig?.['alias'] && aConfig?.['types']) {\n              callFeatureDataCallBacks(poolId, data.features);\n              $('body').css('cursor', 'auto');\n          } else {\n              var service = OpenLayers.Util.urlAppend(lizUrls.wms\n                    ,OpenLayers.Util.getParameterString(lizUrls.params)\n              );\n              $.post(service, {\n                  'SERVICE':'WFS'\n                 ,'VERSION':'1.0.0'\n                 ,'REQUEST':'DescribeFeatureType'\n                 ,'TYPENAME': ('typename' in aConfig) ? aConfig.typename : aName\n                 ,'OUTPUTFORMAT':'JSON'\n              }, function(describe) {\n\n                  aConfig['alias'] = describe.aliases;\n                  aConfig['types'] = describe.types;\n                  aConfig['columns'] = describe.columns;\n\n                  callFeatureDataCallBacks(poolId, data.features);\n\n                  $('body').css('cursor', 'auto');\n\n              },'json');\n           }\n\n      },'json');\n\n      return true;\n  }\n\n  function zoomToOlFeature( feature, proj, zoomAction ){\n      zoomAction = typeof zoomAction !== 'undefined' ?  zoomAction : 'zoom';\n      var format = new OpenLayers.Format.GeoJSON({\n          ignoreExtraDims: true\n      });\n      var feat = format.read(feature)[0];\n      if( feat && 'geometry' in feat ){\n          feat.geometry.transform( proj, lizMap.map.getProjection() );\n\n          // Zoom or center to selected feature\n          if( zoomAction == 'zoom' )\n              map.zoomToExtent(feat.geometry.getBounds());\n          if( zoomAction == 'center' ){\n              var lonlat = feat.geometry.getBounds().getCenterLonLat()\n              map.setCenter(lonlat);\n          }\n      }\n  }\n\n  function zoomToFeature( featureType, fid, zoomAction ){\n      zoomAction = typeof zoomAction !== 'undefined' ?  zoomAction : 'zoom';\n\n      getLayerFeature(featureType, fid, function(feat) {\n        var proj = new OpenLayers.Projection(config.layers[featureType].crs);\n        if( config.layers[featureType].featureCrs )\n            proj = new OpenLayers.Projection(config.layers[featureType].featureCrs);\n          zoomToOlFeature( feat, proj, zoomAction );\n      });\n  }\n\n  function getLayerFeature( featureType, fid, aCallback, aCallbackNotfound, forceToLoad ){\n      if ( !aCallback )\n          return;\n      if ( !(featureType in config.layers) )\n          return;\n\n      var layerConfig = config.layers[featureType];\n      var featureId = featureType + '.' + fid;\n\n      // Use already retrieved feature\n      if(!forceToLoad && layerConfig['features'] && fid in layerConfig['features'] ){\n          aCallback(layerConfig['features'][fid]);\n      }\n      // Or get the feature via WFS in needed\n      else{\n          getFeatureData(featureType, null, featureId, 'extent', false, null, null,\n              function( aName, aFilter, cFeatures, cAliases ){\n\n              if (cFeatures.length == 1) {\n                  var feat = cFeatures[0];\n                  if( !layerConfig['features'] ) {\n                      layerConfig['features'] = {};\n                  }\n                  layerConfig['features'][fid] = feat;\n                  aCallback(feat);\n              }\n              else if(aCallbackNotfound) {\n                  aCallbackNotfound(featureType, fid);\n              }\n          });\n      }\n  }\n\n  function getVectorLayerFeatureTypes() {\n      if ( wfsCapabilities == null ){\n        return [];\n      }\n      return wfsCapabilities.getElementsByTagName('FeatureType');\n  }\n\n  function getVectorLayerResultFormat() {\n    let formats = [];\n    if ( wfsCapabilities == null ){\n      return formats;\n    }else{\n      for (const format of wfsCapabilities.getElementsByTagName('ResultFormat')[0].children) {\n        formats.push(format.tagName);\n      }\n      return formats;\n    }\n  }\n\n\n  function getFeaturePopupContent( aName, feat, aCallback) {\n      // Only use this function with callback\n      if ( !aCallback )\n          return;\n\n      // Only use when feat is set\n      if( !feat )\n          return false;\n\n      // Remove map popup to avoid confusion\n      if (lizMap.map.popups.length != 0)\n          lizMap.map.removePopup( lizMap.map.popups[0] );\n\n      // Get popup content by FILTER and not with virtual click on map\n      var filter = '';\n      var qgisName = aName;\n      if( lizMap.getLayerNameByCleanName(aName) ){\n          qgisName = lizMap.getLayerNameByCleanName(aName);\n      }\n\n      var pkey = null;\n      // Get primary key with attributelayer options\n      if( (qgisName in lizMap.config.attributeLayers) ){\n          pkey = lizMap.config.attributeLayers[qgisName]['primaryKey'];\n      }\n\n      // Test if primary key is set in the atlas tool\n      // Atlas config with one layer (legacy)\n      if( !pkey && 'atlasLayer' in lizMap.config.options && 'atlasPrimaryKey' in lizMap.config.options ){\n        var layerConfig = lizMap.config.layers[qgisName];\n        if( layerConfig.id == lizMap.config.options['atlasLayer'] && lizMap.config.options['atlasPrimaryKey'] != '' ){\n          pkey = lizMap.config.options['atlasPrimaryKey'];\n        }\n      }\n\n      // Atlas config with several layers (LWC >= 3.4)\n      if (!pkey && 'atlas' in lizMap.config && 'layers' in lizMap.config.atlas && Array.isArray(lizMap.config.atlas['layers']) && lizMap.config.atlas['layers'].length > 0) {\n        const layerConfig = lizMap.config.layers[qgisName];\n        for (let index = 0; index < lizMap.config.atlas.layers.length; index++) {\n          const layer = lizMap.config.atlas.layers[index];\n          if (layerConfig.id === layer.layer){\n            pkey = layer.primaryKey;\n            break;\n          }\n        }\n      }\n\n      if( !pkey )\n          return false;\n\n      var pkVal = feat.properties[pkey];\n      filter = qgisName + ':\"' + pkey + '\" = ' + \"'\" + pkVal + \"'\" ;\n\n      var crs = 'EPSG:4326';\n      if(('crs' in lizMap.config.layers[qgisName]) && lizMap.config.layers[qgisName].crs != ''){\n          crs = lizMap.config.layers[qgisName].crs;\n      }\n\n      var wmsOptions = {\n           'LAYERS': aName\n          ,'QUERY_LAYERS': aName\n          ,'STYLES': ''\n          ,'SERVICE': 'WMS'\n          ,'VERSION': '1.3.0'\n          ,'CRS': crs\n          ,'REQUEST': 'GetFeatureInfo'\n          ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n          ,'INFO_FORMAT': 'text/html'\n          ,'FEATURE_COUNT': 1\n          ,'FILTER': filter\n      };\n\n      // Query the server\n      var service = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      $.post(service, wmsOptions, function(data) {\n          aCallback(data);\n      });\n\n  }\n\n  // Get the popup content for a layer given a feature\n  function getFeaturePopupContentByFeatureIntersection(aName, feat, aCallback) {\n\n    // Calculate fake bbox around the feature\n    var units = lizMap.map.getUnits();\n    var lConfig = lizMap.config.layers[aName];\n    if( lizMap.map.maxScale == 'auto' )\n      var scale = lConfig.minScale;\n    else\n      var scale = Math.max( lizMap.map.maxScale, lConfig.minScale );\n    scale = scale * 2;\n    var res = OpenLayers.Util.getResolutionFromScale(scale, units);\n\n    var geomType = feat.geometry.CLASS_NAME;\n    if (\n      geomType == 'OpenLayers.Geometry.Polygon'\n      || geomType == 'OpenLayers.Geometry.MultiPolygon'\n      || geomType == 'OpenLayers.Geometry.Point'\n    ) {\n      var lonlat = feat.geometry.getBounds().getCenterLonLat()\n    }\n    else {\n      var vert = feat.geometry.getVertices();\n      var middlePoint = vert[Math.floor(vert.length/2)];\n      var lonlat = new OpenLayers.LonLat(middlePoint.x, middlePoint.y);\n    }\n\n    // Calculate fake bbox\n    var bbox = new OpenLayers.Bounds(\n      lonlat.lon - 5 * res,\n      lonlat.lat - 5 * res,\n      lonlat.lon + 5 * res,\n      lonlat.lat + 5 * res\n    );\n\n    var gfiCrs = lizMap.map.getProjectionObject().toString();\n    if ( gfiCrs == 'EPSG:900913' )\n      gfiCrs = 'EPSG:3857';\n\n    var wmsOptions = {\n       'LAYERS': aName\n      ,'QUERY_LAYERS': aName\n      ,'STYLES': ''\n      ,'SERVICE': 'WMS'\n      ,'VERSION': '1.3.0'\n      ,'REQUEST': 'GetFeatureInfo'\n      ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n      ,'BBOX': bbox.toBBOX()\n      ,'FEATURE_COUNT': 10\n      ,'HEIGHT': 100\n      ,'WIDTH': 100\n      ,'INFO_FORMAT': 'text/html'\n      ,'CRS': gfiCrs\n      ,'I': 50\n      ,'J': 50\n    };\n\n    // Query the server\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n      ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    $.post(service, wmsOptions, function(data) {\n      if(aCallback){\n        aCallback(service, wmsOptions, data);\n      }\n    });\n  }\n\n\n  function selectLayerFeaturesFromSelectionFeature(targetFeatureType, selectionFeature, geomOperator = 'intersects'){\n\n      var lConfig = config.layers[targetFeatureType];\n      lizMap.loadProjDefinition( lConfig.crs, function( aProj ) {\n\n          var gml3 = new OpenLayers.Format.GML.v3(\n              {\n                  internalProjection: lizMap.map.getProjection(),\n                  externalProjection: aProj,\n                  srsName: aProj\n              }\n          );\n          var gml = gml3.writeNode(\n              'feature:_geometry',\n              selectionFeature.geometry\n          );\n        var spatialFilter = geomOperator+\"($geometry, geom_from_gml('\" ;\n          spatialFilter+= OpenLayers.Format.XML.prototype.write.apply(\n              gml3,\n              gml.children\n          );\n          spatialFilter+= \"'))\";\n\n          if( 'request_params' in lConfig && 'filter' in lConfig['request_params'] ){\n              var rFilter = lConfig['request_params']['filter'];\n              if( rFilter ){\n                  rFilter = rFilter.replace( targetFeatureType + ':', '');\n                  spatialFilter = rFilter +' AND '+ spatialFilter;\n              }\n          }\n          if( 'request_params' in lConfig && 'exp_filter' in lConfig['request_params'] ){\n              // Add exp_filter, for example if set by another tool( filter module )\n              // Often 'filter' is not set because filtertoken is set instead\n              // But in this case, exp_filter must also been set and must be added\n              var eFilter = lConfig['request_params']['exp_filter'];\n              if( eFilter ){\n                  spatialFilter = eFilter +' AND '+ spatialFilter;\n              }\n          }\n          var limitDataToBbox = false;\n          if ( 'limitDataToBbox' in config.options && config.options.limitDataToBbox == 'True'){\n              limitDataToBbox = true;\n          }\n          var getFeatureUrlData = lizMap.getVectorLayerWfsUrl( targetFeatureType, spatialFilter, null, null, limitDataToBbox );\n\n          // add BBox to restrict to geom bbox but not with some geometry operator\n          if (geomOperator !== 'disjoint'){\n            var geomBounds = selectionFeature.geometry.clone().transform(lizMap.map.getProjection(), aProj).getBounds();\n            if (geomBounds.getWidth() == 0 || geomBounds.getHeight() == 0) {\n              geomBounds.extend(new OpenLayers.Bounds(\n                  geomBounds.left - 0.000001,\n                  geomBounds.bottom - 0.000001,\n                  geomBounds.right + 0.000001,\n                  geomBounds.top + 0.000001\n              ));\n            }\n            getFeatureUrlData['options']['BBOX'] = geomBounds.toBBOX();\n            getFeatureUrlData['options']['SRSNAME'] = lConfig.crs;\n          }\n\n          // get features\n          $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(result) {\n                  var gFormat = new OpenLayers.Format.GeoJSON({\n                      ignoreExtraDims: true,\n                      externalProjection: lConfig.crs,\n                      internalProjection: lizMap.map.getProjection()\n                  });\n                  var tfeatures = gFormat.read( result );\n                  var sfIds = $.map(tfeatures, function(feat){\n                      return feat.fid.split('.')[1];\n                  });\n\n                  if (lizMap.mainLizmap.selectionTool.newAddRemoveSelected === 'add' ) {\n                      sfIds = config.layers[targetFeatureType]['selectedFeatures'].concat(sfIds);\n                      for(var i=0; i<sfIds.length; ++i) {\n                          for(var j=i+1; j<sfIds.length; ++j) {\n                              if(sfIds[i] === sfIds[j])\n                                  sfIds.splice(j--, 1);\n                          }\n                      }\n                  } else if (lizMap.mainLizmap.selectionTool.newAddRemoveSelected === 'remove' ) {\n                      var asfIds = config.layers[targetFeatureType]['selectedFeatures'].concat([]);\n                      for(var i=0; i<sfIds.length; ++i) {\n                          var asfIdIdx = asfIds.indexOf( sfIds[i] );\n                          if( asfIdIdx != -1 )\n                              asfIds.splice(asfIdIdx, 1);\n                      }\n                      sfIds = asfIds;\n                  }\n                  config.layers[targetFeatureType]['selectedFeatures'] = sfIds;\n                  lizMap.events.triggerEvent(\"layerSelectionChanged\",\n                      {\n                          'featureType': targetFeatureType,\n                          'featureIds': config.layers[targetFeatureType]['selectedFeatures'],\n                          'updateDrawing': true\n                      }\n                  );\n          });\n      });\n  }\n\n  // Create new dock or minidock\n  // Example : lizMap.addDock('mydock', 'My dock title', 'dock', 'Some content', 'icon-pencil');\n  // see icon list here : http://getbootstrap.com/2.3.2/base-css.html#icons\n  function addDock( dname, dlabel, dtype, dcontent, dicon){\n      // First check if this dname already exists\n      if( $('#mapmenu .nav-list > li.'+dname+' > a').length ){\n          console.log(dname + ' menu item already exists');\n          return;\n      }\n\n      // Create menu icon for activating dock\n      var dockli = '';\n      dockli+='<li class=\"'+dname+' nav-'+dtype+'\">';\n      dockli+='   <a id=\"button-'+dname+'\" rel=\"tooltip\" data-original-title=\"'+dlabel+'\" data-placement=\"right\" href=\"#'+dname+'\" data-container=\"#content\">';\n      dockli += '       <span class=\"icon\"><i class=\"' + dicon + ' icon-white\"></i></span><span class=\"menu-title\">' + dname +'</span>';\n      dockli+='   </a>';\n      dockli+='</li>';\n      $('#mapmenu div ul li.nav-'+dtype+':last').after(dockli);\n      if ( $('#mapmenu div ul li.nav-'+dtype+'.'+dname).length == 0 )\n        $('#mapmenu div ul li:last').after(dockli);\n\n      //  Remove native lizmap icon\n      $('#mapmenu .nav-list > li.'+dname+' > a .icon').css('background-image','none');\n      $('#mapmenu .nav-list > li.'+dname+' > a .icon >i ').css('margin-left', '4px');\n\n      // Add tooltip\n      $('#mapmenu .nav-list > li.'+dname+' > a').tooltip();\n\n      // Create dock tab content\n      var docktab = '';\n      docktab+='<div class=\"tab-pane\" id=\"'+dname+'\">';\n      if( dtype == 'minidock'){\n          docktab+='<div class=\"mini-dock-close\" title=\"' + lizDict['toolbar.content.stop'] + '\" style=\"padding:7px;float:right;cursor:pointer;\"><i class=\"icon-remove icon-white\"></i></div>';\n          docktab+='    <div class=\"'+dname+'\">';\n          docktab+='        <h3>';\n          docktab+='            <span class=\"title\">';\n          docktab+='              <i class=\"'+dicon+' icon-white\"></i>';\n          docktab+='              <span class=\"text\">&nbsp;'+dlabel+'&nbsp;</span>';\n          docktab+='            </span>';\n          docktab+='        </h3>';\n      }\n      docktab+='        <div class=\"menu-content\">';\n      docktab+= dcontent;\n      docktab+='        </div>';\n      docktab+='    </div>';\n      docktab+='</div>';\n      if( dtype == 'minidock'){\n          $('#mini-dock-content').append(docktab);\n          $('#'+dname+' div.mini-dock-close').click(function(){\n            if( $('#mapmenu .nav-list > li.'+dname).hasClass('active') ){\n                $('#button-'+dname).click();\n            }\n          });\n      }\n      else if( dtype == 'right-dock' )\n          $('#right-dock-content').append(docktab);\n      else if( dtype == 'dock' )\n          $('#dock-content').append(docktab);\n      else if( dtype == 'bottomdock' )\n          $('#bottom-dock-content').append(docktab);\n\n      // Create dock tab li\n      var docktabli = '';\n      docktabli+= '<li id=\"nav-tab-'+dname+'\"><a href=\"#'+dname+'\" data-toggle=\"tab\">'+dlabel+'</a></li>';\n      if( dtype == 'minidock')\n          $('#mini-dock-tabs').append(docktabli);\n      else if( dtype == 'right-dock' )\n          $('#right-dock-tabs').append(docktabli);\n      else if( dtype == 'dock' )\n          $('#dock-tabs').append(docktabli);\n      else if( dtype == 'bottomdock' )\n          $('#bottom-dock-tabs').append(docktabli);\n\n  }\n\n  /**\n   * PRIVATE function: getFeatureInfoTolerances\n   * Get tolerances for point, line and polygon\n   * as configured with lizmap plugin, or default\n   * if no configuration found.\n   * Returns:\n   * {Object} The tolerances for point, line and polygon\n   */\n  function getFeatureInfoTolerances(){\n\n    var tolerances = defaultGetFeatureInfoTolerances;\n    if( 'pointTolerance' in config.options\n        && 'lineTolerance' in config.options\n        && 'polygonTolerance' in config.options\n    ){\n      tolerances = {\n        'FI_POINT_TOLERANCE': config.options.pointTolerance,\n        'FI_LINE_TOLERANCE': config.options.lineTolerance,\n        'FI_POLYGON_TOLERANCE': config.options.polygonTolerance\n      };\n    }\n    return tolerances;\n\n  }\n\n  /* PRIVATE function: isHighDensity\n   * Return True when the screen is of high density\n   * Returns:\n   * Boolean\n   */\n  function isHighDensity(){\n    return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) || (window.devicePixelRatio && window.devicePixelRatio > 1.3));\n  }\n\n  function deactivateMaplayerFilter (layername) {\n    var layerN = layername;\n    var layer = null;\n    var layers = map.getLayersByName( cleanName(layername) );\n    if( layers.length == 1) {\n      layer = layers[0];\n    }\n\n    // Remove layer filter\n    delete layer.params['FILTER'];\n    delete layer.params['FILTERTOKEN'];\n    delete layer.params['EXP_FILTER'];\n    if( !('request_params' in config.layers[layername]) ){\n      config.layers[layername]['request_params'] = {};\n    }\n    config.layers[layername]['request_params']['exp_filter'] = null;\n    config.layers[layername]['request_params']['filtertoken'] = null;\n    config.layers[layername]['request_params']['filter'] = null;\n    layer.redraw();\n  }\n\n  function triggerLayerFilter (layername, filter) {\n      // Get layer information\n      var layerN = layername;\n      var layer = null;\n      var layers = map.getLayersByName( cleanName(layername) );\n      if( layers.length == 1) {\n        layer = layers[0];\n      }\n      if(!layer)\n          return false;\n      if( layer.params) {\n        layerN = layer.params['LAYERS'];\n      }\n\n      // Add filter to the layer\n      if( !filter || filter == ''){\n        filter = null;\n        var lfilter = null;\n\n      }else{\n        var lfilter = layerN + ':' + filter;\n      }\n      layer.params['FILTER'] = lfilter;\n      if( !('request_params' in config.layers[layername]) ){\n        config.layers[layername]['request_params'] = {};\n      }\n\n      // Add WFS exp_filter param\n      config.layers[layername]['request_params']['exp_filter'] = filter;\n\n      // Get WMS filter token ( used via GET in GetMap or GetPrint )\n      var surl = OpenLayers.Util.urlAppend(lizUrls.wms\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      var sdata = {\n        service: 'WMS',\n        request: 'GETFILTERTOKEN',\n        typename: layername,\n        filter: lfilter\n      };\n      $.post(surl, sdata, function(result){\n        var filtertoken = result.token;\n        // Add OpenLayers layer parameter\n        delete layer.params['FILTER'];\n        layer.params['FILTERTOKEN'] = filtertoken\n        config.layers[layername]['request_params']['filtertoken'] = filtertoken;\n\n        // Redraw openlayers layer\n        if( config.layers[layername]['geometryType']\n          && config.layers[layername]['geometryType'] != 'none'\n          && config.layers[layername]['geometryType'] != 'unknown'\n        ){\n            //layer.redraw(true);\n          layer.redraw();\n        }\n\n        // Tell popup to be aware of the filter\n        lizMap.events.triggerEvent(\"layerFilterParamChanged\",\n          {\n            'featureType': layername,\n            'filter': lfilter,\n            'updateDrawing': false\n          }\n        );\n      });\n\n      return true;\n  }\n\n  // creating the lizMap object\n  var obj = {\n    /**\n     * Property: map\n     * {<OpenLayers.Map>} The map\n     */\n    map: null,\n    /**\n     * Property: layers\n     * {Array(<OpenLayers.Layer>)} The layers\n     */\n    layers: null,\n    /**\n     * Property: baselayers\n     * {Array(<OpenLayers.Layer>)} The base layers\n     */\n    baselayers: null,\n    /**\n     * Property: events\n     * {<OpenLayers.Events>} An events object that handles all\n     *                       events on the lizmap\n     */\n    events: null,\n    /**\n     * Property: config\n     * {Object} The map config\n     */\n    config: null,\n    /**\n     * Property: dictionnary\n     * {Object} The map dictionnary\n     */\n    dictionary: null,\n    /**\n     * Property: tree\n     * {Object} The map tree\n     */\n    tree: null,\n    /**\n     * Property: lizmapLayerFilterActive\n     * {Object} Contains main filtered layer if filter is active\n     */\n    lizmapLayerFilterActive: null,\n\n    /**\n     * Method: getLizmapDesktopPluginMetadata\n     */\n     getLizmapDesktopPluginMetadata: function() {\n      return getLizmapDesktopPluginMetadata();\n    },\n\n    /**\n     * Method: checkMobile\n     */\n    checkMobile: function() {\n      return mCheckMobile();\n    },\n\n    /**\n     * Method: cleanName\n     */\n    cleanName: function( aName ) {\n      return cleanName( aName );\n    },\n\n    /**\n     * Method: getNameByCleanName\n     */\n    getNameByCleanName: function( cleanName ) {\n      return getNameByCleanName( cleanName );\n    },\n\n    /**\n     * Method: getNameByShortName\n     */\n    getNameByShortName: function( shortName ) {\n      return getNameByShortName( shortName );\n    },\n\n    /**\n     * Method: getNameByTypeName\n     */\n    getNameByTypeName: function( typeName ) {\n      return getNameByTypeName( typeName );\n    },\n\n    /**\n     * Method: getLayerNameByCleanName\n     */\n    getLayerNameByCleanName: function( cleanName ) {\n      return getLayerNameByCleanName( cleanName );\n    },\n\n    /**\n     * Method: addMessage\n     */\n    addMessage: function( aMessage, aType, aClose ) {\n      return mAddMessage( aMessage, aType, aClose );\n    },\n\n    /**\n     * Method: updateMiniDockSize\n     */\n    updateMiniDockSize: function() {\n      return updateMiniDockSize();\n    },\n\n    /**\n     * Method: transformBounds\n     */\n    loadProjDefinition: function( aCRS, aCallback ) {\n      return loadProjDefinition( aCRS, aCallback );\n    },\n\n\n    /**\n     * Method: updateContentSize\n     */\n    updateContentSize: function() {\n      return updateContentSize();\n    },\n\n    /**\n     * Method: clearDrawLayer\n     */\n    clearDrawLayer: function(layerName) {\n      return clearDrawLayer(layerName);\n    },\n\n    /**\n     * Method: getLayerFeature\n     */\n    getLayerFeature: function( featureType, fid, aCallback, aCallbackNotfound, forceToLoad ) {\n      getLayerFeature( featureType, fid, aCallback, aCallbackNotfound, forceToLoad );\n    },\n\n    /**\n     * Method: getFeatureData\n     */\n    getFeatureData: function(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack) {\n      getFeatureData(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack);\n    },\n\n    /**\n     * Method: translateWfsFieldValues\n     */\n    translateWfsFieldValues: function(aName, fieldName, fieldValue, translation_dict) {\n      return translateWfsFieldValues(aName, fieldName, fieldValue, translation_dict);\n    },\n\n    /**\n     * Method: zoomToFeature\n     */\n    zoomToFeature: function( featureType, fid, zoomAction ) {\n      zoomToFeature( featureType, fid, zoomAction );\n    },\n\n\n    /**\n     * Method: getPrintGridInterval\n     */\n    getPrintGridInterval: function(aLayout, aScale, aScales) {\n      return getPrintGridInterval(aLayout, aScale, aScales);\n    },\n\n\n    /**\n     * Method: getPrintCapabilities\n     */\n    getPrintCapabilities: function() {\n      return printCapabilities;\n    },\n\n\n    /**\n     * Method: getExternalBaselayersReplacement\n     */\n    getExternalBaselayersReplacement: function() {\n      return externalBaselayersReplacement;\n    },\n\n    /**\n     * Method: launchTooltipLayer\n     */\n    launchTooltipLayer: function( aLayerName ) {\n        var tlOptions = $('#tooltip-layer-list option[value=\"'+aLayerName+'\"]');\n        if ( tlOptions.length == 1 && $('#tooltip-layer-list').val() != aLayerName)\n            $('#tooltip-layer-list').val( aLayerName ).change();\n        else if ( tlOptions.length != 1 && $('#tooltip-layer-list').val() != '' )\n            $('#tooltip-layer-list').val('').change();\n        return ($('#tooltip-layer-list').val() == aLayerName);\n    },\n\n\n    launchEdition: function() {\n        return false;\n    },\n\n    deleteEditionFeature: function(){\n        return false;\n    },\n\n    deactivateToolControls: function( evt ) {\n      return deactivateToolControls( evt );\n    },\n\n    displayGetFeatureInfo: function( text, xy ) {\n      return displayGetFeatureInfo( text, xy );\n    },\n\n    /**\n     * Method: exportVectorLayer\n     */\n    exportVectorLayer: function( aName, eformat, restrictToMapExtent ) {\n      return exportVectorLayer( aName, eformat, restrictToMapExtent );\n    },\n\n    /**\n     * Method: getVectorLayerWfsUrl\n     */\n    getVectorLayerWfsUrl: function( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent ) {\n      return getVectorLayerWfsUrl( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent );\n    },\n\n    /**\n     * Method: getVectorLayerFeatureType\n     * @returns {Array} Array of FeatureType Elements\n     */\n    getVectorLayerFeatureTypes: function() {\n      return getVectorLayerFeatureTypes();\n    },\n\n    /**\n     * Method: getVectorLayerResultFormat\n     * @returns {string[]} Array of format for file export\n     */\n    getVectorLayerResultFormat: function() {\n      return getVectorLayerResultFormat();\n    },\n\n    /**\n     * Method: getLayerConfigById\n     */\n    getLayerConfigById: function( aLayerId, aConfObjet, aIdAttribute ) {\n      return getLayerConfigById( aLayerId, aConfObjet, aIdAttribute );\n    },\n\n    /**\n     * Method: getFeaturePopupContent\n     */\n    getFeaturePopupContent: function( aName, feat, aCallback) {\n      return getFeaturePopupContent(aName, feat, aCallback);\n    },\n\n    /**\n     * Method: getFeaturePopupContentByFeatureIntersection\n     */\n    getFeaturePopupContentByFeatureIntersection: function( aName, feat, aCallback) {\n      return getFeaturePopupContentByFeatureIntersection(aName, feat, aCallback);\n    },\n\n    /**\n     * Method: selectLayerFeaturesFromSelectionFeature\n     */\n    selectLayerFeaturesFromSelectionFeature: function (targetFeatureType, selectionFeature, geomOperator = 'intersects') {\n      return selectLayerFeaturesFromSelectionFeature(targetFeatureType, selectionFeature, geomOperator);\n    },\n\n    /**\n     * Method: addGeometryFeatureInfo\n     */\n    addGeometryFeatureInfo: function(popup, containerId){\n      return addGeometryFeatureInfo(popup, containerId);\n    },\n\n    /**\n     * Method: addChildrenFeatureInfo\n     */\n    addChildrenFeatureInfo: function(popup, containerId){\n      return addChildrenFeatureInfo(popup, containerId);\n    },\n\n    /**\n     * Method: addChildrenDatavizFilteredByPopupFeature\n     */\n    addChildrenDatavizFilteredByPopupFeature: function(popup, containerId){\n      return addChildrenDatavizFilteredByPopupFeature(popup, containerId);\n    },\n\n    /**\n     * Method: addDock\n     */\n    addDock: function( dname, dlabel, dtype, dcontent, dicon){\n      return addDock(dname, dlabel, dtype, dcontent, dicon);\n    },\n\n    /**\n     * Method: getHashParamFromUrl\n     * Utility function to get searched key in URL's hash\n     * @param {string} hash_key - searched key in hash\n     * @return {string} value for searched key\n     * @example\n     * URL: https://liz.map/index.php/view/map/?repository=demo&project=cats#fid:v_cat20180426181713938.16,other_param:foo\n     * console.log(getHashParamFromUrl('fid'))\n     * returns 'v_cat20180426181713938.16'\n     */\n    getHashParamFromUrl: function (hash_key) {\n      var ret_val = null;\n      var hash = location.hash.replace('#', '');\n      var hash_items = hash.split(',');\n      for (var i in hash_items) {\n        var item = hash_items[i];\n        var param = item.split(':');\n        if (param.length == 2) {\n          var key = param[0];\n          var val = param[1];\n          if (key == hash_key) {\n            return val;\n          }\n        }\n      }\n      return ret_val;\n    },\n\n\n    /**\n     * Apply the global filter on a OpenLayer layer\n     * Only used by filter.js and timemanager.js\n     */\n    triggerLayerFilter: function (layername, filter) {\n      return triggerLayerFilter(layername, filter);\n    },\n\n    /**\n     * Deactivate the global filter on a OpenLayer layer\n     * Only used by filter.js and timemanager.js\n     */\n    deactivateMaplayerFilter: function (layername) {\n      // Get layer information\n      return deactivateMaplayerFilter(layername);\n    },\n\n\n\n    /**\n     * Method: init\n     */\n    init: function() {\n      var self = this;\n\n      var service = OpenLayers.Util.urlAppend(lizUrls.wms\n        , OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n\n      // Get config\n      const configRequest = fetch(OpenLayers.Util.urlAppend(lizUrls.config, OpenLayers.Util.getParameterString(lizUrls.params))).then(function (response) {\n        if (!response.ok) {\n          throw 'Config not loaded: ' + response.status + ' ' + response.statusText\n        }\n        return response.json()\n      });\n\n      // Get key/value config\n      const keyValueConfigRequest = fetch(OpenLayers.Util.urlAppend(lizUrls.keyValueConfig, OpenLayers.Util.getParameterString(lizUrls.params))).then(function (response) {\n        if (!response.ok) {\n          throw 'Key/value config not loaded: ' + response.status + ' ' + response.statusText\n        }\n        return response.json()\n      });\n\n      // Get WMS, WMTS, WFS capabilities\n      const WMSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WMS', REQUEST: 'GetCapabilities', VERSION: '1.3.0' }))).then(function (response) {\n        if (!response.ok) {\n          throw 'WMS GetCapabilities not loaded: ' + response.status + ' ' + response.statusText\n        }\n        return response.text()\n      });\n      const WMTSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WMTS', REQUEST: 'GetCapabilities', VERSION: '1.0.0' }))).then(function (response) {\n        if (!response.ok) {\n          throw 'WMTS GetCapabilities not loaded: ' + response.status + ' ' + response.statusText\n        }\n        return response.text()\n      });\n      const WFSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WFS', REQUEST: 'GetCapabilities', VERSION: '1.0.0' }))).then(function (response) {\n        if (!response.ok) {\n          throw 'WFS GetCapabilities not loaded: ' + response.status + ' ' + response.statusText\n        }\n        return response.text()\n      });\n\n      // Get feature extent if defined in URL\n      let featureExtentRequest;\n      // Get feature info if defined in URL\n      let getFeatureInfoRequest;\n      let getFeatureInfo;\n\n      const urlParameters = (new URL(document.location)).searchParams;\n\n      const layerName = urlParameters.get('layer');\n      const filter = urlParameters.get('filter');\n\n      if(layerName && filter){\n\n          // Feature extent\n          const wfs = new WFS();\n          const wfsParams = {\n              TYPENAME: layerName,\n              EXP_FILTER: filter\n          };\n\n          featureExtentRequest = wfs.getFeature(wfsParams);\n\n          // Feature info\n          if(urlParameters.get('popup') === 'true'){\n            const wms = new WMS();\n            const wmsParams = {\n              QUERY_LAYERS: layerName,\n              LAYERS: layerName,\n              FEATURE_COUNT: 50, // TODO: get this value from config after it has been loaded?\n              FILTER: `${layerName}:${filter}`,\n            };\n\n            getFeatureInfoRequest = wms.getFeatureInfo(wmsParams);\n          }\n      }\n\n      // Request config and capabilities in parallel\n      Promise.all([configRequest, keyValueConfigRequest, WMSRequest, WMTSRequest, WFSRequest, featureExtentRequest, getFeatureInfoRequest]).then(responses => {\n        // config is defined globally\n        config = responses[0];\n        keyValueConfig = responses[1];\n        const wmsCapaData = responses[2];\n        const wmtsCapaData = responses[3];\n        const wfsCapaData = responses[4];\n\n        let featuresExtent = responses[5]?.features?.[0]?.bbox;\n        let features = responses[5]?.features;\n\n        if(featuresExtent){\n          for (const feature of responses[5].features) {\n            featuresExtent = extend(featuresExtent, feature.bbox);\n          }\n        }\n\n        getFeatureInfo = responses[6];\n\n        const domparser = new DOMParser();\n\n        config.options.hasOverview = false;\n\n        // store layerIDs\n        if ('useLayerIDs' in config.options && config.options.useLayerIDs == 'True') {\n          for (var layerName in config.layers) {\n            var configLayer = config.layers[layerName];\n            layerIdMap[configLayer.id] = layerName;\n          }\n        }\n        // store shortnames and shortnames\n        for (var layerName in config.layers) {\n          var configLayer = config.layers[layerName];\n          if ('shortname' in configLayer && configLayer.shortname != '')\n            shortNameMap[configLayer.shortname] = layerName;\n          configLayer.cleanname = cleanName(layerName);\n        }\n\n        // Parse WMS capabilities\n        const wmsFormat =  new OpenLayers.Format.WMSCapabilities({version:'1.3.0'});\n        capabilities = wmsFormat.read(wmsCapaData);\n\n        if (!capabilities.capability) {\n          throw 'WMS Capabilities error';\n        }\n\n        // Parse WMTS capabilities\n        const wmtsFormat = new OpenLayers.Format.WMTSCapabilities({});\n        wmtsCapabilities = wmtsFormat.read(wmtsCapaData);\n        if ('exceptionReport' in wmtsCapabilities) {\n          var wmtsElem = $('#metadata-wmts-getcapabilities-url');\n          if (wmtsElem.length != 0) {\n            wmtsElem.before('<i title=\"' + wmtsCapabilities.exceptionReport.exceptions[0].texts[0] + '\" class=\"icon-warning-sign\"></i>&nbsp;');\n          }\n          wmtsCapabilities = null;\n        }\n\n        // Parse WFS capabilities\n        wfsCapabilities = domparser.parseFromString(wfsCapaData, \"application/xml\");\n        var featureTypes = getVectorLayerFeatureTypes();\n\n        for (const featureType of featureTypes) {\n          var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n          var layerName = lizMap.getNameByTypeName(typeName);\n          if (!layerName) {\n            if (typeName in config.layers)\n              layerName = typeName\n            else if ((typeName in shortNameMap) && (shortNameMap[typeName] in config.layers))\n              layerName = shortNameMap[typeName];\n            else {\n              for (l in config.layers) {\n                if (l.split(' ').join('_') == typeName) {\n                  layerName = l;\n                  break;\n                }\n              }\n            }\n          }\n\n          if (!(layerName in config.layers))\n            continue;\n\n          var configLayer = config.layers[layerName];\n          configLayer.typename = typeName;\n          typeNameMap[typeName] = layerName;\n        }\n\n        //set title and abstract coming from capabilities\n        $('#abstract').html(capabilities.abstract ? capabilities.abstract : '');\n\n        // get and analyse tree\n        var capability = capabilities.capability;\n\n        // Copy QGIS project's projection\n        config.options.qgisProjectProjection = Object.assign({}, config.options.projection);\n\n        // Add the config in self here to be able\n        // to let the JS external script modify some plugin cfg layers properties\n        // before Lizmap will create the layer tree\n        self.config = config;\n        self.events.triggerEvent(\"beforetreecreated\", self);\n        beforeLayerTreeCreated();\n\n        var firstLayer = capability.nestedLayers[0];\n        getLayerTree(firstLayer, tree);\n        analyseNode(tree);\n\n        // Re-save the config in self\n        self.config = config;\n        self.keyValueConfig = keyValueConfig;\n        self.tree = tree;\n        self.events.triggerEvent(\"treecreated\", self);\n\n        // create the map\n        initProjections(firstLayer);\n        createMap(featuresExtent);\n        self.map = map;\n        self.layers = layers;\n        self.baselayers = baselayers;\n        self.controls = controls;\n        self.events.triggerEvent(\"mapcreated\", self);\n\n        // create the switcher\n        createSwitcher();\n        self.events.triggerEvent(\"layersadded\", self);\n\n\n        // Verifying z-index\n        var lastLayerZIndex = map.layers[map.layers.length - 1].getZIndex();\n        if (lastLayerZIndex > map.Z_INDEX_BASE['Feature'] - 100) {\n          map.Z_INDEX_BASE['Feature'] = lastLayerZIndex + 100;\n          map.Z_INDEX_BASE['Popup'] = map.Z_INDEX_BASE['Feature'] + 25;\n          if (map.Z_INDEX_BASE['Popup'] > map.Z_INDEX_BASE['Control'] - 25)\n            map.Z_INDEX_BASE['Control'] = map.Z_INDEX_BASE['Popup'] + 25;\n        }\n\n        // initialize the map\n        // Set map extent depending on options\n        var verifyingVisibility = true;\n        var hrefParam = OpenLayers.Util.getParameters(window.location.href);\n        if (!map.getCenter()) {\n          if (hrefParam.bbox || hrefParam.BBOX) {\n            var hrefBbox = null;\n            if (hrefParam.bbox)\n              hrefBbox = OpenLayers.Bounds.fromArray(hrefParam.bbox);\n            if (hrefParam.BBOX)\n              hrefBbox = OpenLayers.Bounds.fromArray(hrefParam.BBOX);\n\n            if (hrefParam.crs && hrefParam.crs != map.getProjection())\n              hrefBbox.transform(hrefParam.crs, map.getProjection())\n            if (hrefParam.CRS && hrefParam.CRS != map.getProjection())\n              hrefBbox.transform(hrefParam.CRS, map.getProjection())\n            if (map.restrictedExtent.containsBounds(hrefBbox))\n              map.zoomToExtent(hrefBbox, true);\n            else {\n              var projBbox = $('#metadata .bbox').text();\n              projBbox = OpenLayers.Bounds.fromString(projBbox);\n              if (projBbox.containsBounds(hrefBbox)) {\n                var projProj = $('#metadata .proj').text();\n                loadProjDefinition(projProj, function (aProj) {\n                  hrefBbox.transform(aProj, map.getProjection());\n                  map.zoomToExtent(hrefBbox, true);\n                });\n              } else {\n                map.zoomToExtent(map.initialExtent);\n              }\n            }\n          } else {\n            map.zoomToExtent(map.initialExtent);\n          }\n          if(featuresExtent){\n            var format = new OpenLayers.Format.GeoJSON({\n                ignoreExtraDims: true\n            });\n            var locatelayer = map.getLayersByName('locatelayer')[0];\n            for (const feature of features) {\n              if( feature.geometry != null){\n                  var feat = format.read(feature)[0];\n                  feat.geometry.transform('EPSG:4326', map.getProjection());\n                  locatelayer.addFeatures([feat]);\n                  locatelayer.setVisibility(true);\n              }\n            }\n          }\n          verifyingVisibility = false;\n        }\n\n        updateContentSize();\n        map.events.triggerEvent(\"zoomend\", { \"zoomChanged\": true });\n\n        // create navigation and toolbar\n        createNavbar();\n        createToolbar();\n        self.events.triggerEvent(\"toolbarcreated\", self);\n\n        // create permalink\n        createPermalink();\n\n        // Toggle OpenLayers visibility to true for legend checkboxes\n        // 1/ Check permalink is used or not\n        var layersHaveBeenActivatedByPermalink = false;\n        var uparams = getUrlParameters();\n        if ('layers' in uparams) {\n          var players = uparams.layers;\n          for (var i = 0; i < map.layers.length; i++) {\n            var l = map.layers[i];\n            var lbase = l.isBaseLayer;\n            if (!lbase) {\n              if (players[i] == 'T') {\n                layersHaveBeenActivatedByPermalink = true;\n                l.setVisibility(true);\n              }\n            }\n          }\n          runPermalink(uparams);\n        }\n\n        // 2/ Toggle checkboxes\n        $('#switcher button.checkbox[name=\"layer\"]').each(function () {\n          var cb = $(this);\n          var cleanName = cb.val();\n          var oLayer = map.getLayersByName(cleanName)[0];\n          if (oLayer) {\n            // toggle checked class for permalink layers\n            // because OL has already drawn them in map\n            cb.toggleClass('checked', oLayer.visibility);\n\n            // Check layers wich are not yet checked but need to ( for normal behaviour outside permalink )\n            // This will trigger layers to be drawn\n            if (!cb.hasClass('checked') && oLayer.isVisible && !layersHaveBeenActivatedByPermalink) {\n              cb.click();\n            }\n          }\n\n        });\n\n        // verifying the layer visibility for permalink\n        if (verifyingVisibility) {\n          map.getControlsByClass('OpenLayers.Control.ArgParser')[0].configureLayers();\n          for (var i = 0, len = layers.length; i < len; i++) {\n            var l = layers[i];\n            var btn = $('#switcher button.checkbox[name=\"layer\"][value=\"' + l.name + '\"]');\n            if ((hrefParam.layers && l.getVisibility() != btn.hasClass('checked')))\n              $('#switcher button.checkbox[name=\"layer\"][value=\"' + l.name + '\"]').click();\n          }\n        }\n\n        // checked all toggled layer\n        $('#switcher button.checkbox.disabled[name=\"layer\"]:not(.checked)').each(function () {\n          var cb = $(this);\n          var cleanName = cb.val();\n          var name = cleanName;\n          if (cleanName in cleanNameMap)\n            name = getLayerNameByCleanName(cleanName);\n          if (name in config.layers) {\n            var layerConfig = config.layers[name];\n            if (layerConfig.toggled == \"True\")\n              cb.addClass('checked');\n          }\n        });\n\n        // finalize slider\n        $('#navbar div.slider').slider(\"value\", map.getZoom());\n        map.events.on({\n          zoomend: function () {\n            // Update legends\n            $('#switcher table.tree tr.legendGraphics.initialized').each(function () {\n              var self = $(this);\n              var name = self.attr('id').replace('legend-', '');\n              var url = getLayerLegendGraphicUrl(name, true);\n              if (url != null && url != '') {\n                // Change image attribute data-src\n                self.find('div.legendGraphics img').attr('data-src', url);\n                // Only change image attribute src if legend is displayed\n                if (self.hasClass('visible')) {\n                  self.find('div.legendGraphics img').attr('src', url);\n                }\n              }\n            });\n            // update slider position\n            $('#navbar div.slider').slider(\"value\", this.getZoom());\n          }\n        });\n\n        // Connect signal/slot when layer style is changed\n        lizMap.events.on({\n          'layerstylechanged': function (evt) {\n\n            // Change legend data-src and legend src if legend is visible\n            var name = evt.featureType;\n            var url = getLayerLegendGraphicUrl(name, true);\n            if (url != null && url != '') {\n              var lSel = '#switcher table.tree tr#legend-' + name + ' div.legendGraphics img';\n              $(lSel).attr('data-src', url);\n              if ($('#switcher table.tree tr#legend-' + name).hasClass('visible'))\n                $(lSel).attr('src', url);\n            }\n          }\n        });\n\n        // Toggle locate\n        $('#mapmenu ul').on('click', 'li.nav-minidock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            lizMap.events.triggerEvent(\"minidockclosed\", { 'id': id });\n          } else {\n            var oldActive = $('#mapmenu li.nav-minidock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"minidockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.children('a').first().click();\n            parent.addClass('active');\n            lizMap.events.triggerEvent(\"minidockopened\", { 'id': id });\n            updateMiniDockSize();\n          }\n          self.blur();\n\n          return false;\n        });\n\n        // Show locate by layer\n        if (!('locateByLayer' in config))\n          $('#button-locate').parent().hide();\n        else\n          $('#button-locate').click();\n\n        // hide mini-dock if no tool is active\n        if ($('#mapmenu ul li.nav-minidock.active').length == 0) {\n          $('#mini-dock-content > .tab-pane.active').removeClass('active');\n          $('#mini-dock-tabs li.active').removeClass('active');\n        }\n\n        $('#mapmenu ul').on('click', 'li.nav-dock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          var lizmapEvent = '';\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            lizmapEvent = 'dockclosed';\n          } else {\n            var oldActive = $('#mapmenu li.nav-dock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"dockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.show();\n            tab.children('a').first().click();\n            parent.addClass('active');\n            lizmapEvent = 'dockopened';\n          }\n          self.blur();\n\n          var dock = $('#dock');\n          if ($('#dock-tabs .active').length == 0)\n            dock.hide();\n          else if (!dock.is(':visible'))\n            dock.show();\n\n          // trigger event\n          if (lizmapEvent != '')\n            lizMap.events.triggerEvent(lizmapEvent, { 'id': id });\n\n          return false;\n        });\n\n        $('#mapmenu ul').on('click', 'li.nav-right-dock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          var lizmapEvent = '';\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            var lizmapEvent = 'rightdockclosed';\n          } else {\n            var oldActive = $('#mapmenu li.nav-right-dock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"rightdockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.show();\n            tab.children('a').first().click();\n            parent.addClass('active');\n            var lizmapEvent = 'rightdockopened';\n          }\n          self.blur();\n\n          var dock = $('#right-dock');\n          if ($('#right-dock-tabs .active').length == 0) {\n            dock.hide();\n            $('#content').removeClass('right-dock-visible');\n            updateContentSize();\n          } else if (!dock.is(':visible')) {\n            $('#content').addClass('right-dock-visible');\n            dock.show();\n            updateContentSize();\n          }\n\n          // trigger event\n          if (lizmapEvent != '')\n            lizMap.events.triggerEvent(lizmapEvent, { 'id': id });\n          return false;\n        });\n\n        // Toggle menu visibility\n        $('#menuToggle').click(function(){\n          $(this).toggleClass('opened');\n        });\n\n        // Hide mapmenu when menu item is clicked in mobile context\n        $('#menuToggle:visible ~ #mapmenu ul').on('click', 'li > a', function () {\n          $('#menuToggle').removeClass('opened');\n        });\n\n        // Show layer switcher\n        $('#button-switcher').click();\n        updateContentSize();\n\n        $('#headermenu .navbar-inner .nav a[rel=\"tooltip\"]').tooltip();\n        $('#mapmenu .nav a[rel=\"tooltip\"]').tooltip();\n        self.events.triggerEvent(\"uicreated\", self);\n      })\n      .catch((error) => {\n        console.error(error);\n        const errorMsg = `\n          <p class=\"error-msg\">${lizDict['startup.error']}\n          <br><a href=\"${lizUrls.basepath}\">${lizDict['startup.goToProject']}</a></p>`;\n        document.getElementById('header').insertAdjacentHTML('afterend', errorMsg);\n      })\n      .finally(() => {\n        $('body').css('cursor', 'auto');\n        $('#loading').dialog('close');\n\n        // Display getFeatureInfo if requested\n        if(getFeatureInfo){\n          displayGetFeatureInfo(getFeatureInfo,\n            {\n              x: map.size.w / 2,\n              y: map.size.h / 2\n            });\n        }\n      });\n    }\n  };\n  // initializing the lizMap events\n  obj.events = new OpenLayers.Events(\n      obj, null,\n      ['treecreated','mapcreated','layersadded','uicreated',\n       'dockopened','dockclosed'],\n      true,\n      {includeXY: true}\n    );\n  return obj;\n}();\n/*\n * it's possible to add event listener\n * before the document is ready\n * but after this file\n */\nlizMap.events.on({\n    'mapcreated':function(evt){\n      // Add empty baselayer to the map\n      if ( ('emptyBaselayer' in evt.config.options)\n         && evt.config.options.emptyBaselayer == 'True') {\n        // creating the empty base layer\n        layerConfig = {};\n        layerConfig.title = lizDict['baselayer.empty.title'];\n        layerConfig.name = 'emptyBaselayer';\n        evt.config.layers['emptyBaselayer'] = layerConfig;\n\n        evt.baselayers.push(new OpenLayers.Layer.Vector('emptyBaselayer',{\n          isBaseLayer: true\n         ,maxExtent: evt.map.maxExtent\n         ,maxScale: evt.map.maxScale\n         ,minScale: evt.map.minScale\n         ,numZoomLevels: evt.map.numZoomLevels\n         ,scales: evt.map.scales\n         ,projection: evt.map.projection\n         ,units: evt.map.projection.proj.units\n        }));\n        evt.map.allOverlays = false;\n      }\n\n      // Add OpenStreetMap, Google Maps, Bing Maps, IGN Geoportail\n      // baselayers to the map\n      if (\n    (('osmMapnik' in evt.config.options)\n    && evt.config.options.osmMapnik == 'True') ||\n    (('osmStamenToner' in evt.config.options)\n     && evt.config.options.osmStamenToner == 'True') ||\n    (('openTopoMap' in evt.config.options)\n     && evt.config.options.openTopoMap == 'True') ||\n    (('osmCyclemap' in evt.config.options)\n     && evt.config.options.osmCyclemap == 'True'\n     && ('OCMKey' in evt.config.options)) ||\n    (('googleStreets' in evt.config.options)\n     && evt.config.options.googleStreets == 'True') ||\n    (('googleSatellite' in evt.config.options)\n     && evt.config.options.googleSatellite == 'True') ||\n    (('googleHybrid' in evt.config.options)\n     && evt.config.options.googleHybrid == 'True') ||\n    (('googleTerrain' in evt.config.options)\n     && evt.config.options.googleTerrain == 'True') ||\n    (('bingStreets' in evt.config.options)\n     && evt.config.options.bingStreets == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('bingSatellite' in evt.config.options)\n     && evt.config.options.bingSatellite == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('bingHybrid' in evt.config.options)\n     && evt.config.options.bingHybrid == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('ignTerrain' in evt.config.options)\n     && evt.config.options.ignTerrain == 'True') ||\n    (('ignStreets' in evt.config.options)\n     && evt.config.options.ignStreets == 'True') ||\n    (('ignSatellite' in evt.config.options)\n     && evt.config.options.ignSatellite == 'True') ||\n    (('ignCadastral' in evt.config.options)\n     && evt.config.options.ignCadastral == 'True')\n    ) {\n      //adding baselayers\n      var maxExtent = null;\n      if ( OpenLayers.Projection.defaults['EPSG:900913'].maxExtent )\n        maxExtent = new OpenLayers.Bounds(OpenLayers.Projection.defaults['EPSG:900913'].maxExtent);\n      else if ( OpenLayers.Projection.defaults['EPSG:3857'].maxExtent )\n        maxExtent = new OpenLayers.Bounds(OpenLayers.Projection.defaults['EPSG:3857'].maxExtent);\n\n      var lOptions = {zoomOffset:0,maxResolution:156543.03390625};\n      if (('resolutions' in evt.config.options)\n          && evt.config.options.resolutions.length != 0 ){\n        var resolutions = evt.config.options.resolutions;\n        var maxRes = resolutions[0];\n        var numZoomLevels = resolutions.length;\n        var zoomOffset = 0;\n        var res = 156543.03390625;\n        while ( res > maxRes ) {\n          zoomOffset += 1;\n          res = 156543.03390625 / Math.pow(2, zoomOffset);\n        }\n        lOptions['zoomOffset'] = zoomOffset;\n        lOptions['maxResolution'] = maxRes;\n        lOptions['numZoomLevels'] = numZoomLevels;\n      }\n\n      if (('osmMapnik' in evt.config.options) && evt.config.options.osmMapnik == 'True') {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var osm = new OpenLayers.Layer.OSM('osm',\n            [\n            \"https://tile.openstreetmap.org/${z}/${x}/${y}.png\",\n            ]\n            ,options\n            );\n        osm.maxExtent = maxExtent;\n        var osmCfg = {\n             \"name\":\"osm\"\n            ,\"title\":\"OpenStreetMap\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm'] = osmCfg;\n        evt.baselayers.push(osm);\n      }\n\n      if (('osmStamenToner' in evt.config.options) && evt.config.options.osmStamenToner == 'True') {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var stamenToner = new OpenLayers.Layer.OSM('osm-toner',\n            [\"https://stamen-tiles-a.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-b.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-c.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-d.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\"]\n            ,options\n            );\n        stamenToner.maxExtent = maxExtent;\n        var stamenTonerCfg = {\n          \"name\":\"osm-toner\"\n            ,\"title\":\"OSM Stamen Toner\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm-toner'] = stamenTonerCfg;\n        evt.baselayers.push(stamenToner);\n      }\n\n      if (('openTopoMap' in evt.config.options) && evt.config.options.openTopoMap == 'True') {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var openTopoMap = new OpenLayers.Layer.OSM('opentopomap',\n            [\"https://a.tile.opentopomap.org/{z}/{x}/{y}.png\",\n            \"https://b.tile.opentopomap.org/{z}/{x}/{y}.png\",\n            \"https://c.tile.opentopomap.org/{z}/{x}/{y}.png\"]\n            ,options\n            );\n            openTopoMap.maxExtent = maxExtent;\n        var openTopoMapCfg = {\n          \"name\":\"opentopomap\"\n            ,\"title\":\"OpenTopoMap\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['opentopomap'] = openTopoMapCfg;\n        evt.baselayers.push(openTopoMap);\n      }\n\n      if (('osmCyclemap' in evt.config.options) && evt.config.options.osmCyclemap == 'True' && ('OCMKey' in evt.config.options)) {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var cyclemap = new OpenLayers.Layer.OSM('osm-cyclemap','https://tile.thunderforest.com/cycle/${z}/${x}/${y}.png?apiKey='+evt.config.options.OCMKey,options);\n        cyclemap.maxExtent = maxExtent;\n        var cyclemapCfg = {\n             \"name\":\"osm-cycle\"\n            ,\"title\":\"OSM CycleMap\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm-cycle'] = cyclemapCfg;\n        evt.baselayers.push(cyclemap);\n      }\n      try {\n        if (('googleSatellite' in evt.config.options) && evt.config.options.googleSatellite == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:21\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var gsat = new OpenLayers.Layer.Google(\n              \"gsat\",\n              {type: google.maps.MapTypeId.SATELLITE\n                , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          gsat.maxExtent = maxExtent;\n          var gsatCfg = {\n               \"name\":\"gsat\"\n              ,\"title\":\"Google Satellite\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['gsat'] = gsatCfg;\n          evt.baselayers.push(gsat);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n        }\n        if (('googleHybrid' in evt.config.options) && evt.config.options.googleHybrid == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ghyb = new OpenLayers.Layer.Google(\n              \"ghyb\",\n              {type: google.maps.MapTypeId.HYBRID\n                , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          ghyb.maxExtent = maxExtent;\n          var ghybCfg = {\n               \"name\":\"ghyb\"\n              ,\"title\":\"Google Hybrid\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['ghyb'] = ghybCfg;\n          evt.baselayers.push(ghyb);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n        }\n        if (('googleTerrain' in evt.config.options) && evt.config.options.googleTerrain == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:16\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var gphy = new OpenLayers.Layer.Google(\n              \"gphy\",\n              {type: google.maps.MapTypeId.TERRAIN\n              , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          gphy.maxExtent = maxExtent;\n          var gphyCfg = {\n               \"name\":\"gphy\"\n              ,\"title\":\"Google Terrain\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['gphy'] = gphyCfg;\n          evt.baselayers.push(gphy);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n       }\n       if (('googleStreets' in evt.config.options) && evt.config.options.googleStreets == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n         var gmap = new OpenLayers.Layer.Google(\n             \"gmap\", // the default\n             {numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n             );\n         gmap.maxExtent = maxExtent;\n         var gmapCfg = {\n              \"name\":\"gmap\"\n             ,\"title\":\"Google Streets\"\n             ,\"type\":\"baselayer\"\n         };\n         evt.config.layers['gmap'] = gmapCfg;\n         evt.baselayers.push(gmap);\n         evt.map.allOverlays = false;\n         evt.map.zoomDuration = 0;\n       }\n       if (('bingStreets' in evt.config.options) && evt.config.options.bingStreets == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var bmap = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"Road\",\n             name: \"Bing Road\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          bmap.maxExtent = maxExtent;\n          var bmapCfg = {\n             \"name\":\"bmap\"\n            ,\"title\":\"Bing Road\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['bmap'] = bmapCfg;\n          evt.baselayers.push(bmap);\n          evt.map.allOverlays = false;\n       }\n       if (('bingSatellite' in evt.config.options) && evt.config.options.bingSatellite == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var baerial = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"Aerial\",\n             name: \"Bing Aerial\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          baerial.maxExtent = maxExtent;\n          var baerialCfg = {\n             \"name\":\"baerial\"\n            ,\"title\":\"Bing Aerial\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['baerial'] = baerialCfg;\n          evt.baselayers.push(baerial);\n          evt.map.allOverlays = false;\n       }\n       if (('bingHybrid' in evt.config.options) && evt.config.options.bingHybrid == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var bhybrid = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"AerialWithLabels\",\n             name: \"Bing Hybrid\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          bhybrid.maxExtent = maxExtent;\n          var bhybridCfg = {\n             \"name\":\"bhybrid\"\n            ,\"title\":\"Bing Hybrid\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['bhybrid'] = bhybridCfg;\n          evt.baselayers.push(bhybrid);\n          evt.map.allOverlays = false;\n       }\n\n       var ignAttribution = '<a href=\"http://www.ign.fr\" target=\"_blank\"><img width=\"25\" src=\"https://wxs.ign.fr/static/logos/IGN/IGN.gif\" title=\"Institut national de l\\'information géographique et forestière\" alt=\"IGN\"></a>';\n\n       // IGN base layers\n        if ('ignKey' in evt.config.options){\n          var ignKey = evt.config.options.ignKey;\n\n          if (('ignTerrain' in evt.config.options) && evt.config.options.ignTerrain == 'True') {\n            var options = {\n              zoomOffset: 0,\n              maxResolution: 156543.03390625,\n              numZoomLevels: 18\n            };\n            if (lOptions.zoomOffset != 0) {\n              options.zoomOffset = lOptions.zoomOffset;\n              options.maxResolution = lOptions.maxResolution;\n            }\n            if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n              options.numZoomLevels = lOptions.numZoomLevels;\n            else\n              options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n            var ignmap = new OpenLayers.Layer.WMTS({\n              name: \"ignmap\",\n              url: \"https://wxs.ign.fr/\" + ignKey + \"/geoportail/wmts\",\n              layer: \"GEOGRAPHICALGRIDSYSTEMS.MAPS\",\n              matrixSet: \"PM\",\n              style: \"normal\",\n              projection: new OpenLayers.Projection(\"EPSG:3857\"),\n              attribution: ignAttribution\n              , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n              , zoomOffset: options.zoomOffset\n\n            });\n            ignmap.maxExtent = maxExtent;\n            var ignmapCfg = {\n              \"name\": \"ignmap\"\n              , \"title\": \"IGN Scan\"\n              , \"type\": \"baselayer\"\n            };\n            evt.config.layers['ignmap'] = ignmapCfg;\n            evt.baselayers.push(ignmap);\n            evt.map.allOverlays = false;\n          }\n        }\n        if (('ignStreets' in evt.config.options) && evt.config.options.ignStreets == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 18\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ignplan = new OpenLayers.Layer.WMTS({\n            name: \"ignplan\",\n            url: \"https://wxs.ign.fr/cartes/geoportail/wmts\",\n            layer: \"GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            format: \"image/png\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          ignplan.maxExtent = maxExtent;\n          var ignplanCfg = {\n            \"name\": \"ignplan\"\n            , \"title\": \"IGN Plan\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['ignplan'] = ignplanCfg;\n          evt.baselayers.push(ignplan);\n          evt.map.allOverlays = false;\n        }\n        if (('ignSatellite' in evt.config.options) && evt.config.options.ignSatellite == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 22\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ignphoto = new OpenLayers.Layer.WMTS({\n            name: \"ignphoto\",\n            url: \"https://wxs.ign.fr/ortho/geoportail/wmts\",\n            layer: \"ORTHOIMAGERY.ORTHOPHOTOS\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          ignphoto.maxExtent = maxExtent;\n          var ignphotoCfg = {\n            \"name\": \"ignphoto\"\n            , \"title\": \"IGN Photos\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['ignphoto'] = ignphotoCfg;\n          evt.baselayers.push(ignphoto);\n          evt.map.allOverlays = false;\n        }\n        if (('ignCadastral' in evt.config.options) && evt.config.options.ignCadastral == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var igncadastral = new OpenLayers.Layer.WMTS({\n            name: \"igncadastral\",\n            url: \"https://wxs.ign.fr/parcellaire/geoportail/wmts\",\n            layer: \"CADASTRALPARCELS.PARCELLAIRE_EXPRESS\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            format: \"image/png\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          igncadastral.maxExtent = maxExtent;\n          var igncadastralCfg = {\n            \"name\": \"igncadastral\"\n            , \"title\": \"IGN Cadastre\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['igncadastral'] = igncadastralCfg;\n          evt.baselayers.push(igncadastral);\n          evt.map.allOverlays = false;\n        }\n      } catch(e) {\n       }\n     }\n\n      if('lizmapExternalBaselayers' in evt.config){\n\n        var externalService = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        );\n        if (lizUrls.publicUrlList && lizUrls.publicUrlList.length > 1 ) {\n            externalService = [];\n            for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n              externalService.push(\n                OpenLayers.Util.urlAppend(\n                  lizUrls.publicUrlList[j],\n                  OpenLayers.Util.getParameterString(lizUrls.params)\n                )\n              );\n            }\n        }\n\n        // Add lizmap external baselayers\n        for (var id in evt.config['lizmapExternalBaselayers']) {\n\n          var layerConfig = evt.config['lizmapExternalBaselayers'][id];\n\n          if (!('repository' in layerConfig) || !('project' in layerConfig))\n            continue;\n\n          var layerName = evt.cleanName(layerConfig.layerName);\n\n          var layerWmsParams = {\n            layers:layerConfig.layerName\n            ,version:'1.3.0'\n            ,exceptions:'application/vnd.ogc.se_inimage'\n            ,format:(layerConfig.layerImageFormat) ? 'image/'+layerConfig.layerImageFormat : 'image/png'\n            ,dpi:96\n          };\n          if (layerWmsParams.format != 'image/jpeg')\n            layerWmsParams['transparent'] = true;\n\n          // Change repository and project in service URL\n          var reg = new RegExp('repository\\=(.+)&project\\=(.+)', 'g');\n          if (! (externalService instanceof Array) )\n            var url = externalService.replace(reg, 'repository='+layerConfig.repository+'&project='+layerConfig.project);\n          else\n            var url = jQuery.map(externalService, function(element) { return element.replace(reg, 'repository='+layerConfig.repository+'&project='+layerConfig.project) });\n\n          // creating the base layer\n          layerConfig.title = layerConfig.layerTitle\n          layerConfig.name = layerConfig.layerName\n          layerConfig.baselayer = true;\n          layerConfig.singleTile = \"False\";\n          evt.config.layers[layerName] = layerConfig;\n          evt.baselayers.push(new OpenLayers.Layer.WMS(layerName,url\n            ,layerWmsParams\n            ,{isBaseLayer:true\n            ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n            ,buffer:0\n            ,singleTile:(layerConfig.singleTile == 'True')\n            ,ratio:1\n          }));\n          evt.map.allOverlays = false;\n\n        }\n      }\n\n    }\n   ,\n   'uicreated': function(evt){\n     var map = evt.map;\n     if ( map.id in OpenLayers.Layer.Google.cache ) {\n        google.maps.event.addListenerOnce(OpenLayers.Layer.Google.cache[map.id].mapObject, 'tilesloaded', function() {\n            var olLayers = map.layers;\n            var gVisibility = false;\n            for (var i=olLayers.length-1; i>=0; --i) {\n                var layer = olLayers[i];\n                if (layer instanceof OpenLayers.Layer.Google &&\n                            layer.visibility === true && layer.inRange === true) {\n                    layer.redraw(true);\n                    gVisibility = true;\n                    break;\n                }\n            }\n            if (!gVisibility) {\n                for (var i=olLayers.length-1; i>=0; --i) {\n                    var layer = olLayers[i];\n                    if (layer instanceof OpenLayers.Layer.Google) {\n                        layer.display(false);\n                        break;\n                    }\n                }\n            }\n        });\n     }\n\n      // Update legend if mobile\n      if( lizMap.checkMobile() ){\n        if( $('#button-switcher').parent().hasClass('active') )\n          $('#button-switcher').click();\n      }\n\n      // Connect dock close button\n      $('#dock-close').click(function(){ $('#mapmenu .nav-list > li.active.nav-dock > a').click(); });\n      $('#right-dock-close').click(function(){ $('#mapmenu .nav-list > li.active.nav-right-dock > a').click(); });\n   }\n\n});\n\n$(document).ready(function () {\n  // start waiting\n  $('body').css('cursor', 'wait');\n  $('#loading').dialog({\n    modal: true\n    , draggable: false\n    , resizable: false\n    , closeOnEscape: false\n    , dialogClass: 'liz-dialog-wait'\n    , minHeight: 128\n  })\n  .parent().removeClass('ui-corner-all')\n  .children('.ui-dialog-titlebar').removeClass('ui-corner-all');\n  // configurate OpenLayers\n  OpenLayers.DOTS_PER_INCH = 96;\n  // initialize LizMap\n  lizMap.init();\n  $( \"#loading\" ).css('min-height','128px');\n});\n","/**\n * @module ol/extent\n */\nimport Relationship from './extent/Relationship.js';\nimport {assert} from './asserts.js';\n\n/**\n * An array of numbers representing an extent: `[minx, miny, maxx, maxy]`.\n * @typedef {Array<number>} Extent\n * @api\n */\n\n/**\n * Extent corner.\n * @typedef {'bottom-left' | 'bottom-right' | 'top-left' | 'top-right'} Corner\n */\n\n/**\n * Build an extent that includes all given coordinates.\n *\n * @param {Array<import(\"./coordinate.js\").Coordinate>} coordinates Coordinates.\n * @return {Extent} Bounding extent.\n * @api\n */\nexport function boundingExtent(coordinates) {\n  const extent = createEmpty();\n  for (let i = 0, ii = coordinates.length; i < ii; ++i) {\n    extendCoordinate(extent, coordinates[i]);\n  }\n  return extent;\n}\n\n/**\n * @param {Array<number>} xs Xs.\n * @param {Array<number>} ys Ys.\n * @param {Extent} [dest] Destination extent.\n * @private\n * @return {Extent} Extent.\n */\nfunction _boundingExtentXYs(xs, ys, dest) {\n  const minX = Math.min.apply(null, xs);\n  const minY = Math.min.apply(null, ys);\n  const maxX = Math.max.apply(null, xs);\n  const maxY = Math.max.apply(null, ys);\n  return createOrUpdate(minX, minY, maxX, maxY, dest);\n}\n\n/**\n * Return extent increased by the provided value.\n * @param {Extent} extent Extent.\n * @param {number} value The amount by which the extent should be buffered.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n * @api\n */\nexport function buffer(extent, value, dest) {\n  if (dest) {\n    dest[0] = extent[0] - value;\n    dest[1] = extent[1] - value;\n    dest[2] = extent[2] + value;\n    dest[3] = extent[3] + value;\n    return dest;\n  }\n  return [\n    extent[0] - value,\n    extent[1] - value,\n    extent[2] + value,\n    extent[3] + value,\n  ];\n}\n\n/**\n * Creates a clone of an extent.\n *\n * @param {Extent} extent Extent to clone.\n * @param {Extent} [dest] Extent.\n * @return {Extent} The clone.\n */\nexport function clone(extent, dest) {\n  if (dest) {\n    dest[0] = extent[0];\n    dest[1] = extent[1];\n    dest[2] = extent[2];\n    dest[3] = extent[3];\n    return dest;\n  }\n  return extent.slice();\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {number} x X.\n * @param {number} y Y.\n * @return {number} Closest squared distance.\n */\nexport function closestSquaredDistanceXY(extent, x, y) {\n  let dx, dy;\n  if (x < extent[0]) {\n    dx = extent[0] - x;\n  } else if (extent[2] < x) {\n    dx = x - extent[2];\n  } else {\n    dx = 0;\n  }\n  if (y < extent[1]) {\n    dy = extent[1] - y;\n  } else if (extent[3] < y) {\n    dy = y - extent[3];\n  } else {\n    dy = 0;\n  }\n  return dx * dx + dy * dy;\n}\n\n/**\n * Check if the passed coordinate is contained or on the edge of the extent.\n *\n * @param {Extent} extent Extent.\n * @param {import(\"./coordinate.js\").Coordinate} coordinate Coordinate.\n * @return {boolean} The coordinate is contained in the extent.\n * @api\n */\nexport function containsCoordinate(extent, coordinate) {\n  return containsXY(extent, coordinate[0], coordinate[1]);\n}\n\n/**\n * Check if one extent contains another.\n *\n * An extent is deemed contained if it lies completely within the other extent,\n * including if they share one or more edges.\n *\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @return {boolean} The second extent is contained by or on the edge of the\n *     first.\n * @api\n */\nexport function containsExtent(extent1, extent2) {\n  return (\n    extent1[0] <= extent2[0] &&\n    extent2[2] <= extent1[2] &&\n    extent1[1] <= extent2[1] &&\n    extent2[3] <= extent1[3]\n  );\n}\n\n/**\n * Check if the passed coordinate is contained or on the edge of the extent.\n *\n * @param {Extent} extent Extent.\n * @param {number} x X coordinate.\n * @param {number} y Y coordinate.\n * @return {boolean} The x, y values are contained in the extent.\n * @api\n */\nexport function containsXY(extent, x, y) {\n  return extent[0] <= x && x <= extent[2] && extent[1] <= y && y <= extent[3];\n}\n\n/**\n * Get the relationship between a coordinate and extent.\n * @param {Extent} extent The extent.\n * @param {import(\"./coordinate.js\").Coordinate} coordinate The coordinate.\n * @return {import(\"./extent/Relationship.js\").default} The relationship (bitwise compare with\n *     import(\"./extent/Relationship.js\").Relationship).\n */\nexport function coordinateRelationship(extent, coordinate) {\n  const minX = extent[0];\n  const minY = extent[1];\n  const maxX = extent[2];\n  const maxY = extent[3];\n  const x = coordinate[0];\n  const y = coordinate[1];\n  let relationship = Relationship.UNKNOWN;\n  if (x < minX) {\n    relationship = relationship | Relationship.LEFT;\n  } else if (x > maxX) {\n    relationship = relationship | Relationship.RIGHT;\n  }\n  if (y < minY) {\n    relationship = relationship | Relationship.BELOW;\n  } else if (y > maxY) {\n    relationship = relationship | Relationship.ABOVE;\n  }\n  if (relationship === Relationship.UNKNOWN) {\n    relationship = Relationship.INTERSECTING;\n  }\n  return relationship;\n}\n\n/**\n * Create an empty extent.\n * @return {Extent} Empty extent.\n * @api\n */\nexport function createEmpty() {\n  return [Infinity, Infinity, -Infinity, -Infinity];\n}\n\n/**\n * Create a new extent or update the provided extent.\n * @param {number} minX Minimum X.\n * @param {number} minY Minimum Y.\n * @param {number} maxX Maximum X.\n * @param {number} maxY Maximum Y.\n * @param {Extent} [dest] Destination extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdate(minX, minY, maxX, maxY, dest) {\n  if (dest) {\n    dest[0] = minX;\n    dest[1] = minY;\n    dest[2] = maxX;\n    dest[3] = maxY;\n    return dest;\n  }\n  return [minX, minY, maxX, maxY];\n}\n\n/**\n * Create a new empty extent or make the provided one empty.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdateEmpty(dest) {\n  return createOrUpdate(Infinity, Infinity, -Infinity, -Infinity, dest);\n}\n\n/**\n * @param {import(\"./coordinate.js\").Coordinate} coordinate Coordinate.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdateFromCoordinate(coordinate, dest) {\n  const x = coordinate[0];\n  const y = coordinate[1];\n  return createOrUpdate(x, y, x, y, dest);\n}\n\n/**\n * @param {Array<import(\"./coordinate.js\").Coordinate>} coordinates Coordinates.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdateFromCoordinates(coordinates, dest) {\n  const extent = createOrUpdateEmpty(dest);\n  return extendCoordinates(extent, coordinates);\n}\n\n/**\n * @param {Array<number>} flatCoordinates Flat coordinates.\n * @param {number} offset Offset.\n * @param {number} end End.\n * @param {number} stride Stride.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdateFromFlatCoordinates(\n  flatCoordinates,\n  offset,\n  end,\n  stride,\n  dest\n) {\n  const extent = createOrUpdateEmpty(dest);\n  return extendFlatCoordinates(extent, flatCoordinates, offset, end, stride);\n}\n\n/**\n * @param {Array<Array<import(\"./coordinate.js\").Coordinate>>} rings Rings.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function createOrUpdateFromRings(rings, dest) {\n  const extent = createOrUpdateEmpty(dest);\n  return extendRings(extent, rings);\n}\n\n/**\n * Determine if two extents are equivalent.\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @return {boolean} The two extents are equivalent.\n * @api\n */\nexport function equals(extent1, extent2) {\n  return (\n    extent1[0] == extent2[0] &&\n    extent1[2] == extent2[2] &&\n    extent1[1] == extent2[1] &&\n    extent1[3] == extent2[3]\n  );\n}\n\n/**\n * Determine if two extents are approximately equivalent.\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @param {number} tolerance Tolerance in extent coordinate units.\n * @return {boolean} The two extents differ by less than the tolerance.\n */\nexport function approximatelyEquals(extent1, extent2, tolerance) {\n  return (\n    Math.abs(extent1[0] - extent2[0]) < tolerance &&\n    Math.abs(extent1[2] - extent2[2]) < tolerance &&\n    Math.abs(extent1[1] - extent2[1]) < tolerance &&\n    Math.abs(extent1[3] - extent2[3]) < tolerance\n  );\n}\n\n/**\n * Modify an extent to include another extent.\n * @param {Extent} extent1 The extent to be modified.\n * @param {Extent} extent2 The extent that will be included in the first.\n * @return {Extent} A reference to the first (extended) extent.\n * @api\n */\nexport function extend(extent1, extent2) {\n  if (extent2[0] < extent1[0]) {\n    extent1[0] = extent2[0];\n  }\n  if (extent2[2] > extent1[2]) {\n    extent1[2] = extent2[2];\n  }\n  if (extent2[1] < extent1[1]) {\n    extent1[1] = extent2[1];\n  }\n  if (extent2[3] > extent1[3]) {\n    extent1[3] = extent2[3];\n  }\n  return extent1;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {import(\"./coordinate.js\").Coordinate} coordinate Coordinate.\n */\nexport function extendCoordinate(extent, coordinate) {\n  if (coordinate[0] < extent[0]) {\n    extent[0] = coordinate[0];\n  }\n  if (coordinate[0] > extent[2]) {\n    extent[2] = coordinate[0];\n  }\n  if (coordinate[1] < extent[1]) {\n    extent[1] = coordinate[1];\n  }\n  if (coordinate[1] > extent[3]) {\n    extent[3] = coordinate[1];\n  }\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {Array<import(\"./coordinate.js\").Coordinate>} coordinates Coordinates.\n * @return {Extent} Extent.\n */\nexport function extendCoordinates(extent, coordinates) {\n  for (let i = 0, ii = coordinates.length; i < ii; ++i) {\n    extendCoordinate(extent, coordinates[i]);\n  }\n  return extent;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {Array<number>} flatCoordinates Flat coordinates.\n * @param {number} offset Offset.\n * @param {number} end End.\n * @param {number} stride Stride.\n * @return {Extent} Extent.\n */\nexport function extendFlatCoordinates(\n  extent,\n  flatCoordinates,\n  offset,\n  end,\n  stride\n) {\n  for (; offset < end; offset += stride) {\n    extendXY(extent, flatCoordinates[offset], flatCoordinates[offset + 1]);\n  }\n  return extent;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {Array<Array<import(\"./coordinate.js\").Coordinate>>} rings Rings.\n * @return {Extent} Extent.\n */\nexport function extendRings(extent, rings) {\n  for (let i = 0, ii = rings.length; i < ii; ++i) {\n    extendCoordinates(extent, rings[i]);\n  }\n  return extent;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {number} x X.\n * @param {number} y Y.\n */\nexport function extendXY(extent, x, y) {\n  extent[0] = Math.min(extent[0], x);\n  extent[1] = Math.min(extent[1], y);\n  extent[2] = Math.max(extent[2], x);\n  extent[3] = Math.max(extent[3], y);\n}\n\n/**\n * This function calls `callback` for each corner of the extent. If the\n * callback returns a truthy value the function returns that value\n * immediately. Otherwise the function returns `false`.\n * @param {Extent} extent Extent.\n * @param {function(import(\"./coordinate.js\").Coordinate): S} callback Callback.\n * @return {S|boolean} Value.\n * @template S\n */\nexport function forEachCorner(extent, callback) {\n  let val;\n  val = callback(getBottomLeft(extent));\n  if (val) {\n    return val;\n  }\n  val = callback(getBottomRight(extent));\n  if (val) {\n    return val;\n  }\n  val = callback(getTopRight(extent));\n  if (val) {\n    return val;\n  }\n  val = callback(getTopLeft(extent));\n  if (val) {\n    return val;\n  }\n  return false;\n}\n\n/**\n * Get the size of an extent.\n * @param {Extent} extent Extent.\n * @return {number} Area.\n * @api\n */\nexport function getArea(extent) {\n  let area = 0;\n  if (!isEmpty(extent)) {\n    area = getWidth(extent) * getHeight(extent);\n  }\n  return area;\n}\n\n/**\n * Get the bottom left coordinate of an extent.\n * @param {Extent} extent Extent.\n * @return {import(\"./coordinate.js\").Coordinate} Bottom left coordinate.\n * @api\n */\nexport function getBottomLeft(extent) {\n  return [extent[0], extent[1]];\n}\n\n/**\n * Get the bottom right coordinate of an extent.\n * @param {Extent} extent Extent.\n * @return {import(\"./coordinate.js\").Coordinate} Bottom right coordinate.\n * @api\n */\nexport function getBottomRight(extent) {\n  return [extent[2], extent[1]];\n}\n\n/**\n * Get the center coordinate of an extent.\n * @param {Extent} extent Extent.\n * @return {import(\"./coordinate.js\").Coordinate} Center.\n * @api\n */\nexport function getCenter(extent) {\n  return [(extent[0] + extent[2]) / 2, (extent[1] + extent[3]) / 2];\n}\n\n/**\n * Get a corner coordinate of an extent.\n * @param {Extent} extent Extent.\n * @param {Corner} corner Corner.\n * @return {import(\"./coordinate.js\").Coordinate} Corner coordinate.\n */\nexport function getCorner(extent, corner) {\n  let coordinate;\n  if (corner === 'bottom-left') {\n    coordinate = getBottomLeft(extent);\n  } else if (corner === 'bottom-right') {\n    coordinate = getBottomRight(extent);\n  } else if (corner === 'top-left') {\n    coordinate = getTopLeft(extent);\n  } else if (corner === 'top-right') {\n    coordinate = getTopRight(extent);\n  } else {\n    assert(false, 13); // Invalid corner\n  }\n  return coordinate;\n}\n\n/**\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @return {number} Enlarged area.\n */\nexport function getEnlargedArea(extent1, extent2) {\n  const minX = Math.min(extent1[0], extent2[0]);\n  const minY = Math.min(extent1[1], extent2[1]);\n  const maxX = Math.max(extent1[2], extent2[2]);\n  const maxY = Math.max(extent1[3], extent2[3]);\n  return (maxX - minX) * (maxY - minY);\n}\n\n/**\n * @param {import(\"./coordinate.js\").Coordinate} center Center.\n * @param {number} resolution Resolution.\n * @param {number} rotation Rotation.\n * @param {import(\"./size.js\").Size} size Size.\n * @param {Extent} [dest] Destination extent.\n * @return {Extent} Extent.\n */\nexport function getForViewAndSize(center, resolution, rotation, size, dest) {\n  const [x0, y0, x1, y1, x2, y2, x3, y3] = getRotatedViewport(\n    center,\n    resolution,\n    rotation,\n    size\n  );\n  return createOrUpdate(\n    Math.min(x0, x1, x2, x3),\n    Math.min(y0, y1, y2, y3),\n    Math.max(x0, x1, x2, x3),\n    Math.max(y0, y1, y2, y3),\n    dest\n  );\n}\n\n/**\n * @param {import(\"./coordinate.js\").Coordinate} center Center.\n * @param {number} resolution Resolution.\n * @param {number} rotation Rotation.\n * @param {import(\"./size.js\").Size} size Size.\n * @return {Array<number>} Linear ring representing the viewport.\n */\nexport function getRotatedViewport(center, resolution, rotation, size) {\n  const dx = (resolution * size[0]) / 2;\n  const dy = (resolution * size[1]) / 2;\n  const cosRotation = Math.cos(rotation);\n  const sinRotation = Math.sin(rotation);\n  const xCos = dx * cosRotation;\n  const xSin = dx * sinRotation;\n  const yCos = dy * cosRotation;\n  const ySin = dy * sinRotation;\n  const x = center[0];\n  const y = center[1];\n  return [\n    x - xCos + ySin,\n    y - xSin - yCos,\n    x - xCos - ySin,\n    y - xSin + yCos,\n    x + xCos - ySin,\n    y + xSin + yCos,\n    x + xCos + ySin,\n    y + xSin - yCos,\n    x - xCos + ySin,\n    y - xSin - yCos,\n  ];\n}\n\n/**\n * Get the height of an extent.\n * @param {Extent} extent Extent.\n * @return {number} Height.\n * @api\n */\nexport function getHeight(extent) {\n  return extent[3] - extent[1];\n}\n\n/**\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @return {number} Intersection area.\n */\nexport function getIntersectionArea(extent1, extent2) {\n  const intersection = getIntersection(extent1, extent2);\n  return getArea(intersection);\n}\n\n/**\n * Get the intersection of two extents.\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent 2.\n * @param {Extent} [dest] Optional extent to populate with intersection.\n * @return {Extent} Intersecting extent.\n * @api\n */\nexport function getIntersection(extent1, extent2, dest) {\n  const intersection = dest ? dest : createEmpty();\n  if (intersects(extent1, extent2)) {\n    if (extent1[0] > extent2[0]) {\n      intersection[0] = extent1[0];\n    } else {\n      intersection[0] = extent2[0];\n    }\n    if (extent1[1] > extent2[1]) {\n      intersection[1] = extent1[1];\n    } else {\n      intersection[1] = extent2[1];\n    }\n    if (extent1[2] < extent2[2]) {\n      intersection[2] = extent1[2];\n    } else {\n      intersection[2] = extent2[2];\n    }\n    if (extent1[3] < extent2[3]) {\n      intersection[3] = extent1[3];\n    } else {\n      intersection[3] = extent2[3];\n    }\n  } else {\n    createOrUpdateEmpty(intersection);\n  }\n  return intersection;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @return {number} Margin.\n */\nexport function getMargin(extent) {\n  return getWidth(extent) + getHeight(extent);\n}\n\n/**\n * Get the size (width, height) of an extent.\n * @param {Extent} extent The extent.\n * @return {import(\"./size.js\").Size} The extent size.\n * @api\n */\nexport function getSize(extent) {\n  return [extent[2] - extent[0], extent[3] - extent[1]];\n}\n\n/**\n * Get the top left coordinate of an extent.\n * @param {Extent} extent Extent.\n * @return {import(\"./coordinate.js\").Coordinate} Top left coordinate.\n * @api\n */\nexport function getTopLeft(extent) {\n  return [extent[0], extent[3]];\n}\n\n/**\n * Get the top right coordinate of an extent.\n * @param {Extent} extent Extent.\n * @return {import(\"./coordinate.js\").Coordinate} Top right coordinate.\n * @api\n */\nexport function getTopRight(extent) {\n  return [extent[2], extent[3]];\n}\n\n/**\n * Get the width of an extent.\n * @param {Extent} extent Extent.\n * @return {number} Width.\n * @api\n */\nexport function getWidth(extent) {\n  return extent[2] - extent[0];\n}\n\n/**\n * Determine if one extent intersects another.\n * @param {Extent} extent1 Extent 1.\n * @param {Extent} extent2 Extent.\n * @return {boolean} The two extents intersect.\n * @api\n */\nexport function intersects(extent1, extent2) {\n  return (\n    extent1[0] <= extent2[2] &&\n    extent1[2] >= extent2[0] &&\n    extent1[1] <= extent2[3] &&\n    extent1[3] >= extent2[1]\n  );\n}\n\n/**\n * Determine if an extent is empty.\n * @param {Extent} extent Extent.\n * @return {boolean} Is empty.\n * @api\n */\nexport function isEmpty(extent) {\n  return extent[2] < extent[0] || extent[3] < extent[1];\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {Extent} [dest] Extent.\n * @return {Extent} Extent.\n */\nexport function returnOrUpdate(extent, dest) {\n  if (dest) {\n    dest[0] = extent[0];\n    dest[1] = extent[1];\n    dest[2] = extent[2];\n    dest[3] = extent[3];\n    return dest;\n  }\n  return extent;\n}\n\n/**\n * @param {Extent} extent Extent.\n * @param {number} value Value.\n */\nexport function scaleFromCenter(extent, value) {\n  const deltaX = ((extent[2] - extent[0]) / 2) * (value - 1);\n  const deltaY = ((extent[3] - extent[1]) / 2) * (value - 1);\n  extent[0] -= deltaX;\n  extent[2] += deltaX;\n  extent[1] -= deltaY;\n  extent[3] += deltaY;\n}\n\n/**\n * Determine if the segment between two coordinates intersects (crosses,\n * touches, or is contained by) the provided extent.\n * @param {Extent} extent The extent.\n * @param {import(\"./coordinate.js\").Coordinate} start Segment start coordinate.\n * @param {import(\"./coordinate.js\").Coordinate} end Segment end coordinate.\n * @return {boolean} The segment intersects the extent.\n */\nexport function intersectsSegment(extent, start, end) {\n  let intersects = false;\n  const startRel = coordinateRelationship(extent, start);\n  const endRel = coordinateRelationship(extent, end);\n  if (\n    startRel === Relationship.INTERSECTING ||\n    endRel === Relationship.INTERSECTING\n  ) {\n    intersects = true;\n  } else {\n    const minX = extent[0];\n    const minY = extent[1];\n    const maxX = extent[2];\n    const maxY = extent[3];\n    const startX = start[0];\n    const startY = start[1];\n    const endX = end[0];\n    const endY = end[1];\n    const slope = (endY - startY) / (endX - startX);\n    let x, y;\n    if (!!(endRel & Relationship.ABOVE) && !(startRel & Relationship.ABOVE)) {\n      // potentially intersects top\n      x = endX - (endY - maxY) / slope;\n      intersects = x >= minX && x <= maxX;\n    }\n    if (\n      !intersects &&\n      !!(endRel & Relationship.RIGHT) &&\n      !(startRel & Relationship.RIGHT)\n    ) {\n      // potentially intersects right\n      y = endY - (endX - maxX) * slope;\n      intersects = y >= minY && y <= maxY;\n    }\n    if (\n      !intersects &&\n      !!(endRel & Relationship.BELOW) &&\n      !(startRel & Relationship.BELOW)\n    ) {\n      // potentially intersects bottom\n      x = endX - (endY - minY) / slope;\n      intersects = x >= minX && x <= maxX;\n    }\n    if (\n      !intersects &&\n      !!(endRel & Relationship.LEFT) &&\n      !(startRel & Relationship.LEFT)\n    ) {\n      // potentially intersects left\n      y = endY - (endX - minX) * slope;\n      intersects = y >= minY && y <= maxY;\n    }\n  }\n  return intersects;\n}\n\n/**\n * Apply a transform function to the extent.\n * @param {Extent} extent Extent.\n * @param {import(\"./proj.js\").TransformFunction} transformFn Transform function.\n * Called with `[minX, minY, maxX, maxY]` extent coordinates.\n * @param {Extent} [dest] Destination extent.\n * @param {number} [stops] Number of stops per side used for the transform.\n * By default only the corners are used.\n * @return {Extent} Extent.\n * @api\n */\nexport function applyTransform(extent, transformFn, dest, stops) {\n  let coordinates = [];\n  if (stops > 1) {\n    const width = extent[2] - extent[0];\n    const height = extent[3] - extent[1];\n    for (let i = 0; i < stops; ++i) {\n      coordinates.push(\n        extent[0] + (width * i) / stops,\n        extent[1],\n        extent[2],\n        extent[1] + (height * i) / stops,\n        extent[2] - (width * i) / stops,\n        extent[3],\n        extent[0],\n        extent[3] - (height * i) / stops\n      );\n    }\n  } else {\n    coordinates = [\n      extent[0],\n      extent[1],\n      extent[2],\n      extent[1],\n      extent[2],\n      extent[3],\n      extent[0],\n      extent[3],\n    ];\n  }\n  transformFn(coordinates, coordinates, 2);\n  const xs = [];\n  const ys = [];\n  for (let i = 0, l = coordinates.length; i < l; i += 2) {\n    xs.push(coordinates[i]);\n    ys.push(coordinates[i + 1]);\n  }\n  return _boundingExtentXYs(xs, ys, dest);\n}\n\n/**\n * Modifies the provided extent in-place to be within the real world\n * extent.\n *\n * @param {Extent} extent Extent.\n * @param {import(\"./proj/Projection.js\").default} projection Projection\n * @return {Extent} The extent within the real world extent.\n */\nexport function wrapX(extent, projection) {\n  const projectionExtent = projection.getExtent();\n  const center = getCenter(extent);\n  if (\n    projection.canWrapX() &&\n    (center[0] < projectionExtent[0] || center[0] >= projectionExtent[2])\n  ) {\n    const worldWidth = getWidth(projectionExtent);\n    const worldsAway = Math.floor(\n      (center[0] - projectionExtent[0]) / worldWidth\n    );\n    const offset = worldsAway * worldWidth;\n    extent[0] -= offset;\n    extent[2] -= offset;\n  }\n  return extent;\n}\n\n/**\n * Fits the extent to the real world\n *\n * If the extent does not cross the anti meridian, this will return the extent in an array\n * If the extent crosses the anti meridian, the extent will be sliced, so each part fits within the\n * real world\n *\n *\n * @param {Extent} extent Extent.\n * @param {import(\"./proj/Projection.js\").default} projection Projection\n * @return {Array<Extent>} The extent within the real world extent.\n */\nexport function wrapAndSliceX(extent, projection) {\n  if (projection.canWrapX()) {\n    const projectionExtent = projection.getExtent();\n\n    if (!isFinite(extent[0]) || !isFinite(extent[2])) {\n      return [[projectionExtent[0], extent[1], projectionExtent[2], extent[3]]];\n    }\n\n    wrapX(extent, projection);\n    const worldWidth = getWidth(projectionExtent);\n\n    if (getWidth(extent) > worldWidth) {\n      // the extent wraps around on itself\n      return [[projectionExtent[0], extent[1], projectionExtent[2], extent[3]]];\n    } else if (extent[0] < projectionExtent[0]) {\n      // the extent crosses the anti meridian, so it needs to be sliced\n      return [\n        [extent[0] + worldWidth, extent[1], projectionExtent[2], extent[3]],\n        [projectionExtent[0], extent[1], extent[2], extent[3]],\n      ];\n    } else if (extent[2] > projectionExtent[2]) {\n      // the extent crosses the anti meridian, so it needs to be sliced\n      return [\n        [extent[0], extent[1], projectionExtent[2], extent[3]],\n        [projectionExtent[0], extent[1], extent[2] - worldWidth, extent[3]],\n      ];\n    }\n  }\n\n  return [extent];\n}\n"],"names":["WFS","constructor","this","_defaultGetFeatureParameters","repository","lizUrls","params","project","SERVICE","REQUEST","VERSION","OUTPUTFORMAT","_defaultDescribeFeatureTypeParameters","async","options","response","fetch","wms","method","body","URLSearchParams","json","WMS","_defaultGetFeatureInfoParameters","SRS","INFO_FORMAT","text","window","lizMap","config","keyValueConfig","capabilities","wmtsCapabilities","wfsCapabilities","map","baselayers","layers","controls","printCapabilities","scales","layouts","tree","type","defaultGetFeatureInfoTolerances","externalBaselayersReplacement","startupBaselayersReplacement","cleanNameMap","layerIdMap","shortNameMap","typeNameMap","permalinkArgs","layerCleanNames","lastLonLatInfo","getLizmapDesktopPluginMetadata","plugin_metadata","lizmap_plugin_version_str","lizmap_plugin_version","lizmap_web_client_target_version","project_valid","qgis_desktop_version","cleanName","aName","undefined","console","log","theCleanName","accentMap","term","ret","i","length","charAt","normalize","reg","RegExp","replace","performCleanName","nCleanName","getLayerNameByCleanName","layerName","updateContentSize","isMobile","mCheckMobile","$","hasClass","addClass","parent","click","is","hide","append","attr","show","removeClass","insertBefore","h","innerHeight","height","css","outerHeight","w","offsetWidth","parseInt","width","wmsMaxWidth","wmsMaxHeight","Number","removeSingleTile","newMapSize","getCurrentSize","replaceSingleTileSize","clone","wmsMaxMax","Math","max","wmsMinMax","min","mapMax","mapMin","OpenLayers","Size","round","len","layer","Layer","qgisName","name","configLayer","singleTile","addOptions","tileSize","ratio","center","getCenter","updateSize","setCenter","baseLayer","redraw","updateMiniDockSize","updateMapSize","mdmcv","getLayerLegendGraphicUrl","withScale","each","l","layerConfig","externalWmsToggle","externalAccess","legendParams","LAYER","STYLE","styles","SLD_VERSION","EXCEPTIONS","FORMAT","TRANSPARENT","WIDTH","DPI","legendParamsString","Util","getParameterString","urlAppend","url","LAYERFONTSIZE","ITEMFONTSIZE","SYMBOLSPACE","ICONLABELSPACE","RULELABEL","id","getScale","service","getLayerScale","nested","minScale","maxScale","nestedLayers","qgisLayerName","useLayerIDs","getLayerOrder","layersOrder","order","lOrder","getLayerTree","pNode","children","publicUrlList","j","jlen","push","wmtsFormat","Format","WMTSCapabilities","serviceUrl","toLowerCase","groupAsLayer","wmsStyles","s","qgisServerVersion","startsWith","node","lizLayerStyles","layerWmsParams","version","exceptions","format","imageFormat","dpi","attribution","href","indexOf","title","split","wmtsLayer","cached","contents","identifier","wmtsOptions","matrixSet","projection","ref","isBaseLayer","alwaysInRange","inArray","toUpperCase","resolutions","maxRes","numZoomLevels","zoomOffset","res","pow","createLayer","yx","reverseAxisOrder","projCode","getCode","parseFloat","Projection","defaults","extConfig","decodeURI","crs","transparent","lizLayerFilter","isVisible","toggled","visibility","transitionEffect","removeBackBufferDelay","gutter","buffer","wmsLayer","bbox","hasOverview","analyseNode","aNode","nodeConfig","result","removeIdx","analyse","reverse","splice","getSwitcherLine","aParent","str","html","parentConfig","geometryType","displayInLegend","legendOption","legend_image_option","noLegendImage","mutuallyExclusive","lizDict","abstract","substr","n","legendLink","link","basepath","getSwitcherNode","aLevel","child","updateLocateFeatureList","locate","locateByLayer","features","fid","filterValue","filterFieldName","val","feat","properties","vectorjoins","vectorjoin","jName","joinLayer","jLocate","jVal","jFeat","targetFieldName","joinFieldName","fieldName","clearDrawLayer","layer_name","getLayersByName","destroyFeatures","zoomToLocateFeature","proj","events","triggerEvent","GeoJSON","ignoreExtraDims","read","geometry","transform","getProjection","displayGeom","getFeatureUrlData","getVectorLayerWfsUrl","join","post","data","JSON","parse","addFeatures","fail","zoomToExtent","getBounds","getLocateFeature","fields","filterjoins","filterjoin","lConfig","loadProjDefinition","sort","a","b","aProperty","bProperty","isNaN","localeCompare","filterPlaceHolder","filterFieldAlias","fOptions","fValue","before","change","combobox","position","my","at","evt","ui","item","self","uiItem","setTimeout","autocomplete","placeHolder","fieldAlias","toString","oldVal","blur","minLength","createSwitcher","treeTable","stringExpand","stringCollapse","onNodeShow","find","limg","onNodeHide","on","event","which","isSelected","parents","toggleClass","itemType","itemName","childPrefix","childrenOf","siblings","descendantsOf","descendants","concat","parentOf","classNames","className","key","match","substring","ancestorsOf","ancestors","selfTr","first","parentTr","siblingsTr","c","childrenParentTr","siblingTr","setVisibility","slen","siblingButt","mutuallyExclusiveGroups","tr","butt","pId","count","checked","pchecked","trDesc","trd","trButt","windowLink","test","media","open","removeCache","confirm","mapSize","size","select","baselayer","units","addLayer","blConfig","e","blName","setBaseLayer","startupBaselayer","Vector","maxExtent","loadstart","object","loadend","aConfig","locateByLayerList","lname","locateContent","styleMap","StyleMap","pointRadius","fill","stroke","strokeWidth","strokeColor","strokeOpacity","featureTypes","getVectorLayerFeatureTypes","remove","featureType","typeName","getElementsByTagName","textContent","getNameByTypeName","lbl","getAttribute","lName","layerId","joinLayerId","lizmapLayerFilterActive","tooltip","viewport","deactivateToolControls","ctrl","Control","TYPE_TOOL","deactivate","displayGetFeatureInfo","xy","eventLonLatInfo","getLonLatFromPixel","popups","removePopup","popup","popupContainerId","popupLocation","popupReg","pcontent","hasPopupContent","lon","lat","Popup","LizmapAnchored","panMapIfOutOfView","addPopup","preventDefault","tab","verifySize","addChildrenFeatureInfo","addGeometryFeatureInfo","addChildrenDatavizFilteredByPopupFeature","createPermalinkArgs","args","Permalink","prototype","createParams","apply","arguments","getExtent","toBBOX","filter","style","opacity","getUrlParameters","urlParameters","location","search","keyValue","slice","value","decodeURIComponent","updatePermalinkInputs","pHref","iframeSize","pIframe","onMapChangelayer","property","lconfig","bindGeobookmarkEvents","gburl","gbparams","geobookmark","q","get","setGeobookmarkContent","geoparams","runPermalink","gbData","unbind","pparams","players","slist","layerStyles","lstyles","olist","layerOpacities","lopacities","btn","setOpacity","sp","flayer","ffids","Bounds","fromString","containerId","selector","geometries","minx","miny","maxx","maxy","geom","projLoaded","aProj","geomInfo","Geometry","fromWKT","Feature","mydiv","getLayerId","popupId","getLayerConfig","getLayerConfigById","relations","getLayerFeature","plotLayers","datavizLayers","lrelations","nbPlotByLayer","x","rel","getChildrenId","referencingLayer","referencingField","referencedField","layer_id","plot_config","popup_display_child_plot","plot_id","String","Date","valueOf","btoa","random","phtml","lizDataviz","buildPlotContainerHtml","haspc","after","getPlot","pop","popupDisplayChildren","popupMaxFeatures","popupChidrenRequests","rConfigLayerAll","relation","rGetLayerConfig","rConfigLayer","clname","shortname","cleanname","wmsName","wmsOptions","request_params","parentDiv","then","Promise","allSettled","popupChildrenData","childPopupElements","index","popupChildData","resizeTablesButtons","childPopup","popupSource","popupDiv","prop","prepend","next","unwrap","tChildPopup","appendTo","oldPopupChild","DataTable","off","toggle","parentPopupElement","getPrintScale","aScales","newScales","scale","scaleIdx","drawPrintBox","aLayout","aLayer","aScale","getUnits","unitsRatio","INCHES_PER_UNIT","printInProjectProjection","qgisProjectProjection","toGeometry","getCenterLonLat","drawFeature","getPrintGridInterval","refScale","theScale","aLayerId","aConfObjet","aIdAttribute","lx","aCRS","aCallback","Proj4js","defs","aText","mAddMessage","aMessage","aType","aClose","mType","mClose","elt","downloadFile","parameters","callback","xhr","XMLHttpRequest","responseType","onload","status","filename","disposition","getResponseHeader","matches","exec","navigator","userAgent","blob","File","downloadUrl","URL","createObjectURL","document","createElement","download","dispatchEvent","MouseEvent","revokeObjectURL","parenthesis_regex","error_message","setRequestHeader","send","param","getVectorLayerSelectionFeatureIdsString","featureidParameter","fids","aFilter","aFeatureId","geometryName","restrictToMapExtent","startIndex","maxFeatures","getNameByCleanName","getNameByShortName","typename","wfsOptions","filterParam","extent","projFeat","featureDataPool","callFeatureDataCallBacks","poolId","callbacksData","callbacks","forEach","alias","types","getFeatureData","aFeatureID","aGeometryName","aCallBack","stringify","describe","aliases","columns","aCallbackNotfound","forceToLoad","featureId","cFeatures","cAliases","addDock","dname","dlabel","dtype","dcontent","dicon","dockli","docktab","docktabli","obj","dictionary","checkMobile","shortName","addMessage","translateWfsFieldValues","fieldValue","translation_dict","zoomToFeature","zoomAction","featureCrs","feature","lonlat","zoomToOlFeature","getPrintCapabilities","getExternalBaselayersReplacement","launchTooltipLayer","aLayerName","tlOptions","launchEdition","deleteEditionFeature","exportVectorLayer","eformat","exportLayers","selectionLayer","config_layer","is_spatial","has_selection_token","has_parenthesis","selection_token","getVectorLayerResultFormat","formats","tagName","getFeaturePopupContent","pkey","attributeLayers","atlas","Array","isArray","primaryKey","getFeaturePopupContentByFeatureIntersection","getResolutionFromScale","geomType","CLASS_NAME","vert","getVertices","middlePoint","floor","LonLat","y","gfiCrs","getProjectionObject","selectLayerFeaturesFromSelectionFeature","targetFeatureType","selectionFeature","geomOperator","gml3","GML","v3","internalProjection","externalProjection","srsName","gml","writeNode","spatialFilter","XML","write","rFilter","eFilter","limitDataToBbox","geomBounds","getWidth","getHeight","extend","left","bottom","right","top","tfeatures","sfIds","mainLizmap","selectionTool","newAddRemoveSelected","asfIds","asfIdIdx","getHashParamFromUrl","hash_key","hash_items","hash","triggerLayerFilter","layername","layerN","lfilter","surl","sdata","request","filtertoken","token","deactivateMaplayerFilter","init","configRequest","ok","statusText","keyValueConfigRequest","WMSRequest","WMTSRequest","WFSRequest","featureExtentRequest","getFeatureInfoRequest","getFeatureInfo","searchParams","wfsParams","TYPENAME","EXP_FILTER","getFeature","wmsParams","QUERY_LAYERS","LAYERS","FEATURE_COUNT","FILTER","all","responses","wmsCapaData","wmtsCapaData","wfsCapaData","featuresExtent","extent1","extent2","domparser","DOMParser","wmsFormat","WMSCapabilities","capability","wmtsElem","exceptionReport","texts","parseFromString","Object","assign","osmMapnik","osmStamenToner","openTopoMap","osmCyclemap","googleStreets","googleSatellite","googleHybrid","googleTerrain","bingStreets","bingSatellite","bingHybrid","ignTerrain","ignStreets","ignSatellite","ignCadastral","proj4","projOSM","toArray","mapScales","zoomLevelNumber","initialExtent","initBbox","hasBaselayers","emptyBaselayer","minRes","getScaleFromResolution","beforeLayerTreeCreated","firstLayer","lizProj4","wmsBbox","wmsBounds","fromArray","intersectsBounds","initProjections","restrictedExtent","mapHeight","clientHeight","nScales","IMAGE_RELOAD_ATTEMPTS","DEFAULT_PRECISION","Map","Navigation","mouseWheelOptions","interval","tileManager","eventListeners","zoomend","inRange","collapse","aDesc","allOverlays","addControl","Attribution","div","getElementById","addEventListener","createMap","lastLayerZIndex","getZIndex","Z_INDEX_BASE","configOptions","info","verifyingVisibility","hrefParam","getParameters","BBOX","hrefBbox","CRS","containsBounds","projBbox","locatelayer","slider","orientation","getZoom","zoom","zoomTo","navCtrl","getControlsByClass","zoomBox","keyMask","zoomBoxKeyMask","handler","dragHandler","handlers","wheel","activate","edition","active","featureInfo","url_params","zoomIn","zoomOut","hCtrl","NavigationHistory","addControls","previousStack","previousTrigger","previous","nextStack","nextTrigger","moveend","createNavbar","popupsAvailable","editionLayer","editionLayers","modifyGeometry","modifyAttribute","deleteFeature","tolerances","WMSGetFeatureInfo","TYPE_TOGGLE","queryVisible","infoFormat","vendorParams","pointTolerance","lineTolerance","polygonTolerance","handlerOptions","pixelTolerance","getfeatureinfo","layerUrls","refreshGetFeatureInfo","updateDrawing","lastPx","getPixelFromLonLat","refreshInfo","findLayers","candidates","filterTokenList","WMTS","getVisibility","calculateInRange","drillDown","filterToken","nbPopupDisplayed","querySelectorAll","requestParams","addFeatureInfo","printTemplates","pTemplates","pTemplate","enabled","ptTomm","scaleOptions","scaleText","toLocaleString","pMap","pMapIdx","pOverview","maps","mapWidth","grid","Style","fillColor","fillOpacity","layout","dragCtrl","DragFeature","geometryTypes","template","labels","tLabel","htmlState","pTableVectorLayers","tables","t","composerMap","mapId","vectorLayer","project_projection","project_proj","printParams","querySelector","gridInterval","printLayers","styleLayers","opacityLayers","lst","activeBaseLayerName","exbl","activeBaseLayerConfig","overviewId","oExtent","unshift","customPrintLabels","label","selection","formatWKT","WKT","highlightGeom","highlightSymbol","digitizing","featureDrawn","featureDrawnVisibility","draw_feature","getFeatureDrawnSLD","printLaunch","disabled","classList","add","minidockopened","minidockclosed","addPrintControl","tooltipLayers","tooltipLayersDic","tooltipLayersSorted","ttl","tooltipStyleMap","cursor","tlayer","tooltipControl","HighlightFeature","displayPopup","popupOffset","popupTitle","popupSize","addInfoPopup","tf","trim","tooltipFields","hiddenFields","attributes","oMapExtent","nReso","getResolution","oPopupPos","tpopup","Anchored","offset","autoSize","backgroundColor","featureid","fName","fFilter","fFeatures","fAliases","tconfig","colorGeom","removeAttr","addTooltipControl","addRules","Rule","symbolizer","graphicName","strokeDashstyle","measureControls","Measure","Handler","Path","persist","geodesic","immediate","layerOptions","area","Polygon","perimeter","angle","maxVertices","handleMeasurements","measure","out","components","invert","firstComponent","secondComponent","move","A","B","C","AB","sqrt","BC","AC","angleInDegrees","acos","PI","toFixed","element","eventType","stat","getBestLength","control","activeCtrl","addMeasureControls","pLink","eLink","target","submit","bname","afilter","createPermalink","layersHaveBeenActivatedByPermalink","uparams","cb","oLayer","configureLayers","lSel","oldActive","lizmapEvent","dock","catch","error","errorMsg","insertAdjacentHTML","finally","dialog","Events","includeXY","lOptions","maxResolution","osm","OSM","stamenToner","cyclemap","OCMKey","gsat","Google","google","MapTypeId","SATELLITE","minZoomLevel","zoomDuration","ghyb","HYBRID","gphy","TERRAIN","gmap","bmap","Bing","bingKey","baerial","bhybrid","ignAttribution","ignKey","ignmap","ignplan","ignphoto","igncadastral","externalService","layerImageFormat","jQuery","layerTitle","cache","addListenerOnce","mapObject","olLayers","gVisibility","display","ready","modal","draggable","resizable","closeOnEscape","dialogClass","minHeight","DOTS_PER_INCH"],"sourceRoot":""}