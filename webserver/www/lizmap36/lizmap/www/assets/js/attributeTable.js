lizMap.events.on({uicreated:function(e){var t=lizMap.config,a=(lizMap.layers,!1),r={},i={},l=OpenLayers.Util.urlAppend(lizUrls.media,OpenLayers.Util.getParameterString(lizUrls.params)),n=!1;"undefined"!=typeof lizLayerFilter&&(n=!0,lizMap.lizmapLayerFilterActive=!0);var s=!1;if("limitDataToBbox"in t.options&&"True"==t.options.limitDataToBbox&&(s=!0),!("attributeLayers"in t))return-1;var u=lizMap.getVectorLayerFeatureTypes();if(0==u.length)return-1;$("body").css("cursor","wait");var o=[];for(var d in t.attributeLayers)(b=t.attributeLayers[d]).name=d,o.push(b);o.sort((function(e,t){return e.order-t.order}));for(var c=0;c<o.length;c++){var b=o[c];r[lizMap.cleanName(b.name)]=b.name}for(const e of u){var p=e.getElementsByTagName("Name")[0].textContent,y=lizMap.getNameByTypeName(p);if(y&&null!=y){var f=lizMap.cleanName(y),v=r[f];if(i[f]=p,v in t.attributeLayers){a=!0;var m=t.attributeLayers[v];t.layers[v].features={},t.layers[v].featureCrs=null,t.layers[v].featuresFullSet=!1,t.layers[v].selectedFeatures=[],t.layers[v].highlightedFeature=null,t.layers[v].filteredFeatures=[],t.layers[v].request_params={filter:null,exp_filter:null,selection:null};var h=lizMap.map.getLayersByName(f)[0];h&&"FILTER"in h.params&&h.params.FILTER&&(t.layers[v].request_params.filter=h.params.FILTER,lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:r[f],filter:t.layers[v].request_params.filter,updateDrawing:!1})),void 0===t.layers[v].geometryType&&(t.layers[v].geometryType="unknown"),t.layers[v].crs=e.getElementsByTagName("SRS")[0].textContent,""!==t.layers[v].crs&&lizMap.loadProjDefinition(t.layers[v].crs,(function(e){new OpenLayers.Projection(t.layers[v].crs)}));var g=e.getElementsByTagName("LatLongBoundingBox")[0];m.bbox=[parseFloat(g.getAttribute("minx")),parseFloat(g.getAttribute("miny")),parseFloat(g.getAttribute("maxx")),parseFloat(g.getAttribute("maxy"))]}}}if(!a)return $("#mapmenu li.attributeLayers").hide(),-1;var z=!1,T='<table id="attribute-layer-list-table" class="table table-condensed table-hover table-striped" style="width:auto;">';for(var L in r)f=L,"pivot"in t.attributeLayers[r[f]]&&"True"==t.attributeLayers[r[f]].pivot||"hideLayer"in t.attributeLayers[r[f]]&&"True"==t.attributeLayers[r[f]].hideLayer||(T+="<tr>",T+="   <td>"+t.layers[r[f]].title+"</td><td><button value="+f+' class="btn btn-open-attribute-layer">'+lizDict["attributeLayers.toolbar.btn.detail"]+"</button></td>",T+="</tr>",z=!0);function F(e,a,r,i){let n=lizMap.config.layers[e];const s=n.typename,u={TYPENAME:s,GEOMETRYNAME:"extent"};a&&(u.EXP_FILTER=a),"True"==t.options?.limitDataToBbox&&(u.BBOX=lizMap.mainLizmap.map.getView().calculateExtent(),u.SRSNAME=lizMap.mainLizmap.map.getView().getProjection().getCode());let o=[lizMap.mainLizmap.wfs.getFeature(u)],d={getFeature:o.length-1};if(!n?.alias||!n?.types){const e=lizMap.mainLizmap.wfs.describeFeatureType({TYPENAME:s});o.push(e),d.describeFeatureType=o.length-1}const c={};d.keyValues=o.length+0;let b=o.length+0;for(const t in lizMap.keyValueConfig?.[e]){const a=lizMap.keyValueConfig[e][t];if("ValueMap"==a.type)c[t]=a.data;else{let e=lizMap.getLayerConfigById(a.source_layer_id);if(!e||2!=e.length)continue;let r=e[1].typename;if(null==r)continue;c[t]=b,b++,o.push(lizMap.mainLizmap.wfs.getFeature({TYPENAME:r,PROPERTYNAME:a.code_field+","+a.label_field,EXP_FILTER:a.exp_filter?a.exp_filter:""}))}}document.body.style.cursor="progress",Promise.all(o).then((a=>{for(let t=d.keyValues;t<a.length;t++){const r=Object.keys(c).find((e=>c[e]===t)),i=lizMap.keyValueConfig[e][r].code_field,l=lizMap.keyValueConfig[e][r].label_field,n={};a[t].features.forEach((e=>n[e.properties[i]]=e.properties[l])),c[r]=n}if(n.featureCrs="EPSG:4326",d?.describeFeatureType){const e=a[d.describeFeatureType];n.aliases=e.aliases,n.types=e.types,n.columns=e.columns}!function(e,a,r,i,n,s,u){var o=t.layers[e],d=lizMap.cleanName(e);(i=void 0!==i?i:null)||(i=o.alias);for(const e in i)""==i[e]&&(i[e]=e);var c=!0;let b="";if(["#attribute-layer-table-","#edition-table-"].includes(a.replace(d,"")))c=!1;else{let e="";a.startsWith("#attribute-layer-table-")?e=a.replace("#attribute-layer-table-","").split("-")[0]:a.startsWith("#edition-table-")&&(e=a.replace("#edition-table-","").split("-")[0]),e&&(b=t.layers[e].id)}c&&"pivot"in t.attributeLayers[e]&&t.attributeLayers[e].pivot;var p=[];e in t.attributeLayers&&"hiddenFields"in t.attributeLayers[e]&&t.attributeLayers[e].hiddenFields&&(p=t.attributeLayers[e].hiddenFields.trim().split(/[\s,]+/));var y=!1,f=!1;if("editionLayers"in t&&e in t.editionLayers){var v=t.editionLayers[e];"True"!=v.capabilities.modifyAttribute&&"True"!=v.capabilities.modifyGeometry||(y=!0),"True"==v.capabilities.deleteFeature&&(f=!0)}if(!(r=void 0!==r?r:null)){var m=t.layers[e].features;r=Object.keys(m).map((function(e){return m[e]}))}var h=r,g=h.length;if(r&&r.length>0){var z=function(e,a,r,i,n,s){const u=[];let o=0;for(var d in u.push({data:"lizSelected",width:"25px",searchable:!1,sortable:!0,visible:!1}),o+=1,u.push({data:"featureToolbar",width:"25px",searchable:!1,sortable:!1}),o+=1,a[0].properties){if(r.includes(d))continue;const e={data:d,title:i[d]};if(s?.hasOwnProperty(d)){const t=s[d];e.render=function(e,a,r,i){if(Array.isArray(e))return e.map((e=>t[e]?t[e]:e)).join(", ");if(e&&"{"==e.toString().substring(0,1)&&"}"==e.toString().slice(-1)){var l=[],n=e.toString();let a=(n=n.substring(1,n.length-1)).split(",");for(var s in a){let e=a[s].replace(/"/g,"");l.push(t[e]?t[e]:e)}return l.length>0?l.join(", "):null}return t[e]?t[e]:e}}else["decimal","double"].includes(n?.[d])?e.render=function(e,t,a,r){return parseFloat(e)}:e.render=function(e,t,a,r){if(!e||"string"!=typeof e)return e;if("media/"==e.substring(0,6)||"/media/"==e.substring(0,7)||"../media/"==e.substring(0,9)){var i=e,n=r.settings.aoColumns[r.col];return"/media/"==e.substring(0,7)&&(i=e.slice(1)),'<a href="'+l+"&path="+i+'" target="_blank">'+n.title+"</a>"}return"http"==e.substring(0,4)||"www"==e.substring(0,3)?(i=e,"www"==e.substring(0,3)&&(i="http://"+e),'<a href="'+i+'" target="_blank">'+e+"</a>"):e};switch(n?.[d]){case"integer":case"int":case"unsignedInt":case"long":case"unsignedLong":case"decimal":case"double":e.className="text-right";break;case"date":e.className="text-center"}u.push(e)}var c={columns:u,firstDisplayedColIndex:2};if("attributetableconfig"in t.attributeLayers[e]&&t.attributeLayers[e].attributetableconfig&&!$.isEmptyObject(t.attributeLayers[e].attributetableconfig.columns)){var b=t.attributeLayers[e].attributetableconfig.columns.column;if(0==b.length)return c;var p=u.slice(0,2),y=u.slice(2),f=0;for(var v in b){var m=b[v];if("field"==m.attributes.type)for(var h=m.attributes.name,g=m.attributes.hidden,z=0;z<y.length;z++)if("data"in y[z]&&y[z].data===h){if("1"==g)y.splice(z,1);else{var T=z;y.splice(f,0,y.splice(T,1)[0]),f+=1}break}}var L=p.concat(y);c.columns=L}else if("columns"in t.layers[e]&&t.layers[e].columns&&Object.keys(t.layers[e].columns).length>0){p=u.slice(0,2),y=u.slice(2),f=0;for(const a in t.layers[e].columns){const r=t.layers[e].columns[a];for(z=0;z<y.length;z++)"data"in y[z]&&y[z].data===r&&(T=z,y.splice(f,0,y.splice(T,1)[0]),f+=1)}L=p.concat(y),c.columns=L}return c}(e,h,p,i,n,s),T=z.columns,L=z.firstDisplayedColIndex,F=_(h,c,p,o.selectedFeatures,o.id,b),M=F.foundFeatures,C=F.dataSet,k=!1;if(0==(o.features?Object.keys(o.features).length:0)?(k=!0,c||(o.featuresFullSet=!0)):c?o.featuresFullSet||(k=!0):(o.featuresFullSet=!0,k=!0),k&&(o.features=M),o.alias=i,$.fn.dataTable.isDataTable(a))(I=$(a).dataTable()).fnClearTable(),I.fnAddData(C);else{var w=!0;g>5e4&&(w=!1);var N="<<t>ipl>";w?$("#attribute-layer-search-"+d).on("keyup",(function(e){var t=this.value;E((function(){I.fnFilter(t)}),500)})):N="<<t>ipl>",$(a).dataTable({data:C,columns:T,initComplete:function(e,t){const a=new $.fn.dataTable.Api(e).table().node().id.split("attribute-layer-table-")[1];lizMap.events.triggerEvent("attributeLayerContentReady",{featureType:a})},order:[[L,"asc"]],language:{url:lizUrls.dataTableLanguage},deferRender:!0,createdRow:function(e,t,a){-1!=$.inArray(t.DT_RowId.toString(),o.selectedFeatures)&&($(e).addClass("selected"),t.lizSelected="a")},dom:N,pageLength:50,scrollY:"95%",scrollX:"100%"});var I=$(a).dataTable();w||$("#attribute-layer-search-"+d).hide(),$("#attribute-layer-search-"+d).next(".clear-layer-search").click((function(){$("#attribute-layer-search-"+d).val("").focus().keyup()})),$(a).on("page.dt",(function(){$(a+" tr").unbind("click"),$(a+" tr td button").unbind("click")})),$(a).on("draw.dt",(function(){return $(a+" tr").unbind("click"),$(a+" tr td button").unbind("click"),function(e,a){$(a+" tr").click((function(){$(a+" tr").removeClass("active"),$(this).addClass("active");var r=this.querySelector("lizmap-feature-toolbar").fid;lizMap.events.triggerEvent("layerfeaturehighlighted",{sourceTable:a,featureType:e,fid:r});var i=t.layers[e];if(i&&"True"==i.popup){var l=i.features[r],n=a.replace("#attribute-layer-table-","").split("-");n=n[0],$("#attribute-table-panel-"+n).html(""),lizMap.getFeaturePopupContent(e,l,(function(e){$("#attribute-table-panel-"+n).html(e),lizMap.events.triggerEvent("lizmappopupdisplayed_inattributetable");$("#attribute-table-panel-"+n+" h4").append('<a class="close-attribute-feature-panel pull-right" href="#"><i class="icon-remove"></i></a>'),$("#attribute-table-panel-"+n+" h4 a.close-attribute-feature-panel").click((function(){$("#attribute-layer-main-"+n).removeClass("reduced"),$("#attribute-table-panel-"+n).removeClass("visible").html(""),$("#attribute-layer-"+n+" button.btn-detail-attributeTable").removeClass("btn-primary")}))}))}}))}(e,a),O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id")),!1}))}(y||f)&&lizMap.mainLizmap.edition.fetchEditableFeatures([o.id])}r&&0!=r.length?$(a).show():($.fn.dataTable.isDataTable(a)&&(I=$(a).dataTable()).fnClearTable(),$(a).hide(),$("#attribute-layer-"+d+" span.attribute-layer-msg").html(lizDict["attributeLayers.toolbar.msg.data.nodata"]+" "+lizDict["attributeLayers.toolbar.msg.data.extent"]).addClass("failure")),u&&u(e,a)}(e,r,a[0].features,n.aliases,n.types,c,i),document.body.style.cursor="default"})).catch((()=>{document.body.style.cursor="default"}))}function M(e){var a={},r=lizMap.getLayerConfigById(e,t.attributeLayers,"layerId");if(!r)return!1;a.name=r[0];var i=t.layers[r[0]].selectedFeatures;if(!(i.length>0))return!1;var l=[],n=t.layers[r[0]].features;if(!n||Object.keys(n).length<=0)return!1;var s=r[1].primaryKey,u=/^[0-9]+$/;for(var o in i){var d=n[i[o]];if(void 0!==d){var c=d.properties[s];u.test(c)||(c=" '"+c+"' "),l.push(c)}}return a.selected=l,a}function C(e){var a=null,r=[],i=[],l="",n=[],s="",u=[],o=t.layers[e];if(!o)return a;var d=o.id;if("relations"in t&&d in t.relations){var c=t.relations[d],b=0,p="active";for(var y in c){var f=c[y],v=lizMap.getLayerConfigById(f.referencingLayer,t.layers,"id");if(v&&v[0]in t.attributeLayers){(b+=1)>1&&(p="");var m=v[1],h=v[0],g=t.attributeLayers[h];if("hideAsChild"in g&&"True"==g.hideAsChild)continue;var z="attribute-child-tab-"+lizMap.cleanName(e)+"-"+lizMap.cleanName(h),$='<div class="tab-pane attribute-layer-child-content '+p+'" id="'+z+'" >',T="attribute-layer-table-"+lizMap.cleanName(e)+"-"+lizMap.cleanName(h),L="attribute-table-table table table-hover table-condensed table-striped cell-border child-of-"+lizMap.cleanName(e);$+='    <input type="hidden" class="attribute-table-hidden-parent-layer" value="'+lizMap.cleanName(e)+'">',$+='    <input type="hidden" class="attribute-table-hidden-layer" value="'+lizMap.cleanName(h)+'">',$+='    <table id="'+T+'" class="'+L+'" width="100%"></table>',$+="</div>",r.push($);var F='<li id="nav-tab-'+z+'" class="'+p+'"><a href="#'+z+'" data-toggle="tab">'+m.title+"</a></li>";i.push(F);var M=!1;"editionLayers"in t&&(lizMap.getLayerConfigById(f.referencingLayer,t.editionLayers,"layerId"),h in t.editionLayers&&"True"==t.editionLayers[h].capabilities.createFeature&&(M=!0)),M&&(n.push('<li><a href="#'+lizMap.cleanName(h)+'" class="btn-createFeature-attributeTable">'+m.title+"</a></li>"),u.push('<li><a href="#'+lizMap.cleanName(h)+'" class="btn-linkFeatures-attributeTable">'+m.title+"</a></li>"))}}}if(i.length){if(n.length>0){for(var C in l+='&nbsp;<div class="btn-group" role="group" >',l+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',l+=lizDict["attributeLayers.toolbar.btn.data.createChildFeature.title"],l+='      <span class="caret"></span>',l+="    </button>",l+='    <ul class="dropdown-menu" role="menu">',n)l+=n[C];l+="    </ul>",l+="</div>"}if(u.length>0){for(var C in s+='&nbsp;<div class="btn-group" role="group" >',s+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',s+=lizDict["attributeLayers.toolbar.btn.data.linkFeatures.title"],s+='      <span class="caret"></span>',s+="    </button>",s+='    <ul class="dropdown-menu" role="menu">',u)s+=u[C];s+="    </ul>",s+="</div>"}a={"tab-content":r,"tab-li":i,childCreateButton:l,layerLinkButton:s}}return a}T+="</table>",z?($("#attribute-layer-list").html(T),$("button.btn-open-attribute-layer").click((function(){var e=$(this).val();if(s){var a=lizMap.map.getLayersByName(e)[0],i=lizMap.map.getScale();if(a&&!(a.maxScale<i&&i<a.minScale)){var l=lizDict["attributeLayers.msg.layer.not.visible"];return lizMap.addMessage(l,"info",!0).attr("id","lizmap-attribute-message"),!1}}const u=r[e];return $("#nav-tab-attribute-layer-"+e).length||function(e){t.attributeLayers[e];var a=lizMap.cleanName(e),i='<li id="nav-tab-attribute-layer-'+a+'">';i+='<a href="#attribute-layer-'+a+'" data-toggle="tab">'+t.layers[e].title,i+='&nbsp;<i class="btn-close-attribute-tab icon-remove icon-white" style="cursor:pointer"></i>',i+="</a>",i+="</li>",$("#attributeLayers-tabs").append(i);var l='<div id="attribute-layer-'+a+'" class="tab-pane attribute-content bottom-content" >';l+='    <div class="attribute-layer-main" id="attribute-layer-main-'+a+'" >',t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),t.layers[e].filteredFeatures||(t.layers[e].filteredFeatures=[]);var u="";0==t.layers[e].selectedFeatures.length&&(u=" hidden");var o;o=t.layers[e].filteredFeatures.length>0?" active btn-primary":u,l+='<div class="attribute-layer-action-bar">',l+='<div class="btn-group">',l+='  <input id="attribute-layer-search-'+a+'" type="search" class="form-control" placeholder="'+lizDict["attributeLayers.toolbar.input.search.title"]+'">',l+='  <i class="clear-layer-search icon-remove" style="position:absolute;right:4px;top:4px;cursor:pointer;"></i>',l+="</div>",l+='<button class="btn-select-searched btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.select.searched.title"]+'"><i class="icon-star"></i></button>',l+='    <button class="btn-unselect-attributeTable btn btn-mini'+u+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.unselect.title"]+'"><i class="icon-star-empty"></i></button>',l+='    <button class="btn-moveselectedtotop-attributeTable btn btn-mini'+u+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.moveselectedtotop.title"]+'"><i class="icon-arrow-up"></i></button>',n||lizMap.lizmapLayerFilterActive&&lizMap.lizmapLayerFilterActive!=e||(l+='    <button class="btn-filter-attributeTable btn btn-mini'+o+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.filter.title"]+'"><i class="icon-filter"></i></button>'),l+='<lizmap-selection-invert tooltip-placement="bottom" feature-type="'+a+'"></lizmap-selection-invert>';var d=!1;t.layers[e]&&"True"==t.layers[e].popup&&"none"!=t.layers[e].geometryType&&"unknown"!=t.layers[e].geometryType&&(d=!0),d&&(l+='<button type="checkbox" class="btn-detail-attributeTable btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.cb.data.detail.title"]+'">',l+='<i class="icon-info-sign"></i>',l+="</button>");var c=!1;"editionLayers"in t&&a in t.editionLayers&&"True"==t.editionLayers[r[a]].capabilities.createFeature&&(c=!0),c&&(l+='    <button class="btn-createFeature-attributeTable btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.createFeature.title"]+'"><i class="icon-plus-sign"></i></button>'),s&&"none"!=t.layers[e].geometryType&&"unknown"!=t.layers[e].geometryType&&(l+='    <button class="btn-refresh-table btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"]+'">'+lizDict["attributeLayers.toolbar.btn.refresh.table.title"]+"</button>");var b=C(e),p="";if(b&&(l+='    <button class="btn-toggle-children btn btn-mini" value="'+a+'" >'+lizDict["attributeLayers.toolbar.btn.toggle.children.title"]+"</button>",b.childCreateButton&&(l+=b.childCreateButton),b.layerLinkButton&&(l+=b.layerLinkButton)),"exportLayers"in t.options&&"True"==t.options.exportLayers){l+='&nbsp;<div class="export-formats btn-group pull-right" role="group" >',l+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',l+=lizDict["attributeLayers.toolbar.btn.data.export.title"],l+='      <span class="caret"></span>',l+="    </button>",l+='    <ul class="dropdown-menu" role="menu">',l+='        <li><a href="#" class="btn-export-attributeTable">GeoJSON</a></li>',l+='        <li><a href="#" class="btn-export-attributeTable">GML</a></li>';for(var y=lizMap.getVectorLayerResultFormat(),f=0,v=y.length;f<v;f++){var m=y[f].toLowerCase();"gml2"!=m&&"gml3"!=m&&"geojson"!=m&&(l+='        <li><a href="#" class="btn-export-attributeTable">'+m+"</a></li>")}l+="    </ul>",l+="</div>"}if(l+="</div>",b&&(p=" showChildren"),l+='<div class="attribute-layer-content'+p+'">',l+='    <input type="hidden" class="attribute-table-hidden-layer" value="'+a+'">',l+='    <table id="attribute-layer-table-'+a+'" class="attribute-table-table table table-hover table-condensed table-striped order-column cell-border" width="100%"></table>',l+="</div>",b){for(var f in l+='<div class="tabbable attribute-layer-child-content">',l+='    <ul class="nav nav-tabs">',b["tab-li"])l+=b["tab-li"][f];for(var f in l+="    </ul>",l+='    <div class="tab-content">',b["tab-content"])l+=b["tab-content"][f];l+="    </div>",l+="</div>"}l+="</div>",l+='    <div class="attribute-layer-feature-panel" id="attribute-table-panel-'+a+'" ></div>',l+="</div>",$("#attribute-table-container").append(l),$("#attribute-layer-"+a+" button").tooltip({placement:"bottom"}),$(".btn-close-attribute-tab").click((function(){var e=$(this).parent().attr("href");$(this).parent().parent().remove(),$("#attributeLayers-tabs a:last").tab("show"),$(e).remove()})),b&&$("#attribute-layer-"+a+' div.attribute-layer-child-content ul li a[data-toggle="tab"]').on("shown.bs.tab",(function(e){var t=$(e.target).attr("href");$(t).find("table.dataTable").DataTable().tables().columns.adjust()})),s&&$("#attribute-layer-"+a+" button.btn-refresh-table").click((function(){$(this).attr("data-original-title",lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"]).removeClass("btn-warning");var t=lizMap.map.getLayersByName(a)[0],r=lizMap.map.getScale();if(!t)return!1;if(!(t.maxScale<r&&r<t.minScale)){var i=lizDict["attributeLayers.msg.layer.not.visible"];return lizMap.addMessage(i,"info",!0).attr("id","lizmap-attribute-message"),!1}const l="#attribute-layer-table-"+a;return $("#attribute-layer-main-"+a+" > div.attribute-layer-content").hide(),F(e,null,l,(()=>{$("#attribute-layer-main-"+a+" > div.attribute-layer-content").show(),O("#attribute-layer-main-"+a)})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),b&&$("#attribute-layer-"+a+" button.btn-toggle-children").click((function(){var e=$(this).parents("div.attribute-layer-main");return e.find("div.attribute-layer-content").toggleClass("showChildren"),e.find("div.tabbable.attribute-layer-child-content").toggle(),O("#attribute-layer-main-"+a),!1})),d&&$("#attribute-layer-"+a+" button.btn-detail-attributeTable").click((function(){return $("#attribute-layer-main-"+a).toggleClass("reduced",!$(this).hasClass("btn-primary")),$("#attribute-table-panel-"+a).toggleClass("visible",!$(this).hasClass("btn-primary")),$(this).toggleClass("btn-primary"),O("#attribute-layer-main-"+a),!1})),$("#attribute-layer-"+a+" button.btn-unselect-attributeTable").click((function(){var e=r[$(this).val()];return lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:e,updateDrawing:!0}),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" button.btn-moveselectedtotop-attributeTable").click((function(){var e="#attribute-layer-table-"+$(this).val(),t=$(e).DataTable(),a=t.order();a=$.grep(a,(function(e){return 0!=e[0]}));var r=[[0,"asc"]].concat(a);return t.order(r).draw(),$(e).parents("div.attribute-layer-content").scrollTop(0),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),n||$("#attribute-layer-"+a+" button.btn-filter-attributeTable").click((function(){var e=r[$(this).val()];return $(this).hasClass("btn-primary")?(lizMap.events.triggerEvent("layerfeatureremovefilter",{featureType:e}),lizMap.lizmapLayerFilterActive=null):(lizMap.events.triggerEvent("layerfeaturefilterselected",{featureType:e}),lizMap.lizmapLayerFilterActive=e),!1})),$("#attribute-layer-"+a+" a.btn-export-attributeTable").click((function(){var e=$(this).text();"GML"==e&&(e="GML3");var t=$(this).parents("div.attribute-layer-main:first").attr("id").replace("attribute-layer-main-",""),a=r[t];return lizMap.exportVectorLayer(a,e,s),$(this).blur(),!1})),$("#attribute-layer-"+a+" button.btn-createFeature-attributeTable").click((function(){if(1!=$("#attribute-layer-"+a+" tr.active").length)return $("#lizmap-edition-message").remove(),lizMap.addMessage(lizDict["attributeLayers.toolbar.btn.data.createChildFeature.no.actived"],"info",!0).attr("id","lizmap-edition-message"),!1;var e=document.querySelector("#attribute-layer-"+a+" tr.active lizmap-feature-toolbar").fid,i=r[a],l=t.layers[i].id,n=r[$(this).val()];return lizMap.getLayerFeature(i,e,(function(e){var a=t.layers[n].id;lizMap.launchEdition(a,null,{layerId:l,feature:e})})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" a.btn-createFeature-attributeTable").click((function(){if(1!=$("#attribute-layer-"+a+" tr.active").length)return $("#lizmap-edition-message").remove(),lizMap.addMessage(lizDict["attributeLayers.toolbar.btn.data.createChildFeature.no.actived"],"info",!0).attr("id","lizmap-edition-message"),!1;var e=document.querySelector("#attribute-layer-"+a+" tr.active lizmap-feature-toolbar").fid,i=r[a],l=t.layers[i].id,n=$(this).attr("href").replace("#",""),s=r[n];return lizMap.getLayerFeature(i,e,(function(e){var a=t.layers[s].id;lizMap.launchEdition(a,null,{layerId:l,feature:e}),$(this).blur()})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" a.btn-linkFeatures-attributeTable").click((function(){var e=$(this).attr("href").replace("#","");$(this).blur();var i=r[e],l=t.layers[i].id,n=t.attributeLayers[i],s=[],u=r[a],o=t.layers[u].id,d=!1;if("pivot"in n&&"True"==n.pivot&&l in t.relations.pivot){for(var c in t.relations.pivot[l]){if(!(p=M(c)))return!1;p.id=c;var b=t.relations.pivot[l][c];p.fkey=b,s.push(p)}if(2!=s.length)return!1;d="pivot"}else{var p=M(o),y=M(l);if(!p||!y)return!1;if(p.id=o,p.fkey=t.attributeLayers[i].primaryKey,y.id=l,!(o in t.relations))return!1;for(var f in t.relations[o]){var v=t.relations[o][f];v.referencingLayer==l&&(y.fkey=v.referencingField)}if(!("fkey"in y))return!1;s.push(p),s.push(y),d="1n"}if(d){var m=OpenLayers.Util.urlAppend(lizUrls.edition,OpenLayers.Util.getParameterString(lizUrls.params));$.post(m.replace("getFeature","linkFeatures"),{features1:s[0].id+":"+s[0].fkey+":"+s[0].selected.join(),features2:s[1].id+":"+s[1].fkey+":"+s[1].selected.join(),pivot:l},(function(e){$("#lizmap-edition-message").remove(),lizMap.addMessage(e,"info",!0).attr("id","lizmap-edition-message"),"pivot"==d?(lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:r[a],updateDrawing:!0}),lizMap.events.triggerEvent("lizmapeditionfeaturecreated",{layerId:l})):(lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:i,updateDrawing:!0}),lizMap.events.triggerEvent("lizmapeditionfeaturemodified",{layerId:l}))}))}return!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" button.btn-select-searched").click((function(){var e=r[$(this).val()];return lizMap.events.triggerEvent("layerfeatureselectsearched",{featureType:e,updateDrawing:!0}),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}(u),F(u,"request_params"in t.layers[u]&&t.layers[u].request_params.exp_filter?t.layers[u].request_params.exp_filter:null,"#attribute-layer-table-"+e),$("#nav-tab-attribute-layer-"+e+" a").tab("show"),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').change((function(){var e=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked");if(lizMap.lizmapLayerFilterActive){var a=lizMap.lizmapLayerFilterActive;if(t.layers[a].filteredFeatures){P(a);var r=!0;e||(r="removeChildrenFilter"),B(a,r)}}}))):$("#mapmenu li.attributeLayers").hide(),lizMap.events.triggerEvent("attributeLayersReady",{layers:r}),s&&lizMap.map.events.on({moveend:function(){var e;e=lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip.changed"],e+=" "+lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"],$("button.btn-refresh-table").attr("data-original-title",e).addClass("btn-warning").tooltip()}}),$("#attributeLayers-tabs li").click((function(){O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))})),$("body").css("cursor","auto");var k,E=(k=0,function(e,t){clearTimeout(k),k=setTimeout(e,t)});function w(e,a,r,i){var l=t.layers[e],n=lizMap.cleanName(e),s=!0;let u="";if(["#attribute-layer-table-","#edition-table-"].includes(a.replace(n,"")))s=!1;else{let e="";a.startsWith("#attribute-layer-table-")?e=a.replace("#attribute-layer-table-","").split("-")[0]:a.startsWith("#edition-table-")&&(e=a.replace("#edition-table-","").split("-")[0]),e&&(u=t.layers[e].id)}var o,d=[];if(e in t.attributeLayers&&"hiddenFields"in t.attributeLayers[e]&&t.attributeLayers[e].hiddenFields&&(d=t.attributeLayers[e].hiddenFields.trim().split(/[\s,]+/)),!(r=void 0!==r?r:null)){var c=t.layers[e].features;r=Object.keys(c).map((function(e){return c[e]}))}if(r&&r.length>0){var b=_(r,s,d,l.selectedFeatures,l.id,u),p=b.foundFeatures,y=b.dataSet;$.fn.dataTable.isDataTable(a)&&((o=$(a).dataTable()).fnClearTable(),o.fnAddData(y)),l.features=p}return r&&0!=r.length?$(a).show():($.fn.dataTable.isDataTable(a)&&(o=$(a).dataTable()).fnClearTable(),$(a).hide(),$("#attribute-layer-"+n+" span.attribute-layer-msg").html(lizDict["attributeLayers.toolbar.msg.data.nodata"]+" "+lizDict["attributeLayers.toolbar.msg.data.extent"]).addClass("failure")),i&&i(e,a),!1}function _(e,t,a,r,i,l){var n=[],s={};return e.forEach((function(e){var u={},o=e.id.split(".")[1];for(var d in s[o]=e,u.DT_RowId=o,u.lizSelected="z",r&&-1!=$.inArray(o,r)&&(u.lizSelected="a"),u.featureToolbar=`<lizmap-feature-toolbar value="${i+"."+o}" ${t?`parent-layer-id="${l}"`:""}></lizmap-feature-toolbar>`,e.properties)if(!($.inArray(d,a)>-1)){var c=e.properties[d];u[d]=c}n.push(u)})),{dataSet:n,foundFeatures:s}}function N(e,a,r){F(e,a,r,(()=>{var a=!1,i=!1;if("editionLayers"in t&&e in t.editionLayers){var l=t.editionLayers[e];"True"==l.capabilities.createFeature&&(a=!0),"True"!=l.capabilities.modifyAttribute&&"True"!=l.capabilities.modifyGeometry||(i=!0)}$(r).one("draw.dt",(function(){if(i){const e=$(r).parents("div.tab-pane.attribute-layer-child-content").find("input.attribute-table-hidden-parent-feature-id").val();$(r).DataTable().cells().nodes().to$().children("lizmap-feature-toolbar").attr("parent-feature-id",e)}if(a){const e=$($(r).DataTable().column(1).header());0==e.find("button.attribute-layer-feature-create").length&&e.append(`<button class="btn btn-mini attribute-layer-feature-create" value="-1" title="${lizDict["attributeLayers.toolbar.btn.data.createFeature.title"]}">\n                                            <i class="icon-plus"></i>\n                                        </button>`).on("click","button.attribute-layer-feature-create",(function(){var e=$(this).parents("div.tab-pane.attribute-layer-child-content"),a=e.find("input.attribute-table-hidden-parent-feature-id").val(),r=e.find("input.attribute-table-hidden-parent-layer").val(),i=e.find("input.attribute-table-hidden-layer").val();return lizMap.getLayerFeature(r,a,(function(e){var a=t.layers[lizMap.getLayerNameByCleanName(r)].id,l=t.layers[lizMap.getLayerNameByCleanName(i)].id;lizMap.launchEdition(l,null,{layerId:a,feature:e})})),!1}))}if(0==$(r).parents(".edition-children-content").children("ul.nav-tabs").children("li.active").length){var e=$(r).parents(".tab-pane.attribute-layer-child-content").attr("id");$(r).parents(".edition-children-content").find('ul.nav-tabs > li > a[href="#'+e+'"]').click()}return!1}))}))}function I(e,a){a=void 0===a||a,t.layers[e].selectedFeatures=[],lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:a})}function D(e,a,r,i){if(0!=e.length){i=void 0===i||i;var l=e.shift(),n=lizMap.cleanName(l),s=a[l];s?function(e,a,r,i,l,n){if(a){l.push(e);lizMap.getFeatureData(e,a,null,"extent",!1,null,null,(function(s,u,o,d,c){var b=t.layers[e];b.features={};var p={};const y=b?.shortname||b.name;var f=o,v=b.id,m=t.attributeLayers[e].primaryKey,h=[],g={},z=lizMap.getLayerConfigById(v,t.attributeLayers,"layerId"),T=null;if(z&&(T=z[1]),"relations"in t&&v in t.relations&&n){var L=t.relations[v];for(var F in L){var M=x(L[F],l);M&&(g[M[0]]=M[1])}}var C=S(v,T,l),k=[];f.forEach((function(e){var t=e.id.split(".")[1];p[t]=e;var r=e.properties[m];if("types"in b&&m in b.types&&"string"==b.types[m]?r=" '"+r+"' ":/^[0-9]+$/.test(r)||(r=" '"+r+"' "),h.push(r),k.push(t),n&&a)for(var i in g){var l=g[i];g[i].parentValues.push("'"+e.properties[l.parentField]+"'")}if(C&&a){var s=C.otherParentRelation.referencingField;C.otherParentValues.push("'"+e.properties[s]+"'")}})),b.features=p,b.alias=d;var E=null,_=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];if(_&&_.params&&(layerN=_.params.LAYERS),0==h.length&&h.push("-99999"),a&&(E=y+':"'+m+'" IN ( '+h.join(" , ")+" ) ",!a.startsWith("$id"))){var N=a;a.startsWith(y)||(N=y+":"+a),E=N}if(b.request_params.filter=E,b.request_params.exp_filter=a,_&&_.params)if(a){var I=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),A={service:"WMS",request:"GETFILTERTOKEN",typename:y,filter:E};$.post(I,A,(function(e){_.params.FILTERTOKEN=e.token,delete _.params.FILTER,b.request_params.filtertoken=e.token,b.geometryType&&"none"!=b.geometryType&&"unknown"!=b.geometryType&&_.redraw(!0)}))}else delete _.params.FILTER,delete _.params.FILTERTOKEN,b.request_params.filtertoken=null;_&&"none"!=b.geometryType&&"unknown"!=b.geometryType&&_.redraw(!0);var B="#attribute-layer-table-"+lizMap.cleanName(e);if($(B).length&&w(e,B,f),lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:e,filter:E,updateDrawing:!0}),n)for(var P in g){var q=P,O=g[P],R=null,j=null;a&&O.parentValues.length>0&&"removeChildrenFilter"!=n?j='"'+O.fieldToFilter+'" IN ( '+O.parentValues.join(" , ")+" )":a&&"removeChildrenFilter"!=n&&(j='"'+O.fieldToFilter+'" IN ( -99999 )'),R=y+":"+j,t.layers[q].request_params.filter=R,t.layers[q].request_params.exp_filter=j,i[P]=j,r.push(P)}C&&(R=null,j=null,a&&(C.otherParentValues.length>0?(j='"'+C.otherParentRelation.referencedField+'"',R=y+":"+(j+=" IN ( "+C.otherParentValues.join(" , ")+" )"),C.otherParentRelation.referencedField,C.otherParentValues):(R=y+":"+(j='"'+C.otherParentRelation.referencedField+"\" IN ( '-999999' )"),C.otherParentRelation.referencedField)),t.layers[C.otherParentTypeName].request_params.filter=R,t.layers[C.otherParentTypeName].request_params.exp_filter=j,i[C.otherParentTypeName]=j,r.push(C.otherParentTypeName)),r.length>0&&D(r,i,l,n)}))}else A(e,r,i,l,n)}(l,s,e,a,r,i):A(l,e,a,r,i);var u="inherit";s&&(u="rgba(255, 171, 0, 0.4)"),$("#switcher .treeTable tr#group-"+n).css("background-color",u),$("#switcher .treeTable tr#layer-"+n).css("background-color",u),$("#layerActionUnfilter").toggle(null!==lizMap.lizmapLayerFilterActive).css("background-color","rgba(255, 171, 0, 0.4)")}}function x(e,a){var r=lizMap.getLayerConfigById(e.referencingLayer,t.attributeLayers,"layerId");if(!r)return null;var i=r[0],l=r[1];if(-1!=$.inArray(i,a))return null;var n=!1;return"pivot"in l&&"True"==l.pivot&&l.layerId in t.relations.pivot&&(n=!0),[i,{filter:null,fieldToFilter:e.referencingField,parentField:e.referencedField,parentValues:[],pivot:n,otherParentTypeName:null,otherParentRelation:null,otherParentValues:[]}]}function S(e,a,r){var i=!1,l=null;if("pivot"in a&&"True"==a.pivot&&a.layerId in t.relations.pivot&&(i=!0),!i)return l;var n=null,s=null,u=null;for(var o in t.relations)if("pivot"!=o&&o!=e&&(!(b=lizMap.getLayerConfigById(o,t.attributeLayers,"layerId"))||-1==$.inArray(b[0],r))){var d=t.relations[o];for(var c in d){var b;d[c].referencingLayer==a.layerId&&(n=o,s=d[c],u=(b=lizMap.getLayerConfigById(o,t.attributeLayers,"layerId"))[0])}}return n&&s&&((l={}).otherParentTypeName=u,l.otherParentRelation=s,l.otherParentValues=[]),l}function A(e,a,r,i,l){i.push(e);var n=t.layers[e];n.features={};var s=n.id,u={},o=lizMap.getLayerConfigById(s,t.attributeLayers,"layerId"),d=null;if(o&&(d=o[1]),"relations"in t&&s in t.relations&&l){var c=t.relations[s];for(var b in c){var p=x(c[b],i);p&&(u[p[0]]=p[1])}}var y=S(s,d,i),f=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];n.request_params.filter=null,n.request_params.exp_filter=null,n.request_params.filtertoken=null,f&&(delete f.params.FILTER,delete f.params.FILTERTOKEN),f&&"none"!=n.geometryType&&"unknown"!=n.geometryType&&f.redraw(!0);var v="#attribute-layer-table-"+lizMap.cleanName(e);if($(v).length&&function(e,a,r,i){const l={TYPENAME:lizMap.config.layers[e].typename,GEOMETRYNAME:"extent"};"True"==t.options?.limitDataToBbox&&(l.BBOX=lizMap.mainLizmap.map.getView().calculateExtent(),l.SRSNAME=lizMap.mainLizmap.map.getView().getProjection().getCode());const n=lizMap.mainLizmap.wfs.getFeature(l);Promise.all([n]).then((t=>{w(e,r,t[0].features),document.body.style.cursor="default"})).catch((()=>{document.body.style.cursor="default"}))}(e,0,v),lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:e,filter:null,updateDrawing:!0}),l)for(var m in u)r[m]=null,a.push(m);y&&(console.log(y),t.layers[y.otherParentTypeName].request_params.filter=null,t.layers[y.otherParentTypeName].request_params.exp_filter=null,t.layers[y.otherParentTypeName].request_params.filtertoken=null,r[y.otherParentTypeName]=null,a.push(y.otherParentTypeName)),a.length>0&&D(a,r,i,l)}function B(e,a){a=void 0===a||a;var r=t.layers[e];if(r){var i=lizMap.cleanName(e),l=lizMap.map.getLayersByName(i)[0],n=null;r.filteredFeatures&&r.filteredFeatures.length>0&&(n="$id IN ( "+r.filteredFeatures.join(" , ")+" ) ");var s=e;if(r.shortname&&(s=r.shortname),r.selectedFeatures&&r.selectedFeatures.length){r.request_params.selection=s+":"+r.selectedFeatures.join();var u=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),o={service:"WMS",request:"GETSELECTIONTOKEN",typename:s,ids:r.selectedFeatures.join()};$.post(u,o,(function(e){r.request_params.selectiontoken=e.token,l&&(l.params.SELECTIONTOKEN=e.token)}))}else l&&delete l.params.SELECTIONTOKEN,r.request_params.selection=null,r.request_params.selectiontoken=null;var d=[e],c={};c[e]=n,D(d,c,[],a)}}function P(e){var a=t.layers[e].selectedFeatures,r=t.layers[e].filteredFeatures,i=lizMap.cleanName(e);a&&a.length>0?($('button.btn-unselect-attributeTable[value="'+i+'"]').removeClass("hidden"),$('button.btn-moveselectedtotop-attributeTable[value="'+i+'"]').removeClass("hidden")):($('button.btn-unselect-attributeTable[value="'+i+'"]').addClass("hidden"),$('button.btn-moveselectedtotop-attributeTable[value="'+i+'"]').addClass("hidden")),$('button.btn-filter-attributeTable[value="'+i+'"]').addClass("hidden").removeClass("btn-primary"),(!lizMap.lizmapLayerFilterActive&&a&&a.length>0||lizMap.lizmapLayerFilterActive==e)&&($('button.btn-filter-attributeTable[value="'+i+'"]').removeClass("hidden"),r&&r.length>0&&$('button.btn-filter-attributeTable[value="'+i+'"]').addClass("btn-primary"))}function q(e){$(".attribute-table-table[id]").each((function(){var a=$(this).attr("id");if(!a)return!0;var i=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(i&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(e)==i){for(var l="#"+a,n=l,s=i,u=e,o=$(l).attr("class").split(" "),d=0;d<o.length;d++)if(o[d].match("child-of-")){n="#attribute-layer-table-"+(s=o[d].substring("child-of-".length)),u=r[s];break}if(n!=l)if(l.match("edition-table-")){var c=$('#edition-form-container form input[name="liz_featureId"]').val(),b=$('#edition-form-container form input[name="liz_layerId"]').val(),p=lizMap.getLayerConfigById(b);if(e in t.attributeLayers&&u==p[0]){var y=function(e,a){if("relations"in t&&e in t.relations){var r=t.relations[e];for(var i in r){var l=r[i];if(l.referencingLayer==a)return l}}return null}(b,t.attributeLayers[e].layerId);null!=y&&lizMap.getLayerFeature(u,c,(function(t){var a=t.properties;filter='"'+y.referencingField+"\" = '"+a[y.referencedField]+"'",N(e,filter,l)}))}}else{var f=t.layers[u].highlightedFeature;f&&$(n+" tr#"+f).click()}else F(e,null,l)}}))}function O(e){var t=$(e).find("table.dataTable");if(0!=t.length){var a=$(e+" div.attribute-layer-content").height()?$(e+" div.attribute-layer-content").height():0;a-=$(e+" thead").height()?$(e+" thead").height():0,a-=$(e+" div.dataTables_paginate").height()?$(e+" div.dataTables_paginate").height():0,a-=$(e+" div.dataTables_filter").height()?$(e+" div.dataTables_filter").height():0,a-=20,t.parent("div.dataTables_scrollBody").height(a),t.DataTable().tables().columns.adjust()}}lizMap.refreshDatatableSize=function(e){return O(e)},lizMap.events.on({layerfeaturehighlighted:function(e){t.layers[e.featureType].highlightedFeature=e.fid,function(e,a,r){var i=t.layers[a].features[r];if(!i)return!1;var l=i.properties,n=t.layers[a];if(!n)return!1;var s=n.id;if("relations"in t&&s in t.relations){var u=t.relations[s];for(const a of u){const r=lizMap.getLayerConfigById(a.referencingLayer,t.layers,"id");if(r&&"False"==t.attributeLayers?.[r[0]]?.hideAsChild){const[t,i]=r;let n="";a.referencingLayer==i.id&&(n='"'+a.referencingField+"\" = '"+l[a.referencedField]+"'"),F(t,n,e.replace(" table:first","")+"-"+lizMap.cleanName(t))}}}}(e.sourceTable,e.featureType,e.fid)},layerfeatureselected:function(e){!function(e,a,r){if(r=void 0!==r?r:null,t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),-1==$.inArray(a,t.layers[e].selectedFeatures))t.layers[e].selectedFeatures.push(a);else{var i=$.inArray(a,t.layers[e].selectedFeatures);t.layers[e].selectedFeatures.splice(i,1)}lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:r})}(e.featureType,e.fid,e.updateDrawing)},layerfeatureunselectall:function(e){I(e.featureType,e.updateDrawing)},layerfeatureselectsearched:function(e){!function(e,a){a=void 0===a||a,t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]);var r=!1;$(".attribute-table-table[id]").each((function(){$(this).attr("id");var a=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(a&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(e)==a){for(var i=[],l=$(this).DataTable().rows({filter:"applied"}).ids(),n=0;n<l.length;n++)i.push(l[n]);t.layers[e].selectedFeatures=i,r=!0}})),r&&lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:a})}(e.featureType,e.updateDrawing)},layerfeaturefilterselected:function(e){!function(e){if(!t.attributeLayers[e])return!1;t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),t.layers[e].filteredFeatures=t.layers[e].selectedFeatures.slice(),I(e,!1),lizMap.lizmapLayerFilterActive=e,lizMap.events.triggerEvent("layerFilteredFeaturesChanged",{featureType:e,featureIds:t.layers[e].filteredFeatures,updateDrawing:!0})}(e.featureType)},layerfeatureremovefilter:function(e){!function(e){t.layers[e].filteredFeatures=[],lizMap.lizmapLayerFilterActive=null;var a=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];a&&(delete a.params.FILTER,delete a.params.FILTERTOKEN),t.layers[e].request_params.filter=null,t.layers[e].request_params.exp_filter=null,t.layers[e].request_params.filtertoken=null,lizMap.events.triggerEvent("layerFilteredFeaturesChanged",{featureType:e,featureIds:t.layers[e].filteredFeatures,updateDrawing:!0})}(e.featureType)},layerSelectionChanged:function(e){var a;P(e.featureType),a=e.featureType,e.featureIds,$(".attribute-table-table[id]").each((function(){$(this).attr("id");var e=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(e&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(a)==e){if(!r){t.layers[a].selectedFeatures||(t.layers[a].selectedFeatures=[]);var r=t.layers[a].selectedFeatures}var i=$(this).DataTable(),l=$(this).dataTable();i.rows($(this).find("tr.selected")).every((function(){l.fnUpdate("z",this,0,!1,!1)})).nodes().to$().removeClass("selected"),r.length>0&&((i=$(this).DataTable()).data().each((function(e){-1!=$.inArray(e.DT_RowId.toString(),r)&&(e.lizSelected="a")})),i.rows((function(e,t,a){return"a"==t.lizSelected})).nodes().to$().addClass("selected"))}})),e.updateDrawing&&function(e){var a=t.layers[e];if(a){var r=lizMap.cleanName(e),i=lizMap.map.getLayersByName(r)[0];if(i){var l=e;if(a.shortname&&(l=a.shortname),a.selectedFeatures&&a.selectedFeatures.length){"request_params"in a||(a.request_params={}),a.request_params.selection=l+":"+a.selectedFeatures.join();var n=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),s={service:"WMS",request:"GETSELECTIONTOKEN",typename:l,ids:a.selectedFeatures.join()};$.post(n,s,(function(e){a.request_params.selectiontoken=e.token,i&&(i.params.SELECTIONTOKEN=e.token),a.geometryType&&"none"!=a.geometryType&&"unknown"!=a.geometryType&&i.redraw(!0)}))}else i&&delete i.params.SELECTIONTOKEN,"request_params"in a||(a.request_params={}),a.request_params.selection=null,a.request_params.selectiontoken=null,a.geometryType&&"none"!=a.geometryType&&"unknown"!=a.geometryType&&i.redraw(!0)}}}(e.featureType)},layerFilteredFeaturesChanged:function(e){P(e.featureType);var t=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked");"cascade"in e&&(t=e.cascade),B(e.featureType,t)},lizmapeditionfeaturecreated:function(e){var a=lizMap.getLayerConfigById(e.layerId,t.attributeLayers,"layerId");if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;q(r)}},lizmapeditionfeaturemodified:function(e){var a=lizMap.getLayerConfigById(e.layerId);if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;q(r)}},lizmapeditionfeaturedeleted:function(e){var a=lizMap.getLayerConfigById(e.layerId);if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;q(r);const e=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked");let i=!1;("filteredFeatures"in t.layers[r]&&t.layers[r].filteredFeatures.length>0||"request_params"in t.layers[r]&&t.layers[r].request_params.filter||"request_params"in t.layers[r]&&t.layers[r].request_params.exp_filter)&&(i=!0),i&&lizMap.lizmapLayerFilterActive&&e&&B(lizMap.lizmapLayerFilterActive,e)}},lizmaplocatefeaturechanged:function(e){if(!(e.featureType in t.attributeLayers)||n)return!1;var a=t.locateByLayer[e.featureType],r=!1;if("filterOnLocate"in a&&"True"==a.filterOnLocate&&(r=!0),!r)return!1;lizMap.events.triggerEvent("layerfeatureselected",{featureType:e.featureType,fid:e.featureId,updateDrawing:!1}),lizMap.events.triggerEvent("layerfeaturefilterselected",{featureType:e.featureType})},lizmaplocatefeaturecanceled:function(e){lizMap.events.triggerEvent("layerfeatureremovefilter",{featureType:e.featureType})},lizmapeditionformdisplayed:function(e){$("#edition-children-container").hide().html("");var a=e.featureId;if(a&&""!=a){var i=e.layerId,l=lizMap.getLayerConfigById(i);if(l&&"relations"in lizMap.config&&i in lizMap.config.relations){var n=lizMap.config.relations[i],s=l[0];if(n.length>0){var u=C(s),o="";if(u){for(var d in u.childCreateButton&&(o+='<div class="attribute-layer-action-bar">',o+=u.childCreateButton,o+="</div>"),o+='<div class="tabbable edition-children-content">',o+='    <ul class="nav nav-tabs">',u["tab-li"])o+=u["tab-li"][d];for(var d in o+="    </ul>",o+='    <div class="tab-content">',u["tab-content"])o+=u["tab-content"][d];o+="    </div>",o+="</div>"}$("#edition-children-container").show().append(o),$("#edition-children-container div.tabbable div.tab-pane input.attribute-table-hidden-parent-layer").after('<input class="attribute-table-hidden-parent-feature-id" value="'+a+'" type="hidden">'),$("#edition-children-container div.tabbable ul.nav-tabs li").each((function(){$(this).attr("id",$(this).attr("id").replace(/nav-tab-attribute-child-tab-/g,"nav-tab-edition-child-tab-"))})),$("#edition-children-container div.tabbable ul.nav-tabs li a").each((function(){$(this).attr("href",$(this).attr("href").replace(/attribute-child-tab-/g,"edition-child-tab-"))})),$("#edition-children-container div.tabbable div.tab-content div.tab-pane").each((function(){$(this).attr("id",$(this).attr("id").replace(/attribute-child-tab-/g,"edition-child-tab-"))})),$("#edition-children-container div.tabbable div.tab-content table").each((function(){$(this).attr("id",$(this).attr("id").replace(/attribute-layer-/g,"edition-"))})),$("#edition-children-container button.btn-createFeature-attributeTable").click((function(){var e=i,l=r[$(this).val()];return lizMap.getLayerFeature(s,a,(function(a){var r=t.layers[l].id;lizMap.launchEdition(r,null,{layerId:e,feature:a})})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#edition-children-container a.btn-createFeature-attributeTable").click((function(){var e=i,l=$(this).attr("href").replace("#",""),n=r[l];return lizMap.getLayerFeature(s,a,(function(a){var r=t.layers[n].id;lizMap.launchEdition(r,null,{layerId:e,feature:a}),$(this).blur()})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),lizMap.getLayerFeature(s,a,(function(e){for(var a=e.properties,r=0,i=n.length;r<i;r++){var l=n[r],u=l.referencingLayer,o=lizMap.getLayerConfigById(u);if(o){var d=o[0],c=(o[1],'"'+l.referencingField+"\" = '"+a[l.referencedField]+"'"),b="#edition-table-"+lizMap.cleanName(s)+"-"+lizMap.cleanName(d);d in t.attributeLayers&&N(d,c,b)}}}))}}}},bottomdocksizechanged:function(e){O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},dockopened:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},dockclosed:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},rightdockopened:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},rightdockclosed:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&O("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))}}),lizMap.getAttributeFeatureData=function(e,a,r,i,l){if(a=void 0!==a?a:null,r=void 0!==r?r:null,i=void 0!==i?i:"extent",l=void 0!==l?l:null,!(e in t.layers)){var n=lizMap.getNameByCleanName(e);if(!n||!(n in t.layers))return console.log('getAttributeFeatureData: "'+e+'" and "'+n+'" not found in config'),!1;e=n}t.layers[e],e in t.attributeLayers&&t.attributeLayers[e];var s=!1;return"limitDataToBbox"in t.options&&"True"==t.options.limitDataToBbox&&(s=!0),lizMap.getFeatureData(e,a,r,i,s,null,null,l),!0}}});
//# sourceMappingURL=attributeTable.js.map